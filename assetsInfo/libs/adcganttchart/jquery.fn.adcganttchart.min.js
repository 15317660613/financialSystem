/* jQuery fn adcGanttChart v1.1.0 */
;(function($,undefined){"use strict";var now=new Date();var DEBUG=false;var VERSION='1.1.0';var defaults={height:560,width:0,toolbarHeight:60,cellHeight:50,projectCellWidth:224,projectImage:'/ADC_info/favicon.ico',separator:'-',defaultDate:[now.getFullYear(),now.getMonth()+1,now.getDate()].join('-'),request:{},loadMore:{left:0,right:0},container:{width:0,height:0},viewCurrent:0,viewSet:[{id:'W',name:'周视图',loadDays:24*7,cellWidth:112},{id:'M',name:'月视图',loadDays:18*30,cellWidth:112},{id:'D',name:'日视图',loadDays:30,cellWidth:112}],legend:[{name:'需求',style:'background-color: rgb(54, 203, 203);opacity: .7964;'},{name:'设计',style:'background-color: rgb(77, 203, 115);opacity: .7964;'},{name:'开发',style:'background-color: rgb(250, 211, 55);opacity: .7964;'},{name:'测试',style:'background-color: rgb(255, 134, 127);opacity: .7964;'}],xAxis:[],yAxis:[],dataMatrix:[],url:'',rawData:[]};var ELEM='adc-ganttchart',ELEM_TOOLBAR=ELEM+'-toolbar',ELEM_TOOLBAR_VIEW_CONTAINER=ELEM_TOOLBAR+'-view-container',ELEM_TOOLBAR_VIEW=ELEM_TOOLBAR+'-view',ELEM_TOOLBAR_LEGEND_CONTAINER=ELEM_TOOLBAR+'-legend-container',ELEM_TOOLBAR_LEGEND=ELEM_TOOLBAR+'-legend',ELEM_TOOLBAR_LEGEND_HIDE=ELEM_TOOLBAR+'-legend-hide',ELEM_CONTAINER=ELEM+'-container',ELEM_BOX=ELEM+'-box',ELEM_HEADER=ELEM+'-header',ELEM_BODY=ELEM+'-body',ELEM_MAIN=ELEM+'-main',ELEM_FIXED=ELEM+'-fixed',ELEM_CELL=ELEM+'-cell',ELEM_CELL_PATCH=ELEM+'-cell-patch',ELEM_LOADING=ELEM+'-loading',ELEM_LOADING_LT_IE10=ELEM+'-loading-lt-ie10',ELEM_DEFAULT_DATE=ELEM+'-default-date';var TPL_LOADING='<div class="'+ELEM_LOADING+'"><div class="loading"></div></div>',TPL_LOADING_LT_IE10='<div class="'+ELEM_LOADING_LT_IE10+'"><div class="loading">Loading . . .</div></div>';var TPL='<div class="'+ELEM_TOOLBAR+'">                    <div class="'+ELEM_TOOLBAR_VIEW_CONTAINER+'"></div>                    <div class="'+ELEM_TOOLBAR_LEGEND_CONTAINER+'"></div>                </div>                <div class="'+ELEM_CONTAINER+'">                    <div class="'+ELEM_BOX+'">                        <div class="'+ELEM_HEADER+'">                            <table cellspacing="0" cellpadding="0" border="0">                                <thead></thead>                            </table>                        </div>                        <div class="'+ELEM_BODY+' '+ELEM_MAIN+'">                            <table cellspacing="0" cellpadding="0" border="0">                                <tbody></tbody>                            </table>                        </div>                        <div class="'+ELEM_FIXED+'">                            <div class="'+ELEM_HEADER+'">                                <table cellspacing="0" cellpadding="0" border="0">                                    <thead></thead>                                </table>                            </div>                            <div class="'+ELEM_BODY+'">                                <table cellspacing="0" cellpadding="0" border="0">                                    <tbody></tbody>                                </table>                            </div>                        </div>                    </div>                </div>';var Instance=function(){var that=this;return{version:VERSION,today:function(){that.scrollToDefaultDate.call(that,true)}}};var Class=function(options,elem){var that=this;that.options=options;that.elem=elem;that.init()};Class.prototype.init=function(){var that=this,options=that.options,elem=that.elem;elem.addClass(ELEM);if(options.width>0)elem.css('width',options.width);elem.append(TPL);elem.find('.'+ELEM_TOOLBAR).css('height',options.toolbarHeight);elem.find('.'+ELEM_CONTAINER).css('height',options.height-options.toolbarHeight);elem.find('.'+ELEM_MAIN).css('height',options.height-options.toolbarHeight-options.cellHeight);elem.find('.'+ELEM_FIXED).find('.'+ELEM_BODY).css('height',options.height-options.toolbarHeight-options.cellHeight);$.each(options.viewSet,function(index,item){$('.'+ELEM_TOOLBAR_VIEW_CONTAINER).append('<div class="'+ELEM_TOOLBAR_VIEW+'" data-view="'+index+'">'+item.name+'</div>')});$('.'+ELEM_TOOLBAR_VIEW).on('click',function(){var viewIndex=$(this).data('view');that.reload.call(that,{viewCurrent:viewIndex})});var toolbarLegendContainer=$('.'+ELEM_TOOLBAR_LEGEND_CONTAINER),styleSheet='<style>.adc-ganttchart-project-style {background-color: transparent;}';$.each(options.legend,function(index,item){toolbarLegendContainer.append('<div class="'+ELEM_TOOLBAR_LEGEND+' adc-ganttchart-legend'+index+'" data-legend="'+index+'">'+item.name+'</div>');styleSheet+='.adc-ganttchart-project-style'+index+',.adc-ganttchart-legend'+index+':before {'+item.style+'}'});styleSheet+='</style>';$('.'+ELEM).append(styleSheet);$('.'+ELEM_TOOLBAR_LEGEND).on('click',function(){var legendIndex=$(this).data('legend'),legendClass=$(this).hasClass(ELEM_TOOLBAR_LEGEND_HIDE);if(legendClass){$(this).removeClass(ELEM_TOOLBAR_LEGEND_HIDE);$('.adc-ganttchart-project-style'+legendIndex).css('visibility','visible')}else{$(this).addClass(ELEM_TOOLBAR_LEGEND_HIDE);$('.adc-ganttchart-project-style'+legendIndex).css('visibility','hidden')}});that.loading(true);that.requestInitial();that.pullData();that.render();that.scrollEvent();that.scrollToDefaultDate();that.loading(false);options.container.width=$('.'+ELEM_MAIN).find('table').width();options.container.height=$('.'+ELEM_MAIN).find('table').height()};Class.prototype.reload=function(config){var that=this,options=that.options,toLeft=false,toRight=false;if(!config||(config.hasOwnProperty('viewCurrent')&&config.viewCurrent===options.viewCurrent)||(config.hasOwnProperty('loadMore')&&config.loadMore.left===options.loadMore.left&&config.loadMore.right===options.loadMore.right)){return}if(config.hasOwnProperty('loadMore')&&config.loadMore.left===options.loadMore.left&&config.loadMore.right!==options.loadMore.right){toRight=true}else if(config.hasOwnProperty('loadMore')&&config.loadMore.left!==options.loadMore.left&&config.loadMore.right===options.loadMore.right){toLeft=true}if(config.hasOwnProperty('viewCurrent')){config.loadMore={left:0,right:0}}that.loading(true);options=$.extend(options,config);that.requestInitial();that.render();if(config&&config.hasOwnProperty('viewCurrent')){that.scrollToDefaultDate()}else if(config&&toLeft){var newWidth=$('.'+ELEM_MAIN).find('table').width(),diff=newWidth-options.container.width,left=$('.'+ELEM_MAIN).scrollLeft();$('.'+ELEM_MAIN).scrollLeft(left+diff)}options.container.width=$('.'+ELEM_MAIN).find('table').width();options.container.height=$('.'+ELEM_MAIN).find('table').height();that.loading(false)};Class.prototype.pullData=function(){var that=this,options=that.options;if(options.url){$.ajax({type:'GET',url:options.url,contentType:'application/json; charset=utf-8',data:options.request,dataType:'json',headers:{},async:false,success:function(res){options.rawData=res},error:function(err,msg){console&&console.error&&console.error(msg)}})}else if(options.data){options.rawData={data:options.data}}else{console&&console.error&&console.error('Parameter url cannot be empty.')}};Class.prototype.requestInitial=function(){var that=this,options=that.options,loadMore=options.loadMore;var startDate=that.calcDate(options.defaultDate,-options.viewSet[options.viewCurrent].loadDays*(loadMore.left+1));var endDate=that.calcDate(options.defaultDate,options.viewSet[options.viewCurrent].loadDays*(loadMore.right+1));if(options.viewCurrent===0){var tmpStartDate=that.dateStringFormat(startDate),tmpStartWeek=tmpStartDate.getDay(),tmpEndDate=that.dateStringFormat(endDate),tmpEndWeek=tmpEndDate.getDay();if(tmpStartWeek===0){startDate=that.calcDate(startDate,-6)}else if(tmpStartWeek>1){startDate=that.calcDate(startDate,1-tmpStartWeek)}if(tmpEndWeek>0){endDate=that.calcDate(endDate,7-tmpEndWeek)}}else if(options.viewCurrent===1){var tmpStartDate=that.dateStringFormat(startDate),tmpStartYear=tmpStartDate.getFullYear(),tmpStartMonth=tmpStartDate.getMonth()+1,tmpEndDate=that.dateStringFormat(endDate),tmpEndYear=tmpEndDate.getFullYear(),tmpEndMonth=tmpEndDate.getMonth()+1;startDate=that.calcDate([tmpStartYear,tmpStartMonth,1].join(options.separator),0);if(tmpEndMonth===12){endDate=that.calcDate([tmpEndYear+1,1,1].join(options.separator),-1)}else{endDate=that.calcDate([tmpEndYear,tmpEndMonth+1,1].join(options.separator),-1)}}options.request={start:startDate,end:endDate}};Class.prototype.yAxisInitial=function(){var that=this,options=that.options,data=options.rawData.data,result=[];$.each(data,function(index,item){result.push({id:item.id,name:item.name,schedule:item.schedule,start:item.start,mark:item.mark})});options.yAxis=result};Class.prototype.xAxisInitial=function(){var that=this,options=that.options,separator=options.separator,startDate=options.request.start,endDate=options.request.end,viewInfo=options.viewSet[options.viewCurrent];var result=[];switch(viewInfo.id){case'W':var currentDate=that.getWeekInfo(startDate).firstDateOfWeek;while(that.compareDate(currentDate,endDate)<=0){var currentWeekInfo=that.getWeekInfo(currentDate);var currentYearInfo=result.length===0||(currentWeekInfo.month===1&&currentWeekInfo.week===1)?currentWeekInfo.year+' ':'';currentWeekInfo.month=currentWeekInfo.month.toString().length===1?'0'+currentWeekInfo.month:currentWeekInfo.month;var isDefaultDate=that.compareDate(options.defaultDate,currentDate);isDefaultDate=isDefaultDate>=0&&isDefaultDate<7;result.push({name:currentYearInfo+currentWeekInfo.month+'月 第'+currentWeekInfo.week+'周',firstDate:currentWeekInfo.firstDateOfWeek,isDefaultDate:isDefaultDate});currentDate=that.calcDate(currentDate,7)}break;case'M':var startDateIns=that.dateStringFormat(startDate),currentDate=[startDateIns.getFullYear(),startDateIns.getMonth()+1,startDateIns.getDate()].join(separator);while(that.compareDate(currentDate,endDate)<=0){var currentMonthDateIns=that.dateStringFormat(currentDate),currentMonthYear=currentMonthDateIns.getFullYear(),currentMonthMonth=currentMonthDateIns.getMonth()+1,currentMonthDay=currentMonthDateIns.getDate(),currentMonthMonth=currentMonthMonth.toString().length===1?'0'+currentMonthMonth:currentMonthMonth,currentMonthDay=currentMonthDay.toString().length===1?'0'+currentMonthDay:currentMonthDay,currentMonthInfo=currentMonthMonth+'月',currentYearInfo=result.length===0||parseInt(currentMonthMonth,10)===1?currentMonthYear+'年':'',countDays=new Date(currentMonthYear,parseInt(currentMonthMonth,10),0).getDate();var isDefaultDate=that.compareDate(options.defaultDate,currentDate);isDefaultDate=isDefaultDate>=0&&isDefaultDate<countDays;result.push({name:currentYearInfo+currentMonthInfo,firstDate:[currentMonthYear,currentMonthMonth,currentMonthDay].join(separator),isDefaultDate:isDefaultDate,Y:currentMonthYear,M:parseInt(currentMonthMonth,10),countDays:countDays});if(currentMonthMonth===12){currentMonthYear++;currentMonthMonth=1}else{currentMonthMonth++}currentDate=[currentMonthYear,currentMonthMonth,1].join(separator)}break;case'D':var currentDate=startDate;while(that.compareDate(currentDate,endDate)<=0){var currentDayIns=that.dateStringFormat(currentDate),currentDayYear=currentDayIns.getFullYear(),currentDayMonth=currentDayIns.getMonth()+1,currentDayDay=currentDayIns.getDate(),currentDayMonth=currentDayMonth.toString().length===1?'0'+currentDayMonth:currentDayMonth,currentDayDay=currentDayDay.toString().length===1?'0'+currentDayDay:currentDayDay,currentYearInfo=result.length===0||(parseInt(currentDayMonth,10)===1&&parseInt(currentDayDay,10)===1)?currentDayYear+'年':'',currentMonthInfo=result.length===0||parseInt(currentDayDay,10)===1?currentDayMonth+'月':'';var isDefaultDate=that.compareDate(options.defaultDate,currentDate);isDefaultDate=isDefaultDate===0;result.push({name:currentYearInfo+currentMonthInfo+currentDayDay+'日',firstDate:[currentDayYear,currentDayMonth,currentDayDay].join(separator),isDefaultDate:isDefaultDate});currentDate=that.calcDate(currentDate,1)}break;default:break}options.xAxis=result};Class.prototype.render=function(){var that=this,options=that.options,elem=that.elem;$('.adc-ganttchart-toolbar-view-container').find('.adc-ganttchart-toolbar-view').removeClass('adc-ganttchart-toolbar-view-active');$($('.adc-ganttchart-toolbar-view-container').find('.adc-ganttchart-toolbar-view')[options.viewCurrent]).addClass('adc-ganttchart-toolbar-view-active');that.xAxisInitial();that.yAxisInitial();elem.find('.'+ELEM_FIXED).find('thead').empty();elem.find('.'+ELEM_FIXED).find('thead').append('<tr><th><div class="'+ELEM_CELL+'">项目名称</div></th></tr>');var fixedTbodyDOM='';$.each(options.yAxis,function(index,item){fixedTbodyDOM+='<tr data-id="'+item.id+'">                                    <td>                                        <div class="'+ELEM_CELL+'">                                            <img src="'+options.projectImage+'">'+item.name+'                                        </div>                                    </td>                                </tr>'});elem.find('.'+ELEM_FIXED).find('tbody').empty();elem.find('.'+ELEM_FIXED).find('tbody').append(fixedTbodyDOM);var mainTheadDOM='<tr>';$.each(options.xAxis,function(index,item){var isDefaultDate=item.isDefaultDate?ELEM_DEFAULT_DATE:'';mainTheadDOM+='<th data-firstdate="'+item.firstDate+'" class="'+isDefaultDate+'"><div class="'+ELEM_CELL+'">'+item.name+'</div></th>'});mainTheadDOM+='</tr>';$(elem.find('.'+ELEM_HEADER).find('thead')[0]).empty();$(elem.find('.'+ELEM_HEADER).find('thead')[0]).append(mainTheadDOM);var mainTbodyDOM='',xLength=options.xAxis.length,yLength=options.yAxis.length;for(var i=0;i<yLength;i++){var trDom='<tr>';for(var j=0;j<xLength;j++){var isDefaultDate=options.xAxis[j].isDefaultDate?ELEM_DEFAULT_DATE:'';trDom+='<td class="'+isDefaultDate+'"><div class="'+ELEM_CELL+'"></div></td>'}trDom+='</tr>';mainTbodyDOM+=trDom}elem.find('.'+ELEM_MAIN).find('tbody').empty();elem.find('.'+ELEM_MAIN).find('tbody').append(mainTbodyDOM);$('.'+ELEM_FIXED).find('.'+ELEM_CELL).css('width',options.projectCellWidth+1);$($('.'+ELEM_HEADER)[0]).css('margin-left',options.projectCellWidth+2);$('.'+ELEM_MAIN).css('margin-left',options.projectCellWidth+2);that.generateDateMatrix();that.drawScheduleChart();that.mark();that.scrollPatch()};Class.prototype.generateDateMatrix=function(){var that=this,options=that.options,xAxis=options.xAxis,yAxis=options.yAxis,requestStart=options.request.start,requestEnd=options.request.end,viewInfo=options.viewSet[options.viewCurrent];var tmpMatrix=[];for(var i=0;i<yAxis.length;i++){var tmpArray=[];for(var j=0;j<xAxis.length;j++){tmpArray.push([])}tmpMatrix.push(tmpArray)}$.each(yAxis,function(index,item){var startDate=JSON.parse(JSON.stringify(item.start)),schedule=JSON.parse(JSON.stringify(item.schedule)),yAxisStart=index,rowData=tmpMatrix[yAxisStart];var judgeDate=that.compareDate(requestStart,startDate);if(judgeDate>0){startDate=requestStart;$.each(schedule,function(ind,val){var tmp=schedule[ind];if(judgeDate>0){if(judgeDate>=val){judgeDate-=tmp;schedule[ind]=0}else{schedule[ind]-=judgeDate;judgeDate=0}}})}if(that.compareDate(startDate,requestEnd)>0)return true;switch(viewInfo.id){case'W':var startWeekInfo=that.getWeekInfo(startDate),xAxisStart=0;$.each(xAxis,function(i,ii){if(startWeekInfo.firstDateOfWeek===ii.firstDate){xAxisStart=i;return false}});var currentScheduleIndex=-1;$.each(schedule,function(ind,val){if(val!==0){currentScheduleIndex=ind;return false}});if(currentScheduleIndex===-1)return true;for(var i=xAxisStart;i<xAxis.length;i++){var currentWeekFirstDate=xAxis[i].firstDate;var currentWeekRemainLength=i===xAxisStart?7-that.compareDate(startDate,currentWeekFirstDate):7;var resultArray=[];for(var j=0;j<schedule.length;j++){if(schedule[j]===0){resultArray.push(0)}}while(currentWeekRemainLength>0){if(currentScheduleIndex>=schedule.length)break;var currentScheduleLength=schedule[currentScheduleIndex];if(currentWeekRemainLength<currentScheduleLength){resultArray.push(Math.round(currentWeekRemainLength/7*100));schedule[currentScheduleIndex]-=currentWeekRemainLength;currentWeekRemainLength=0}else{resultArray.push(Math.round(currentScheduleLength/7*100));schedule[currentScheduleIndex]=0;currentWeekRemainLength-=currentScheduleLength;currentScheduleIndex++}}rowData[i]=resultArray;if(currentScheduleIndex>=schedule.length)break;startDate=that.calcDate(startDate,currentWeekRemainLength)}break;case'M':var startMonthInfo=that.dateStringFormat(startDate),startMonthInfoYear=startMonthInfo.getFullYear(),startMonthInfoMonth=startMonthInfo.getMonth()+1,xAxisStart=0;$.each(xAxis,function(i,ii){if(startMonthInfoYear===ii.Y&&startMonthInfoMonth===ii.M){xAxisStart=i;return false}});var currentScheduleIndex=-1;$.each(schedule,function(ind,val){if(val!==0){currentScheduleIndex=ind;return false}});if(currentScheduleIndex===-1)return true;for(var i=xAxisStart;i<xAxis.length;i++){var monthInfo=xAxis[i],monthDayCount=monthInfo.countDays,currentMonthFirstDate=monthInfo.firstDate,currentMonthRemainLength=i===xAxisStart?monthDayCount-that.compareDate(startDate,currentMonthFirstDate):monthDayCount;var resultArray=[];for(var j=0;j<schedule.length;j++){if(schedule[j]===0){resultArray.push(0)}}while(currentMonthRemainLength>0){if(currentScheduleIndex>=schedule.length)break;var currentScheduleLength=schedule[currentScheduleIndex];if(currentMonthRemainLength<currentScheduleLength){resultArray.push(Math.round(currentMonthRemainLength/monthDayCount*100));schedule[currentScheduleIndex]-=currentMonthRemainLength;currentMonthRemainLength=0}else{resultArray.push(Math.round(currentScheduleLength/monthDayCount*100));schedule[currentScheduleIndex]=0;currentMonthRemainLength-=currentScheduleLength;currentScheduleIndex++}}rowData[i]=resultArray;if(currentScheduleIndex>=schedule.length)break;startDate=that.calcDate(startDate,monthDayCount)}break;case'D':var startDayInfo=that.dateStringFormat(startDate),xAxisStart=0;$.each(xAxis,function(i,ii){var xAxisDateInfo=that.dateStringFormat(ii.firstDate);if(startDayInfo.getFullYear()===xAxisDateInfo.getFullYear()&&startDayInfo.getMonth()===xAxisDateInfo.getMonth()&&startDayInfo.getDate()===xAxisDateInfo.getDate()){xAxisStart=i;return false}});var currentScheduleIndex=-1;$.each(schedule,function(ind,val){if(val!==0){currentScheduleIndex=ind;return false}});if(currentScheduleIndex===-1)return true;for(var i=xAxisStart;i<xAxis.length;i++){var dayInfo=xAxis[i];var resultArray=[];for(var j=0;j<schedule.length;j++){if(schedule[j]===0){resultArray.push(0)}}if(currentScheduleIndex>=schedule.length)break;resultArray.push(100);rowData[i]=resultArray;schedule[currentScheduleIndex]--;if(schedule[currentScheduleIndex]===0)currentScheduleIndex++;startDate=that.calcDate(startDate,1)}break;default:break}});options.dataMatrix=tmpMatrix};Class.prototype.drawScheduleChart=function(){var that=this,options=that.options,dataMatrix=options.dataMatrix,cellArray=$('.'+ELEM_MAIN).find('.'+ELEM_CELL);for(var i=0;i<dataMatrix.length;i++){var row=dataMatrix[i],start=true;for(var j=0;j<row.length;j++){var base=row.length*i,index=base+j,result=row[j];if(result.length>0){var htmlContent='';var totalLength=0;var projectStatus='';$.each(result,function(ind,val){totalLength+=val;if(ind===0&&start){projectStatus='adc-ganttchart-project-start'}if(start&&result[0]===0){}if((!row[j+1]||row[j+1].length===0)&&ind===result.length-1){projectStatus='adc-ganttchart-project-end'}if(val!==0){htmlContent+='<div class="adc-ganttchart-project adc-ganttchart-project-style'+ind+' '+projectStatus+'" style="width: '+val+'%;"></div>'}projectStatus=''});if(start&&totalLength<100&&row[j+1].length>0){var patch=100-totalLength;htmlContent='<div class="adc-ganttchart-project adc-ganttchart-project-style" style="width: '+patch+'%;"></div>'+htmlContent}if((!row[j+1]||row[j+1].length===0)&&totalLength<100){var patch=100-totalLength;htmlContent+='<div class="adc-ganttchart-project adc-ganttchart-project-style" style="width: '+patch+'%;"></div>'}if(start)start=false;$(cellArray[index]).html(htmlContent)}}}};Class.prototype.mark=function(){var that=this,options=that.options,xAxis=options.xAxis,yAxis=options.yAxis,elem=that.elem,projectRow=elem.find('.adc-ganttchart-main').find('tbody').find('tr');if(options.viewCurrent!==0)return;for(var y=0;y<yAxis.length;y++){var target=yAxis[y];var rowElem=$(projectRow[y]).find('td');if(!target.mark)continue;$.each(target.mark,function(ind,item){if(that.compareDate(item[0],target.start)<0||that.compareDate(item[0],that.calcDate(target.start,target.schedule))>=0||that.compareDate(item[0],options.request.start)<0||that.compareDate(item[0],options.request.end)>=0)return true;for(var x=0;x<xAxis.length;x++){var remain=that.compareDate(item[0],xAxis[x].firstDate);if(remain>=0&&remain<7)break}var style={left:(remain/7*100)+'%'};$.extend(style,item[2]);var styleStr='';for(name in style){styleStr+=name;styleStr+=':';styleStr+=style[name];styleStr+=';'}$(rowElem[x]).prepend('<span style="'+styleStr+'">'+item[1]+'</span>')})}};Class.prototype.scrollPatch=function(){var that=this,elem=that.elem,scollWidth=$('.'+ELEM_MAIN).width()-$('.'+ELEM_MAIN).prop('clientWidth'),scollHeight=$('.'+ELEM_MAIN).height()-$('.'+ELEM_MAIN).prop('clientHeight');$(elem.find('.'+ELEM_HEADER).find('thead')[0]).find('.'+ELEM_CELL_PATCH).remove();if(scollWidth){var patchElem=$('<th class="'+ELEM_CELL_PATCH+'"><div></div></th>');patchElem.find('div').css({height:20,width:scollWidth});$(elem.find('.'+ELEM_HEADER).find('thead').find('tr')[0]).append(patchElem)}elem.find('.'+ELEM_FIXED).find('tbody').find('.'+ELEM_CELL_PATCH).remove();if(scollHeight){var patchElem=$('<tr class="'+ELEM_CELL_PATCH+'"><td><div></div></td></tr>');patchElem.find('div').css({height:scollHeight,width:225});elem.find('.'+ELEM_FIXED).find('tbody').append(patchElem)}};Class.prototype.scrollEvent=function(){var that=this,options=that.options;$('.'+ELEM_MAIN).on('scroll',function(){var othis=$(this),scrollLeft=othis.scrollLeft(),scrollTop=othis.scrollTop(),tableWidth=$('.'+ELEM_MAIN).width(),watchWidth=options.viewSet[options.viewCurrent].cellWidth*3,loadMore=JSON.parse(JSON.stringify(options.loadMore));$('.'+ELEM_HEADER).scrollLeft(scrollLeft);$('.'+ELEM_FIXED).find('.'+ELEM_BODY).scrollTop(scrollTop);if(scrollLeft<watchWidth){loadMore.left++;that.reload({loadMore:loadMore})}else if(options.container.width-tableWidth-scrollLeft<watchWidth){loadMore.right++;that.reload({loadMore:loadMore})}})};Class.prototype.scrollToDefaultDate=function(animate){var that=this,options=that.options,cellWidth=options.viewSet[options.viewCurrent].cellWidth,mainWidth=$('.'+ELEM_MAIN).width(),left=$($('.'+ELEM_HEADER)[0]).find('th.adc-ganttchart-default-date')[0].offsetLeft;left-=mainWidth/2;left+=cellWidth/2;if(animate)$('.'+ELEM_MAIN).animate({scrollLeft:left},300);else $('.'+ELEM_MAIN).scrollLeft(left)};Class.prototype.loading=function(flag){var that=this,browserInfo=that.browser();if(browserInfo.browser==='ie'&&parseInt(browserInfo.version,10)<10){if(flag){$('.'+ELEM).append(TPL_LOADING_LT_IE10)}else{$('.'+ELEM).find('.'+ELEM_LOADING_LT_IE10).remove()}}else{if(flag){$('.'+ELEM).append(TPL_LOADING)}else{$('.'+ELEM).find('.'+ELEM_LOADING).remove()}}};Class.prototype.browser=function(){var browser='';var version='';var userAgent=navigator.userAgent.toLowerCase();var isOpera=userAgent.indexOf("opera")>-1||userAgent.indexOf("opr")>-1;var isIE=userAgent.indexOf("compatible")>-1&&userAgent.indexOf("msie")>-1&&!isOpera;var isFirefox=userAgent.indexOf("firefox")>-1;var isSafari=userAgent.indexOf("safari")>-1;var isChrome=userAgent.indexOf("chrome")>-1;if(isIE){var reIE=new RegExp("msie (\\d+\\.\\d+);");reIE.test(userAgent);browser='ie';version=parseFloat(RegExp["$1"]).toString()}return{browser:browser,version:version}};Class.prototype.dateStringFormat=function(dateString,separator){var that=this,separator=separator||that.options.separator,date=dateString.split(separator),dateIns=new Date(parseInt(date[0],10),parseInt(date[1],10)-1,parseInt(date[2],10));return dateIns};Class.prototype.getWeekInfo=function(date,separator){var that=this,separator=separator||that.options.separator,dateIns=that.dateStringFormat(date,separator),dateYear=dateIns.getFullYear(),dateMonth=dateIns.getMonth()+1,dateDay=dateIns.getDate(),dateWeek=dateIns.getDay(),firstDayOfMonth=new Date(dateYear,dateMonth-1,1),firstDayOfMonth_Week=firstDayOfMonth.getDay(),lastDayOfFirstWeek=firstDayOfMonth_Week===0?1:7-firstDayOfMonth_Week+1,lastDayOfMonth=new Date(dateYear,11,31),lastDayOfMonth_Week=lastDayOfMonth.getDay(),firstDayOfLastWeek=lastDayOfMonth_Week===0?25:lastDayOfMonth.getDate()-lastDayOfMonth_Week+1;if(firstDayOfMonth_Week===1){var currentWeek=parseInt((dateDay-1)/7,10)+1}else if(dateDay>lastDayOfFirstWeek){if(dateMonth===1){var currentWeek=parseInt((dateDay-lastDayOfFirstWeek-1)/7,10)+2}else{var currentWeek=parseInt((dateDay-lastDayOfFirstWeek-1)/7,10)+1}}else{if(dateMonth===1){var currentWeek=1}else{return that.getWeekInfo(that.calcDate(date,-1),separator)}}var currentWeekFirstDate=dateWeek===1?that.calcDate(date,0):dateWeek===0?that.calcDate(date,-6):that.calcDate(date,1-dateWeek);return{year:dateYear,month:dateMonth,week:currentWeek,firstDateOfWeek:currentWeekFirstDate}};Class.prototype.calcDate=function(date,day,separator){var that=this,separator=separator||that.options.separator,calcDateDateIns=that.dateStringFormat(date,separator);if(day instanceof Array){day=(function(arr){var count=0;while(arr.length>0){count+=arr.shift()}return count})(JSON.parse(JSON.stringify(day)))}calcDateDateIns.setDate(calcDateDateIns.getDate()+day);var newDateArray=[];newDateArray.push(calcDateDateIns.getFullYear());var m=calcDateDateIns.getMonth()+1;m=m.toString().length===1?'0'+m.toString():m.toString();newDateArray.push(m);var d=calcDateDateIns.getDate();d=d.toString().length===1?'0'+d.toString():d.toString();newDateArray.push(d);return newDateArray.join(separator)};Class.prototype.compareDate=function(a,b,separator){var that=this,separator=separator||that.options.separator,dateAIns=that.dateStringFormat(a,separator),dateATime=dateAIns.getTime(),dateBIns=that.dateStringFormat(b,separator),dateBTime=dateBIns.getTime(),result=dateATime-dateBTime;return result/(24*60*60*1000)};$.fn.ADCGanttChart=function(options){var options=$.extend({},defaults,options);var that=this;var ins=new Class(options,that);return Instance.call(ins)}})(jQuery);