<!--
File   : task.html
Created: Wednesday August 29th 2018 3:12:18 pm
Author : yuchunyu97
License: MIT License

Copyright (c) 2018 yuchunyu97

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-----
-----
Description: 日报管理
-----
HISTORY:

-->
<!-- zTree 样式 -->
<link rel="stylesheet" href="../../assetsInfo/libs/zTree/css/metroStyle/metroStyle.css">
<style>
    #btn-export {
        margin-left: 10px;
    }
    .ztree li span.button.chk.checkbox_false_disable{
        display: none;
    }
    .task-timeline {
        position: relative;
        padding-top: 20px;
        min-width: 530px;
    }

    .task-timeline .task-timeline-item {
        overflow: hidden;
        padding-bottom: 20px;
    }

    .task-timeline .task-timeline-item .task-timeline-time {
        float: left;
        width: 100px;
        clear: both;
        text-align: right;
        margin-top: 5px;
    }

    .task-timeline .task-timeline-item .task-timeline-time h1 {
        font-size: 16px;
        color: #55B7FF;
        line-height: 22px;
    }

    .task-timeline .task-timeline-item .task-timeline-time h5 {
        font-size: 14px;
        color: #949494;
        line-height: 20px;
    }

    .task-timeline .task-timeline-item .task-timeline-axis {
        float: left;
        width: 50px;
        margin-top: 5px;
    }

    .task-timeline .task-timeline-item .task-timeline-axis span {
        /* background-color: #7ED321; */
        display: block;
        width: 22px;
        height: 22px;
        border-radius: 22px;
        margin: 0 auto;
        text-align: center;
        line-height: 22px;
        color: #fff;
    }

    .task-timeline .task-timeline-item .task-timeline-content {
        float: left;
        position: relative;
    }

    .task-timeline .task-timeline-item .task-timeline-content::before {
        content: '';
        position: absolute;
        left: -26px;
        top: 32px;
        width: 2px;
        height: 100%;
        /* background-color: #7ED321; */
    }

    .task-timeline .task-timeline-item:last-child .task-timeline-content::before {
        content: none;
    }

    .task-timeline .task-timeline-item .task-timeline-content .task-timeline-header {
        background-color: rgba(126, 211, 33, 0.3);
        color: #4D9A00;
        width: 376px;
        min-height: 32px;
        line-height: 32px;
        font-size: 16px;
        text-indent: 1em;
    }

    .task-timeline .task-timeline-item .task-timeline-content .task-timeline-header::before {
        content: '';
        position: absolute;
        left: -7px;
        top: 11px;
        width: 0;
        height: 0;
        border-left: 0;
        border-right: 7px solid transparent;
        border-top: 5px solid transparent;
        border-bottom: 5px solid transparent;
    }

    .task-timeline .task-timeline-item .task-timeline-content .task-timeline-body {
        box-sizing: border-box;
        /* border: 1px solid rgba(126, 211, 33, 0.3); */
        width: 376px;
        min-height: 63px;
        color: #949494;
        font-size: 14px;
        line-height: 20px;
        padding: 5px 18px;
        word-break: break-all;
    }

    /* 0 - 灰色 */


    .task-timeline .task-timeline-item.task-timeline-status0 .task-timeline-axis span {
        background-color: #D4D4D4;
    }

    .task-timeline .task-timeline-item.task-timeline-status0 .task-timeline-content::before {
        background-color: #D4D4D4;
    }

    .task-timeline .task-timeline-item.task-timeline-status0 .task-timeline-content .task-timeline-header {
        background-color: #EAEAEA;
        color: #949494;
    }

    .task-timeline .task-timeline-item.task-timeline-status0 .task-timeline-content .task-timeline-header::before {
        border-right-color: #EAEAEA;
    }

    .task-timeline .task-timeline-item.task-timeline-status0 .task-timeline-content .task-timeline-body {
        border: 1px solid #EAEAEA;
    }

    .task-timeline-status0-important .task-timeline-header {
        background-color: #EAEAEA !important;
        color: #949494 !important;
    }

    .task-timeline-status0-important .task-timeline-body {
        border: 1px solid #EAEAEA !important;
    }

    /* 1 - 红色 */


    .task-timeline .task-timeline-item.task-timeline-status1 .task-timeline-axis span {
        background-color: #FF7168;
    }

    .task-timeline .task-timeline-item.task-timeline-status1 .task-timeline-content::before {
        background-color: #FF7168;
    }

    .task-timeline .task-timeline-item.task-timeline-status1 .task-timeline-content .task-timeline-header {
        background-color: rgba(255, 113, 104, 0.3);
        color: #F14E10;
    }

    .task-timeline .task-timeline-item.task-timeline-status1 .task-timeline-content .task-timeline-header::before {
        border-right-color: rgba(255, 113, 104, 0.3);
    }

    .task-timeline .task-timeline-item.task-timeline-status1 .task-timeline-content .task-timeline-body {
        border: 1px solid rgba(255, 113, 104, 0.3);
    }

    .task-timeline-status1-important .task-timeline-header {
        background-color: rgba(255, 113, 104, 0.3) !important;
        color: #F14E10 !important;
    }

    .task-timeline-status1-important .task-timeline-body {
        border: 1px solid rgba(255, 113, 104, 0.3) !important;
    }

    /* 2 - 绿色 */

    .task-timeline .task-timeline-item.task-timeline-status2 .task-timeline-axis span {
        background-color: #7ED321;
    }

    .task-timeline .task-timeline-item.task-timeline-status2 .task-timeline-content::before {
        background-color: #7ED321;
    }

    .task-timeline .task-timeline-item.task-timeline-status2 .task-timeline-content .task-timeline-header {
        background-color: rgba(126, 211, 33, 0.3);
        color: #4D9A00;
    }

    .task-timeline .task-timeline-item.task-timeline-status2 .task-timeline-content .task-timeline-header::before {
        border-right-color: rgba(126, 211, 33, 0.3);
    }

    .task-timeline .task-timeline-item.task-timeline-status2 .task-timeline-content .task-timeline-body {
        border: 1px solid rgba(126, 211, 33, 0.3);
    }

    .task-timeline-status2-important .task-timeline-header {
        background-color: rgba(126, 211, 33, 0.3) !important;
        color: #4D9A00 !important;
    }

    .task-timeline-status2-important .task-timeline-body {
        border: 1px solid rgba(126, 211, 33, 0.3) !important;
    }
    .redSpan{
        color:red;
    }
</style>
<div class="layui-row layui-col-space15">
    <!-- 单列普通表格 -->
    <div class="layui-col-md12">
        <div class="layui-card p-main">
            <div class="layui-card-header" style="height: 0px"></div>
            <!-- 卡片容器 -->
            <div class="layui-card-body">
                <!-- 数据表格顶部控制栏 -->
                <div class="layui-form">
                    <div class="layui-form-item table-top-bar">
                        <div>
                            <div class="layui-inline">
                                <div class="layui-inline ">
                                    <button class="layui-btn layui-btn-sm layui-btn-primary" id="btn-add-daily">
                                        <i class="layui-icon  layui-icon-add-1"></i>
                                        新建
                                    </button>
                                    <button id="btn_edit_daily" type="button" class="layui-btn layui-btn-sm layui-import">
                                        <i class="layui-icon layui-icon-edit"></i>
                                        编辑
                                    </button>
                                    <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-becth-delete">
                                        <i class="layui-icon  layui-icon-delete"></i>
                                        删除
                                    </button>
                                    <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-sumbit-approval">
                                        提交审批
                                    </button>
                                    <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-sumbit-back">
                                        撤回
                                    </button>
                                    <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-sumbit-look">
                                        查看流程
                                    </button>
                                </div>
                            </div>
                            <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-projectPool-export" style="margin-left: 5px;display: none;float:right;">
                                <!--href="/api/Daily/dataExport"-->
                                <a  download="导出日志.xlms" style="color: #000">
                                    <i class="layui-icon  layui-icon-download-circle"></i>项目池导出
                                </a>
                            </button>
                            <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-project-export" style="margin-left: 5px;display: none;float:right;">
                                <!--href="/api/Daily/dataExport"-->
                                <a  download="导出日志.xlms" style="color: #000">
                                    <i class="layui-icon  layui-icon-download-circle"></i>项目导出
                                </a>
                            </button>
                            <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-export" style="display: none;float:right;">
                                <!--href="/api/Daily/dataExport"-->
                                <a  download="导出日志.xlms" style="color: #000">
                                    <i class="layui-icon  layui-icon-download-circle"></i>日报导出
                                </a>
                            </button>
                        </div>
                    </div>

                </div>
                <!-- 下部表格容器 -->
                <table id="tableContent-daily" lay-filter="tableContent-daily"></table>
            </div>
        </div>
    </div>
</div>
<!-- zTree js 文件 -->
<script src="../../assetsInfo/libs/zTree/js/jquery.ztree.all.min.js"></script>
<script src="../../assetsInfo/js/MenuAuthHelper.js"></script>

<script>
    //1 已审批 2已提交 3草稿 4 已撤回 5已驳回
    // 初始化 layui
    layui.use(['laydate', 'table', 'upload','formSelects'], function() {
        var table = layui.table,
            form = layui.form,
            upload = layui.upload,
            formSelects = layui.formSelects,
            laydate = layui.laydate,
            tools = layui.tools,
            config = layui.config,
            admin = layui.admin;
        var thisYear=new Date().getFullYear();
        var maxYear = thisYear+"-12-31";
        var minYear = thisYear+"-1-1";
        // 初始化日期组件
        laydate.render({
            elem: '#planStartName',
            max: 0
        });
        laydate.render({
            elem: '#planEndTime',
            max: 0
        });

        var account = config.getAccount();

        $.ajax({
            url: admin.formatUrl('/api/sys/menu/listMenuByUserId/' + account.usid),
            type: 'GET',
            dataType: 'JSON',
            async: false, // 同步进行，防止访问不到 config.menus 数据
            success: function (data) {
                $.each(data.data, function (index, item) {
                    if (item.permission == 'fin:daily:dataexport') {
                        $('#btn-export').css('display','inline-block');
                        $('#btn-project-export').css('display','inline-block');
                        $('#btn-projectPool-export').css('display','inline-block');
                    }
                })
            }
        })
        var heightTable = $(document).height() - 140;
        // console.log($(document));
        // 渲染左侧表格
        var renderTable = function(search) {
            if (!search) {
                search = {};
            }
            // 渲染表格
            table.render({
                elem: '#tableContent-daily',
                id: 'tableContent-daily',
                url: admin.formatUrl('/api/Daily/getLoginUserDailyByPage'),
                contentType : "application/json",
                method:'post',
                // 格式化后台返回的数据
                parseData: function(res) { //res 即为原始返回的数据
                    // 返回结果，进行渲染表格
                    return {
                        "code": res.respCode, //解析接口状态
                        "count": res.data.count,
                        "msg": res.message, //解析提示文本
                        "data": res.data.dataList //解析数据列表
                    };
                },
                request: {
                    pageName: 'page',
                    limitName: 'pageSize'
                },
                // height: 472,
                height: heightTable,
                cols: [
                    [{
                        type: 'checkbox'
                    },
                        {
                            field: 'createUserName',
                            title: '姓名',
                            width: 100,
                            align: 'center',
                        },
                        {
                            field: 'budgetName',
                            title: '业务',
                            align: 'center',
                            templet: function(d) {
                                return '<div title="'+d.budgetName+'"><span>'+ d.budgetName +'</span></div>';
                            }
                        },
                        {
                            field: 'projectName',
                            title: '项目',
                            align: 'center',
                            templet: function(d) {
                                return '<div title="'+d.projectName+'"><span>'+ d.projectName +'</span></div>';
                            }
                        }, {
                        field: 'taskName',
                        title: '任务',
                        align: 'center',
                        templet: function(d) {
                            return '<div title="'+d.taskName+'"><span>'+ d.taskName +'</span></div>';
                        }
                    }, {
                        field: 'dailyCreateTime',
                        title: '日期',
                        align: 'center',
                        templet: function (row) {
                            if (row.dailyCreateTime) {
                                return '<div title="'+tools.getDate(row.dailyCreateTime,"YYYY-MM-DD")+'"><span>'+ tools.getDate(row.dailyCreateTime,"YYYY-MM-DD") +'</span></div>' ;
                            }
                        }
                    }, {
                        field: 'workCostTime',
                        title: '时长',
                        align: 'center',
                        width: 60,
                    }, {
                        field: 'workDescription',
                        title: '工作描述',
                        align: 'center',
                        templet: function(d) {
                            return '<div title="'+d.workDescription+'"><span>'+ d.workDescription +'</span></div>';
                        }
                    }, {
                        field: 'createTime',
                        // title: '提交时间',
                        title: '保存时间',
                        align: 'center',
                        templet: function (row) {
                            if (row.createTime) {
                                return '<div title="'+tools.getDate(row.createTime,"YYYY-MM-DD HH:mm:ss")+'"><span>'+ tools.getDate(row.createTime,"YYYY-MM-DD HH:mm:ss") +'</span></div>';
                            }
                        }
                    }, {
                        field: 'approveUserName',
                        title: '审批人',
                        width: 100,
                        align: 'center',
                    }, {
                        field: 'workDescription',
                        title: '审批时间',
                        align: 'center',
                        templet: function (row) {
                            if (row.modifyTime) {
                                return '<div title="'+tools.getDate(row.modifyTime,"YYYY-MM-DD HH:mm:ss")+'"><span>'+ tools.getDate(row.modifyTime,"YYYY-MM-DD HH:mm:ss") +'</span></div>' ;
                            }else{
                                return '';
                            }
                        }
                    }, {
                        field: 'approveState ',
                        title: '审批状态',
                        align: 'center',
                        templet: function (row) {
                            if (row.approveState) {
                                var arr=['已审批','未审批','未提交','未提交','已驳回',"未确认"];
                                var color;
                                if(row.approveState==1){
                                    color='#00d84c';
                                }else if(row.approveState==2){
                                    color='#ff0000';
                                }else if(row.approveState==3||row.approveState==0||row.approveState==4||row.approveState==5){
                                    color='#ccc';
                                }
                                return '<span style="color:'+color+'">'+arr[row.approveState-1]+'</span>';
                            }else{
                                return '';
                            }
                        }
                    },
                    ]
                ],
                page: true,
                limit: 15, //显示的数量
                limits:[10,15,20,25,30],
                cellMinWidth: 90,
                where: search
            });
        }

        // 初始化，执行一次渲染表格
        renderTable();
        // DONE: 侧边栏变化时刷新数据表格
        // 将 table ID 存入数组
        layui.admin.addTableCache('tableContent-daily');

        // 表单提交，查询
        form.on('submit(search_daily)', function(data) {
            // 获取表单数据
            var d = data.field;
            d.name = $.trim(d.name);
            d.planStartTime = $.trim(d.planStartTime);
            d.planStartTime = $.trim(d.planStartTime);
            renderTable(d);


        });
        form.on('submit(reset_daily)', function(data) {
            reset();
        });



        /*
           任务添加
         */
        $('#btn-add-daily').on('click', function() {
            popMenu('add')

        });
        var dateChange=function(data){
            var str = data.replace(/-/g,'/');
            var date = new Date(str).getTime();
            return date;
        };
        $('#btn-export').on('click', function() {
//            var  a = document.createElement('a');
//            a.href = '/api/Daily/dataExport';
//            a.download='任务导出.xlsx'
//            document.body.append(a);
//            a.click();
            layer.open({
                type: 1,
                title: '选择导出范围',
                content: '<div id="searchDate" class="layui-form" lay-filter="searchDate"; style="padding: 20px" >\n' +
                '<div class="layui-form-item" style="position: relative">\n' +
                '<div style="display: inline-block;width: 80px;height:19px">' +
                '<label style="white-space: pre;position: absolute;top:5px;"><span class="redSpan">*</span>开始时间：</label>' +
                '</div>'+
                '<div style="display: inline-block;width: calc(100% - 90px);position: relative">\n' +
                '<input type="text" style="cursor: pointer" placeholder="请选择导出时间" lay-verify="required" class="layui-input" name="startLong" id="startLong" >\n' +
                '<img src="/assetsInfo/images/riliform.png" style="position: absolute; top: 50%; right: 5px; font-size: 20px; width: 20px; height: 20px; margin-top: -10px;"/>\n' +
                '</div>\n' +
                '</div>\n' +
                '<div class="layui-form-item" style="position: relative">\n' +
                '<div style="display: inline-block;width: 80px;height:19px">' +
                '<label style="white-space: pre;position: absolute;top:5px;"><span class="redSpan">*</span>结束时间：</label>' +
                '</div>'+
                '<div style="display: inline-block;width: calc(100% - 90px);position: relative">\n' +
                '<input type="text" style="cursor: pointer" placeholder="请选择导出时间" lay-verify="required" class="layui-input" name="endLong" id="endLong" >\n' +
                '<img src="/assetsInfo/images/riliform.png" style="position: absolute; top: 50%; right: 5px; font-size: 20px; width: 20px; height: 20px; margin-top: -10px;"/>\n' +
                '</div>\n' +
                '</div>\n' +
                '</div>',
                area: ['400px', '250px'],
                btn: ['确定', '取消'],
                yes: function(index, layero) {
                    if(!$('#startLong').val()){
                        return layer.msg('请选择开始时间', {
                            icon: 5
                        });
                    }
                    if(!$('#endLong').val()){
                        return layer.msg('请选择结束时间', {
                            icon: 5
                        });
                    }
                    var startLong = dateChange($('#startLong').val());
                    var endLong = dateChange($("#endLong").val());
                    if(startLong>endLong){
                        return layer.msg('开始时间大于结束时间，请重新选择', {
                            icon: 5
                        });
                    }
                    var allDate = parseInt((endLong - startLong) / 1000 / 60 / 60 /24);
                    if(allDate>60){
                        return layer.msg('时间范围超过60天，请重新选择', {
                            icon: 5
                        });
                    }
                    window.location.href = "/ADC_info/api/Daily/dataExport?startLong="+startLong+"&endLong="+endLong;
                    layer.close(index);
                },
                success: function() {
                    laydate.render({
                        elem: '#startLong'
                    });
                    laydate.render({
                        elem: '#endLong'
                    });

                },
                resize: false
            });

        });

        $('#btn-projectPool-export').off("click").on('click', function() {
//            var  a = document.createElement('a');
//            a.href = '/api/Daily/dataExport';
//            a.download='任务导出.xlsx'
//            document.body.append(a);
//            a.click();
            layer.open({
                type: 1,
                title: '选择导出范围',
                content: '<div id="searchDate" class="layui-form" lay-filter="searchDate"; style="padding: 20px" >\n' +
                '<div class="layui-form-item" style="position: relative">\n' +
                '<div style="display: inline-block;width: 80px;height:19px">' +
                '<label style="white-space: pre;position: absolute;top:5px;"><span class="redSpan">*</span>开始时间：</label>' +
                '</div>'+
                '<div style="display: inline-block;width: calc(100% - 90px);position: relative">\n' +
                '<input type="text" style="cursor: pointer" placeholder="请选择导出时间" lay-verify="required" class="layui-input" name="startLong" id="startLong" >\n' +
                '<img src="/assetsInfo/images/riliform.png" style="position: absolute; top: 50%; right: 5px; font-size: 20px; width: 20px; height: 20px; margin-top: -10px;"/>\n' +
                '</div>\n' +
                '</div>\n' +
                '<div class="layui-form-item" style="position: relative">\n' +
                '<div style="display: inline-block;width: 80px;height:19px">' +
                '<label style="white-space: pre;position: absolute;top:5px;"><span class="redSpan">*</span>结束时间：</label>' +
                '</div>'+
                '<div style="display: inline-block;width: calc(100% - 90px);position: relative">\n' +
                '<input type="text" style="cursor: pointer" placeholder="请选择导出时间" lay-verify="required" class="layui-input" name="endLong" id="endLong" >\n' +
                '<img src="/assetsInfo/images/riliform.png" style="position: absolute; top: 50%; right: 5px; font-size: 20px; width: 20px; height: 20px; margin-top: -10px;"/>\n' +
                '</div>\n' +
                '</div>\n' +
                '</div>',
                area: ['400px', '250px'],
                btn: ['确定', '取消'],
                yes: function(index, layero) {
                    if(!$('#startLong').val()){
                        return layer.msg('请选择开始时间', {
                            icon: 5
                        });
                    }
                    if(!$('#endLong').val()){
                        return layer.msg('请选择结束时间', {
                            icon: 5
                        });
                    }
                    var startLong = dateChange($('#startLong').val());
                    var endLong = dateChange($("#endLong").val());
                    if(startLong>endLong){
                        return layer.msg('开始时间大于结束时间，请重新选择', {
                            icon: 5
                        });
                    }
                    var allDate = parseInt((endLong - startLong) / 1000 / 60 / 60 /24);
                    if(allDate>400){
                        return layer.msg('时间范围超过400天，请重新选择', {
                            icon: 5
                        });
                    }
                    window.location.href = "/ADC_info/api/project/pool/projectPoolExport?startLong="+startLong+"&endLong="+endLong;
                    layer.close(index);
                },
                success: function() {
                    laydate.render({
                        elem: '#startLong'
                    });
                    laydate.render({
                        elem: '#endLong'
                    });

                },
                resize: false
            });

        });
        $('#btn-project-export').on('click', function() {
//            var  a = document.createElement('a');
//            a.href = '/api/Daily/dataExport';
//            a.download='任务导出.xlsx'
//            document.body.append(a);
//            a.click();
            layer.open({
                type: 1,
                title: '选择导出范围',
                content: '<div id="searchDate" class="layui-form" lay-filter="searchDate"; style="padding: 20px" >\n' +
                '<div class="layui-form-item" style="position: relative">\n' +
                '<div style="display: inline-block;width: 80px;height:19px">' +
                '<label style="white-space: pre;position: absolute;top:5px;"><span class="redSpan">*</span>开始时间：</label>' +
                '</div>'+
                '<div style="display: inline-block;width: calc(100% - 90px);position: relative">\n' +
                '<input type="text" style="cursor: pointer" placeholder="请选择导出时间" lay-verify="required" class="layui-input" name="startLong" id="startLong" >\n' +
                '<img src="/assetsInfo/images/riliform.png" style="position: absolute; top: 50%; right: 5px; font-size: 20px; width: 20px; height: 20px; margin-top: -10px;"/>\n' +
                '</div>\n' +
                '</div>\n' +
                '<div class="layui-form-item" style="position: relative">\n' +
                '<div style="display: inline-block;width: 80px;height:19px">' +
                '<label style="white-space: pre;position: absolute;top:5px;"><span class="redSpan">*</span>结束时间：</label>' +
                '</div>'+
                '<div style="display: inline-block;width: calc(100% - 90px);position: relative">\n' +
                '<input type="text" style="cursor: pointer" placeholder="请选择导出时间" lay-verify="required" class="layui-input" name="endLong" id="endLong" >\n' +
                '<img src="/assetsInfo/images/riliform.png" style="position: absolute; top: 50%; right: 5px; font-size: 20px; width: 20px; height: 20px; margin-top: -10px;"/>\n' +
                '</div>\n' +
                '</div>\n' +
                '</div>',
                area: ['400px', '250px'],
                btn: ['确定', '取消'],
                yes: function(index, layero) {
                    if(!$('#startLong').val()){
                        return layer.msg('请选择开始时间', {
                            icon: 5
                        });
                    }
                    if(!$('#endLong').val()){
                        return layer.msg('请选择结束时间', {
                            icon: 5
                        });
                    }
                    var startLong = dateChange($('#startLong').val());
                    var endLong = dateChange($("#endLong").val());
                    if(startLong>endLong){
                        return layer.msg('开始时间大于结束时间，请重新选择', {
                            icon: 5
                        });
                    }
                    var allDate = parseInt((endLong - startLong) / 1000 / 60 / 60 /24);
                    if(allDate>400){
                        return layer.msg('时间范围超过400天，请重新选择', {
                            icon: 5
                        });
                    }
                    window.location.href = "/ADC_info/api/Daily/projectExport?startLong="+startLong+"&endLong="+endLong;
                    layer.close(index);
                },
                success: function() {
                    laydate.render({
                        elem: '#startLong'
                    });
                    laydate.render({
                        elem: '#endLong'
                    });

                },
                resize: false
            });

        });
        $('#btn_edit_daily').on('click', function() {
            var checkStatus = table.checkStatus('tableContent-daily');
            if (checkStatus.data.length != 1) {
                return layer.msg('请选择1个要编辑的日报', {
                    icon: 0
                });
            }
            popMenu("edit", checkStatus.data[0]);

        });
        //撤回
        $('#btn-sumbit-back').off('click').on('click', function() {
            var checkStatus = table.checkStatus('tableContent-daily');
            if (checkStatus.data.length == 0) {
                return layer.msg('请选择1个要审批的日报', {
                    icon: 0
                });
            }
            var textMsg,num;
            var data={
                businessKeyArray:[],
            };
            for (var i = 0; i <checkStatus.data.length ; i++) {
                if(checkStatus.data.length==1){
                    if(checkStatus.data[i].approveState==0||checkStatus.data[i].approveState==3||checkStatus.data[i].approveState==4||checkStatus.data[i].approveState==5){
                        return layer.msg('该日报未提交！不可撤回！', {
                            icon: 0
                        });
                    }else if(checkStatus.data[i].approveState==1){
                        return layer.msg('该日报已审批！不可撤回！', {
                            icon: 0
                        });
                    }else if(checkStatus.data[i].approveState==6){
                        return layer.msg('该日报未确认，不可撤回！', {
                            icon: 0
                        });
                    }
                }else{
                    if(checkStatus.data[i].approveState==6||checkStatus.data[i].approveState==0||checkStatus.data[i].approveState==1||checkStatus.data[i].approveState==3||checkStatus.data[i].approveState==4||checkStatus.data[i].approveState==5){
                        return layer.msg('包含不可撤回的日报！', {
                            icon: 0
                        });
                    }
                }
                data.businessKeyArray.push(checkStatus.data[i].id);
            }
            if(data.businessKeyArray.length==1){
                textMsg='确定撤回此条日报吗？'
            }else{
                textMsg='确定撤回此'+data.businessKeyArray.length+'条日报吗？';
            }
            layer.confirm(textMsg, {
                icon: 3,
                title: '提示'
            }, function () {
                admin.req('/api/activiti-task/recall', data, function (data) {
                    if (data.ok) {
                        layer.msg('撤回任务成功！', {
                            icon: 1
                        });
                        table.reload('tableContent-daily', {
                            where: {
                                reload: new Date().getTime()
                            }
                        });
                    } else {
                        return layer.msg(data.reason, {
                            icon: 5
                        });
                    }
                }, {
                    method: 'POST'
                });
            });
        });

        //提交审批
        $('#btn-sumbit-approval').off('click').on('click', function() {
            var checkStatus = table.checkStatus('tableContent-daily');
            if (checkStatus.data.length == 0) {
                return layer.msg('请选择1个要审批的日报', {
                    icon: 0
                });
            }
            var globalProcessData1 = {
                "processDefinitionKey":"p478e4b877d504d39a392ba9317bd35e8",
                'businessKeyAssigneeMap':{

                },
                formData: 1
            };
            var globalProcessData2 = {
                "comment": "",
                "formContent": "1",
                "type": 0,
                //日报的id
                "businessKeyArray":[],
                "variables": {
                    "approve": "restartagree"
                }

            };
            var textMsg;
            var load1=false,load2=false;
            for (var i = 0; i <checkStatus.data.length ; i++) {
                if(checkStatus.data.length==1){
                    if(checkStatus.data[i].approveState==2){
                        return layer.msg('该日报已提交！请先撤回审批！', {
                            icon: 0
                        });
                    }else if(checkStatus.data[i].approveState==1){
                        return layer.msg('该日报已审批！', {
                            icon: 0
                        });
                    }
                }else{
                    if(checkStatus.data[i].approveState==2||checkStatus.data[i].approveState==1){
                        return layer.msg('包含不可提交审批的日报！', {
                            icon: 0
                        });
                    }
                }
                if(checkStatus.data[i].approveState==4||checkStatus.data[i].approveState==5){
                    globalProcessData2.businessKeyArray.push(checkStatus.data[i].id);
                }else{
                    globalProcessData1.businessKeyAssigneeMap[checkStatus.data[i].id]='';
                    checkStatus.data[i].approveState=2;
                }
            }
            if(checkStatus.data.length==1){
                textMsg='确定提交此条日报吗？'
            }else{
                textMsg='确定提交此'+checkStatus.data.length+'条日报吗？';
            }
            layer.confirm(textMsg, {
                icon: 3,
                title: '提示'
            }, function () {
                if(!$.isEmptyObject(globalProcessData1.businessKeyAssigneeMap)){
                    admin.req('/api/Daily/saveList', checkStatus.data, function (data) {
                        if (data.ok) {
                            //保存后重新判断未审批的启动流程，已审批的不进行操作
                            globalProcessData1.businessKeyAssigneeMap={};
                            for (var i = 0; i <data.data.length ; i++) {
                                if(data.data[i].approveState==2||data.data[i].approveState==3){
                                    globalProcessData1.businessKeyAssigneeMap[data.data[i].id]='';
                                }
                            }
                            if(!$.isEmptyObject(globalProcessData1.businessKeyAssigneeMap)){
                                admin.req('/api/customized-branch/startProcessMulti',globalProcessData1 , function (res) {
                                    load1=true;
                                    if (res.ok) {
                                        if(load2&&load1){
                                            layer.msg('提交成功！', {
                                                icon: 1
                                            });
                                            table.reload('tableContent-daily', {
                                                where: {
                                                    reload: new Date().getTime()
                                                }
                                            });
                                        }

                                    } else {
                                        if(load2&&load1){
                                            layer.msg('提交失败！' + res.message, {
                                                icon: 5
                                            });
                                        }
                                    }
                                }, {
                                    method: 'post'
                                });
                            }else{
                                load1=true;
                                if(load2&&load1){
                                    layer.msg('提交成功！', {
                                        icon: 1
                                    });
                                    table.reload('tableContent-daily', {
                                        where: {
                                            reload: new Date().getTime()
                                        }
                                    });
                                }
                            }
                        } else {
                            return layer.msg('保存失败：' + data.message, {
                                icon: 5
                            });
                        }
                    }, {
                        method: 'post'
                    });
                }else{
                    load1=true;
                }
                if(globalProcessData2.businessKeyArray.length!=0){
                    admin.req('/api/customized-branch/complete_multi_task_id',globalProcessData2 , function (res) {
                        load2=true;
                        if (res.ok) {
                            if(load2&&load1){
                                layer.msg('提交成功！', {
                                    icon: 1
                                });
                                table.reload('tableContent-daily', {
                                    where: {
                                        reload: new Date().getTime()
                                    }
                                });
                            }
                        } else {
                            if(load2&&load1){
                                layer.msg('提交失败！' + res.message, {
                                    icon: 5
                                });
                            }
                        }
                    }, {
                        method: 'post'
                    });
                }else{
                    load2=true;
                }
            })

        });
        $('#btn-sumbit-look').off('click').on('click', function() {
            var checkStatus = table.checkStatus('tableContent-daily');
            if (checkStatus.data.length != 1) {
                return layer.msg('请选择1个要查看的流程', {
                    icon: 0
                });
            }
            if(checkStatus.data[0].approveState==0||checkStatus.data[0].approveState==3){
                return layer.msg('该日报未提交！不可查看流程！', {
                    icon: 0
                });
            }else if(checkStatus.data[0].approveState==1){
                return layer.msg('该日报已审批！不可查看流程！', {
                    icon: 0
                });
            }
            admin.req('/api/customized-branch/progressImageData', {
                    businessKey: checkStatus.data[0].id
                },
                function (res) {
                    if (res.ok) {
                        layer.open({
                            type: 1,
                            title: '查看流程',
                            content: '<div class="" id="task-timeline"></div>',
                            area: ['550px', '350px'],
                            yes: function(index, layero) {

                            },
                            success: function() {
                                var timelineData = res.data,
                                    timelineHtml = '<ul class="task-timeline">';
                                if (timelineData.length > 0) {
                                    timelineData.reverse();
                                }else{
                                    timelineData=[
                                        {
                                            ccTaskItems: [
                                                {
                                                    assignee: null,
                                                    assigneeRealName: null,
                                                    dealTime: tools.getDate(checkStatus.data[0].createTime,"YYYY-MM-DD HH:mm:ss"),
                                                    remark: "",
                                                    status: 2,
                                                    taskDefKey: "5975250",
                                                    taskDefName: "上级领导审批",
                                                }
                                            ],
                                            order: 0,
                                            status: 2,
                                        },
                                        {
                                            ccTaskItems: [
                                                {
                                                    assignee: "SKCR3Z688H",
                                                    assigneeRealName: checkStatus.data[0].createUserName,
                                                    dealTime: tools.getDate(checkStatus.data[0].createTime,"YYYY-MM-DD HH:mm:ss"),
                                                    remark: "发起",
                                                    status: 2,
                                                    taskDefKey: "sid-C23CCF0E-A0E0-44F9-B150-79BD03CB7A46",
                                                    taskDefName: "日报审批 发起",
                                                }
                                            ],
                                            order: 0,
                                            status: 2,
                                        }
                                    ];
                                    timelineData.reverse();
                                }
                                console.log(timelineData);
                                // 将流程制作为 HTML
                                for (var i = 0; i < timelineData.length; i++) {
                                    var item = timelineData[i],
                                        ccTaskItems = item.ccTaskItems;
                                    if (ccTaskItems.length === 1) {
                                        // 简单串行流程
                                        var tmp = ccTaskItems[0];
                                        var approveUserName;
                                        if(tmp.assigneeRealName){
                                            approveUserName=tmp.assigneeRealName;
                                        }else{
                                            approveUserName = checkStatus.data[0].approveUserName;
                                            if(tmp.taskDefName.indexOf("发起") > -1){
                                                approveUserName =checkStatus.data[0].createUserName;
                                            }
                                        }
                                        // 处理时间
                                        // 对日期时间字符串做格式校验
                                        var tmpDealTime =
                                                /^[1-9]\d{3}-(0[1-9]|1[0-2]|[1-9])-(0[1-9]|[1-2][0-9]|3[0-1]|[1-9])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/
                                                    .test(tmp.dealTime) ? tmp.dealTime.split(' ') : ['', '待处理'],
                                            // 处理人姓名
                                            tmpAssigneeRealName =approveUserName,
                                            // 备注，处理意见
                                            tmpRemark = tmp.remark ? tmp.remark : '暂无处理意见',
                                            // 状态
                                            tmpStatus = item.status,
                                            // 任务名
                                            tmpTaskDefName = tmp.taskDefName;
                                        timelineHtml += '<li class="task-timeline-item task-timeline-status' +
                                            tmpStatus + '"><div class="task-timeline-time"><h1>' + tmpDealTime[
                                                0] + '</h1><h5>' + tmpDealTime[1] +
                                            '</h5></div><div class="task-timeline-axis"><span>' + (i + 1) +
                                            '</span></div><div class="task-timeline-content"><div class="task-timeline-header">' +
                                            tmpTaskDefName + ' - ' + tmpAssigneeRealName +
                                            '</div><div class="task-timeline-body">' + tmpRemark +
                                            '</div></div></li>';
                                    } else if (ccTaskItems.length > 1) {
                                        // 并行流程
                                        var arrDealTime = [];
                                        for (var k = 0; k < ccTaskItems.length; k++) {
                                            arrDealTime.push(ccTaskItems[k].dealTime);
                                        }
                                        // DONE: 将时间排序，时间越晚越靠前
                                        // TODO: 兼容 IE
                                        arrDealTime.sort(function (a, b) {
                                            if (a === '' && b === '') {
                                                return 0;
                                            } else if (a === '') {
                                                return 1;
                                            } else if (b === '') {
                                                return -1;
                                            } else {
                                                a = new Date(a).getTime();
                                                b = new Date(b).getTime();
                                                return b - a;
                                            }
                                        });
                                        tmpDealTime =
                                            /^[1-9]\d{3}-(0[1-9]|1[0-2]|[1-9])-(0[1-9]|[1-2][0-9]|3[0-1]|[1-9])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/
                                                .test(arrDealTime[0]) ? arrDealTime[0].split(' ') : ['', '待处理']
                                        timelineHtml += '<li class="task-timeline-item task-timeline-status' +
                                            item.status + '"><div class="task-timeline-time"><h1>' +
                                            tmpDealTime[0] + '</h1><h5>' + tmpDealTime[1] +
                                            '</h5></div><div class="task-timeline-axis"><span>' + (i + 1) +
                                            '</span></div><div class="task-timeline-content">';
                                        for (var j = 0; j < ccTaskItems.length; j++) {

                                            var tmp = ccTaskItems[j];
                                            var approveUserName;
                                            if(tmp.assigneeRealName){
                                                approveUserName=tmp.assigneeRealName;
                                            }else{
                                                approveUserName =checkStatus.data[0].approveUserName;
                                                if(tmp.taskDefName.indexOf("发起") > -1){
                                                    approveUserName =checkStatus.data[0].createUserName;
                                                }
                                            }
                                            // 处理人姓名
                                            var tmpAssigneeRealName = approveUserName,
                                                // 备注，处理意见
                                                tmpRemark = tmp.remark ? tmp.remark : '暂无处理意见',
                                                // 状态
                                                tmpStatus = tmp.status,
                                                // 任务名
                                                tmpTaskDefName = tmp.taskDefName;
                                            timelineHtml += '<div class="task-timeline-status' + tmpStatus +
                                                '-important"><div class="task-timeline-header">' +
                                                tmpTaskDefName +
                                                ' - ' + tmpAssigneeRealName +
                                                '</div><div class="task-timeline-body">' + tmpRemark +
                                                '</div></div>';
                                        }
                                        timelineHtml += '</div></li>';
                                    }
                                }

                                timelineHtml += '</ul>';
                                $('#task-timeline').html(timelineHtml);
                            },
                            resize: false
                        });
                    } else {
                        layer.msg('待办任务流程加载失败：' + res.message, {
                            icon: 5
                        });
                    }
                });
        });
        /*
           批量删除
         */
        $('#btn-becth-delete').on('click', function() {
            var checkStatus = table.checkStatus('tableContent-daily');
            if (checkStatus.data.length == 0) {
                return layer.msg('请选择要删除的日报', {
                    icon: 0
                });

            };
            var msgTi='确定删除' + checkStatus.data.length + '个日报吗？';
            for (var i = 0; i <checkStatus.data.length ; i++) {
                if(checkStatus.data.length==1){
                    if(checkStatus.data[i].approveState==2){
                        return layer.msg('该日报已提交！不可删除！', {
                            icon: 0
                        });
                    }else if(checkStatus.data[i].approveState==1){
                        msgTi="删除该日报将会影响您历史的工时统计，且被删除日报不可恢复，是否确定删除？";
                        // return layer.msg('该日报已审批！不可删除！', {
                        //     icon: 0
                        // });
                    }
                }else{
                    if(checkStatus.data[i].approveState==2){
                        return layer.msg('包含不可删除的日报！', {
                            icon: 0
                        });
                    }
                    if(checkStatus.data[i].approveState==1){
                        msgTi="删除的日报将会影响您历史的工时统计，且被删除日报不可恢复，是否确定删除？"
                    }
                }
            }
            var ids = [];
            var load1=false,load2=false;
            var globalProcessData2 = {
                "comment": "",
                "formContent": "1",
                "type": 0,
                //日报的id
                "businessKeyArray":[],
                "variables": {
                    "approve": "shutdownProcess"
                }

            };
            for (var item of checkStatus.data) {
                if(item.approveState==4||item.approveState==5||item.approveState==1){
                    globalProcessData2.businessKeyArray.push(item.id);
                }
                ids.push(item.id);
            }
            layer.confirm(msgTi, {
                icon: 3,
                title: '提示'
            }, function() {
                admin.req('/api/Daily/' + ids.join(','), {}, function(data) {
                    load1=true;
                    if (data.ok) {
                        if(load2&&load1){
                            layer.msg('删除成功！', {
                                icon: 1
                            });
                            table.reload('tableContent-daily', {
                                where: {
                                    reload: new Date().getTime()
                                }
                            });
                        }

                    } else {
                        if(load2&&load1) {
                            return layer.msg('删除失败：' + data.message, {
                                icon: 5
                            });
                        }
                    }
                }, {
                    method: 'delete'
                });
                if(globalProcessData2.businessKeyArray.length!=0){
                    admin.req('/api/customized-branch/complete_multi_task_id',globalProcessData2 , function (res) {
                        load2=true;
                        if (res.ok) {
                            if(load2&&load1){
                                layer.msg('删除成功！', {
                                    icon: 1
                                });
                                table.reload('tableContent-daily', {
                                    where: {
                                        reload: new Date().getTime()
                                    }
                                });
                            }
                        } else {
                            if(load2&&load1){
                                layer.msg('删除失败！' + res.message, {
                                    icon: 5
                                });
                            }
                        }
                    }, {
                        method: 'post'
                    });
                }else{
                    load2=true;
                }
            });

        });
        /*
           导入任务
         */
        upload.render({
            elem: '#upload-daily', //绑定元素,
            url: '/api/Daily/import', //上传接口
            accept: 'file',
            acceptMime: 'xlsx/xlsm',
            before: function(obj) {
                layer.load(); //上传loading
            },
            done: function(res) {
                layer.closeAll();

                if (res.respCode == 0) {
                    layer.msg('导入成功！', {
                        icon: 1
                    });
                } else {
                    return layer.msg('导入失败：' + res.message, {
                        icon: 5
                    });
                }
            },
            error: function() {
                //请求异常回调
                layer.closeAll();
                return layer.msg('导入出现错误，请重试！', {
                    icon: 5
                });
            }
        });


        function popMenu(handleType, data) {
            var params = {};
            var title = "日报添加";
            localStorage.usid=config.getAccount().usid;
            var date=tools.getDate(new Date().getTime(),"YYYY-MM-DD");
            if (handleType == 'add') {
                params.dailyCreateTime = date;
            }
            if (handleType === 'edit') {
                title = '日报编辑';
                params = data;
                localStorage.usid=data.createUserId;
                data.dailyCreateTime = tools.getDate(data.dailyCreateTime,"YYYY-MM-DD");
            }
            if(params.approveState==1||params.approveState==2){
                title = '日报查看';
            }
            params.handleType = handleType;
            admin.popupCenter({
                title: title,
                width:950,
                path: 'components/tpl/daily_save_form.html',
                finish: function() {
                    renderTable()
                },
                end: function() {
                    renderTable()
                },
                success: function() {
                    setFormValue(params);
                    form.render();
                }
            });

        };





        function setFormValue(obj) {
            if(!obj.workCostTime&&obj.handleType=='edit'){
                $('#oldWork').css('display','black');
                $('#dailyInfoList').css('display','none');
                $('#center-area').hide();

                //出差
                if (obj.dailyType==1)
                {
                    //$('#center-area').show();
                    obj.customerInfo=[obj.customer,obj.dept,obj.contacts];

                }
                obj.taskChecked=obj.taskIdArray;
                var elemArray=  $('#dailytype-form input:radio');
                $.each(elemArray,function(index,elem){
                    if (elem.value==obj.dailyType)
                    {
                        $(elem).prop('checked','checked');
                    }

                });
                var custArray=  $('#time_form input:radio');
                $.each(custArray,function(index,value){
                    if (value.value==obj.timeSlot)
                    {
                        $(value).prop('checked','checked');
                    }
                });
                var con= obj.workDescription?obj.workDescription:"" ;
                $('.workDescription_new').val(con);
            }else if(obj.workCostTime||obj.handleType=='add'){
                $('#oldWork').css('display','none');
                $('#dailyInfoList').css('display','black');
                if(obj.id){
                    var setDailyFun = function () {
                        $('.noDaily').css('display', 'none');
                        var isShareHtml ="";
                        if((obj.approveState==1||obj.approveState==2||obj.approveState==6||
                                ((obj.approveState==3||obj.approveState==5||obj.approveState==4)&&obj.dailyParentCreateUserId))
                            &&(obj.dailyParentCreateUserId||obj.childrenDailyCreateUserNames)){
                            var strH = '提示：此条日报由'+obj.dailyParentCreateUserName+'共享';
                            if(!obj.dailyParentCreateUserId){
                                strH = '提示：此条日报共享至'+obj.childrenDailyCreateUserNames.join("、");
                                if(obj.childrenDailyCreateUserNames.length==0){
                                    strH="";
                                }
                            }
                            isShareHtml='<div class="layui-form-item dailySelectMember" style="color:#FF9999">\n' +
                                strH+
                                '    </div>';
                        }
                        obj.workDescription = ADCFormDesignHelper.htmlDecodeByRegExp(obj.workDescription);
                        $('#dailyInfoList').append('<div class="dailyBox layui-form-item"  dailyParentId="'+obj.dailyParentId+'"  dailyParentCreateUserId="'+obj.dailyParentCreateUserId+'" dailyParentCreateUserName="'+obj.dailyParentCreateUserName+'" childTaskFlag="'+(obj.childTaskFlag?4:3)+'" id="'+obj.taskIdArray[0]+'">\n' +
                            '                        <span  class="workName" data-id="'+obj.id+'" data-approveState="'+obj.approveState+'" data-budgetId="'+(obj.budgetId?obj.budgetId:"")+'" data-projectId="'+(obj.projectId?obj.projectId:"")+'" id="'+obj.approveUserId+'"  title="'+obj.taskName+'" >'+obj.taskName+'</span>\n' +
                            '                        <input autocomplete="off"  type="text" name="dailyTime"\n' +
                            '                             id="dailyTime'+obj.taskIdArray[0]+'" value="'+obj.dailyCreateTime+'"  placeholder="日期" class="layui-input rili dailyTime" readonly lay-verify="required">\n' +
                            '                        <input type="text" class="workTime" onkeyup="replaceit(this)" value="'+obj.workCostTime+'" lay-verify="required|numberInt"  />\n' +
                            '<span>小时</span>\n' +
                            '                        <textarea maxlength="200" name="workDescription" type="text"  rows="8"\n' +
                            '                                  placeholder="请输入任务描述,字数控制在200字以内"\n' +
                            '                                  class="layui-textarea workDescription_new workInfo"\n' +
                            '                        >'+obj.workDescription+'</textarea>'+
                            '<div class="layui-form-item " style="height: 36px;margin-top: 10px;margin-bottom:0px;position: relative">\n' +
                            '                    <label style="width:35px;padding:5px 0" class="layui-form-label labelWidth"><span>成果:</span> </label>\n' +
                            '                    <div class="layui-input-block reduceMarginL" style="position: relative">\n' +
                            '                        <input style="background: #F6F8FE" type="text" placeholder="请上传附件" name="'+ obj.taskResultFileId +'" id="fileName_'+ obj.taskIdArray[0] +'" class="layui-input" readonly>\n' +
                            '                    </div>\n' +
                            '                    <div class="layui-inline " style="position:absolute;right:0;top: 1px;margin-right:0px">\n' +
                            '                        <button style="background: #229FFF;color:#fff;border:none" class="layui-btn layui-btn-sm layui-btn-normal" title="上传" id="chooseFile_'+ obj.taskIdArray[0] +'">上传</button>\n' +
                            '                        <button style="background: #87C459;color:#fff;border:none;margin-left: 3px;display: none" class="layui-btn layui-btn-sm layui-btn-normal" title="下载" id="download_'+ obj.taskIdArray[0] +'" >下载</button>\n' +
                            '                        <button style="background: #FC6664;color:#fff;border:none;margin-left: 3px" class="layui-btn layui-btn-sm layui-btn-normal" title="删除" id="delFile_'+ obj.taskIdArray[0] +'" >删除</button>\n' +
                            '                        <button class="layui-btn layui-btn-sm layui-btn-normal" title="上传" id="upload_'+ obj.taskIdArray[0] +'" style="display: none">上传</button>\n' +
                            '                    </div>\n' +
                            '                </div>'+
                            memberHtml+isShareHtml+
                            '                    </div>');
                        giveBind(obj.taskIdArray[0]);
                        if(obj.taskResultFileId){
                            $('#chooseFile_'+obj.taskIdArray[0]).css("display","none");
                            $('#download_'+obj.taskIdArray[0]).css("display","inline-block");
                        }
                        $('#fileName_' + obj.taskIdArray[0]).val(obj.resultFileName ? obj.resultFileName:'')
                        laydate.render({
                            elem: '#dailyTime'+obj.taskIdArray[0]+'',
                            type: 'date',
                            min:minYear,
                            max:maxYear
                        });
                    };
                    var memberHtml="";
                    if((obj.approveState==4||obj.approveState==5||obj.approveState==3)&&!obj.dailyParentCreateUserId&&obj.childTaskFlag!=null){
                        memberHtml='<div class="layui-form-item dailySelectMember">\n' +
                            '        <label class="layui-form-label" >协作人<img src="/assetsInfo/images/wenhao.png"  class="menW'+obj.taskIdArray[0]+' wenhao" />：</label>\n' +
                            '        <div class="layui-input-block" >\n' +
                            '            <div name="dailyMemberIds'+obj.taskIdArray[0]+'" id="dailyMemberIds'+obj.taskIdArray[0]+'">\n' +
                            '            </div>\n' +
                            '        </div>\n' +
                            '</div>';

                        var loadD2 =layer.load(2);
                        var urlDaily ="/api/budget/task/query/";
                        if(obj.childTaskFlag){
                            urlDaily="/api/budget/childrentask/query/";
                        }
                        $.ajax({
                            url: urlDaily+obj.taskIdArray[0],
                            type: 'get',
                            // data: JSON.stringify(optionNum),
                            // contentType: 'application/json',
                            success: function (res) {
                                layer.close(loadD2);
                                if (res.ok) {
                                    var arr =res.data.mapsList;
                                    var arr1 =res.data.userIdDeptNameMapList?res.data.userIdDeptNameMapList:[];
                                    var formSelectArr=[];
                                    for (var i = 0; i < arr.length; i++) {
                                        var title="";
                                        for(var j =0;j<arr1.length;j++){
                                            if(arr1[j].id==arr[i].id){
                                                title=arr1[j].name;
                                            }
                                        }
                                        if(arr[i].id!=config.getAccount().usid){
                                            formSelectArr.push({
                                                name: arr[i].name,
                                                value: arr[i].id,
                                                title:title
                                            });
                                        }
                                    }
                                    setDailyFun();
                                    var memberIds_blong_xmSelect = xmSelect.render({
                                        el: '#dailyMemberIds'+obj.taskIdArray[0],
                                        filterable: true,
                                        on: function(data){

                                        },
                                        theme: {
                                            color: '#0081ff',
                                        },
                                        autoRow: true,
                                        direction: 'down',
                                        searchTips: '输入你要找的人',
                                        toolbar: {
                                            show: true,
                                        },
                                        initValue:obj.childrenDailyCreateUserIds,
                                        data: formSelectArr,
                                        show:function(){

                                        },
                                        template: function(name, value, selected, disabled){
                                            return "<span title="+name.item.title+">"+name.item.name+"</span>";        //返回一个html结构, 用于显示选项

                                        },
                                    });
                                    var menIndex;
                                    $(".menW"+obj.taskIdArray[0]).off('mouseleave').on('mouseleave',function () {
                                        layer.close(menIndex);
                                    }).off('mouseenter').on('mouseenter',function () {
                                        menIndex=layer.tips("<span style='color:#333333;'>选择协作人后，此条日报将同时进入协作人的日程管理中，并计入其工时。</span>", '.menW'+obj.taskIdArray[0], {
                                            tips: [1, '#fff'],
                                        });
                                    });
                                } else {
                                    return layui.layer.msg(res.message, {
                                        icon: 5
                                    });
                                }
                            },
                            error: function (err) {
                                layer.close(loadD2);
                                return layui.layer.msg(err.message, {
                                    icon: 5
                                });
                            }
                        });
                    }else{
                        setDailyFun();
                    }
                }
            }
            obj.taskChecked = obj.taskIdArray;
            if(obj.approveState==1||obj.approveState==2){
                $('#btn-sumbit-save').attr("disabled", 'disabled');
                $('#btn-sumbit-save').removeClass("layui-btn-normal");
                $('#btn-sumbit-save').addClass("layui-btn layui-btn-disabled");
                $('#btn-daily-save').attr("disabled", 'disabled');
                $('#btn-daily-save').removeClass("layui-btn-normal");
                $('#btn-daily-save').addClass("layui-btn layui-btn-disabled");
                $('#chooseFile_'+obj.taskIdArray[0]).css("display","none");
                $('#delFile_'+obj.taskIdArray[0]).css("display","none");
                $('#delFile_'+obj.taskIdArray[0]).parent().css("right","55px");
                $('#fileName_' + obj.taskIdArray[0]).attr("placeholder","");
            }
            form.render();
            console.log(obj.dailyCreateTime);
            var title = $('.layui-tpl-container .layui-card-header');
            var formNames = ['id', 'workDescription', 'handleType','customerInfo','taskChecked','dailyCreateTime','usid','approveState','workCostTime'];
            obj.title && title.text(obj.title);
            console.log(formNames)
            for (var i = 0; i < formNames.length; i++) {
                if (obj[formNames[i]]) {
                    $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val(obj[formNames[i]]);
                } else {
                    $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val('');
                }
            }

        }
       /* function giveBind(id){
            var file = '';
            var files
            // 清空文件队列
            function clearFile(){
                for (var x in files) {
                    delete files[x];
                }
            }
            var index;
            $('#delFile_'+id).off('click').on('click',function () {
                if(!$('#fileName_'+id).val()){
                    return layer.msg('请先选择文件', {
                        icon: 5
                    });
                }
            });


            // 上传
            var uploadRender = upload.render({
                elem: '#chooseFile_'+id,
                url: '/api/sys/file/upload',
                field: 'file',
                accept: 'file',// 所有文件
                auto: false,// 自动上传
                exts:'pdf|doc|docx|xlsx|xls|zip|rar|jpg|jpeg|png|gif|ppt|pptx',// 允许上传的文件后缀
                bindAction: '#upload_'+id,
                choose:function(obj){
                    uploadRender.config.elem.next()[0].value = '';// 防止choose方法只触发一次
                    files = obj.pushFile();// 文件队列
                    clearFile();
                    obj.preview(function(index, file, result){// file:准备上传的文件对象
                        files = obj.pushFile();
                        $('#fileName_'+id).val(file.name);
                        $('#delFile_'+id).off('click').on('click',function () {
                            if(!$('#fileName_'+id).val()){
                                return layer.msg('请先选择文件', {
                                    icon: 5
                                });
                            }else{
                                delete files[index];// 删除列表中对应的文件，一般在某个事件中使用
                                $('#fileName_'+id).val('');
                            }
                        })
                    });
                },
                before:function () {
                    if($('#fileName_'+id).val()){
                        index = layer.load(2);
                    }else {
                        return layer.msg('请先选择文件', {
                            icon: 5
                        });
                    }
                },
                done: function(res,indexs) {// 上传完毕回调
                    layer.close(index);
                    if (res.ok) {
                        layer.msg('文件上传成功！', {
                            icon: 1
                        });
                        file = res.data.fileId;
                        //删除附件
                        $('#delFile_'+id).off('click').on('click',function () {
                            if($('#fileName_'+id).val()){
                                $.ajax({
                                    url: "/api/knowledge/paper/deleteFile/"+file,
                                    type: 'delete',
                                    success: function (data) {
                                        if (data.ok) {
                                            delete files[indexs];
                                            $('#fileName_'+id).val('');
                                            file = '';
                                        } else {
                                            return layer.msg(data.reason, {
                                                icon: 5
                                            });
                                        }
                                    }
                                })
                            }else {
                                return layer.msg('请先选择文件', {
                                    icon: 5
                                });
                            }

                        })
                    } else {
                        layer.msg('文件上传失败：' + res.message, {
                            icon: 5
                        });
                    }
                }
            });

        }*/
        var file = '';
        function giveBind(id){

            var files
            // 清空文件队列
            function clearFile(){
                for (var x in files) {
                    delete files[x];
                }
            }
            var index;
            $('#delFile_'+id).off('click').on('click',function () {
                if(!$('#fileName_'+id).val()){
                    return layer.msg('请先上传文件', {
                        icon: 5
                    });
                }else{
                    $('#fileName_'+id).val('')
                    $('#fileName_'+id).prop('name','')
                    $('#chooseFile_'+id).css("display","inline-block");
                    $('#download_'+id).css("display","none");
                }
            });
            $('#download_'+id).off('click').on('click',function () {
                if($('#fileName_'+id).val()){
                    window.open("/ADC_info/api/sys/file/"+$('#fileName_'+id).prop('name')+"/download")
                }else{
                    return layer.msg('文件损坏请联系管理员', {
                        icon: 5
                    });
                }
            })

            // 上传
            var uploadRender = upload.render({
                elem: '#chooseFile_'+id,
                url: '/api/sys/file/upload',
                field: 'file',
                accept: 'file',// 所有文件
                auto: false,// 自动上传
                exts:'pdf|doc|docx|xlsx|xls|zip|rar|jpg|jpeg|png|gif|ppt|pptx',// 允许上传的文件后缀
                bindAction: '#upload_'+id,
                choose:function(obj){
                    console.log("上传")
                    uploadRender.config.elem.next()[0].value = '';// 防止choose方法只触发一次
                    files = obj.pushFile();// 文件队列
                    clearFile();
                    obj.preview(function(index, file, result){// file:准备上传的文件对象
                        files = obj.pushFile();
                        $('#fileName_'+id).val(file.name);
                        $('#upload_'+id).click()
                    });
                },
                before:function () {
                    if($('#fileName_'+id).val()){
                        index = layer.load(2);
                    }else {
                        return layer.msg('请先选择文件', {
                            icon: 5
                        });
                    }
                },
                done: function(res,indexs) {// 上传完毕回调
                    layer.close(index);
                    if (res.ok) {
                        layer.msg('文件上传成功！', {
                            icon: 1
                        });
                        file = res.data.fileId;
                        $('#fileName_'+id).prop('name',res.data.fileId);
                        $('#chooseFile_'+id).css("display","none");
                        $('#download_'+id).css("display","inline-block");
                        //删除附件
                        $('#delFile_'+id).off('click').on('click',function () {
                            if($('#fileName_'+id).val()){
                                $.ajax({
                                    url: "/api/knowledge/paper/deleteFile/"+file,
                                    type: 'delete',
                                    success: function (data) {
                                        if (data.ok) {
                                            delete files[indexs];
                                            $('#fileName_'+id).val('');
                                            $('#fileName_'+id).prop('name',"");
                                            file = '';
                                            $('#chooseFile_'+id).css("display","inline-block");
                                            $('#download_'+id).css("display","none");
                                        } else {
                                            return layer.msg(data.reason, {
                                                icon: 5
                                            });
                                        }
                                    }
                                })
                            }else {
                                return layer.msg('请先上传文件', {
                                    icon: 5
                                });
                            }
                            $('#download_'+id).off('click').on('click',function () {
                                if($('#fileName_'+id).val()){
                                    window.open("/ADC_info/api/sys/file/"+file+"/download")
                                }else{
                                    return layer.msg('文件损坏请联系管理员', {
                                        icon: 5
                                    });
                                }
                            })
                        })
                    } else {
                        layer.msg('文件上传失败：' + res.message, {
                            icon: 5
                        });
                    }
                }
            });

        }
    });
</script>