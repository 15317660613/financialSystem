<script src="../../assetsInfo/js/LayCalculator.js"></script>
<style>
    .ztree {
        height: calc(100vh - 165px) !important;
        overflow-y: hidden;
    }
    .ztree:hover{
        overflow-y: auto;
    }
    .ztree::-webkit-scrollbar {/*滚动条整体样式*/
        background: #305475;
        width: 12px;
    }
    .ztree::-webkit-scrollbar-thumb {/*滚动条里面小方块*/
        border-radius: 10px;
        -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        background: #4B6F8E;
    }
    .adc-ganttchart-toolbar-text {
        display: none;
    }
    .smallTest{
        font-size: 9px !important;
        margin-left: 5px !important;
        margin-left: 5px !important;
        color: #ddd;
    }
    .layui-header{
        position: fixed;
        width: 100vw;
    }
    .layui-body{
        padding-top: 49px!important;
    }
    /*.layui-layout-admin .layui-body .layui-tab .layui-tab-content::-webkit-scrollbar {*/
    /*display: none*/
    /*}*/
    /*.layui-layout-admin .layui-body .layui-tab .layui-tab-content::-ms-scrollbar {*/
    /*display: none*/
    /*}*/
    .layui-tab-title .layui-this:after {
        display: none;
    }


    .vehicleRepair, .propertyId_select {
        height: 30px;
        border: 1px solid #999;
        border-radius: 3px;
    }
    input::-webkit-input-placeholder {
        color: #d4dce7!important;
        /* placeholder字体大小  */
        font-size: 12px;
        /* placeholder位置  */
        text-align: left;
    }
    textarea::-webkit-input-placeholder {
        color: #d4dce7!important;
        /* placeholder字体大小  */
        font-size: 12px;
        /* placeholder位置  */
        text-align: left;
    }
    .layui-tab-brief>.layui-tab-more li.layui-this:after, .layui-tab-brief>.layui-tab-title .layui-this:after {
        border: none;
        border-radius: 0;
        border-bottom: 3px solid #F6BA12 !important;
    }
    .layui-tab-brief > .layui-tab-title .layui-this {
        color: #fff !important;
        border-bottom: 1px solid #F6BA12;
    }
    body  #budgetSaveForm .layui-form-label {
        width: 136px;
    }
    body #budgetSaveForm .layui-form-label.noIncome {
        width: 106px;
    }

    #budgetSaveForm  .reduceMarginL {
        margin-left: 147px;
    }
    body .layui-form-label {
        width: 106px;
    }
    body .layui-layout-admin .layui-body .layui-tab .layui-tab-title {
        padding: 0;
    }
    .dropdown-menu{
        display: none;
    }
    .dropdown-menu li button{
        background: #fff !important;
        margin: 0;
        color:#000;
        height:35px;
        width: 80px!important;
    }
    /*.dropdown-menu button{*/
    /*width: 80px!important;*/
    /*height: 30px;*/
    /*background: #fff !important;*/
    /*}*/
    .dropdown-menu{
        background: transparent!important;
        border:none!important;
    }
    .munePic{
        background-image: url(../../assetsInfo/images/tans.png);
        background-repeat: no-repeat;
        width: 100%;
    }
    .dropdown-menu li{
        border-bottom: 1px solid #fff;
    }
    .layui-tab-title.dofer .dropdown-menu li:hover{
        background: #F6BA12 !important;
        opacity: 0.8;
    }
    .layui-tab-title.dofer li:hover{
        background: #00B1FF!important;
        color:#fff!important;
    }
    .layui-layout-admin .layui-body .layui-tab .layui-tab-title li {
        color: #eae7e7;
    }
    body {
        overflow-y: hidden;
    }
    /*导航隐藏*/
    .layui-layout-admin .admin-breadcrumb{
        display: none;
    }
    /*.ztree li span.button.switch {*/
    /*width: 18px;!important;*/
    /*height: 18px;!important;*/
    /*}*/
    /*.ztree li span.button.center_docu {*/
    /*background-position: -56px -18px;!important;*/
    /*}*/
    /*.ztree li span.button {*/
    /*background-image:url("../../assetsInfo/libs/zTree/css/metroStyle/img/zTreeStandard.png") !important;*/
    /**/
    /*}*/
    #budgetSaveForm .layui-tab-brief > .layui-tab-title .layui-this {
        color: #229FFF!important;
        border-bottom: 1px solid #229FFF;
    }
    .tree-block{
        width: 240px;
        /*height: 100%;*/
        float: left;
        color: #F5F5F5;
        background-color: #305475  !important;
        padding: 15px 0;
        overflow-y: hidden;
        overflow-x: hidden;
        -ms-overflow-style: none;
    }
    .tree-block::-webkit-scrollbar {
        display: none;
    }
    .ztree li span.button.switch {
        width: 30px;
        height: 21px;
        float: right;
        position: absolute;
        right: 1px;
        z-index: 1000;
    }
    html ,body,.layui-layout.layui-layout-admin ,.layui-body,.layui-row,.tree-block{
        height: 100%;
    }

    .dofer .layui-this{
        background: #00B1FF!important;
        color:#cecece!important;
    }
    .ztree li a{
        color: #fff!important;
    }
    .searchInput.input{
        margin-top: 10px;
        width: 100%;border:none;border-radius: 20px;
        background: #305475;
        border:1px solid #f3f3f3;
        height: 26px;
        padding-left: 15px;
        /*text-align: center;*/
    }
    .searchInput::-webkit-input-placeholder { /* WebKit browsers */
        opacity:0.4
    }

    .searchInput::-moz-placeholder { /* Mozilla Firefox 19+ */
        opacity:0.4
    }

    .searchInput:-ms-input-placeholder { /* Internet Explorer 10+ */
        opacity:0.4
    }
    .dofer li:hover{
        background: #3C6A95!important;
        color:#cecece!important;
    }
    .dofer button{
        background: #627c97!important;
        margin: 0.5px 0;
        color:#fff;
        border: none;
        width: 95%!important;
    }
    .dropdown-menu{
        min-width: 0!important;
    }
    .ownerBox{
        padding-top: 14px;
    }
    .ownerBox button{
        padding: 0;
        background: transparent;
        border: none!important;
        color: #fff!important;
        font-size: 12px;
        padding-top: 4px;
        float: right;
        padding-right: 10px;
    }
    .ztree button{
        width: auto!important;
        padding: 0!important;
        margin: 0!important;
        background-color: transparent!important;
        height: 21px;
        border:none;
    }
    /*body .ztree li a.curSelectedNode {*/
    /*padding-top: 0px;*/
    /*background-color: #5880A5;*/
    /*color: black;*/
    /*height: 21px;*/
    /*opacity: 1;*/
    /*}*/
    .remove{
        float: right;
    }

    body .ztree li .diyBtn1{
        position: absolute;
        right: 45px;
        top: 23%;
    }
    body .ztree li .diyBtn2{
        position: absolute;
        right: 65px;
        top: 23%;
    }
    body .ztree li a{
        position: relative;
    }
    /*body .ztree li a:hover{*/
    /*padding-top: 0px;*/
    /*background-color: #a54835;*/
    /*color: black;*/
    /*opacity: 1;*/
    /*}*/
    /*body .ztree li a:before {*/
    /*position: absolute;*/
    /*top: 0;*/
    /*left:0;*/
    /*width: 30px;*/
    /*height: 100%;*/
    /*background-color: yellow;*/
    /*}*/
    body .ztree li span.button {
        line-height: 0;
        margin: 0;
        padding: 0;
        width: 20px;
        height: 20px;
        display: inline-block;
        vertical-align: middle;
        border: 0 none;
        cursor: pointer;
        outline: none;
        /*background-color: transparent;*/
        background-repeat: no-repeat;
        background-attachment: scroll;
        background-image: url(../../assetsInfo/libs/zTree/css/metroStyle/img/metrotree.png);
    }
    /*body .ztree li ul.line {*/
    /*background: url(../../assetsInfo/libs/zTree/css/metroStyle/img/line_connsolid.png) 0 0 repeat-y;*/
    /*}*/
    body .ztree li span.button.roots_open {
        background-position: -87px 0;
    }
    body .ztree li span.button.roots_close {
        background-position:-110px 0;
    }
    body .ztree li span.button.center_close {
        background-position:-110px 0;
    }
    body .ztree li span.button.center_open {
        background-position: -87px 0;
    }
    .ztree li span.button.roots_close {
        background-position:-110px 0 !important;
    }
    body .ztree li span.button.center_docu {
        background-position: -101px -187px;
    }
    body .ztree li span.button.ico_open, body .ztree li span.button.ico_close,body .ztree li span.button.ico_docu {
        background-position: -110px -18px;

    }

    body .ztree li span.button.bottom_docu {
        background-position: -84px -119px;
    }
    .ztree li.level0  a.level0  span.button.remove {
        margin-left: 2px;
        margin-right: -1px;
        background-position: -189px -42px !important;
        vertical-align: top;
    }
    .RightContent html, body {
        height: 100%;
    }

    .RightContent .layui-row{
        height: auto;
    }
    #businessDetailDiv .main {
        height: 100% !important;
    }

    .RightContent .card-padding {
        padding: 0 10px;
    }
    .RightContent .form-left{
        color: #1A1A1A;
    }
    .RightContent .form-right{
        color: #666666;
    }
    .RightContent .row-margin{
        margin-top: 10px;
    }
    .RightContent .layui-card-body{
        padding : 4px 5px 9px;
        font-size: 12px;
    }
    .RightContent .layui-card-header{
        padding: 0 5px;
        /*border-bottom: 2px solid rgba(0,0,0,0.1);*/
        height:34px;
        line-height: 34px;
    }
    .RightContent .lay-tab-noShadow{
        box-shadow : none !important;
    }
    .RightContent .lay-tab-noPadding{
        padding: 0 15px;
    }
    .RightContent .cart-title{
        font-size: 14px;
        font-family: Source Han Sans CN;
        font-weight: 500;
        line-height: 34px;
        color: #4D4D4D;
        overflow:hidden;
    }
    #businessDetailDiv .analysas-height{
        height: 300px !important;
    }
    .RightContent p{
        margin : 0;
    }
    .RightContent{
        margin-bottom: 30px;
        display: none
    }
    .RightContent th, .RightContent td{
        text-align: center;
        padding: 5px;

    }
    .RightContent .table-cont{
        max-height: 240px;
        overflow: auto;
    }
    .layui-this th{
        color: #ffffff;
    }
    .li-disabled{
        pointer-events: none;
        cursor: default;
    }
    .backGround{
        background: #000 !important;
    }
    .staticInfo{
        width: 100%;
        vertical-align: middle;
        text-align: center;
        border-radius: 4px 0px 0px 0px;
        font-size: 12px;
    }

    .staticInfo tr{
        height: 40px;
        line-height: 40px;
    }
    .staticInfo thead{
        background-color: #10ADE8;
        opacity: 1;
        font-size: 14px;
        font-family: PingFang SC;
        color: #fff;
    }
    .staticInfo tr:nth-child(odd){
        background-color:#F1FAFD;
    }
    .staticInfo tr:nth-child(even) {
        background-color:#E5F6FC;
    }
    .itemDeilvery{
        overflow:hidden;

    }

    .itemDeilvery li{
        height: 41px;
        line-height: 41px;
        padding-left: 13px;
        overflow:hidden;
    }
    .itemDeilvery li p{
        display: inline-block;

    }
    .itemDeilvery .centerSpan{
        width: 65%;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
    .itemDeilvery li:nth-child(2n+1)
    {
        background-color: #FAFAFA;

    }
    .itemDeilvery li:nth-child(2n)
    {
        background-color: #F5F5F5;

    }

    /* .odd{
        background-color: #FAFAFA;
    }
    .even{
        background-color:#F5F5F5;
    } */
    .layui-card-body .layui-table{
        margin: 0;
    }
    .jdtall{
        width: 60%;
        height: 10px;
        float: left;
        margin-top: 15px;
        margin-left: 14%;
    }
    .jindutiao{
        width: 100%;
        height: 10px;
        background: rgba(230,230,230,1);
        opacity: 1;
        border-radius: 10px;
        float: left
    }
    .dwjindutiao {
        display: block;
        z-index: 10;
        left: 0;
        width: 33%;
        height: 10px;
        border-radius: 10px;
        background: linear-gradient(to right,#C2EFFF, #10ADE8);
    }
    .text{
        position: absolute;
        right: 8%;
        top: 50%;
        opacity: 0.6;
    }
    .disBlock{
        display: block;
    }
    .disNone{
        display: none;
    }


    .layui-this .layui-table thead tr{
        background-color: #008FC3 !important;
    }
    .layui-this .layui-table tbody tr:first-child{
        background-color: #E5F6FC !important;
    }
    .layui-this .layui-table tbody tr:last-child{
        background-color: #F1FAFD !important;
    }
    .layui-this  .layui-table{
        border: 2px solid #008FC3 !important;
    }
    .layui-this .imgTri
    {
        position: absolute;bottom: 16px;left: 63px;display: block;
    }
    .imgTri{
        display: none;
    }
    .layui-table:after{
        width: 4px;
        height: 4px;
        display: block;
    }
    .imgMargin{
        position: absolute;
        left: 6%;
        top: 32%;
    }
    #file-page{
        width:100%;
        text-align:center;
        position:absolute;
        bottom:0px
    }
    #file-page .layui-laypage{
        margin:0px;
    }
    #file-page .layui-laypage a,#file-page .layui-laypage span{
        border:none;
        height:20px;
        line-height:20px;

    }
    #file-page .layui-laypage .layui-laypage-curr .layui-laypage-em{
        background:#fff;

    }
    #file-page .layui-laypage .layui-laypage-curr em{
        color:#55B7FF;
    }
    #taskChild-file-page{
        width:100%;
        text-align:center;
        position:absolute;
        bottom:0px
    }
    #taskChild-file-page .layui-laypage{
        margin:0px;
    }
    #taskChild-file-page .layui-laypage a,#taskChild-file-page .layui-laypage span{
        border:none;
        height:20px;
        line-height:20px;

    }
    #taskChild-file-page .layui-laypage .layui-laypage-curr .layui-laypage-em{
        background:#fff;

    }
    #taskChild-file-page .layui-laypage .layui-laypage-curr em{
        color:#55B7FF;
    }
    #taskfile-page{
        width:100%;
        text-align:center;
        position:absolute;
        bottom:0px
    }
    #taskfile-page .layui-laypage{
        margin:0px;
    }
    #taskfile-page .layui-laypage a,#taskfile-page .layui-laypage span{
        border:none;
        height:20px;
        line-height:20px;

    }
    #taskfile-page .layui-laypage .layui-laypage-curr .layui-laypage-em{
        background:#fff;

    }
    #taskfile-page .layui-laypage .layui-laypage-curr em{
        color:#55B7FF;
    }
    #upload-project-file :hover{
        color:#55B7FF;
    }
    .top-choose{
        display: flex;
        display:-webkit-flex;
    }
    .model-choose{
        width:150px;
        height:25px;
        line-height:25px;
        margin-left:30px;
        display: flex;
        cursor: pointer;
    }
    .model-choose .child{
        width:50%;
        height:100%;
        color:#fff;
        text-align:center;
        font-size:12px;
        border:1px solid rgba(255, 255, 255, 0.4);

    }
    .model-choose .child:first-child{
        border-top-left-radius:5px;
        border-bottom-left-radius:5px;
        border-right:none;

    }
    .model-choose .child:last-child{
        border-top-right-radius:5px;
        border-bottom-right-radius:5px;
        border-left:none;
    }
    .model-choose .choose{
        background: #008FC3;
    }
    .filter-area{
        position: relative;
        width:60px;
        cursor: pointer;
    }
    .filter-area .dropdown-menu{
        left:-10px;
    }
    .org-top{
        margin-top:4px;
        color:#fff;
        display:none;
    }
    #filter-icon{
        margin-left:20px;
        opacity: 1;
    }
    #filter-icon:hover{
        opacity: 0.8;
    }
    #filter-list{
        border-radius: 4px;
        padding-top:5px;
        padding-bottom:5px;
    }
    #filter-list li{
        width:68px;
        font-size:12px;
        text-align:center;
        line-height:25px;
        color:#000;
        padding-left:10px;
        padding-right:10px;


    }
    #filter-list :hover{
        background: rgb(197, 222, 231);

    }
    .finishBtn{
        border: 1px solid #10ADE8 !important;
        color: #10ADE8;
        height: 22px;
        line-height: 20px;
        float: right;
        background: #fff;
        padding: 0 10px;
        margin-top: 5px;
    }
    .finishBtn[disabled]{
        cursor: no-drop;
        background: #ddd;
        border: 1px solid #ccc !important;
        color: #545454;
    }
    .over-ellipsis{
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap
    }
    .multi-line{
        display: inline-block;
        /*height: 120px;*/
        width: 100%;
        line-height: 20px;
        /*overflow: hidden;*/
        word-wrap:break-word;

    }
    .cardHeight{
        height:280px;
    }
    .cardInfo{
        height: 100%;
        width: 100%;
    }
    .textOverflow{
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }
    @media screen and (max-width: 1366px) {
        .paddingCard{
            padding-bottom: 0px;
        }
    }
    .showBtn{
        width:94px;
        border:none;
    }
    #pageBox .layui-laypage .layui-laypage-skip .layui-input,
    #pageBox .layui-laypage .layui-laypage-skip .layui-laypage-btn{
        color: black;
    }
    #pageBox .layui-laypage{
        margin-bottom: 0px;
    }
    #pageBox .layui-laypage .layui-laypage-prev, #pageBox .layui-laypage .layui-laypage-next{
        border: none;
        height: 30px;
        line-height: 25px;
        margin: 0px 2px;
    }
    .peoName{
        color: #333;
        text-decoration: none;
    }
    .peoName:hover {
        color: #777;
        text-decoration: none;
    }
    #manageBox li button {
        background: #fff !important;
        margin: 0;
        color: #000;
        height: 35px;
        width: 80px !important;
    }
    #manageBox{
        display: none;
    }
    .contractInfo{
        width: 100%;
    }
    .contractInfo .layui-table-view .layui-table th{
        border-bottom: none !important;
    }
    .width30{
        width: 17%;
        float: left;
    }
    .width60{
        width: 82%;
        float: left;
    }
    #projectProgress{
        display: none;
    }
    .task-timeline-info {
        position: relative;
        padding-top: 10px;
        min-width: 530px;
    }

    .task-timeline-info::after, .task-timeline-info .task-timeline-item .itemList::after,
    .task-timeline-info .task-timeline-item::after {
        content: "";
        height: 0;
        clear: both;
        overflow: hidden;
        display: block;
        visibility: hidden;
    }

    .task-timeline-info .task-timeline-item {
        /*overflow: hidden;*/
        padding-bottom: 15px;
    }

    .task-timeline-info .task-timeline-item .itemList {
        height: 85px;
        float: left;
        width: calc(100% - 96px);
        background-color: #F7F6F6;
        margin-left: 96px;
        position: relative;
        border-radius: 10px;
        text-align: center;
    }

    .task-timeline-info .task-timeline-item .itemList::before {
        content: '';
        position: absolute;
        left: -14px;
        top: 34px;
        width: 0;
        height: 0;
        border-left: 0;
        border-right: 14px solid #F7F6F6;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;

    }

    .task-timeline-info .task-timeline-item .task-timeline-time {
        float: left;
        width: 100px;
        clear: both;
        text-align: right;
        margin-top: 5px;
    }

    .task-timeline-info .task-timeline-item .task-timeline-time h1 {
        font-size: 16px;
        color: #55B7FF;
        line-height: 22px;
        margin: 0;
        padding: 0;
    }

    .task-timeline-info .task-timeline-item .task-timeline-time h5 {
        font-size: 14px;
        color: #949494;
        line-height: 20px;
    }

    .task-timeline-info .task-timeline-item .task-timeline-axis {
        float: left;
        width: 90px;
        margin-top: 5px;
        position: relative;
    }

    .task-timeline-info .task-timeline-item .task-timeline-axis .task-timeline-logo {
        position: absolute;
        top: 23px;
        width: 90px;
    }

    .task-timeline-info .task-timeline-item .task-timeline-axis h1 {
        font-size: 15px;
        line-height: 22px;
        margin: 9px 0 0 0;
        padding: 0;
        text-align: center;
    }

    .task-timeline-info .task-timeline-item .task-timeline-axis span {
        /* background-color: #7ED321; */
        display: block;
        width: 28px;
        height: 28px;
        border-radius: 28px;
        margin: 0 auto;
        text-align: center;
        line-height: 28px;
        color: #fff;
    }

    .task-timeline-info .task-timeline-item .task-timeline-axis img {
        margin: 0 auto;
        display: block;
    }

    .task-timeline-info .task-timeline-item .task-timeline-content {
        position: relative;
        margin: 0 auto;
        text-align: center;
        width: calc(25% - 65px);
    }
    .task-timeline-info .task-timeline-item .task-timeline-content-float{
        float: left;
        margin-left: 65px;
    }
    .task-timeline-info .task-timeline-item .task-timeline-content-float:nth-of-type(1){
        margin-left:35px;
    }
    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo {
        height: 22px;
        color: #fff;
        margin: 0 auto;
        width: 135px;
        margin-top: 5px;
        border-radius: 5px;
        position: relative;
    }

    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo .taskInfo-text {
        position: relative;
        cursor: pointer;
    }

    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo .taskInfo-Info {
        background-color: #fff;
        color: #999999;
        z-index: 1;
        position: absolute;
        width: 135px;
        border-radius: 5px;
        display: none;
        cursor: pointer;
    }

    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo .taskInfo-Info .taskInfo-Info-active {
        background-color: #55B7FF;
        color: #fff;
    }

    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo img {
        position: absolute;
        top: 5px;
        right: 2px;
    }

    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo1 {
        background-color: #9BE1B0;
    }

    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo2 {
        background-color: #55B7FF;
    }

    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo0 {
        background-color: #55B7FF;
    }
    .task-timeline-info .task-timeline-item .task-timeline-content .taskInfo3 {
        background-color: #C9C9C9;
    }
    .task-timeline-info .task-timeline-item .task-timeline-content .task-line {
        width: calc(100% + 40px);
        border: 1px dashed rgba(85, 183, 255, 1);
        position: absolute;
        top: 41px;
        left: 54%;
        border-bottom: none;
    }

    .task-staus {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin: 0 auto;
    }

    .task-staus1 {
        background-color: #9BE1B0;
    }

    .task-staus2 {
        background-color: #55B7FF;
    }

    .task-staus0 {
        background-color: #55B7FF;
    }
    .task-staus3 {
        background-color: #C9C9C9;
    }
    .task-timeline-info .task-timeline-item .task-timeline-content .task-timeline-header {
        margin-top: 5px;
        white-space: pre-line;
        min-width: 220px;
        min-height: 32px;
        line-height: 32px;
        font-size: 16px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* 0 - 灰色 */
    .task-timeline-info .task-timeline-item.task-timeline-status0 .task-timeline-axis span {
        background-color: #C9C9C9;
    }

    .task-timeline-info .task-timeline-item.task-timeline-status0 .task-timeline-content1::before {
        background-color: #D4D4D4;
    }

    /* 1 - 红色 */

    .task-timeline-info .task-timeline-item.task-timeline-status1 .task-timeline-axis span {
        background-color: #55B7FF;
    }
    /* 2 - 绿色 */

    .task-timeline-info .task-timeline-item.task-timeline-status2 .task-timeline-axis span {
        background-color: #55B7FF;
    }

    .task-timeline-info .task-timeline-item.task-timeline-status2 .task-timeline-content1::before {
        background-color: #7ED321;
    }

    .task-staus-style {
        display: inline-block;
        margin-left: 20px;
    }
    .task-container-l {
        height: 100%;
        padding: 0;
        transition: 0.3s all;
    }
    .task-container {
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }

    .task-container .layui-row {
        height: 100%;
    }
    .ztree-over .node_name{
        width: calc(100% - 45px);
        overflow: hidden;
        text-overflow:ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: bottom;

    }
    .milestone .layui-table-box table{
        width: 100%;
    }
    .milestone .box{
        position: relative;
        height: 160px;
        overflow: hidden;
    }
    .milestone .box img{
        position: absolute;
        left: 50%;
        top: 50%;
        height: 260px;
        margin-top: -140px;
        margin-left: -175px;
    }
    .deliverable-tree li a,.taskdeliverable-tree li a{
        color: #666;
    }
    .deliverable-tree>li,.taskdeliverable-tree>li{
         margin:  0 0 27px 10px;
     }
    .deliverable-tree>li:first-child,.taskdeliverable-tree>li:first-child{
        margin-top:  10px;
    }
    .deliverable-tree li ul li:first-child,.taskdeliverable-tree li ul li:first-child{
        margin: 18px 0 0 0px;
    }
    .deliverable-tree li ul li,.taskdeliverable-tree li ul li{
        margin:  27px 0 0 0px;
    }
    #deliverable-movetree>li,#taskdeliverable-movetree>li{
        margin:  0 0 17px 10px;
    }
    #deliverable-movetree li ul li,#taskdeliverable-movetree li ul li{
        margin:  17px 0 0 10px;
    }
    #deliverable-movetree li ul li:first-child,#taskdeliverable-movetree li ul li:first-child{
        margin: 10px 0 0 10px;
    }
    .deliverable-tree ul,.taskdeliverable-tree ul{
        margin-bottom: 0;
    }
    .deliverable-tree .layui-tree-branch,.taskdeliverable-tree .layui-tree-branch{
        display: none;
    }
    .deliverable-tree li .layui-tree-spread,.taskdeliverable-tree li .layui-tree-spread{
        display: none;
    }
    .deliverable-tree .layui-tree-leaf,.taskdeliverable-tree .layui-tree-leaf{
        display: none;
    }
    .uploadFile,.taskuploadFile {
        color: #fff;
        width: 80px ;
        height: 22px;
        cursor: pointer;
        background: #2099F1;
        border: 1px solid #2099F1;
        text-align: center;
        float: left;
        font-size: 13px;
        border-radius: 2px;
        font-weight: 400;
    }
    .disable{
        pointer-events: none;
    }
    .moveFile,.taskmoveFile{
        color: #333;
        height: 22px;
        width:60px ;
        cursor: pointer;
        border: 1px solid #ccc;
        text-align: center;
        float: left;
        font-size: 13px;
        margin-left: 10px;
        border-radius: 2px;
        font-weight: 400;
    }
    .layui-layer-iframe .layui-layer-title{
        font-size: 16px;
        font-weight: bold;
    }
    .deliverable-tree li a cite,.taskdeliverable-tree li a cite{
        font-size: 14px;
        color: #666;
        font-weight: 400;
        width: 140px;
        display: inline-block;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }
    #deliverable-movetree li a cite,#taskdeliverable-movetree li a cite{
        width: 215px;
    }
    #deliverable-tree,#taskdeliverable-tree{
        border:1px solid #F5F5F5;
        overflow-y: auto;
    }
    #deliverable .layui-card-body>img ,#taskdeliverable .layui-card-body>img{
        position: absolute;
        top: 45%;
        left: 20%
    }
    .deliverable-tree li ul{
        margin-left: 40px;
    }
    .proBudget label{
        font-weight: 400;
    }
    .project_change_form .project_title_info .project_title{
        margin: 0;
    }
    .taskprocessInstance{
        background: #e9e8e6;
    }
    @media screen and (max-width: 1366px) {
        .paddingCard {
            padding-bottom: 0px;
        }

        .task-timeline-info .task-timeline-item .task-timeline-content {
            width: calc(25% - 25px);
        }
        .task-timeline-info .task-timeline-item .task-timeline-content-float,
        .task-timeline-info .task-timeline-item .task-timeline-content-float:nth-of-type(1){
            margin-left: 25px;
        }

        .task-timeline-info .task-timeline-item .task-timeline-content .task-line {
            left: 54%;
            width: calc(100% + 9px);
        }
    }
    /*科研表单选择下拉框空隙太大问题*/
    #searchDate input{
        height:38px;
        line-height: 38px;
    }
    /*下拉框间隙太大问题修改*/
    .budgetMain .layui-form-selected dl{
        top:32px;
    }
    .budgetMain .layui-form-selectup dl{
        top: auto;
        margin-bottom: 0;
        bottom: 32px;
    }
    .projectInfo {
        width: 100%;
        display: flex;
        flex-flow: row;
        border-radius: 2px;
        justify-content: center;
        background-color: white;
        padding: 10px 5px 0px;
    }
    .projectInfo .projectInfoBox {
        height: 96px;
        display: flex;
        flex-flow: row;
        border:1px solid rgba(238,238,238,1);
        flex:3;
        background-color: white;
        justify-content: center;
        align-items: center;
        margin-right: 10px;
    }

    .projectInfoCycle {
        font-size: 20px;
        border-radius: 50%;
        width: 58px;
        height: 58px;
        border: 2px solid #16D0FF;
        color: #16D0FF;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        background: rgba(22, 208, 255, 0.1);
    }
    .projectInfoText {
        /*width: calc(100% - 75px);*/
        margin-left: 26px;
        height: 66px;
    }

    .infoNumber {
        color: #008FC3;
        font-size: 30px;
    }

    .infoCount {
        font-size: 12px;
        color: #858585;
    }
    .infoMessage {
        color: rgba(232,232,232,1);
        font-size: 30px;
        /*height: 30px;*/
    }
    #budgetLook{
        display: none;
    }
    /*.itemDeilve*/
</style>
<!-- zTree 样式 -->
<link rel="stylesheet" href="../../assetsInfo/libs/zTree/css/metroStyle/ebizStyle.css">
<link rel="stylesheet" href="../../assetsInfo/xm-select.js">

<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<!-- echarts以及甘特图 -->
<link rel="stylesheet" href="../../assetsInfo/libs/adcganttchart/jquery.fn.adcganttchart.css">
<!--表格样式-->
<link rel="stylesheet" href="../../assetsInfo/libs/chosen/chosen.min.css">
<script src="../../assetsInfo/libs/adcganttchart/jquery.fn.adcganttchart.js"></script>
<script src="../../assetsInfo/libs/echarts.js"></script>
<!-- 表单辅助方法，用于启动表单时的权限控制和数据获取与提交 -->
<script src="../../assetsInfo/js/ADCFormDesignHelper.js"></script>
<input type="hidden" name="">
<div class="layui-row layui-col-space30 " style="overflow: hidden;height: calc(100% + 30px)!important;">
    <div class="tree-block">

        <div id="top" style="margin-top: 14px;margin-left: 189px;cursor: pointer;display: none;    position: absolute;bottom: 5px; left: 0;z-index: 1000;">
            <img src="../../assetsInfo/images/vertical-align-top.png" alt="" title="回到顶部"  onclick="$('.ztree').scrollTop(0)">
        </div>

        <div class="grid-demo grid-demo-bg1" style="width: 240px">
            <div class="layui-card-body sor ztree-over" style="padding:0;">
                <div class="layui-tab layui-tab-brief " lay-filter="docDemoTabBrief" style="min-height: 100vh;background: #305475;">

                    <!--<ul class="layui-tab-title dofer" style="position: inherit!important;background: #00B1FF!important;">-->
                    <!--<li class="layui-this">全部</li>-->
                    <!--<li>仅看我的</li>-->
                    <!--<li>我的关注</li>-->
                    <!--</ul>-->
                    <div style="border-bottom: 1px solid #2a4b68;padding-bottom: 9px;position: fixed;top: 49px;width: 240px;background: #305475; z-index: 1001;" id="scrollPage">

                        <div class='top-choose' style='display:none'>
                            <div class='model-choose' >
                                <div class="child choose" id='primary-model'>
                                    普通模式
                                </div>
                                <div class="child " id='org-model'>
                                    机构模式
                                </div>
                            </div>
                            <div class='filter-area'>
                                <img src="../../assetsInfo/images/icon/filter.png" alt=""  id='filter-icon'>

                                <div  class="dropdown-menu" style="margin: 0!important;" id='filter-drop'>
                                    <ul role="menu" style="text-align: center;margin-bottom: 0!important;background: #fff" id='filter-list'>

                                        <li state="">
                                            全部

                                        </li>
                                        <li  state="0">
                                            进行中
                                        </li>
                                        <!-- <li  state="1">
                                               审批中
                                       </li> -->
                                        <li state="2">
                                            已完成
                                        </li>
                                    </ul>
                                </div>

                            </div>


                        </div>
                        <div>
                            <div style="float: left;width: 100%; padding: 2.5px 6px 2px 10px; position: relative" >
                                <input type="text" style="border:1px solid rgba(255,255,255,0.4);" class="searchInput input" placeholder="请输入关键字" id="key" onfocus="$(this).css('border','1px solid #f3f3f3')" onblur="$(this).css('border','1px solid rgba(255,255,255,0.4)')">
                                <img src="/assetsInfo/images/searchs.png" alt="" title="搜索" class="text" style="cursor: pointer">
                            </div>
                            <!--<div style="float: left;width: 10%;padding:7px 0 0 0 ;background: #00B1FF" >-->
                            <!--<i class="layui-icon layui-icon-search" style="font-size: 18px;cursor: pointer" id="keysearch" ></i>-->
                            <!--</div>-->

                            <div style="clear: both"></div>
                        </div>
                        <div style="float: left;width: 40%;text-align:center; margin-top:14px;" >
                            <div class="btn-group dofer">
                                <button type="button" class="btn btn-primary dropdown-toggle " id="tanchu"  style="    padding: 2px 8px;"><i class="layui-icon layui-icon-add-1"></i>新增
                                    <span class="caret"></span>
                                </button>
                                <ul id="manageBox" style="text-align: center;margin-bottom: 0!important;background: #fff;position: absolute;left: 80px;top: 32px;">
                                    <li>
                                        <button id="btn_manage" type="button" class="layui-btn layui-btn-sm layui-import" style='background-color: #fff!important;color:#000'>
                                            <a href="#!ADC_projectPool_projectPool_html" id="btn_Jump" style="color:black;text-decoration:none" title="经营类">经营类</a>
                                        </button>
                                    </li>
                                    <!--<li>-->
                                        <!--<button id="btn_noManage" type="button" class="layui-btn layui-btn-sm layui-import" style='background-color: #fff!important;color:#000'>-->
                                            <!--非经营类-->
                                        <!--</button>-->
                                    <!--</li>-->
                                    </button>
                                    </li>
                                    <li>
                                        <button id="btn_research" type="button" class="layui-btn layui-btn-sm layui-import" style='background-color: #fff!important;color:#000'>
                                            科研类
                                        </button>
                                    </li>
                                    <li>
                                        <button id="btn_admin" type="button" class="layui-btn layui-btn-sm layui-import" style='background-color: #fff!important;color:#000'>
                                            管理类
                                        </button>
                                    </li>
                                    <li>
                                        <button id="btn_special" type="button" class="layui-btn layui-btn-sm layui-import" style='background-color: #fff!important;color:#000'>
                                            专项类
                                        </button>
                                    </li>
                                </ul>
                                <div id='add-dropdown' class="dropdown-menu" style="margin: 0!important;">
                                    <div  style="width: 100%;position: absolute;top:-1px;">
                                        <div class="munePic" style="margin-left: 35px;width: 10px;height: 15px">
                                        </div>
                                    </div>
                                    <ul role="menu" style="text-align: center;margin-bottom: 0!important;background: #fff">
                                        <li>
                                            <button id="btn_addBuss" type="button" class="layui-btn layui-btn-sm layui-import">
                                                业务
                                            </button>
                                        </li>
                                        <li>
                                            <button id="btn_add" type="button" class="layui-btn layui-btn-sm layui-import">
                                                项目
                                            </button>
                                        </li>
                                        <li>
                                            <button id="btn_addTaks" type="button" class="layui-btn layui-btn-sm layui-import">任务
                                            </button>
                                        </li>
                                        <li>
                                            <button id="btn_addChildTask" type="button" class="layui-btn layui-btn-sm layui-import">下级任务
                                            </button>
                                        </li>
                                        <li>
                                            <!--<button id="btn_addNo" type="button" class="layui-btn layui-btn-sm layui-import" style="padding: 6px">-->
                                                <!--非项目工作-->
                                            <!--</button>-->
                                            <button id="btn_noManage" type="button" class="layui-btn layui-btn-sm layui-import" style="padding: 6px">
                                                日常事务类
                                            </button>
                                        </li>
                                    </ul>
                                </div>

                            </div>
                            <p class='org-top'>数据中心</p>
                        </div>

                        <div style="float: right;width: 50px" class="ownerBox">
                            <button id="closeAll" type="button" class="layui-btn layui-btn-sm layui-import disNone" style="margin: 0!important;">
                                关闭全部 <img src="../../assetsInfo/images/close.png" alt="" style="    padding: 4.5px 2px 6px 2px;">
                            </button>
                            <button id="expandAll" type="button" class="layui-btn layui-btn-sm layui-import disBlock">
                                展开全部 <img src="../../assetsInfo/images/open.png" alt="" style="    padding: 3.5px 2px 5px 2px;">
                            </button>
                        </div>
                        <div style="clear: both"></div>
                    </div>
                    <div id='tree-main' class="layui-tab-content " style="position: inherit!important;overflow-y: inherit;padding:0;">
                        <div class="layui-tab-item layui-show">
                            <ul id="select-org" class="ztree"  onscroll="gotop()"></ul>
                        </div>
                        <div class="layui-tab-item">
                            <p style="text-align: center">暂无数据</p>
                        </div>
                        <div class="layui-tab-item">
                            <p style="text-align: center">暂无数据</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="budgetMain" style="width: calc(100vw - 238px); float: right;background: #EEEEEE; padding: 0px 10px; overflow: auto;height: calc(100vh - 10px);">
        <div id="nodata" style="    background: #fff; width: 100%; height: 100%; text-align: center;">
            <div style="margin: 0 auto;padding-top: 20%">
                <img src="../../assetsInfo/images/back.png" alt="">
                <p style="color: #828282;font-size: 14px;">暂无其他内容</p>
            </div>

        </div>
        <div id="businessDetailDiv" class="RightContent" style="margin-top:25px">
            <div class="layui-row layui-col-space10">
                <div class="layui-col-md12" id="businessDetail">
                    <div class="layui-card card-padding" style="height: 100%;">
                        <div class="layui-card-header lc-header cart-title"><img src="../../assetsInfo/images/icon/business_1.png"/>&nbsp;&nbsp;业务详情
                        </div>
                        <div class="layui-card-body" id="detail">

                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="budgetInfo">
                <div class="layui-col-md12" id="budget">
                    <div class="layui-card layui-col-md12 card-padding">
                        <div class="layui-card-header lc-header cart-title"><img src="../../assetsInfo/images/icon/business_2.png"/>&nbsp;&nbsp;业务预算
                        </div>

                        <div class="layui-card-body layui-col-md12" style="text-align: center">
                            <div id="budgetChart" style="height: 210px; width: 100%;"></div>
                            <div style="width: 100%;overflow-x: auto;">
                                <table class="layui-table" style="width: 100%;">
                                    <thead>
                                    <tr>
                                        <th >预算/月份</th>
                                        <th >一月</th>
                                        <th >二月</th>
                                        <th >三月</th>
                                        <th >四月</th>
                                        <th >五月</th>
                                        <th >六月</th>
                                        <th >七月</th>
                                        <th >八月</th>
                                        <th >九月</th>
                                        <th >十月</th>
                                        <th >十一月</th>
                                        <th >十二月</th>
                                    </tr>
                                    </thead>
                                    <tbody id="budgetTbody">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10">
                <div class="layui-col-md12">
                    <div class="layui-card card-padding">
                        <div class="layui-card-header lc-header cart-title"><img src="../../assetsInfo/images/icon/business_3.png"/>&nbsp;&nbsp;统计信息
                        </div>
                        <div class="layui-card-body">
                            <div class="layui-col-md12 analysas-height" id="persons">

                            </div>
                            <div class="layui-form" id="budgetYear">
                                <div  class="layui-form-item " style="text-align: right;margin:0">
                                    <div class="layui-inline" style="width:80px;text-align: left">
                                        <select  name="budget_year" id='budget_year'   lay-filter="budget_year" ></select>
                                    </div>
                                </div>
                            </div>

                            <div class="layui-col-md12 analysas-height" style="margin-top:46px;" id="income">

                            </div>
                            <!--<div class="layui-col-md4 analysas-height" id="cost">-->

                            <!--</div>-->
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="projectList">
                <div class="layui-col-md12">
                    <div class="layui-card card-padding">
                        <div class="layui-card-header lc-header cart-title"><img src="../../assetsInfo/images/icon/business_4.png"/>&nbsp;&nbsp;项目列表
                            <div class="layui-card-header-right-btn">

                            </div>
                        </div>
                        <div class="layui-form" >
                            <div  class="layui-form-item " style="text-align: right;margin:0;margin-top: 4px;">
                                <!--<div class="layui-row" style="text-align: right">-->
                                <div class="layui-inline" style="text-align: left;margin-right:5px;width:170px;position: relative">
                                    <select  name="project_search" id='project_search'   lay-filter="project_search" >
                                        <option value="" id="emptySearch" selected>--查询条件--</option>
                                        <option value="1">项目名称</option>
                                        <option value="2">项目状态</option>
                                        <option value="3">项目负责人</option>
                                    </select>
                                </div>
                                <div class="layui-inline" style="margin-right:5px;position: relative;">
                                    <input  type="text" style="width:198px;height:30px;border:1px solid #e6e6e6; padding-left: 10px" placeholder="请输入" id="searchText">
                                    <img style="position:absolute;right:5px;top:4px;height:20px;width:20px" src="/assetsInfo/images/sousuo.png" id="searchBtn"  >
                                </div>
                                <!--<div id="searchInput" class="layui-inline" style="margin-right:-3px;position: absolute;right: 27px;top: 43px;">-->

                                <!--&lt;!&ndash;<button  type="button"  class="searchBtn layui-btn layui-btn-primary" >查询</button>&ndash;&gt;-->

                                <!--</div>-->
                                <!--</div>-->
                            </div>
                        </div>
                        <div class="layui-card-body" style="margin-top: 0">
                            <table class="layui-table">
                                <thead>
                                <tr>
                                    <!--style="width:628px;min-width: 628px-->
                                    <!--style="width:90px;min-width: 90px">-->
                                    <!--style="width:500px;min-width: 500px-->
                                    <!--style="width:100px;min-width: 100px-->
                                    <!--style="width:100px;min-width: 100px-->
                                    <!--style="width:167px;min-width: 167px-->
                                    <th >项目名称</th>
                                    <th style="min-width: 65px;">负责人</th>
                                    <th >项目组成员</th>
                                    <th style="width: 100px;">预计人力投入(人天)</th>
                                    <th style="min-width: 100px;">项目完成状态</th>
                                    <th style="min-width: 100px;">创建时间</th>
                                </tr>
                                </thead>
                                <tbody id="projectTbody">

                                </tbody>
                            </table>

                        </div>
                        <div id="pageBox" style="text-align: center">

                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="taskList">
                <div class="layui-col-md12 ">
                    <div class="layui-card card-padding" >
                        <div class="layui-card-header lc-header cart-title" style="overflow: visible"><img src="../../assetsInfo/images/icon/business_5.png"/>&nbsp;&nbsp;任务列表
                            <!--<div class="layui-inline" style="position: relative;height:30px;">-->
                            <!--<button  type="button"  style="height:24px;line-height: 20px;position: relative;top:-5px;" class="searchBtn layui-btn layui-btn-primary" id="showRange" >显示范围</button>-->
                            <!--<div  style="position: absolute;z-index: 99999;top:25px">-->
                            <!--<ul role="menu" style="text-align: center;margin-bottom: 0!important;background: #fff">-->
                            <!--<li>-->
                            <!--<button id="btn_showAll" type="button" class="layui-btn layui-btn-sm layui-import showBtn" >-->
                            <!--全部显示-->
                            <!--</button>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<button id="btn_ing" type="button" class="layui-btn layui-btn-sm layui-import showBtn">-->
                            <!--进行中-->
                            <!--</button>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<button id="btn_noStart" type="button" class="layui-btn layui-btn-sm layui-import showBtn">-->
                            <!--未开始-->
                            <!--</button>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<button id="btn_done" type="button" class="layui-btn layui-btn-sm layui-import showBtn">-->
                            <!--已完成-->
                            <!--</button>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<button id="btn_delay" type="button" class="layui-btn layui-btn-sm layui-import showBtn">-->
                            <!--已延期-->
                            <!--</button>-->
                            <!--</li>-->
                            <!--</ul>-->
                            <!--</div>-->
                            <!--</div>-->
                            <div class="layui-card-header-right-btn">
                            </div>
                        </div>
                        <div class="layui-card-body " id="GantChart" style=" padding: 10px 15px; margin-right: 0px;width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="projectDetailDiv" class="RightContent" style="margin-top:20px">
            <div class="layui-row layui-col-space10">
                <!--<div class="layui-col-xs6">-->
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-md12" id="projectDetail">
                        <div class="layui-card card-padding cardInfo" >
                            <div class="layui-card-header lc-header cart-title"><img src="../../assetsInfo/images/icon/project_1.png"/>&nbsp;&nbsp;项目信息
                                <button class="finishBtn"  style="display:none;" id="goBack">返回</button>
                                <button class="finishBtn"style="margin-right: 15px;" id="finishPro">结项</button>
                            </div>
                            <div class="layui-card-body"  id="projectDetailInfo">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="budgetLook">
                <div class="layui-col-md12">
                    <div class="layui-card card-padding">
                        <div class="layui-card-header lc-header cart-title"><img
                                src="../../assetsInfo/images/icon/shouzhimingxi.png"/>&nbsp;&nbsp;收支一览

                        </div>
                        <div class="projectInfo">
                            <div class="projectInfoBox">
                                <div style="display: inline-block;height: 60px">
                                    <div class="projectInfoCycle">票</div>
                                </div>
                                <div class="projectInfoText">
                                    <div class="infoNumber" id="sumProject"></div>
                                    <div class="infoCount">项目已开票额（万元）</div>
                                </div>
                            </div>
                            <div class="projectInfoBox">
                                <div style="display: inline-block;height: 60px">
                                    <div class="projectInfoCycle">收</div>
                                </div>
                                <div class="projectInfoText">
                                    <div class="infoMessage" >数据整理中</div>
                                    <div class="infoCount">项目已进账额（万元）</div>
                                </div>
                            </div>
                            <div class="projectInfoBox" style="margin-right: 0">
                                <div style="display: inline-block;height: 60px">
                                    <div class="projectInfoCycle">支</div>
                                </div>
                                <div class="projectInfoText">
                                    <div class="infoMessage" >数据整理中</div>
                                    <div class="infoCount">项目已支出额（万元）</div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-card-body" style=" overflow: inherit">
                            <div id="contractInfo" lay-filter="contractInfo"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="projectProgress">
                <div class="layui-col-md12">
                    <div class="layui-card card-padding" style="height:700px;">
                        <div class="layui-card-header lc-header cart-title"><img
                                src="../../assetsInfo/images/icon/business_4.png"/>&nbsp;&nbsp;项目进度一览
                            <div style="float: right">
                                <div class="task-staus task-staus2 task-staus-style"></div>
                                进行中
                                <div class="task-staus task-staus1 task-staus-style"></div>
                                已完成
                                <div class="task-staus task-staus3 task-staus-style"></div>
                                未完成
                            </div>
                        </div>
                        <div class="layui-card-body" style=" overflow: inherit">
                            <div class="" id="task-timeline-info">
                                <ul class="task-timeline-info">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="workProgress">
                <div class="layui-col-md12">
                    <div class="layui-card card-padding">
                        <div class="layui-card-header lc-header cart-title"><img
                                src="../../assetsInfo/images/icon/business_4.png"/>&nbsp;&nbsp;工作进度安排

                        </div>
                        <div class="layui-card-body" style=" overflow: inherit">
                            <div id="workProgressTable" lay-filter="workProgressTable"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="researchBox">
                <div class="layui-col-md12">
                    <div class="layui-card card-padding">
                        <div class="layui-card-header lc-header cart-title"><img src="../../assetsInfo/images/icon/business_3.png"/>&nbsp;&nbsp;统计信息
                        </div>
                        <div class="layui-card-body">
                            <div class="layui-form" id="researchYear">
                                <div  class="layui-form-item " style="text-align: right;margin:0">
                                    <div class="layui-inline" style="width:80px;text-align: left">
                                        <select  name="research_year" id='research_year'   lay-filter="research_year" >
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md12 analysas-height" style="height: 300px !important;" id="research-persons">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="milestone">
                <div class="layui-col-md12">
                    <div class="layui-card card-padding">
                        <div class="layui-card-header lc-header cart-title">
                            <img src="../../assetsInfo/images/icon/dizhi.png"/>&nbsp;&nbsp;项目实施阶段里程碑
                            <span style="margin-left: 20px;font-size: 12px">筛选</span>
                            <select id="statusChange" style="height: 20px; font-size: 12px">
                                <option value="全部" selected="selected">全部</option>
                                <option>未开始</option>
                                <option>未完成</option>
                                <option>未完成（已有风险）</option>
                                <option>已完成</option>
                            </select>
                        </div>
                        <div class="layui-card-body milestone">
                            <table id="milestone-form" lay-filter="milestone-form"></table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="noBusiness">
                <div class="layui-col-md12 paddingCard">
                    <div class="layui-card layui-col-md12 card-padding">
                        <div class="layui-card-header lc-header cart-title">
                            <img src="../../assetsInfo/images/icon/project_7.png"/>
                            &nbsp;&nbsp;项目交付物
                            <div class="layui-card-header-right-btn layui-pull-right" id='upload-project-file' title='上传文件'>
                                <i class="layui-icon layui-icon-upload-drag" style="font-size:20px"></i>
                            </div>
                        </div>
                        <div class="layui-card-header-right-btn">
                        </div>
                        <div class="cardHeight" >
                            <div class="infoNotic" style="text-align: center">
                                <img src="../assetsInfo/images/back.png" alt="">
                                <div style="color: #ccc">暂无数据</div>
                            </div>
                            <ul class="itemDeilvery"  p-each='fileList'>
                                <li >
                                    <p style="float:left;">
                                        <img p-bind="src:{{icon}}" alt="">
                                    </p>
                                    <p class="centerSpan" style='width:50%' p-bind='title:{{fileName}}'>{{fileName}}</p>
                                    <p style='overflow: hidden;margin-right: 20px;width:10%' >{{size}}</p>
                                    <p style='overflow: hidden;width:10%'>{{uploader}}</p>
                                    <p style="float:right"><span>{{date}} &nbsp</span>
                                        <span  style='display:inline-block' p-bind="fileId:{{fileId}} ^ fileName:{{fileName}}" class='delProFile'><i class="layui-icon layui-icon-delete"></i>   </span>
                                        <a  p-bind="href:{{href}}"><i class="layui-icon layui-icon-download-circle"></i>   </a>
                                    </p>

                                </li>

                            </ul>
                            <div id="taskfile-page"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="deliverable">
                <div class="layui-col-md12 paddingCard">
                    <div class="layui-card layui-col-md12 card-padding">
                        <div class="layui-card-header lc-header cart-title">
                            <img src="../../assetsInfo/images/icon/jiaofu.png"/>
                            &nbsp;&nbsp;项目交付物
                            <!--<div class="layui-card-header-right-btn layui-pull-right" id='upload-project-file' title='上传文件'>
                                <i class="layui-icon layui-icon-upload-drag" style="font-size:20px"></i>
                            </div>-->
                        </div>
                        <div class="layui-card-body">
                            <div id="deliverable-tree" class="deliverable-tree" style="float:left;width: 19%; height:407px; padding-top: 10px"></div>
                            <img src="../../assetsInfo/images/icon/right.png" alt="" class="right">
                            <div id="deliverable-box" style="float:right;width: 78%;">
                                <div style="overflow: hidden">
                                    <input type="file" id="file" multiple="multiple" style="display:none">
                                    <div class="uploadFile">
                                        <img style="margin-top: -5px;" src="../../assetsInfo/images/icon/shangchuan.png" alt="">上传文件</div>
                                    <div class="moveFile" >
                                        <img style="margin-top: -5px;" src="../../assetsInfo/images/icon/yidong.png" alt="">移动</div>
                                </div>
                                <table id="deliverable-form" lay-filter="deliverable-form"></table>
                                <!--<div class="box" style="width: 100%; height: 386px; text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: 386px"></div>-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="taskDetailDiv" class="RightContent" style="margin-top:20px">
            <div class="layui-row">
                <!-- 任务 -->
                <div class="layui-row row-margin layui-col-space15">
                    <div class="layui-col-md12">
                        <div class="layui-card card-padding" style="height: 100%;">
                            <div class="layui-card-header lc-header">
                                <img src="../../assetsInfo/images/icon/business_1.png" style="margin-top:-3px"/>
                                <span style="font-weight: 500;font-size: 16px;">&nbsp;&nbsp;任务基本信息</span>
                                <button class="finishBtn" id="finishTask">完成</button>
                            </div>
                            <div class="layui-card-body" id="taskDetail"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row row-margin ">
                <div class="layui-col-md12 ">
                    <div class="layui-card card-padding">
                        <div class="layui-card-header lc-header">
                            <img src="../../assetsInfo/images/icon/business_5.png " style="margin-top: -3px"/>&nbsp;&nbsp;任务进度
                            <div class="layui-card-header-right-btn">
                            </div>
                        </div>
                        <div id="taskGantChart">
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space10" id="tasknoBusiness">
                <div class="layui-col-md12 paddingCard">
                    <div class="layui-card layui-col-md12 card-padding">
                        <div class="layui-card-header lc-header cart-title">
                            <img src="../../assetsInfo/images/icon/project_7.png"/>
                            &nbsp;&nbsp;任务交付物
                            <div class="layui-card-header-right-btn layui-pull-right" id='taskupload-project-file' title='上传文件'>
                                <i class="layui-icon layui-icon-upload-drag" style="font-size:20px"></i>
                            </div>
                        </div>
                        <div class="layui-card-header-right-btn"></div>
                        <div class="cardHeight" >
                            <div class="taskinfoNotic" style="text-align: center">
                                <img src="../assetsInfo/images/back.png" alt="">
                                <div style="color: #ccc">暂无数据</div>
                            </div>
                            <ul class="itemDeilvery" p-each='fileList'>
                                <li >
                                    <p style="float:left;"><img p-bind="src:{{icon}}" alt=""></p>
<!--                                    <p style='width:25%;float:left;' p-bind='title:{{resultName}}'><span style="display: inline-block;width: 70%" class="textOverflow">{{resultName}}</span></p>-->
                                    <p class="centerSpan" style='width:50%;float:left;' p-bind='title:{{fileName}}'><span style="display: inline-block;width: 70%" class="textOverflow">{{fileName}}</span></p>
                                    <p style='overflow: hidden;margin-right: 20px;width:10%' >{{size}}</p>
                                    <p style='overflow: hidden;width:10%'>{{uploader}}</p>
                                    <p style="float:right"><span>{{date}} &nbsp</span>
                                        <span  style='display:inline-block' p-bind="fileId:{{fileId}} ^ fileName:{{fileName}}" class='delProFile'><i class="layui-icon layui-icon-delete"></i>   </span>
                                        <a  p-bind="href:{{href}}"><i class="layui-icon layui-icon-download-circle"></i>   </a>
                                    </p>
                                </li>
                            </ul>
                            <div id="file-page"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!--<div class="layui-row layui-col-space10" id="taskdeliverable">
                <div class="layui-col-md12 paddingCard">
                    <div class="layui-card layui-col-md12 card-padding">
                        <div class="layui-card-header lc-header cart-title">
                            <img src="../../assetsInfo/images/icon/jiaofu.png"/>
                            &nbsp;&nbsp;项目交付物
                            &lt;!&ndash;<div class="layui-card-header-right-btn layui-pull-right" id='upload-project-file' title='上传文件'>
                                <i class="layui-icon layui-icon-upload-drag" style="font-size:20px"></i>
                            </div>&ndash;&gt;
                        </div>
                        <div class="layui-card-body">
                            <div id="taskdeliverable-tree" class="taskdeliverable-tree" style="float:left;width: 19%; height:407px; padding-top: 10px"></div>
                            <img src="../../assetsInfo/images/icon/right.png" alt="" class="right">
                            <div id="taskdeliverable-box" style="float:right;width: 78%;">
                                <div style="overflow: hidden">
                                    <input type="file" id="taskFile" multiple="multiple" style="display:none">
                                    <div class="taskuploadFile">
                                        <img style="margin-bottom: 3px;" src="../../assetsInfo/images/icon/shangchuan.png" alt="">上传文件</div>
                                    <div class="taskmoveFile" >
                                        <img style="margin-bottom: 3px;" src="../../assetsInfo/images/icon/yidong.png" alt="">移动</div>
                                </div>
                                <table id="taskdeliverable-form" lay-filter="taskdeliverable-form"></table>
                                &lt;!&ndash;<div class="box" style="width: 100%; height: 386px; text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: 386px"></div>&ndash;&gt;
                            </div>
                        </div>
                    </div>
                </div>
            </div>-->
        </div>
        <div id="taskDetailDivChild" class="RightContent" style="margin-top:20px">
            <!-- 子任务 -->
            <div class="layui-row">
                <div class="layui-row row-margin layui-col-space15">
                    <div class="layui-col-md12">
                        <div class="layui-card card-padding" style="height: 100%;">
                            <div class="layui-card-header lc-header">
                                <img src="../../assetsInfo/images/icon/business_1.png" style="margin-top:-3px"/>
                                <span style="font-weight: 500;font-size: 16px;">&nbsp;&nbsp;任务基本信息</span>

                                <button class="finishBtn" id="finishTaskChild">完成</button>
                            </div>
                            <div class="layui-card-body" id="childTask"></div>
                        </div>

                        <div class="layui-card layui-col-md12 card-padding">
                            <div class="layui-card-header lc-header cart-title">
                                <img src="../../assetsInfo/images/icon/project_7.png"/>
                                &nbsp;&nbsp;任务交付物
                                <div class="layui-card-header-right-btn layui-pull-right" id='taskChild-upload-project-file' title='上传文件'>
                                    <i class="layui-icon layui-icon-upload-drag" style="font-size:20px"></i>
                                </div>
                            </div>
                            <div class="layui-card-header-right-btn"></div>
                            <div class="cardHeight" >
                                <div class="taskinfoNotic" style="text-align: center">
                                    <img src="../assetsInfo/images/back.png" alt="">
                                    <div style="color: #ccc">暂无数据</div>
                                </div>
                                <ul class="itemDeilvery" p-each='fileList'>
                                    <li >
                                        <p style="float:left;"><img p-bind="src:{{icon}}" alt=""></p>
                                        <p class="centerSpan" style='width:50%;float:left;' p-bind='title:{{fileName}}'><span style="display: inline-block;width: 70%" class="textOverflow">{{fileName}}</span></p>
                                        <p style='overflow: hidden;margin-right: 20px;width:10%' >{{size}}</p>
                                        <p style='overflow: hidden;width:10%'>{{uploader}}</p>
                                        <p style="float:right"><span>{{date}} &nbsp</span>
                                            <span  style='display:inline-block' p-bind="fileId:{{fileId}} ^ fileName:{{fileName}}" class='delProFile'><i class="layui-icon layui-icon-delete"></i>   </span>
                                            <a  p-bind="href:{{href}}"><i class="layui-icon layui-icon-download-circle"></i>   </a>
                                        </p>
                                    </li>
                                </ul>
                                <div id="taskChild-file-page"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 表格操作列 -->
<script type="text/html" id="control-1">
    <a class="table-control-btn" lay-event="track">保存</a>
</script>

<!-- 里程碑表格操作列 -->
<script type="text/html" id="control-2">
    <a class="table-control-btn" lay-event="view" style="color: #55B7FF;"><img src="../../assetsInfo/images/icon/chakan.png"/> 查看</a>
</script>
<script type="text/html" id="control-3">
    <a class="table-control-btn" lay-event="download" style="color: #55B7FF;"><img style="margin-top: -5px;" src="../../assetsInfo/images/icon/xiazai.png"/> 下载</a>
    <a class="table-control-btn" lay-event="delete" style="color: #55B7FF;"><img style="margin-top: -5px;" src="../../assetsInfo/images/icon/shanc0hu.png"/> 删除</a>
</script>

<!-- zTree js 文件 -->
<script src="../../assetsInfo/libs/zTree/js/jquery.ztree.all.min.js"></script>
<script src="assetsInfo/libs/chosen/chosen.jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="../../assetsInfo/libs/exhide.js"></script>
<script src="../../assetsInfo/libs/fuzzy.js"></script>
<script type="text/html" id="propertyId">
    <input type="hidden" value={{d.propertyId}}>
    <!--<a class="table-control-btn inuse" lay-event="enable">持续</a>-->
    <!--<a class="table-control-btn unuse" lay-event="disable">新增</a>-->
    <select name="vehicleRepair" class="propertyId_select" lay-filter="propertyId_select" lay-ignore="">
        <option value="">-- 请选择 --</option>
        <option value="cx">持续</option>
        <option value="xz">新增</option>
    </select>
</script>
<script type="text/html" id="workProgressTool">
    {{# if(d.extInfo2!='-1') { }}
    <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btn-work-look">查看</button>
    {{# } else{ }}
    <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btn-work-edit">检查</button>
    {{#  } }}
</script>
<script type="text/html" id="deptId">
    <!--<select name="orgId" xm-select="orgId" xm-select-skin="normal" xm-select-radio="">-->
    <select name="deptId" xm-select="deptId" xm-select-skin="normal" xm-select-radio="" id="orgId" lay-filter="orgId">
        <option value="">选择机构名</option>
    </select>
</script>
<script type="text/html" id="barDel">
    <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</button>
</script>
<script type="text/html" id="vehicleStatus">
    {{d.status.display}}
</script>

<script>
    function gotop(){
        if($('.ztree').scrollTop()>200){
            $('#top').show()
        }else {
            $('#top').hide()
        }
    }

    // 初始化 layui
    layui.use(['table', 'formSelects', 'laydate', 'tools','upload','laypage','tree','util'], function () {
        $('.layui-col-md9').css("width",'calc(100vw - 310px)');
        var table = layui.table,
            form = layui.form,
            upload=layui.upload,
            laydate=layui.laydate,
            config = layui.config,
            formSelects = layui.formSelects,
            tools = layui.tools,
            admin = layui.admin,
            tree = layui.tree,
            util = layui.util,
            laypage = layui.laypage,
            exts='pdf|doc|docx|xlsx|xls|zip|rar|jpg|jpeg|png|gif|ppt',
            extsImage={
                pdf:"wenjian",
                doc:'wenjian',
                docx:'wenjian',
                xlsx:'wenjian',
                xls:'wenjian',
                zip:'wenjian',
                rar:'wenjian',
                jpg:'shouhui',
                jpeg:'shouhui',
                jped:'shouhui',
                png:'shouhui',
                gif:'shouhui',
                ppt:'ppt'
            },
            fileUpload=null,
            taskfileUpload=null,
            taskChild_fileUpload=null,
            vmData={fileList:[]},
            filterType='',//新增查询条件 （空：全部  0：进行中 1：审批中 2：已完成）
            modelType=0,//模式
            orgPermission=false,
            projectId='',
            projectRsChange=true,
            projectIsChange=true;
            contactAddress = config.getAccount().contactAddress;
        form.render();
        //判断是否点击左侧菜单树，存在点击
        var curTreeNode;
        var downSize = 6;
        var conNum,width30,width60,width503='',width504='';
        //判断窗口分辨率
        $(document).ready(function() {
            if(screen.width==1920){
                conNum=35;
                width30='17%';
                width60='82%';
                width503=503;
                width504=504;
            }if(screen.width<=1366){
                conNum=20;
                width30='26%';
                width60='73%';
            }
        });

        // 初始化组织机构列表
        var url = "/api/budget/budget/tree";
        var BudgetId = '';
        var vm=$('.RightContent').vm(vmData);

        //console.log(config.getAccount())
        //校验权限（角色为主任或者市场发展部员工可查看机构模式）

        for(var item of config.getAccount().orgs) {
            if(item.name=='市场发展部') {
                orgPermission=true;
                // $('#btn_addBuss').show();
                break;
            }
        }
        if(orgPermission==false) {
            for(var item of config.getAccount().roles) {
                if (item.name == '超级管理员') {
                    orgPermission = true;
                    // $('#btn_addBuss').show();
                    break;
                }
                if(item.name=='主任') {
                    orgPermission=true;
                    break
                }
            }
        }

        if(orgPermission) {
            $('.top-choose').show();
            $('#tree-main').css('padding-top','117px');
        } else {
            $('.top-choose').hide();
            $('#tree-main').css('padding-top','97px');
        }

        var idDelArr=[];
        var tableContractInit=function (data,id,edit) {
            for (var i = 0; i <data.projectContractInvoiceEOList.length ; i++) {
                data.projectContractInvoiceEOList[i].invoiceDate=data.projectContractInvoiceEOList[i].invoiceDate?tools.getDate(data.projectContractInvoiceEOList[i].invoiceDate,"YYYY-MM-DD"):'';
                data.projectContractInvoiceEOList[i].recieveMoneyDate=data.projectContractInvoiceEOList[i].recieveMoneyDate?tools.getDate(data.projectContractInvoiceEOList[i].recieveMoneyDate,"YYYY-MM-DD"):'';
            }
            var col=[{
                title: '开票次数',
                type: 'numbers',
                fixed:'left',
                align: 'center',
                width:100,
            },{
                title: '开票时间',
                field: 'invoiceDate',
                align: 'center',
                event:'date',
                edit:edit,
                width:id=='#contractTableEdit'?'':width503
            }, {
                title: '开票金额（元）',
                field: 'invoiceAmount',
                align: 'center',
                edit:edit,
                width:id=='#contractTableEdit'?'':width503
            }, {
                title: '收款时间',
                field: 'recieveMoneyDate',
                align: 'center',
                event:'date',
                edit:edit,
                width:id=='#contractTableEdit'?'':width504
            }];
            var width;
            if(id=='#contractTableEdit'){
                width=750;
                col.push({
                    title: '操作',
                    align: 'center',
                    toolbar:'#barDel',
                    width: 163
                });
            }else{
                width=false;
            }

            table.render({
                elem: id,
                // url: admin.formatUrl('/api/business/tableReport/getBusinessStatus?thisYear='+thisYear+'&startMonth=1&endMonth=12'), //数据接口
                method: 'GET',
                data:data.projectContractInvoiceEOList,
                width:width,
                cols: [
                    col
                ],
                page: false,
            });
            table.on('tool(contractTableEdit)', function (obj) {
                var data = obj.data;
                var newdata = {};
                if (obj.event === 'date') {
                    var field = $(this).data('field');
                    if (field === 'invoiceDate') {
                        if(data.length > 12){
                            return layer.msg('项目信息审批人为空，不能关闭，请联系管理员！', {
                                icon: 5});
                            data = '' ;
                        }
                    }

                    laydate.render({
                        elem: this.firstChild
                        , show: true //直接显示
                        , closeStop: this
                        , done: function (value, date) {
                            newdata[field] = value;
                            obj.update(newdata);
                        }
                    });
                }else if(obj.event==='del'){
                    var indexs=obj.tr[0].rowIndex;
                    if(obj.data.id){
                        admin.req('/api/processform/projectContractInvoice/'+obj.data.id,'', function (res) {
                            if (res.ok) {
                                layer.confirm('真的删除行么', function(index){
                                    idDelArr.push({
                                        id:obj.data.id,
                                        delflag:'0'
                                    });
                                    tableReload(indexs);
                                    layer.close(index);
                                    $('#btn-pro-cancel').off('click').on('click', function () {
                                        admin.req('/api/processform/projectContractInvoice/updateAndInsertList', idDelArr, function (res) {
                                            if (res.ok) {
                                                idDelArr=[];
                                                admin.closePopupCenter();
                                            } else {
                                                layer.msg(res.message, {
                                                    icon: 1
                                                });
                                            }
                                        }, {
                                            method: 'put'
                                        });
                                    });
                                    //向服务端发送删除指令
                                });
                            } else {
                                layer.msg('删除失败！', {
                                    icon: 1
                                });
                            }
                        }, {
                            method: 'delete'
                        });
                    }else{
                        tableReload(indexs);
                    }

                }
            });
        };
        function tableReload(index) {
            var  cbList = table.cache.contractTableEdit;
            var col=[{
                title: '开票次数',
                type: 'numbers',
                fixed:'left',
                align: 'center',
                width:100,
            },{
                title: '开票时间',
                field: 'invoiceDate',
                align: 'center',
                event:'date',
                edit:'text'
            }, {
                title: '开票金额',
                field: 'invoiceAmount',
                align: 'center',
                edit:'text'
            }, {
                title: '收款时间',
                field: 'recieveMoneyDate',
                align: 'center',
                event:'date',
                edit:'text',
            }];

            cbList.splice(index, 1);
            if (cbList.length > 0) {
                col.push({
                    title: '操作',
                    align: 'center',
                    toolbar: '#barDel',
                    width: 163
                })
            }
            table.reload("contractTableEdit", {
                data: cbList,
                cols: [col]
            });
        }
        //项目进度一览
        var getProgress = function (id,research,infoData) {
            var isClick = false;
            if(infoData.projectMemberIds&&infoData.projectMemberIds.length!=0){
                for(var i =0;i<infoData.projectMemberIds.length;i++){
                    var curInfo = infoData.projectMemberIds[i];
                    if(curInfo==config.getAccount().usid){
                        isClick = true;
                    }
                }
            }else{
                isClick = false;
            }
            for(var j =0;j<config.getAccount().rolesstr.length;j++){
                if(config.getAccount().rolesstr[j]=='ZVXUGCP56D'){
                    isClick = true;
                }
            }
            admin.req("/api/progress/detail/list?projectId="+id, {}, function(res) {
                if (res.ok) {
                    var html = '';
                    var data=res.data;
                    for (var i = 0; i < data.length; i++) {
                        var res = data[i];
                        var cont = '',arr=['未启动','已完成','进行中'],arrList=['进行中','已完成','进行中'];
                        var textClass='task-timeline-content task-timeline-content-float';
                        var liWidth='',line='';
                        var listLength=res.progressDetailEOList.length;
                        var lineall='<div class="task-line"></div>';
                        if(listLength==1){
                            textClass='task-timeline-content';
                        }
                        //处理1366兼容
                        $(document).ready(function() {
                            if(screen.width==1920){
                                if(listLength==3) {
                                    liWidth = 'calc(50% - 65px)';
                                    line = '<div class="task-line" style="left:52%;width: calc(100% - 152px);"></div><div class="task-line" style="left:-30%;width: calc(100% - 152px);"></div>';
                                }else if(listLength==2){
                                    lineall='<div class="task-line" style="left:54%;width: 354%"></div>';
                                }
                            }if(screen.width<=1366) {
                                if(listLength==3) {
                                    liWidth = 'calc(50% - 25px)';
                                    line = '<div class="task-line" style="left:52%;width: calc(100% - 114px);"></div><div class="task-line" style="left:-27%;width: calc(100% - 114px);"></div>';
                                }else if(listLength==2){
                                    lineall='<div class="task-line" style="left:54%;width: 327%"></div>';
                                }
                            }
                        });
                        var conStaus;

                        for (var j = 0; j < listLength; j++) {
                            var contRes = res.progressDetailEOList[j];
                            var projectInfo0 = contRes.processInstance;
                            conStaus=(projectInfo0.length==0?'3':(projectInfo0[projectInfo0.length-1].processStatus));
                            if(contRes.processDefinitionKey==-101||contRes.processDefinitionKey==-100){
                                conStaus=1;
                            }
                            if((contRes.processDefinitionKey=='p1f7644df2b8f4eeebe8d75a28bf9d76e')&&conStaus==0){
                                projectIsChange=false;
                            }else if((contRes.processDefinitionKey=='p1f7644df2b8f4eeebe8d75a28bf9d76e')&&(conStaus==1||conStaus==3)){
                                projectIsChange=true;
                            }
                            if((contRes.processDefinitionKey=='pa0001fb0970341808dd0869ab05c8a3c')&&conStaus==0){
                                projectRsChange=false;
                            }else if((contRes.processDefinitionKey=='pa0001fb0970341808dd0869ab05c8a3c')&&(conStaus==1||conStaus==3)){
                                projectRsChange=true;
                            }
                            var projectCont='';
                            for (var k = 0; k <contRes.processInstance.length ; k++) {
                                var projectInfo = contRes.processInstance[k];
                                projectCont+='<div data-processName="'+contRes.processName+'"  data-processInstanceId="'+projectInfo.processInstanceId+'' +
                                    '" class=" taskprocessInstance '+(k==contRes.processInstance.length-1?'taskInfo-Info-active':'')+'">'+((tools.getDate(projectInfo.processTime, "YYYY-MM-DD"))
                                    +arrList[projectInfo.processStatus])+'</div>';
                            }
                            if(listLength==3&&j==0){
                                lineall='';
                            }
                            if(listLength==2&&j==1){
                                cont+='<li class="'+textClass+'" style="height:70px"></li><li class="'+textClass+'" style="height:70px"></li>'
                            }
                            cont += '<li class="'+textClass+'" style="width:'+(res.progressDetailEOList.length==3&&j==1?liWidth:'')+'">' +
                                '<div class="task-timeline-header" title="'+contRes.processName+'">'+contRes.processName+'</div>' +
                                '<div class="task-staus task-staus'+conStaus+'"></div>' +
                                (j!=listLength-1?(listLength==3&&j==1?line:lineall):'') +
                                '<div  class="taskInfo taskInfo'+conStaus+'">' +
                                '<div data-status="'+(contRes.processInstance.length==0?'0':'1')+'" data-processLimit="'+contRes.processLimit+'" data-processDefinitionKey="'+contRes.
                                    processDefinitionKey+'" class="taskInfo-text">'
                                +(projectInfo0.length==0?(contRes.processDefinitionKey==-101||contRes.processDefinitionKey==-100)?"已完成":arr[0]:(tools.getDate(projectInfo0[projectInfo0.length-1].processTime, "YYYY-MM-DD"))+arrList[projectInfo0[projectInfo0.length-1].processStatus])
                                +((conStaus==3||contRes.processDefinitionKey==-101||contRes.processDefinitionKey==-100)?'':'<img src="../../assetsInfo/images/xia.png">') +'</div>'+
                                '<div class="taskInfo-Info">' +
                                projectCont+
                                '</div>' +
                                '</div>' +
                                '</li>';
                        }
                        if(research&&i==0){
                            res.stageStatus=1;
                        }
                        html += '<li class="task-timeline-item task-timeline-status' + res.stageStatus + '">' +
                            '<div class="task-timeline-axis">' +
                            '<div class="task-timeline-logo">' +
                            '<span>' + (i+1) + '</span>' +
                            '<h1>'+res.stageName+'</h1>'+
                            (i==data.length-1?'':('<img src="../../assetsInfo/images/jiantou'+res.stageStatus+'.png" >'))+
                            '</div>' +
                            '</div>' +
                            '<ul class="itemList">' +
                            cont+
                            '</ul>'+
                            '</li>';

                    }
                    $('.task-timeline-info').empty().append(html);
                    $('.taskInfo').off('click').on('click','.taskInfo-text',function () {
                        var processDefinitionKey=$(this).data('processdefinitionkey');
                        var processLimit=$(this).data('processlimit');
                        if(isClick||processDefinitionKey=='-100'||processDefinitionKey=='-101'||processDefinitionKey=='-102'||processDefinitionKey=='-103'){
                            if((processDefinitionKey=='p1f7644df2b8f4eeebe8d75a28bf9d76e'
                                    )&&!projectIsChange){
                                return layer.msg('项目变更表已启动，请先完成流程', {
                                    icon: 5
                                });
                            }
                            if((processDefinitionKey=='pa0001fb0970341808dd0869ab05c8a3c')&&!projectRsChange){
                                return layer.msg('该表单已启动，请先完成流程', {
                                    icon: 5
                                });
                            }
                            if(processDefinitionKey=='-100'){
                                admin.popupCenter({
                                    id: 'ADCFormDesignHelper-startProcess',
                                    maxmin: false,
                                    title: '查看项目',
                                    path: 'components/researchForm/mainForm.html',
                                    area: ['100%', '100%'],
                                    // btn: ['启动', '取消'],
                                    btnAlign: 'c',
                                    resize: false,
                                    finish: function () {

                                    },
                                    success: function () {
                                        $('#researchProjectId').val(id);
                                        $('#isEdit').val(1);
                                        var elem = '.mainForm';
                                        var inputElem = $(elem + ' input'),
                                            textareaElem = $(elem + ' textarea'),
                                            selectElem = $(elem + ' select'),
                                            buttonElem = $(elem + ' button');
                                        inputElem.attr('disabled', 'disabled');
                                        textareaElem.attr('disabled', 'disabled');
                                        selectElem.attr('disabled', 'disabled');
                                        buttonElem.attr('disabled', 'disabled');
                                        //所有文件控件下载按钮移除只读属性
                                        for (var i = 0; i <buttonElem.length ; i++) {
                                            buttonElem.eq(i).css('display','none');
                                            if(buttonElem.eq(i).html()=='下载'){
                                                buttonElem.eq(i).removeAttr("disabled");
                                            }
                                        }
                                    }
                                },'top');
                            }else if(processDefinitionKey=='-101'){
                                admin.popupCenter({
                                    id: 'ADCFormDesignHelper-startProcess',
                                    maxmin: false,
                                    title: '查看项目',
                                    path: 'components/researchForm/mainForm.html',
                                    area: ['100%', '100%'],
                                    // btn: ['启动', '取消'],
                                    btnAlign: 'c',
                                    resize: false,
                                    finish: function () {

                                    },
                                    success: function () {
                                        $('#researchProjectId').val(id);
                                        $('#procBusinessKey').val(res.data);
                                        $('#isEdit').val(2);
                                        var elem = '.mainForm';
                                        var inputElem = $(elem + ' input'),
                                            textareaElem = $(elem + ' textarea'),
                                            selectElem = $(elem + ' select'),
                                            buttonElem = $(elem + ' button');
                                        inputElem.attr('disabled', 'disabled');
                                        textareaElem.attr('disabled', 'disabled');
                                        selectElem.attr('disabled', 'disabled');
                                        buttonElem.attr('disabled', 'disabled');
                                        //所有文件控件下载按钮移除只读属性
                                        for (var i = 0; i <buttonElem.length ; i++) {
                                            buttonElem.eq(i).css('display','none');

                                        }
                                    }
                                },'top');
                            }else if(processDefinitionKey=='pa0001fb0970341808dd0869ab05c8a3c'){
                                if(($(this).siblings('.taskInfo-Info').children()&&$(this).siblings('.taskInfo-Info').children().length<processLimit&&processLimit!=0)||processLimit==-1){
                                    $.ajax({
                                        url: "/api/research/hiBase/lastKey/"+id,
                                        type:'get',
                                        success: function (res) {
                                            if(res.ok){
                                                admin.popupCenter({
                                                    id: 'ADCFormDesignHelper-startProcess',
                                                    maxmin: false,
                                                    title: '查看项目',
                                                    path: 'components/researchChangeForm/mainChangeForm.html',
                                                    area: ['100%', '100%'],
                                                    // btn: ['启动', '取消'],
                                                    btnAlign: 'c',
                                                    resize: false,
                                                    finish: function () {
                                                        getProgress(id,false,infoData);
                                                        table.reload('workProgressTable');
                                                    },
                                                    success: function () {
                                                        $('#researchProjectId').val(id);
                                                        $('#procBusinessKey').val(res.data);
                                                        // $('#isEdit').val(2);
                                                        // var elem = '.mainForm';
                                                        // var inputElem = $(elem + ' input'),
                                                        //     textareaElem = $(elem + ' textarea'),
                                                        //     selectElem = $(elem + ' select'),
                                                        //     buttonElem = $(elem + ' button');
                                                        // inputElem.attr('disabled', 'disabled');
                                                        // textareaElem.attr('disabled', 'disabled');
                                                        // selectElem.attr('disabled', 'disabled');
                                                        // buttonElem.attr('disabled', 'disabled');
                                                        // //所有文件控件下载按钮移除只读属性
                                                        // for (var i = 0; i <buttonElem.length ; i++) {
                                                        //     buttonElem.eq(i).css('display','none');
                                                        //
                                                        // }
                                                    }
                                                },'top');
                                            }else{
                                                layer.msg(res.message, {
                                                    icon: 5
                                                });
                                            }
                                        }
                                    })
                                }else{
                                    return  layer.msg('该表单已经启动过流程', {
                                        icon: 5
                                    });
                                }
                            }else if(processDefinitionKey=='p9d12f5b27f9a482c8772de52d2825334'){
                                if(($(this).siblings('.taskInfo-Info').children()&&$(this).siblings('.taskInfo-Info').children().length<processLimit&&processLimit!=0)||processLimit==-1) {
                                    $.ajax({
                                        url: "/api/research/endBase/lastKey/"+id,
                                        type:'get',
                                        success: function (res) {
                                            if(res.ok){
                                                admin.popupCenter({
                                                    id: 'ADCFormDesignHelper-startProcess',
                                                    maxmin: false,
                                                    title: '查看项目',
                                                    path: 'components/researchEndForm/mainEndForm.html',
                                                    area: ['100%', '100%'],
                                                    // btn: ['启动', '取消'],
                                                    btnAlign: 'c',
                                                    resize: false,
                                                    finish: function () {
                                                        getProgress(id,false,infoData);
                                                        table.reload('workProgressTable');
                                                    },
                                                    success: function () {
                                                        $('#researchProjectId').val(id);
                                                        $('#procBusinessKey').val(res.data);
                                                        // $('#isEdit').val(2);
                                                        // var elem = '.mainForm';
                                                        // var inputElem = $(elem + ' input'),
                                                        //     textareaElem = $(elem + ' textarea'),
                                                        //     selectElem = $(elem + ' select'),
                                                        //     buttonElem = $(elem + ' button');
                                                        // inputElem.attr('disabled', 'disabled');
                                                        // textareaElem.attr('disabled', 'disabled');
                                                        // selectElem.attr('disabled', 'disabled');
                                                        // buttonElem.attr('disabled', 'disabled');
                                                        // //所有文件控件下载按钮移除只读属性
                                                        // for (var i = 0; i <buttonElem.length ; i++) {
                                                        //     buttonElem.eq(i).css('display','none');
                                                        //
                                                        // }
                                                    }
                                                },'top');
                                            }else{
                                                layer.msg(res.message, {
                                                    icon: 5
                                                });
                                            }
                                        }
                                    })
                                }else{
                                    return  layer.msg('该表单已经启动过流程', {
                                        icon: 5
                                    });
                                }
                            }else if(processDefinitionKey!=-1){
                                if(($(this).siblings('.taskInfo-Info').children()&&$(this).siblings('.taskInfo-Info').children().length<processLimit&&processLimit!=0)||processLimit==-1){
                                    var startProcess = function(){
                                        admin.req('/api/activiti/repository/getProcessStartRequestForm', {
                                            processDefinitionKey: processDefinitionKey
                                        }, function (result) {
                                            if (result.ok && result.data != null) {
                                                if (result.data.id.indexOf('.html') > 0) {
                                                    // 外部表单流程
                                                    admin.popupCenter({
                                                        title: '启动流程',
                                                        path: 'components/tpl/process_def_tpl_start.html',
                                                        area: ['90%', '90%'],
                                                        finish: function () {

                                                        },
                                                        success: function () {
                                                            $("#process_def_tpl_start").load(result.data
                                                                .id);
                                                            $("#process_id").val(data.processId);
                                                            $("#process_key").val(data.processKey);
                                                            $("#isExternalForm").val('1');
                                                        }
                                                    });
                                                } else {
                                                    // 正常流程
                                                    admin.req('/api/form/' + result.data.id, {}, function (response) {
                                                        if (response.data.design == 1) {} else {
                                                            var newData = $.extend({}, data, result);
                                                            newData.processDefinitionKey=processDefinitionKey;
                                                            ADCFormDesignHelper.startProcess(newData, function () {
                                                                getProgress(id,false,infoData);
                                                                table.reload('workProgressTable');
                                                            },id);
                                                        }
                                                    });
                                                }
                                            }

                                        }, {
                                            method: 'POST'
                                        });
                                    };
                                    if(processDefinitionKey=='p0d341ec07f034170a797be3a2d164c3d') {
                                        $.ajax({
                                            url:"/api/research/save/checkpoint?projectId="+id,
                                            type:"GET",
                                            contentType: 'application/json',
                                            async:false,
                                            success:function (res) {
                                                if(res.ok){
                                                    startProcess();
                                                }else{
                                                    return layer.msg('无检查内容，不能启动流程', {
                                                        icon: 5
                                                    });
                                                }
                                            }
                                        });
                                    }else{
                                        startProcess()
                                    }
                                }else{
                                    return  layer.msg('该表单已经启动过流程', {
                                        icon: 5
                                    });
                                }
                            }
                        }else{
                            return  layer.msg('非项目组成员无权限启动', {
                                icon: 5
                            });
                        }

                    }).off('mouseleave').on('mouseleave',function () {
                        $(this).children('.taskInfo-Info').css('display','none');
                        $(this).children('.taskInfo-text').children('img').attr('src','../../assetsInfo/images/xia.png');
                    }).off('mouseenter').on('mouseenter','.taskInfo-text',function () {
                        $(this).children('img').attr('src','../../assetsInfo/images/shang.png');
                        $(this).siblings('.taskInfo-Info').css('display','block');
                    });

                    $('.taskprocessInstance').off('click').on('click',function () {
                        var dataObj={
                            name:$(this).data('processname'),
                            processInstanceId:$(this).data('processinstanceid')
                        };
                        var processDefinitionKeyInfo = $(this).parent().siblings('.taskInfo-text').data('processdefinitionkey');
                        if(processDefinitionKeyInfo=="pa0001fb0970341808dd0869ab05c8a3c"
                            ||processDefinitionKeyInfo=="p9d12f5b27f9a482c8772de52d2825334"){
                            $.ajax({
                                url: "/api/research/hiBase/lastKey/"+id+"?procInstId="+$(this).data('processinstanceid'),
                                type:'get',
                                success: function (res) {
                                    if(res.ok){
                                        dataObj.businessKey=res.data;
                                        dataObj.processDefinitionKey=processDefinitionKeyInfo;
                                        admin.popupCenter({
                                            title: '查看任务：' + dataObj.name,
                                            path: 'components/tpl/process_my_tpl_view.html',
                                            area: ['100%', '100%'],
                                            resize: false,
                                            finish: function () { },
                                            success: function () {
                                                process_my_tpl_view(dataObj);
                                            }
                                        });
                                    }else{
                                        layer.msg(res.message, {
                                            icon: 5
                                        });
                                    }
                                }
                            })
                        }else{
                            admin.popupCenter({
                                title: '查看任务：' + dataObj.name,
                                path: 'components/tpl/process_my_tpl_view.html',
                                area: ['100%', '100%'],
                                resize: false,
                                finish: function () { },
                                success: function () {
                                    process_my_tpl_view(dataObj);
                                }
                            });
                        }


                    })
                } else {
                    return layer.msg('获取信息失败' + res.message, {
                        icon: 5
                    });
                }
            }, {
                method: 'get'
            });
        };
        //注意projectId 必须是全局 否则upload 插件上传id还是首次render的id，因为upload.render不能多次渲染
        function getProjectFile(){

            searchFile({pageSize:downSize,page:1,projectId:projectId});
            //创建一个上传组件
            if(fileUpload==null){
                fileUpload=upload.render({
                    elem: '#upload-project-file'
                    ,url: '/api/budget/file/upload'
                    ,accept:'file'
                    ,exts:exts
                    ,size: 50*1024
                    ,before: function(obj){


                        //动态付参数，不能鞋写在外部，否则projectId固定了
                        this.data={userId:config.getAccount().usid,filePath:'c',projectId:projectId}
                    }
                    ,done: function(res, index, upload){ //上传后的回调

                        if(res.respCode==0)
                        {
                            searchFile({pageSize:downSize,page:1,projectId:projectId})
                        }
                        else{
                            return layer.msg('上传失败:' + res.message, {
                                icon: 5
                            });
                        }
                    }
                })

            }
            function searchFile(params){
                admin.req('/api/budget/project/getDeliveryFile',
                    params, function(res) {
                        if(res.respCode=='0') {
                            if(res.data.list&&res.data.list.length!=0){
                                $('.infoNotic').hide();
                            }else{
                                $('.infoNotic').show();
                            }
                            for(var item of res.data.list) {
                                item.icon = '../../assetsInfo/images/detailPage/'+extsImage[item.fileType]+'.png';
                                item.href = ' /api/budget/file/'+item.fileId+'/download';
                                item.date = new Date(item.createTime).toLocaleDate();
                                item.fileName = item.fileName+'.'+item.fileType;
                                item.size = item.fileSize;
                                item.uploader = item.uploadUser;
                            }
                            vm.set({
                                fileList: res.data.list
                            })
                            if(params.page==1) {
                                initPage(res.data.count)
                            }
                            $('.delProFile').off('click').on('click',function(){

                                var fileId = $(this).attr('fileId');
                                var fileName = $(this).attr('fileName');
                                layer.confirm('确定删除文件:'+fileName+'吗？', {
                                    icon: 3,
                                    title: '提示'
                                }, function() {
                                    admin.req('/api/budget/project/file/' + fileId, {}, function(data) {
                                        if (data.ok) {
                                            layer.msg('删除文件成功！', {
                                                icon: 1
                                            });
                                            searchFile({pageSize:downSize,page:1,projectId:projectId})
                                        } else {
                                            return layer.msg('删除文件失败：' + data.message, {
                                                icon: 5
                                            });
                                        }
                                    }, {method: 'delete'});
                                });
                            });
                        } else{
                            layer.msg('查询失败!', {
                                icon: 5
                            });
                        }
                    },{method:"post"});
            }
            function initPage(count) {
                // 修改layui page 分页样式 制作简易版 分页 去掉边框，修改选种样式  修改前一页和下一页样式
                laypage.render({
                    elem: 'taskfile-page'
                    ,count: count
                    ,limit: downSize
                    ,jump: function(obj, first){
                        $('#file-page .layui-laypage-prev').html("<i class='layui-icon layui-icon-left'></i>");
                        $('#file-page .layui-laypage-next').html("<i class='layui-icon layui-icon-right'></i>");
                        if(!first) {
                            searchFile({pageSize:downSize,page:obj.curr,projectId:projectId})
                        }
                    },
                });
            }
        }
        // 筛选下拉按钮
        $("#filter-icon").on('mouseover',function() {
            $("#filter-drop").show();
            $("ul#filter-list li").each(function() {
                $(this).css('color','#000');
                if($(this).attr('state')==filterType) {
                    $(this).css('color','#008FC3');
                }
            })
        }).on('mouseleave',function () {
            $("#filter-drop").hide();
        });
        $("ul#filter-list").on("click","li",function(){
            filterType=$(this).attr('state');
            $("#filter-drop").hide();
            getTreeData(modelType)
        });
        $("#filter-drop").on("mouseover",function(){
            $(this).show();
        }).on('mouseleave',function () {
            $("#filter-drop").hide();
        });
        // 模式切换
        $("#primary-model").on("click",function(){
            $('#primary-model').addClass('choose');
            $('#org-model').removeClass('choose');
            modelType=0;
            getTreeData(0);
            $('.org-top').hide();
            $('.btn-group').show();
        });
        $("#org-model").on("click",function(){
            $('#primary-model').removeClass('choose');
            $('#org-model').addClass('choose');
            modelType=1;
            getTreeData(1);
            $('.btn-group').hide();
            $('.org-top').show();
        });
        getTreeData(0);
        function businessDetail(id,name) {
            var projectSearch='';
            // 展示业务预算的echarts
            var showBar = function (chartData) {
                // 图表初始化
                var myChart=echarts.init(document.getElementById("budgetChart"));
                // 图表配置项
                var option={
                    legend: {
                        data:[{name : '合同预算'},
                            {name : '收入预算'}],
                        itemWidth : 20,
                        itemHeight : 12
                    },
                    tooltip: {},
                    grid: {
                        left: '3%',
                        right: '4%',
                        top : 50,
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            data: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        },
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '预算(万元)',
                            nameTextStyle:{
                                color : "rgba(0,0,0,0.5)"
                            },
                            min: 0,
                            max: parseInt(chartData.max / 100) * 100 + 100,
                            splitLine : {
                                show : false
                            },
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            },
                            axisLabel: {
                                formatter: '{value}'
                            }
                        }
                    ],
                    series: [
                        {
                            name:'合同预算',
                            type:'bar',
                            data:chartData.deal,
                            barGap:'140%',
                            barWidth : 13,
                            label : {
                                show : true,
                                position : "top"
                            },
                            tooltip: {},
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0,color: '#55B7FF'},
                                {offset: 1,color: '#C2EFFF'}
                            ]),
                            itemStyle : {
                                barBorderRadius : [3,3,0,0]
                            }

                        },
                        {
                            name:'收入预算',
                            type:'bar',
                            barWidth : 13,
                            barGap:'140%',
                            data: chartData.income,
                            label : {
                                show : true,
                                position : "top"
                            },
                            tooltip: {},
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0,color: '#FF9E98'},
                                {offset: 1,color: '#FFDFC2'}
                            ]),
                            itemStyle : {
                                borderWidth : 19,
                                barBorderRadius : [3,3,0,0]
                            }
                        }
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
            };

            // 展示人力统计echarts
            var showPerson = function (xData,yData) {
                // 图表初始化
                var myChart = echarts.init(document.getElementById("persons"));
                myChart.resize();
                // 图表配置项
                var option={
                    legend: {
                        data:[{name : '工作量'}],
                        itemWidth : 20,
                        itemHeight : 12,
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        top : 50,
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            data: xData,
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '投入人力(天)',
                            nameTextStyle:{
                                color : "rgba(0,0,0,0.5)"
                            },
                            splitLine : {
                                show : false
                            },
                            axisLabel: {
                                formatter: '{value}'
                            },
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            name:'工作量',
                            type:'bar',
                            data:yData,
                            label : {
                                show : true,
                                position : "top"
                            },
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0,color: '#55B7FF'},
                                {offset: 1,color: '#D1F3FF'}
                            ]),
                            barWidth : 14,
                            itemStyle : {
                                barBorderRadius : [3,3,0,0]
                            }
                        }
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
            };
            var getStatistics = function (year) {

                admin.req("/api/business/operatingBudget/getBusinessYearData/"+name+"/"+year, {}, function(res) {
                    if (res.ok) {
                        showIncome(res.data);
                    } else {
                        return layer.msg('获取信息失败' + res.message, {
                            icon: 5
                        });
                    }
                }, {
                    method: 'get'
                });
            };
            //业务工时统计新接口
            var getManDayByMonth=function(){
                admin.req('/api/statistics/businessWorktime/getManDayByMonth/' + id, {}, function(res) {
                    if (res.ok) {
                        var xData=[1,2,3,4,5,6,7,8,9,10,11,12];
                        var yData=[0,0,0,0,0,0,0,0,0,0,0,0];
                        for (var i = 0; i <res.data.length ; i++) {
                            yData[res.data[i].month-1]=res.data[i].worktime.toFixed(2);
                        }
                        showPerson(xData,yData)
                    } else {
                        return layer.msg('获取信息失败' + res.message, {
                            icon: 5
                        });
                    }
                }, {
                    method: 'get'
                });
            };
            getManDayByMonth();
            // $(window).resize(function () {
            //     autoSize()
            // });
            //
            // var autoSize = function(){
            //     if ( $("#budget").height() > $("#businessDetail").height() ) {
            //         $("#businessDetail").height($("#budget").height());
            //     } else {
            //         $("#budget").height($("#businessDetail").height());
            //     }
            // };
            //
            // autoSize();
            //获取历史有数据的年份
            var  getAllYear =function () {
                admin.req('/api/business/operatingBudget/queryAllYear', {}, function(res) {
                    if (res.ok) {
                        var arr = res.data,
                            elem = $('#budget_year');
                        elem.empty().append('');
                        for (var i = 0; i < arr.length; i++) {
                            if (arr[i]) {
                                if (i == 0) {
                                    elem.empty().append('<option selected value="' + arr[i] + '">' + arr[i] + '</option>')
                                } else {
                                    elem.append('<option  value="' + arr[i] + '">' + arr[i] + '</option>');

                                }

                            }
                        }
                        form.render('select');
                        getStatistics(res.data[0]);
                    } else {
                        return layer.msg('获取信息失败' + res.message, {
                            icon: 5
                        });
                    }
                }, {
                    method: 'get'
                });
            };
            form.on('select(budget_year)', function(data) {
                getStatistics(data.value);
            });

            // 展示收入统计echarts
            var showIncome = function (data) {
                // if(!$.isEmptyObject(data)){
                // 图表初始化
                var myChart=echarts.init(document.getElementById("income"));
                myChart.resize();
                // 图表配置项
                var option={
                    legend: {
                        data:[{name : '业务收入'}],
                        itemWidth : 20,
                        itemHeight : 12
                    },
                    grid: {
                        left: (data?"3%":30),
                        right: '4%',
                        top : 50,
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            data: ['1','2','3','4','5','6','7','8','9','10','11','12'],
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '金额(万元)',
                            nameTextStyle:{
                                color : "rgba(0,0,0,0.5)"
                            },
                            splitLine : {
                                show : false
                            },
                            axisLabel: {
                                formatter: '{value}'
                            },
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            name:'业务收入',
                            type:'bar',
                            data:data,
                            label : {
                                show : true,
                                position : "top"
                            },
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0,color: '#FE8A23'},
                                {offset: 1,color: '#FEDDBE'}
                            ]),
                            barWidth : 14,
                            itemStyle : {
                                barBorderRadius : [3,3,0,0]
                            }
                        }
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
                // }else{
                //     $('#income').html('<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>')
                // }
            };

            // 展示业务支出echarts
            var showCost = function (data) {
                // if (!$.isEmptyObject(data)) {
                // 图表初始化
                var myChart = echarts.init(document.getElementById("cost"));
                var max = Math.max.apply(null, data);
                max = (parseInt(max / 100) + 2) * 100;
                // 图表配置项
                var option = {
                    legend: {
                        data: [{name: '业务支出'}],
                        itemWidth: 20,
                        itemHeight: 12
                    },
                    grid: {
                        left: (data ? "3%" : 30),
                        right: '4%',
                        top: 50,
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            data: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                            axisLine: {
                                lineStyle: {
                                    color: "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '金额(万元)',
                            max: max,
                            nameTextStyle: {
                                color: "rgba(0,0,0,0.5)"
                            },
                            splitLine: {
                                show: false
                            },
                            axisLabel: {
                                formatter: '{value}'
                            },
                            axisLine: {
                                lineStyle: {
                                    color: "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            name: '业务支出',
                            type: 'bar',
                            data: data,
                            label: {
                                show: true,
                                position: "top"
                            },
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: '#23BC77'},
                                {offset: 1, color: '#BFFEE1'}
                            ]),
                            barWidth: 14,
                            itemStyle: {
                                barBorderRadius: [3, 3, 0, 0]
                            }
                        }
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
                // } else {
                //     $('#cost').html('<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>')
                // }
            };

            // 渲染业务详情
            var showDetail = function (data) {

                var detail = "";
                var property = "";
                switch ( data.property ){
                    case "0" :
                        property = "经营类";
                        break;
                    case "1" :
                        property = "非经营类";
                        break;
                    case "2" :
                        property = "科研类";
                }
                detail += ' <div class="layui-row ">' +
                    '<div class="layui-col-md4 " style="padding-right: 2px">' +
                    '<div class="layui-col-md3" ><b>业务名称:</b></div>' +
                    '<div class="layui-col-md9" ><p class="over-ellipsis">' + (data.projectName?data.projectName:'' )+ '</p></div>' +
                    '</div>' +
                    '<div class="layui-col-md4 " style="padding-right: 2px">' +
                    '<div class="layui-col-md3" ><b>业务属性:</b></div>' +
                    '<div class="layui-col-md9" ><p class="over-ellipsis">' + property + '</p></div>' +
                    '</div>' +
                    '<div class="layui-col-md4 " style="padding-right: 2px">' +
                    '<div class="layui-col-md3" ><b>业务经理:</b></div>' +
                    '<div class="layui-col-md9" ><p>' + (data.usname ? data.usname : "") + '</p></div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="layui-row ">' +
                    '<div class="layui-col-md4 " style="padding-right: 2px">' +
                    '<div class="layui-col-md3" ><b>业务性质:</b></div>' +
                    '<div class="layui-col-md9" ><p>' + (data.propertyId === "cx"? "持续":"新增") + '</p></div>' +
                    '</div>' +
                    '<div class="layui-col-md4 " style="padding-right: 2px">' +
                    '<div class="layui-col-md3" ><b>业务周期:</b></div>' +
                    '<div class="layui-col-md9" ><p>' + (data.cycle?data.cycle:'') + '</p></div>' +
                    '</div>' +
                    '<div class="layui-col-md4 " style="padding-right: 2px">' +
                    '<div class="layui-col-md3" ><b>项目组名称:</b></div>' +
                    '<div class="layui-col-md9" ><p class="over-ellipsis">' + (data.teamName?data.teamName:'') + '</p></div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="layui-row ">' +
                    '<div class="layui-col-md4 " style="padding-right: 2px">' +
                    '<div class="layui-col-md3" ><b>19年实际收入:</b></div>' +
                    '<div class="layui-col-md9" ><p>' + (data.currentYearEstimate?data.currentYearEstimate:0) + '万元</p></div>' +
                    '</div>' +
                    '<div class="layui-col-md4 " style="padding-right: 2px">' +
                    '<div class="layui-col-md3" ><b>业务简介:</b></div>' +
                    '<div class="layui-col-md9" ><p class="multi-line">' + (data.remark?data.remark:"暂无") + '</p></div>' +
                    '</div>' +
                    '</div>';
                $("#detail").html("");
                $("#detail").append(detail);
                console.log($('#detial .layui-col-md9 p'))
                $('.layui-col-md9 p').each(function(){
                    $(this).attr('title',$(this).text())

                })
            };

            // 查询业务详情
            var getBusinessDetail = function (){
                $.ajax({
                    url: "/api/budget/budget/" + id,
                    type: 'get',
                    success: function (res) {
                        if (res.ok) {
                            // 整理数据
                            var data = tidyData(res.data);
                            if(res.data.property==='0'){
                                $('#budgetInfo').show();
                                $('#income').show();
                                $('#budgetYear').show();
                                var myChart=echarts.init(document.getElementById("income"));
                                myChart.dispose();
                                // 展示柱状图
                                showBar(data.chartData);
                                // 添加列表的两个数据行
                                $("#budgetTbody").html("");
                                $("#budgetTbody").append(data.deal).append(data.income);
                                getAllYear();
                            }
                            // else if (res.data.property=="2"){
                            //     $('#budgetYear').show();
                            //     $('#budgetInfo').hide();
                            //     $('#income').hide();
                            // }
                            else{
                                $('#budgetInfo').hide();
                                $('#income').hide();
                                $('#budgetYear').hide();
                            }
                            // 动态修改左侧详情信息的高度
                            // if ( $("#budget").height() > $("#businessDetail").height() ) {
                            //     $("#businessDetail").height($("#budget").height());
                            // } else {
                            //     $("#budget").height($("#businessDetail").height());
                            // }
                            showDetail(res.data);
                        }
                    }
                });
            };
            // 整理业务详情数据
            var tidyData = function (data){
                if( data.property == 0){
                    var dealTr = "<tr><td>合同</td>";
                }
                else{
                    var dealTr = "<tr><td>预算</td>";
                }

                var incomeTr = "<tr><td>收入</td>";
                var incomeArr = [];
                var dealArr = [];
                var maxVal = 0;
                var chartData = {};
                var dataFinl = {};
                for ( var i = 1; i <= 12 ; i++){
                    if (data["nextYear" + i +"Income"] > maxVal) {
                        maxVal = data["nextYear" + i +"Income"];
                    }
                    if (data["nextYear" + i + "Deal"] > maxVal) {
                        maxVal = data["nextYear" + i + "Deal"];
                    }
                    if( data.property==0){
                        incomeArr.push( data["nextYear" + i +"Income"]);
                        incomeTr += "<td>" + (data["nextYear" + i +"Income"]?data["nextYear" + i +"Income"]:0) + "</td>";

                    }

                    dealArr.push( data["nextYear" + i + "Deal"]);
                    dealTr += "<td>" + (data["nextYear" + i +"Deal"]?data["nextYear" + i + "Deal"]:0) + "</td>";
                }
                incomeTr += "</tr>";
                dealTr += "</tr>";
                chartData.income = incomeArr;
                chartData.deal = dealArr;
                chartData.max = maxVal;
                dataFinl.chartData = chartData;
                dataFinl.deal = dealTr;

                if( data.property==0)
                {
                    dataFinl.income = incomeTr;

                }

                return dataFinl;
            };
            getBusinessDetail();
            var projectPage=1;
            var projectSize=10;
            var text;
            var setPage=function (count) {
                laypage.render({
                    elem: 'pageBox'
                    ,count: count,
                    limit:projectSize
                    ,layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                    ,jump: function(obj,first){
                        $('#pageBox .layui-laypage-prev').html("<i class='layui-icon layui-icon-left'></i>");
                        $('#pageBox .layui-laypage-next').html("<i class='layui-icon layui-icon-right'></i>");
                        if(!first) {
                            projectPage=obj.curr;
                            projectSize=obj.limit;
                            if(projectSearch==1){
                                getProjectList(text,"","");
                            }else if(projectSearch==2){
                                getProjectList("",text,"");
                            }else if(projectSearch==3){
                                getProjectList("","",text);
                            }else if(!projectSearch){
                                getProjectList("","","");
                            }
                        }
                    },

                });
            };
            // 查询业务下的所有项目
            var getProjectList = function (name,status,manager) {
                $.ajax({
                    url: admin.formatUrl("/api/budget/budget/getProjectsByTips4Page?projectName="+name+"&projectStatus="+status+"&projectManager="+manager+"&bussinessId="+id+"&pageIndex="+projectPage+"&pageSize="+projectSize),
                    type: 'get',
                    success: function (res) {
                        if (res.ok) {
                            if(res.data.dataList&&res.data.dataList.length==0&&!name&&!status&&!manager){
                                $('#projectList').hide();
                            }else{
                                $('#projectList').show();
                            }
                            if(projectPage==1)
                            {
                                setPage(res.data.count)
                            }
                            var projectList = "";
                            $.map(res.data.dataList,function (item) {
                                item.personInput =  item.personInput == null ? '':  item.personInput;
                                var str='';
                                for (var i = 0; i <item.mapList.length ; i++) {
                                    var tmp=item.mapList[i];
                                    if(i==(item.mapList.length-1)){
                                        str+='<a class = "peoName" href="#!personCalendar?&usid=' + tmp.id + '&usname=' + tmp.name + '">'+tmp.name +'</a>';
                                    }else{
                                        str+='<a class = "peoName" href="#!personCalendar?&usid=' + tmp.id + '&usname=' + tmp.name + '">'+tmp.name +'</a>、';
                                    }
                                }
                                projectList += "<tr><td class='projectName' style='cursor: pointer' id="+item.id+" >" + item.name + "</td>" +
                                    "<td>" + item.projectLeader + "</td>" +
                                    "<td>" + str + "</td>" +
                                    "<td>" + item.personInput  + "</td>" +
                                    "<td>" + item.finishedStatus + "</td>" +
                                    "<td>" + tools.getDate(item.createTime,"YYYY-MM-DD") + "</td></tr>"
                            });
                            $("#projectTbody").html("");
                            $("#projectTbody").append(projectList);
                        }
                    }
                });
            };
            form.on('select(project_search)', function(data) {
                projectSearch=data.value;
            });
            $("#searchText").off('keyup').on('keyup',function (e) {
                var theEvent = e || window.event;
                var code = theEvent.keyCode || theEvent.which || theEvent.charCode ;
                if (code == 13) {
                    projectPage=1;
                    text=$("#searchText").val();
                    if(projectSearch==1){
                        getProjectList(text,"","");
                    }else if(projectSearch==2){
                        getProjectList("",text,"");
                    }else if(projectSearch==3){
                        getProjectList("","",text);
                    }else if(!projectSearch){
                        getProjectList("","","");
                    }
                }
            });
            $("#searchBtn").off('click').on('click',function (data) {
                projectPage=1;
                text=$("#searchText").val();
                if(projectSearch==1){
                    getProjectList(text,"","");
                }else if(projectSearch==2){
                    getProjectList("",text,"");
                }else if(projectSearch==3){
                    getProjectList("","",text);
                }else if(!projectSearch){
                    getProjectList("","","");
                }
            });
            $("#searchText").val('');
            // $("#searchText").hide();
            $("#project_search option[id='emptySearch']").prop('selected', 'selected');
            form.render('select');
            getProjectList("","","");
            $ ('#projectTbody').off("click").delegate ('td.projectName', 'click', function (event) {
                $(".RightContent").hide();
                $('#nodata').hide();
                $("#projectDetailDiv").show();
                new projectDetail($ (this)[0].id,id,name);
            });
            // $("#taskList").hide();
            // 查询项目甘特图数据
            var gant = function () {
                $("#GantChart").empty();
                $('#GantChart').ADCGanttChart({
                    url: '/api/budget/budget/' + id + '/getTaskStatus',
                    styleBarStart: ""
                });
            };
            gant();
        }
        function projectDetail(id,treeId,treeNmaeTitle){
            $('#tasknoBusiness').css('display',"none");
            projectId=id;
            if(treeId&&treeNmaeTitle){
                $("#goBack").show();
                $("#goBack").off('click').on('click',function (data) {
                    $(".RightContent").hide();
                    $('#nodata').hide();
                    $("#businessDetailDiv").show();
                    new businessDetail(treeId,treeNmaeTitle);
                });
            }else{
                $("#goBack").hide();
            }

            var getDream = function (data) {
                if ( data.completeWorkTime && (data.completeWorkTime.length > 0)
                    && data.executeWorkTime && (data.executeWorkTime.length > 0 )
                    && data.laveWorkTime && (data.laveWorkTime.length > 0) ) {
                    var total = data.completeWorkTime[0] + data.executeWorkTime[0] + data.laveWorkTime[0];
                    total -= (total % 3);
                    total = total / 3 * 2;
                    total -= (total % 21);
                    var dream = [];
                    var step = total / 21;
                    for (var i = 1; i <= 21; i++) {
                        dream.push(total -= step);
                    }
                    return dream;
                } else {
                    return [];
                }
            };
            // 展示燃尽图左侧的echarts
            var showUpL = function (chartData) {
                // if (chartData.completeWorkTime == null && chartData.executeWorkTime == null && chartData.laveWorkTime == null) {
                //     $('#upPicL').html('<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>')
                // } else if (chartData.completeWorkTime.length == 0 && chartData.executeWorkTime.length == 0 && chartData.laveWorkTime.length == 0)  {
                //     $('#upPicL').html('<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>')
                // } else {
                // 图表初始化
                var myChart = echarts.init(document.getElementById("upPicL"));
                chartData = chartData ? chartData : {};
                // 图表配置项
                var option = {
                    legend: {
                        data: [{name: '完成小时数', icon: "circle", itemHeight: 10, itemWidth: 20},
                            {name: '进行小时数', icon: "circle", itemHeight: 10, itemWidth: 10},
                            {name: '尚需小时数', icon: "circle", itemHeight: 10, itemWidth: 10},
                            {name: '理想趋势', icon: "line", itemHeight: 10, itemWidth: 30}],
                        itemWidth: 20,
                        itemHeight: 12
                    },
                    grid: {
                        left: (getDream(chartData).length === 0 ? 30 : '3%'),
                        // left: 30,
                        right: '4%',
                        top: 50,
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            boundaryGap: false,
                            data: chartData.hasOwnProperty("time") ? chartData.time : ["2019/02/01", "2019/02/02", "2019/02/03", "2019/02/04", "2019/02/05"],
                            splitLine: {
                                show: true
                            },
                            axisLine: {
                                lineStyle: {
                                    color: "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            axisLine: {
                                lineStyle: {
                                    color: "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            name: '完成小时数',
                            type: 'line',
                            stack: '总量',
                            color: "#A7E6FD",
                            symbol: "none",
                            areaStyle: {
                                color: "#C0EDFD"
                            },
                            data: chartData.hasOwnProperty("completeWorkTime") ? chartData.completeWorkTime : []
                        },
                        {
                            name: '进行小时数',
                            type: 'line',
                            color: "#D7FEAE",
                            symbol: "none",
                            stack: '总量',
                            areaStyle: {
                                color: "#E0FFC1"
                            },
                            data: chartData.hasOwnProperty("executeWorkTime") ? chartData.executeWorkTime : []
                        },
                        {
                            name: '尚需小时数',
                            type: 'line',
                            color: "#FFD9B6",
                            symbol: "none",
                            stack: '总量',
                            areaStyle: {
                                color: "#FFDCC2"
                            },
                            data: chartData.hasOwnProperty("laveWorkTime") ? chartData.laveWorkTime : []
                        },
                        {
                            name: '理想趋势',
                            type: 'line',
                            symbol: "none",
                            color: "#FF8F78",
                            lineStyle: {
                                shadowBlur: 15,
                                shadowColor: "rgba(255,0,0,0.5)"
                            },
                            data: getDream(chartData)
                        }
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
                // }

            };

            // 展示项目质量echarts
            var showQuality = function (data) {
                // if(data!= null && data.length!=0){
                data = data?data:[];
                // 图表初始化
                var myChart=echarts.init(document.getElementById("projectDensity"));
                // 图表配置项
                var option={
                    xAxis: {
                        nameTextStyle:{
                            padding:[20,0,0,($("#projectDensity").width()/2 + 90)],
                            color : "rgba(0,0,0,0.5)"
                        },
                        nameLocation : "middle",
                        name :"收入(万元)",
                        axisLine : {
                            lineStyle : {
                                color : "rgba(0,0,0,0.5)"
                            }
                        }
                    },
                    yAxis: {
                        name : "成本(万元)",
                        nameTextStyle:{
                            color : "rgba(0,0,0,0.5)"
                        },
                        axisLine : {
                            lineStyle : {
                                color : "rgba(0,0,0,0.5)"
                            }
                        }
                    },
                    legend: {
                        data:[{name : 'bug密度', icon : "circle"}],
                        left: 160,
                        itemWidth : 20,
                        itemHeight : 12
                    },
                    series: [{
                        name:"bug密度",
                        symbolSize: function(res){
                            if (res) {
                                return Math.pow(res[2], 1 / 3) * 60;
                            } else {
                                return 0;
                            }
                        },
                        data: data,
                        type: 'scatter',
                        label: {
                            show : true,
                            formatter :function(res){
                                if ( res ) {
                                    return res.data[2];
                                }
                            },
                            fontSize : 10,
                            emphasis: {
                                show: true,
                                formatter: function (param) {
                                    if ( param && param.data ) {
                                        return param.data[2];
                                    }
                                },
                            }
                        },
                        tooltip : {
                            position : "center"
                        },
                        itemStyle: {
                            opacity : 1 ,
                            normal: {
                                color: function(res){
                                    if ( res.value && (res.value[2] <= 0.4) ){
                                        return "#55B7FF";
                                    } else {
                                        return "#F6BB16";
                                    }
                                }
                            }
                        }
                    }]
                };
                // 进行图表配置
                myChart.setOption(option);
                // }else{
                //     $('#projectDensity').html('<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>')
                // }

            };

            // 展示燃尽图右侧的echarts
            var showUpR = function (chartData) {
                // if(chartData.names.length!= 0 && chartData.finish.length!= 0 && chartData.leave.length!= 0 && chartData.other.length!= 0 ) {
                // 图表初始化
                var myChart = echarts.init(document.getElementById("upPicR"));
                // 图表配置项
                var option = {
                    legend: {
                        data: ['已完成', '剩余'],
                        left: 100,
                        itemWidth: 20,
                        itemHeight: 12
                    },
                    grid: {
                        left: '3%',
                        top: 50,
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'value',
                        show: false,
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        axisLine: {
                            lineStyle: {
                                color: "#FFF"
                            },
                        },
                        name: "工作分配(小时)",
                        nameTextStyle: {
                            color: "rgba(0,0,0,0.5)"
                        },
                        axisLabel: {
                            color: "#000",
                        },
                        type: 'category',
                        data: chartData.names
                    },
                    series: [
                        {
                            name: '已完成',
                            type: 'bar',
                            stack: '总量',
                            label: {
                                normal: {
                                    show: true,
                                    formatter: function (res) {
                                        if (res.data > 3) {
                                            return res.data;
                                        }
                                        return '{a|' + res.data + '}';
                                    },
                                    rich: {
                                        a: {
                                            fontSize: 0.1,
                                            color: '#ffffff'
                                        }
                                    }
                                }
                            },
                            itemStyle: {
                                barBorderRadius: [6, 0, 0, 6]
                            },
                            barWith: 14,
                            color: "#10ADE8",
                            data: chartData.finish
                        },
                        {
                            name: '剩余',
                            type: 'bar',
                            stack: '总量',
                            itemStyle: {
                                borderWidth: 12
                            },
                            label: {
                                normal: {
                                    show: true,
                                    formatter: function (res) {
                                        if (res.data > 3) {
                                            return res.data;
                                        }
                                        return '{a|' + res.data + '}';
                                    },
                                    rich: {
                                        a: {
                                            fontSize: 0.1,
                                            color: '#ffffff'
                                        }
                                    }
                                }
                            },
                            color: "#F6BB16",
                            data: chartData.leave
                        },
                        {
                            name: "多余的",
                            type: 'bar',
                            barWidth: 12,
                            itemStyle: {
                                barBorderRadius: [0, 6, 6, 0]
                            },
                            stack: '总量',
                            color: "#EEEEEE",
                            data: chartData.other
                        },
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
                // }else{
                //     $('#upPicR').html('<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>')
                // }
            };

            //统计信息
            var getStatoic=function () {
                $.ajax({
                    url : "/api/budget/project/status/query/"+id+"/queryTotle",
                    type:"get",
                    success:function (res) {
                        if(res.ok){
                            var data = res.data;
                            var  content ="";
                            var arr=['项目立项','立项评审会','需求评审会','项目启动会','项目执行','项目验收','项目总结会'] ;
                            var num;
                            for (var i = 0;i < data.length; i++) {
                                if (i === 0) {
                                    var img = "<td style=\"color: #67DC97;\"><img src=\"../../assetsInfo/images/green.png\" class='imgMargin'>";
                                } else {
                                    var img = "<td style=\"color: red;\"><img src=\"../../assetsInfo/images/red.png\" class='imgMargin'>";
                                }

                                if(data[i][2] == false) {
                                    if( i > num){
                                        img="<td >"
                                    }

                                    content +="   <li class=\"layui-col-space15 li-disabled \" style=\"height: 130px; width: 16%; position: relative\">\n" +
                                        "                                    <table class=\"layui-table\">\n" +
                                        "                                        <thead>\n" +
                                        "                                        <tr style=\"background-color:#EBEBEB \"><th style=\"text-align: center\">"+ arr[i] +"</th></tr>\n" +
                                        "                                        </thead>\n" +
                                        "                                        <tbody>\n" +
                                        "                                        <tr style=\"background-color:#F5F5F5 \"><td>"+data[i][0]+"</td></tr>\n" +
                                        "  <tr style=\"background-color:#FAFAFA\">" + img +data[i][1]+"</td></tr>\n" +
                                        "                                        </tbody>\n" +
                                        "                                    </table>\n" +
                                        "        <img class=\"imgTri\" src=\"../../assetsInfo/images/icon/ass.png\" alt=\"\" style=\"position: absolute;bottom: 17px;left: 63px;\">\n" +
                                        "                                </li>"
                                } else{
                                    num = i;
                                    content +="   <li class=\"layui-col-space15 layui-this\" style=\"height: 130px; width: 16%; position: relative\">\n" +
                                        "                                    <table class=\"layui-table\">\n" +
                                        "                                        <thead>\n" +
                                        "                                        <tr style=\"background-color:#EBEBEB \"><th style=\"text-align: center\">"+ arr[i] +"</th></tr>\n" +
                                        "                                        </thead>\n" +
                                        "                                        <tbody>\n" +
                                        "                                        <tr style=\"background-color:#F5F5F5 \"><td><img class='imgMargin' src='../../assetsInfo/images/choose.png' >"+data[i][0]+"</td></tr>\n" +
                                        "  <tr style=\"background-color:#FAFAFA\"><td> -- </td></tr>\n" +
                                        "                                        </tbody>\n" +
                                        "                                    </table>\n" +
                                        "                                    <img class=\"imgTri\" src=\"../../assetsInfo/images/icon/ass.png\" alt=\"\" style=\"position: absolute;bottom: 17px;left: 63px;\">\n" +
                                        "                                </li>"
                                }

                            }
                            $("#staticInfo").html("");
                            $("#staticInfo").html(content);

                        }
                    }
                })
            };

//            var ele = document.getElementsByClassName("table-cont");
//            function scrollHandle (e){
//                var scrollTop = this.scrollTop;
//                this.querySelector('thead').style.transform = 'translateY(' + scrollTop + 'px)';
//            }
//
//            for ( var item in ele ) {
//                item.addEventListener('scroll', scrollHandle)
//            }

            var showStaticInfo = function (id) {
                $.ajax({
                    url: "/api/budget/project/status/query/"+id+"/queryWorkTime",
                    type: "get",
                    success: function (res) {
                        if(res.ok){
                            if(res.data.memberStatusVO){
                                var data=res.data.memberStatusVO[0];
                                var  content ="<table class=\"staticInfo\">\n" +
                                    "                                        <thead>\n" +
                                    "                                            <tr style=\"background-color: #10ADE8;\">\n" +
                                    "                                                <td>参与人员</td>\n" +
                                    "                                                <td>职位</td>\n" +
                                    "                                                <td>任务数</td>\n" +
                                    "                                                <td>已完成</td>\n" +
                                    "                                                <td>任务完成度</td>\n" +
                                    "                                                <td>已用/预计工时</td>\n" +
                                    "                                            </tr>\n" +
                                    "                                        </thead>";
                                for(var i of data){
                                    var position = i.position;
                                    if(!position  ){
                                        position = "暂无"
                                    }
                                    content +="<tr>\n" +
                                        "                                            <td>\n" +
                                        "                                                <span style='float: left;margin-left: 28%;'>\n" +
                                        "                                                    <img src=\"../../assetsInfo/images/tx.png\" width=\"30\">\n" +
                                        "                                                </span>\n" +
                                        "                                                <span style='    float: left;width: 46%;'>"+i.name +"</span>\n" +
                                        "                                            </td>\n" +
                                        "                                            <td>"+ position +"</td>\n" +
                                        "                                            <td>"+i.taskNum +"</td>\n" +
                                        "                                            <td>"+i.completeTaskNum +"</td>\n" +
                                        " <td>\n" +
                                        "                                                <div class='jdtall'>\n" +
                                        "                                                    <span class='jindutiao' ><span class='dwjindutiao' style='width:" +i.mark+ "'></span></span>\n" +
                                        "                                                    " +
                                        "                                                </div>\n" +
                                        "                                                <span >"+i.mark+"</span>\n" +
                                        "                                            </td>"+
                                        "                                            <td>"+ (i.statistics?i.statistics:"0/0")+"</td>\n" +
                                        "                                        </tr>"
                                }
                                content += "</table>"  ;
                                // $(".getStaticInfoone").html("");
                                // $(".getStaticInfoone").html(content);
                                // $(".getStaticInfotwo").html("");
                                // $(".getStaticInfotwo").html(content);
                                // $(".getStaticInfothree").html("");
                                // $(".getStaticInfothree").html(content);
                                $("#getStaticInfofour").html("");
                                $("#getStaticInfofour").html(content);
                                // $(".getStaticInfofive").html("");
                                // $(".getStaticInfofive").html(content);
                                autoSize();
                            }else{
                                var content ='<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>';
                                $("#getStaticInfofour").html("");
                                $("#getStaticInfofour").html(content);
                                autoSize();
                            }

                        }
                    }
                });
            };
            var autoSize = function(){
                $("#processList").height(140 + $("#projectDetailDiv .layui-show").height() + "px");
                //项目进度原来的高度由140改为40
                // $("#processList").height(40 + $("#projectDetailDiv .layui-show").height() + "px");
                if ( $("#projectBudget").height() > $("#projectDetail").height() ) {
                    $("#projectDetail").height($("#projectBudget").height());
                } else {
                    $("#projectBudget").height($("#projectDetail").height());
                }
            };
            $(window).resize(function () {
                autoSize();
            });

            // 展示绩效管理的echarts
            var showPerformance = function (chartData) {
                // if (chartData != null && chartData.names != null && chartData.firstQuarter != null && chartData.firstQuarter != null && chartData.secondQuarter != null && chartData.thirdQuarter != null && chartData.fourthQuarter != null && chartData.aveQuarter != null) {
                // 图表初始化
                var myChart = echarts.init(document.getElementById("performance"));
                // 图表配置项
                chartData = chartData ? chartData : {};
                var option = {
                    legend: {
                        data: [{name: '第一季度', icon: "circle"},
                            {name: '第二季度', icon: "circle"},
                            {name: '第三季度', icon: "circle"},
                            {name: '第四季度', icon: "circle"},
                            {name: '平均绩效', icon: "line"}],
                        itemWidth: 20,
                        itemHeight: 12
                    },
                    tooltip: {},
                    grid: {
                        left: '3%',
                        right: '5%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            data: (chartData.hasOwnProperty("names") ? chartData.names : []),
                            nameGap: 5,
                            name: '人员',
                            nameTextStyle: {
                                color: "rgba(0,0,0,0.5)"
                            },
                            axisLine: {
                                lineStyle: {
                                    color: "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '分数',
                            nameTextStyle: {
                                color: "rgba(0,0,0,0.5)"
                            },
                            axisLine: {
                                lineStyle: {
                                    color: "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            name: '第一季度',
                            type: 'bar',
                            color: '#55B7FF',
                            barWidth: '25',
                            stack: 'score',
                            data: (chartData.hasOwnProperty("firstQuarter") ? chartData.firstQuarter : [])
                        },
                        {
                            name: '第二季度',
                            type: 'bar',
                            color: "#94E3E3",
                            stack: 'score',
                            data: (chartData.hasOwnProperty("secondQuarter") ? chartData.secondQuarter : [])
                        },
                        {
                            name: '第三季度',
                            type: 'bar',
                            color: "#7ED321",
                            stack: 'score',
                            data: (chartData.hasOwnProperty("thirdQuarter") ? chartData.thirdQuarter : [])
                        },
                        {
                            name: '第四季度',
                            type: 'bar',
                            color: "#FADB5E",
                            stack: 'score',
                            data: (chartData.hasOwnProperty("fourthQuarter") ? chartData.fourthQuarter : [])
                        },
                        {
                            name: '平均绩效',
                            type: 'line',
                            symbol: "circle",
                            symbolSize: 9,
                            color: "#FF9E98",
                            itemStyle: {
                                borderColor: "#fff",
                                borderWidth: 3
                            },
                            lineStyle: {
                                shadowBlur: 10,
                                shadowColor: "#FF9E98"
                            },
                            data: (chartData.hasOwnProperty("aveQuarter") ? chartData.aveQuarter : [])
                        }
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
                // }else{
                //     $('#performance').html('<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>');
                // }
            };

            // 展示预算收支的echarts
            var showFinanciial = function (chartData) {
                // if(chartData !=null && Object.getOwnPropertyNames(chartData).length != 0){
                // 图表初始化
                var myChart=echarts.init(document.getElementById("financial"));
                chartData = chartData?chartData:{};
                // 图表配置项
                var option={
                    legend: {
                        data:[{name : '支出'},
                            {name : '收入'},
                            {name : '利润',icon : "line"}],
                        itemWidth : 20,
                        itemHeight : 12
                    },
                    grid: {
                        left: '3%',
                        right: '5%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            data: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
                            axisPointer: {
                                type: 'shadow'
                            },
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '预算(万元)',
                            nameTextStyle:{
                                color : "rgba(0,0,0,0.5)",
                                padding : [0,0,0,30]
                            },
                            axisLabel: {
                                formatter: '{value}'
                            },
                            splitLine : {
                                show : false
                            },
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            name:'支出',
                            type:'bar',
                            data:chartData.hasOwnProperty("expenses")?chartData.expenses:[],
                            label : {
                                show : true,
                                position : "top"
                            },
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0,color: '#55B7FF'},
                                {offset: 1,color: '#C2EFFF'}
                            ])

                        },
                        {
                            name:'收入',
                            type:'bar',
                            data:chartData.hasOwnProperty("income")?chartData.income:[],
                            label : {
                                show : true,
                                position : "top"
                            },
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0,color: '#FADB5E'},
                                {offset: 1,color: '#FFEFC2'}
                            ])
                        },
                        {
                            name:'利润',
                            type:'line',
                            data:chartData.hasOwnProperty("profit")?chartData.profit:[],
                            symbol : "circle",
                            symbolSize : 9,
                            color : "#FF9E98",
                            itemStyle : {
                                borderColor : "#fff",
                                borderWidth : 3
                            },
                            lineStyle : {
                                shadowBlur :  10,
                                shadowColor : "#FF9E98"
                            }
                        }
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
                // }else{
                //     $('#financial').html('<p style="text-align: center"><img src="../../assetsInfo/images/back2.png"></p>');
                // }

            };
            var getWorkProgress = function (infoData) {
                table.render({
                    elem: '#workProgressTable',
                    url: admin.formatUrl('/api/research/progress/page?researchProjectId='+id), //数据接口
                    method: 'GET',
                    id: 'workProgressTable',
                    // 格式化后台返回的数据
                    parseData: function (res) { //res 即为原始返回的数据
                        for (var i = 0; i <res.data.list.length ; i++) {
                            if(res.data.list[i].extInfo1==0){
                                res.data.list[i].extInfo1='未完成'
                            }else{
                                res.data.list[i].extInfo1='已完成'
                            }
                        }
                        // 返回结果，进行渲染表格
                        return {
                            "code": res.respCode, //解析接口状态
                            "count": res.data.count,
                            "msg": res.message, //解析提示文本
                            "data": res.data.list //解析数据列表
                        };
                    },
                    request: {
                        pageName: 'page',
                        limitName: 'pageSize'
                    },
                    page:true,
                    cols: [
                        [ {
                            type: 'numbers',
                            title: '序号',
                            fixed: 'left',
                            width:80
                        },{
                            title: '检查内容',
                            field: 'checkDetail',
                            align: 'center'
                        }, {
                            title: '检查时间',
                            field: 'date',
                            align: 'center',
                            templet: function (row) {
                                if (row.date) {
                                    return '<div title="'+tools.getDate(row.date,"YYYY-MM-DD")+'"><span>'+ tools.getDate(row.date,"YYYY-MM-DD") +'</span></div>' ;
                                }
                            }
                        },{
                            title: '检查情况',
                            field: 'extInfo1',
                            align: 'center'
                        }, {
                            title: '操作',
                            align: 'center',
                            toolbar:'#workProgressTool'
                        }]
                    ],
                });
                table.on('tool(workProgressTable)', function (obj) {
                    // 获取点击列的数据
                    var data = obj.data;
                    var layEvent = obj.event;
                    if( layEvent=="btn-work-edit"){
                        var isClick = false;
                        if(infoData.projectMemberIds&&infoData.projectMemberIds.length!=0){
                            for(var i =0;i<infoData.projectMemberIds.length;i++){
                                var curInfo = infoData.projectMemberIds[i];
                                if(curInfo==config.getAccount().usid){
                                    isClick = true;
                                }
                            }
                        }else{
                            isClick = false;
                        }
                        for(var j =0;j<config.getAccount().rolesstr.length;j++){
                            if(config.getAccount().rolesstr[j]=='ZVXUGCP56D'){
                                isClick = true;
                            }
                        }
                        if(isClick){
                            admin.req('/api/activiti/repository/getProcessStartRequestForm', {
                                processDefinitionKey: 'p0d341ec07f034170a797be3a2d164c3d'
                            }, function (result) {
                                if (result.ok && result.data != null) {
                                    if (result.data.id.indexOf('.html') > 0) {
                                        // 外部表单流程
                                        admin.popupCenter({
                                            title: '启动流程',
                                            path: 'components/tpl/process_def_tpl_start.html',
                                            area: ['90%', '90%'],
                                            finish: function () {

                                            },
                                            success: function () {
                                                $("#process_def_tpl_start").load(result.data
                                                    .id);
                                                $("#process_id").val(data.processId);
                                                $("#process_key").val(data.processKey);
                                                $("#isExternalForm").val('1');
                                            }
                                        });
                                    } else {
                                        // 正常流程
                                        admin.req('/api/form/' + result.data.id, {}, function (response) {
                                            if (response.data.design == 1) {} else {
                                                var newData = $.extend({}, data, result);
                                                newData.processDefinitionKey='p0d341ec07f034170a797be3a2d164c3d';
                                                ADCFormDesignHelper.startProcess(newData, function () {
                                                    getProgress(id,true,infoData);
                                                    table.reload('workProgressTable');
                                                },id,false,false,data);
                                            }
                                        });
                                    }
                                }

                            }, {
                                method: 'POST'
                            });
                        }else{
                            return  layer.msg('非项目组成员无权限启动', {
                                icon: 5
                            });
                        }
                    }else if(layEvent=="btn-work-look"){
                        var dataObj={
                            name:'《科研项目节点检查纪录表》',
                            processInstanceId:data.extInfo2,
                        };
                        admin.popupCenter({
                            title: '查看任务：' + dataObj.name,
                            path: 'components/tpl/process_my_tpl_view.html',
                            area: ['100%', '100%'],
                            resize: false,
                            finish: function () { },
                            success: function () {
                                process_my_tpl_view(dataObj);
                            }
                        });
                    }

                });
            };
            var showPerson = function (xData,yData) {
                // 图表初始化
                var myChart=echarts.init(document.getElementById("research-persons"));
                myChart.resize();
                var max = Math.max.apply(null,yData);
                max = (parseInt(max/100) + 1) * 100 + 50;
                // 图表配置项
                var option={
                    legend: {
                        data:[{name : '工作量'}],
                        itemWidth : 20,
                        itemHeight : 12
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        top : 50,
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            data: xData,
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '投入人力(天)',
                            // max : max,
                            nameTextStyle:{
                                color : "rgba(0,0,0,0.5)"
                            },
                            splitLine : {
                                show : false
                            },
                            axisLabel: {
                                formatter: '{value}'
                            },
                            axisLine : {
                                lineStyle : {
                                    color : "rgba(0,0,0,0.5)"
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            name:'工作量',
                            type:'bar',
                            data:yData,
                            label : {
                                show : true,
                                position : "top"
                            },
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0,color: '#55B7FF'},
                                {offset: 1,color: '#D1F3FF'}
                            ]),
                            barWidth : 14,
                            itemStyle : {
                                barBorderRadius : [3,3,0,0]
                            }
                        }
                    ]
                };
                // 进行图表配置
                myChart.setOption(option);
            };
            //科研工时统计新接口
            var getManDayByMonth=function(year){
                admin.req('/api/statistics/projectWorktime/getManDayByMonth/'+id+'/'+year , {}, function(res) {
                    if (res.ok) {
                        var xData=[1,2,3,4,5,6,7,8,9,10,11,12];
                        var yData=[0,0,0,0,0,0,0,0,0,0,0,0];
                        for (var i = 0; i <res.data.length ; i++) {
                            yData[res.data[i].month-1]=res.data[i].worktime.toFixed(2);
                        }
                        showPerson(xData,yData)
                    } else {
                        return layer.msg('获取信息失败' + res.message, {
                            icon: 5
                        });
                    }
                }, {
                    method: 'get'
                });
            };
            //获取历史有数据的年份
            var  getAllYear =function () {
                    var elem = $('#research_year');
                    elem.empty().append('');
                    var arr =[new Date().getFullYear(),new Date().getFullYear()-1];
                    for (var i = 0; i < arr.length; i++) {
                        if (arr[i]) {
                            if (i == 0) {
                                elem.empty().append('<option selected value="' + arr[i] + '">' + arr[i] + '</option>')
                            } else {
                                elem.append('<option  value="' + arr[i] + '">' + arr[i] + '</option>');
                            }
                        }
                 }
                form.render('select');
                getManDayByMonth(arr[0]);
            };
            form.on('select(research_year)', function(data) {
                getManDayByMonth(data.value);
            });
            getAllYear();
            var setInvoice = function (data,infoTitle) {
                var sumNum=0;
                for (var i = 0; i <data.projectContractInvoiceEOList.length ; i++) {
                    data.projectContractInvoiceEOList[i].invoiceDate=data.projectContractInvoiceEOList[i].invoiceDate?tools.getDate(data.projectContractInvoiceEOList[i].invoiceDate,"YYYY-MM-DD"):'';
                    sumNum+=Math.round(data.projectContractInvoiceEOList[i].invoiceAmount / 10000);
                }
                $("#sumProject").html(sumNum);
                // 渲染表格
                table.render({
                    elem: '#contractInfo',
                    id: 'contractInfo',
                    data:data.projectContractInvoiceEOList,
                    // height: 472,
                    cols: [
                        [{
                            title: '序号',
                            type: 'numbers',
                            fixed:'left',
                            align: 'center',
                            width:100
                        }, {
                            field: 'status',
                            title: '日期',
                            align: 'center',
                            templet:function(d) {
                                var text=d.invoiceDate;
                                return '<div  title="'+text+'"><span>'+ text +'</span></div>'
                            }
                        }, {
                            // field: 'recieveMoneyDate',
                            title: '事项',
                            align: 'center',
                            templet:function(d) {
                                // var text= d.receiveUserName ? d.receiveUserName : "";
                                return '<div title="'+infoTitle+'"><span>'+ infoTitle +'</span></div>'
                            }
                        },  {
                            field: 'invoiceAmount',
                            title: '金额',
                            align: 'center',
                            templet:function(d) {
                                var text= d.invoiceAmount ? d.invoiceAmount : 0;
                                return '<div title="'+text+'"><span>'+ text +'</span></div>'
                            }
                        }]
                    ],
                    cellMinWidth: 90,
                    limit: data.projectContractInvoiceEOList.length
                });
            };
            // 渲染项目详情
            var showDetail = function (data) {
                var detail = "";
                if(data.businessId.indexOf('rs_')!=-1) {
                    $('.task-timeline-info').empty();
                    $('#projectProgress').css('display','block');
                    $('#projectProgress .card-padding').css('height','580px');
                    $('#deliverable').css('display','none');
                    $('#noBusiness').css('display','block');
                    $('#milestone').css('display','none');
                    $('#workProgress').css('display','block');
                    getProgress(id,true,data);
                    getWorkProgress(data);
                   var projectTime = (data.projectBeginTime?tools.getDate(data.projectBeginTime,"YYYY.MM.DD"):"")+'-'+(data.projectEndTime?tools.getDate(data.projectEndTime,"YYYY.MM.DD"):"");
                    detail += '<div class="layui-row ">' +
                        '<div class="layui-col-md4 " style="padding-right: 2px">' +
                        '<div class="width30 form-left" ><span>合同编号:</span></div>' +
                        '<div class="width60 form-right" title="'+(data.contractNo?data.contractNo:"")+'" style="cursor: default"><p>'+(data.contractNo?data.contractNo:"")+'</p></div>' +
                        // '<div class="width60 form-right" title="' + data.name + '" style="cursor: default"><p>' +  (data.name.length>conNum?(data.name.substring(0,conNum)+'...'):data.name)+ '</p></div>' +
                        '</div>' +
                        '<div class="layui-col-md4 " style="padding-right: 2px">' +
                        '<div class="width30 form-left" ><span>项目状态:</span></div>' +
                        '<div class="width60 form-right" title="'+(data.finishedStatus?data.finishedStatus:"")+'" style="cursor: default"><p>' +  (data.finishedStatus?data.finishedStatus:"")+ '</p></div>' +
                        '</div>' +
                        '<div class="layui-col-md4 " style="padding-right: 2px">' +
                        '<div class="width30 form-left " ><span>项目类型:</span></div>' +
                        '<div class="width60 form-right" title="'+(data.business?data.business:"")+ '" style="cursor: default"><p>' +(data.business?data.business:"")+ '</p></div>' +
                        '</div>' +
                        '</div>'+
                        '<div class="layui-row ">' +
                        '<div class="layui-col-md4 " style="padding-right: 2px">' +
                        '<div class="width30 form-left" ><span>项目名称:</span></div>' +
                        '<div class="width60 form-right" title="'+(data.name?data.name:"")+'" style="cursor: default"><p>'+(data.name?data.name:"")+'</p></div>' +
                        '</div>' +
                        '<div class="layui-col-md4 " style="padding-right: 2px">' +
                        '<div class="width30 form-left" ><span>起止日期:</span></div>' +
                        '<div class="width60 form-right"><p title="'+projectTime+'">' + projectTime + '</p></div>' +
                        '</div>' +
                        '</div>'+
                        '<div class="layui-row ">' +
                        '<div class="layui-col-md4 " style="padding-right: 2px">' +
                        '<div class="width30 form-left" ><span>项目负责人:</span></div>' +
                        '<div class="width60 form-right" title="'+(data.projectLeader?data.projectLeader:"")+'" style="cursor: default"><p>'+(data.projectLeader?data.projectLeader:"")+'</p></div>' +
                        '</div>' +
                        '<div class="layui-col-md4 " style="padding-right: 2px">' +
                        '<div class="width30 form-left" ><span>项目组成员:</span></div>' +
                        '<div class="width60 form-right" title="' + data.projectMemberNames + '" style="cursor: default"><p>' + (data.projectMemberNames.length>conNum?(data.projectMemberNames.substring(0,conNum)+'...'):data.projectMemberNames)+ '</p></div>' +
                        '</div>' +
                        '</div>'+
                        '</div>';
                } else {
                    if (!data.projectContractInvoiceEOList) {
                        $('.task-timeline-info').empty();
                        $('#projectProgress').css('display', 'none');
                        $('#deliverable').css('display', 'none');
                        $('#noBusiness').css('display', 'block');
                        $('#milestone').css('display', 'none');
                        $('#workProgress').css('display', 'none');
                        detail += ' <div class="layui-row ">' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="layui-col-md2 form-left" ><b>项目名称:</b></div>' +
                            '<div class="layui-col-md10 form-right" title="' + data.name + '" style="cursor: default"><p>' + data.name + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="layui-col-md2 form-left"><b>所属业务:</b></div>' +
                            '<div class="layui-col-md10 form-right"><p title="' + data.budget + '"  style="cursor: default;">' + data.budget + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="layui-col-md2 form-left" ><b>负责人:</b></div>' +
                            '<div class="layui-col-md10 form-right" ><p>' + data.projectLeader + '</p></div>' +
                            '</div>' +

                            '</div>' +
                            '<div class="layui-row ">' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="layui-col-md2 form-left" ><b>创建时间:</b></div>' +
                            '<div class="layui-col-md10 form-right"><p>' + tools.getDate(data.createTime, "YYYY.MM.DD") + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="layui-col-md2 form-left" ><b>项目状态:</b></div>' +
                            '<div class="layui-col-md10 form-right" ><p id="proStatus">' + data.finishedStatus + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="layui-col-md2 form-left " ><b>项目简介:</b></div>' +
                            '<div class="layui-col-md10 form-right "  title="' + (data.projectDescription ? data.projectDescription : "暂无") + '"><p class="multi-line">' + (data.projectDescription ? data.projectDescription : "暂无") + '</p></div>' +
                            '</div>' +
                            '</div>';
                    } else {
                        $('#projectProgress').css('display', 'block');
                        $('#projectProgress .card-padding').css('height','700px');
                        $('#deliverable').css('display', 'block');
                        $('#noBusiness').css('display', 'none');
                        $('#milestone').css('display', 'block');
                        $('#workProgress').css('display', 'none');
                        $('#statusChange').val('全部');
                        getProgress(id,false,data);
                        renderTable(id, '', data.name);
                        renderTree(id);
                        var contractAmount = '';
                        if (data.contractAmountStr) {
                            contractAmount = data.contractAmountStr;
                        } else {
                            contractAmount = data.contractAmount;
                        }
                        detail += '<div class="layui-row ">' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>项目名称:</span></div>' +
                            '<div class="width60 form-right" title="' + data.name + '" style="cursor: default"><p>' + (data.name.length > conNum ? (data.name.substring(0, conNum) + '...') : data.name) + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>合同编号:</span></div>' +
                            '<div class="width60 form-right" title="' + (data.contractNo ? data.contractNo : "") + '" style="cursor: default"><p>' + (data.contractNo ? data.contractNo : "") + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left " ><span>合同企业名称:</span></div>' +
                            '<div class="width60 form-right" title="' + data.projectOwner + '" style="cursor: default"><p>' + (data.projectOwner.length > conNum ? (data.projectOwner.substring(0, conNum) + '...') : data.projectOwner) + '</p></div>' +
                            '</div>' +
                            '</div>' +
                            '<div class="layui-row ">' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>合同金额:</span></div>' +
                            '<div class="width60 form-right" title="' + (contractAmount ? contractAmount : "") + '" style="cursor: default"><p>' + (contractAmount ? contractAmount : "") + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>合同签订时间:</span></div>' +
                            '<div class="width60 form-right"><p>' + (data.projectStartTime ? tools.getDate(data.projectStartTime, "YYYY.MM.DD") : "") + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left " ><span>合同内部联系人:</span></div>' +
                            '<div class="width60 form-right" title="' + data.projectLeader + '" style="cursor: default"><p>' + data.projectLeader + '</p></div>' +
                            '</div>' +
                            '</div>' +
                            '<div class="layui-row ">' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>项目组成员:</span></div>' +
                            '<div class="width60 form-right" title="' + data.projectMemberNames + '" style="cursor: default"><p>' + (data.projectMemberNames.length > conNum ? (data.projectMemberNames.substring(0, conNum) + '...') : data.projectMemberNames) + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>业务类型:</span></div>' +
                            '<div class="width60 form-right" title="' + data.business + '" style="cursor: default"><p>' + data.business + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left " ><span>所属业务:</span></div>' +
                            '<div class="width60 form-right" title="' + data.budget + '" style="cursor: default"><p>' + (data.budget.length > conNum ? (data.budget.substring(0, conNum) + '...') : data.budget) + '</p></div>' +
                            '</div>' +
                            '</div>' +
                            '<div class="layui-row ">' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>预计人力投入:</span></div>' +
                            '<div class="width60 form-right" title="' + (data.personInput ? data.personInput : "") + '" style="cursor: default"><p>' + (data.personInput ? data.personInput : "") + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>项目描述:</span></div>' +
                            '<div class="width60 form-right "  title="' + (data.projectDescription ? data.projectDescription : "暂无") + '"><p class="multi-line">' + (data.projectDescription ? (data.projectDescription.length > conNum ? (data.projectDescription.substring(0, conNum) + '...') : data.projectDescription) : "暂无") + '</p></div>' +
                            '</div>' +
                            '<div class="layui-col-md4 " style="padding-right: 2px">' +
                            '<div class="width30 form-left" ><span>认领信息:</span></div>' +
                            '<div class="width60 form-right" title="claimInfo" style="cursor: default"><p> ' +
                                (data.createUserName ? '由'+data.createUserName +
                                    (data.startTime ?'在'+ tools.getDate(data.startTime, "YYYY.MM.DD") : "")+
                                        '认领此项目' : "") + '</p></div>' +
                            '</div>' +

                            '</div>';
                    }
                }
                    $("#projectDetailInfo").html("");
                    $("#projectDetailInfo").append(detail);
                    $('.width30').css('width', width30);
                    $('.width60').css('width', width60);
                    if (data.projectContractInvoiceEOList) {
                        $("#budgetLook").css("display","block");
                        setInvoice(data,"开票");
                        // tableContractInit(data, '#contractInfo', false);
                    }else{
                        $("#budgetLook").css("display","none");
                    }
            };

            // 查询项目详情
            var getBusinessDetail = function (){
                $.ajax({
                    url: "/api/budget/project/query/" + id,
                    type: 'get',
                    success: function (res) {
                        if (res.ok) {
                            //根据后台字段判断是否可点击完成 personInput字段和枚举找后台确定再修改
                            if(res.data.projectLeaderId!=config.getAccount().usid)
                            {
                                $('#finishPro').css('display','none');

                            }
                            else  if(res.data.btnFlag!=0){
                                $('#finishPro').css('display','block');
                                $('#finishPro').attr("disabled","disabled")

                            }else {
                                $('#finishPro').css('display','block');
                                $('#finishPro').removeAttr('disabled');
                                $('#finishPro').off('click').on("click",function () {
                                    console.log("项目完成")
                                    //approveUserId 待后台改成一个人之后 确认是数组还是字符串
                                    if(!res.data.approveUserId)
                                    {
                                        return layer.msg('项目信息审批人为空，不能关闭，请联系管理员！', {
                                            icon: 5});
                                    }
                                    var approveUserId=res.data.approveUserId.split(",")
                                    var vars = "[{'name':'major','value':'"+approveUserId[0]+"'},{'name':'btnType','value':'审批中'}]"
                                    var makeupoliet = {
                                        variables:eval(vars),
                                        processDefinitionKey:'pa9ab387856d24dd19f47e072a3dd6f1c',
                                        businessKey:id //id
                                    };
                                    //给自研传流程
                                    layui.admin.req('/api/budget/project/changeFinshStatus', makeupoliet,
                                        function (result) {
                                            //    改变状态
                                            if(result.ok){
                                                $("#proStatus").text("审批中")
                                                $('#finishPro').attr("disabled","disabled");
                                                layer.msg('项目已关闭，请等待审批！', {
                                                    icon: 1
                                                });

                                            }
                                        },{
                                            method: 'POST'
                                        });
                                    //    //给qiushi传状态vm
                                    //    $.ajax({
                                    //                 url: "/api/budget/project/changeFinshStatus/"+id+ "/"+res.data.finishedStatus,
                                    //                 type: 'get',
                                    //                 success: function (res) {
                                    //                     if(res.respCode!=0){
                                    //                         return layer.msg('关闭项目失败:' + res.message, {
                                    //                                     icon: 5
                                    //                                 });
                                    //                      }


                                    //                 }
                                    //             })

                                })
                            }
                            // 渲染项目详情
                            showDetail(res.data);
                            // getStatoic(id);
                            // showStaticInfo(id);
                            // 动态修改左侧详情信息的高度
                            if ( $("#projectBudget").height() > $("#projectDetail").height() ) {
                                $("#projectDetail").height($("#projectBudget").height());
                            } else {
                                $("#projectBudget").height($("#projectDetail").height());
                            }
                        }
                    }
                });
            };
            getBusinessDetail();

            // 查询echarts数据
            var getUpDetail = function (){
                $.ajax({
                    url: "/api/budget/project/status/query/" + id + "/queryWorkTime",
                    type: 'get',
                    success: function (res) {
                        if (res.ok) {
                            res.data = res.data?res.data:{};
                            var echartsData = tidyData ( res.data );
                            // showUpL(res.data);
                            // showUpR(echartsData);
                            // showPerformance(res.data.projectAchievementsChartVO);
                            // showQuality(res.data.bugDensity);
                            // showFinanciial(res.data.financeChart);

                        }
                    }
                });
            };
            var tidyData = function(data){

                var echartData = {};
                var names = [];
                var finish = [];
                var leave = [];
                var other = [];
                if ( data.hasOwnProperty("memberWorkTimeMap")){
                    for ( var index in data.memberWorkTimeMap ){
                        names.push(index);
                        finish.push(data.memberWorkTimeMap[index]["已完成"]);
                        leave.push(data.memberWorkTimeMap[index]["剩余"]);
                        other.push(50-data.memberWorkTimeMap[index]["已完成"]-data.memberWorkTimeMap[index]["剩余"]);
                    }
                }
                echartData.names = names;
                echartData.finish = finish;
                echartData.leave = leave;
                echartData.other = other;
                return echartData;
            };
            getUpDetail();
            getProjectFile(id);
        }

        // 子任务 任务交付物
        function taskDetailChild(id){
            projectId = id;
            function getTaskChildProjectFile(){
                searchFile({pageSize:downSize,page:1,projectId:projectId});
                // 创建一个上传组件
                if(taskChild_fileUpload == null){
                    taskChild_fileUpload = upload.render({
                        elem: '#taskChild-upload-project-file',
                        url: '/api/sys/file/upload',
                        accept: 'file',
                        exts: exts,
                        size: 50*1024,
                        before: function(obj){
                            // 动态付参数，不能鞋写在外部，否则projectId固定了
                            this.data={userId:config.getAccount().usid,filePath:'c',foreignId:projectId}
                        },
                        done: function(res, index, upload){ //上传后的回调
                            if(res.respCode==0) {
                                searchFile({pageSize:downSize,page:1,projectId:projectId})
                            }
                            else{
                                return layer.msg('上传失败:' + res.message, {
                                    icon: 5
                                });
                            }
                        }
                    })
                }
                function searchFile(params){
                    admin.req('/api/budget/taskResult/queryTaskResultFilePageByTaskId/'+params.projectId+'/'+params.page+'/'+params.pageSize,
                        {}, function(res) {
                            if(res.respCode=='0') {
                                if(res.data.list && res.data.list.length!=0){
                                    $('.taskinfoNotic').hide();
                                }else{
                                    $('.taskinfoNotic').show();
                                }
                                var arr_taskChild = [];// 错误数据不进行渲染
                                for(var item of res.data.list) {
                                    if(null == item.fileId){
                                        continue;
                                    }else {
                                        var it = {
                                            icon: '../../assetsInfo/images/detailPage/' + extsImage[item.fileType] + '.png',
                                            href: ' /api/sys/file/'+item.fileId+'/download',
                                            date: new Date(item.uploadTime).toLocaleDate(),
                                            fileName: item.fileName+'.'+item.fileType,
                                            size: item.fileSize,
                                            uploader: item.uploadUserName,
                                            fileId:item.fileId
                                        }
                                        arr_taskChild.push(it);
                                    }
                                }
                                vm.set({
                                    fileList: arr_taskChild
                                })
                                if(params.page==1) {
                                    initPage(res.data.count)
                                }
                                $('.delProFile').off('click').on('click',function(){
                                    var fileId = $(this).attr('fileId');
                                    var fileName = $(this).attr('fileName');
                                    layer.confirm('确定删除文件: '+fileName+ '吗？', {
                                        icon: 3,
                                        title: '提示'
                                    }, function() {
                                        // admin.req('/api/budget/project/file/' + fileId, {}, function(data) {
                                        admin.req('/api/sys/file/deleteFileByFileId/' + fileId, {}, function(data) {
                                            if (data.ok) {
                                                layer.msg('删除文件成功！', {
                                                    icon: 1
                                                });
                                                searchFile({pageSize:downSize,page:1,projectId:projectId})
                                            } else {
                                                return layer.msg('删除文件失败：' + data.message, {
                                                    icon: 5
                                                });
                                            }
                                        }, {method: 'delete'});
                                    });
                                });
                            } else{
                                layer.msg('查询失败!', {
                                    icon: 5
                                });
                            }
                        },{method:"get"});
                }
                function initPage(count) {
                    // 修改layui page 分页样式 制作简易版 分页 去掉边框，修改选种样式  修改前一页和下一页样式
                    laypage.render({
                        elem: 'taskChild-file-page',
                        count: count,
                        limit: downSize,
                        jump: function(obj, first){
                            $('#taskChild-file-page .layui-laypage-prev').html("<i class='layui-icon layui-icon-left'></i>");
                            $('#taskChild-file-page .layui-laypage-next').html("<i class='layui-icon layui-icon-right'></i>");
                            if(!first) {
                                searchFile({pageSize:downSize,page:obj.curr,projectId:projectId})
                            }
                        },
                    });
                }
            }
            getTaskChildProjectFile();

            // 渲染下级任务详情
            var showDetails = function (data) {
                if(data){
                    var details = "";
                    details += '<div class="layui-row" style="margin-bottom: 5px;">' +
                                    '<div class="layui-col-md3">' +
                                        '<p>' +
                                            '<div class="layui-col-md4" style="width:70px;!important"><b>任务名称:</b></div>' +
                                            '<div class="layui-col-md8" style="color:#666"><p>' + data.childTaskName + '</p></div>' +
                                        '</p>' +
                                        '<p>' +
                                            '<div class="layui-col-md4" style="width:70px;!important"><b>任务状态:</b></div>' +
                                            '<div class="layui-col-md8" style="color:#666" id="childTaskStatus"><p>' + data.status + '</p></div>' +
                                        '</p>' +
                                    '</div>' +
                                    '<div class="layui-col-md3">' +
                                        '<p>' +
                                            '<div class="layui-col-md4" style="width:70px;!important"><b>开始时间:</b></div>' +
                                            '<div class="layui-col-md8" style="color:#666"><p>' + tools.getDate(data.planStartTime,"YYYY-MM-DD HH:mm:ss") + '</p></div>' +
                                        '</p>' +
                                    '</div>' +
                                    '<div class="layui-col-md3">' +
                                        '<p>' +
                                            '<div class="layui-col-md4" style="width:70px;!important"><b>结束时间:</b></div>' +
                                            '<div class="layui-col-md8" style="color:#666"><p>' + tools.getDate(data.planEndTime,"YYYY-MM-DD HH:mm:ss") + '</p></div>' +
                                        '</p>' +
                                    '</div>' +
                                    '<div class="layui-col-md3">' +
                                        '<p>' +
                                            '<div class="layui-col-md4" style="width:70px;!important"><b>任务成员:</b></div>' +
                                            '<div class="layui-col-md8" style="color:#666"><p>' + data.personName + '</p></div>' +
                                        '</p>' +
                                    // '<p>' +
                                    //      '<div class="layui-col-md4" style="width:70px;!important"><b>优先级:</b></div>' +
                                    //      '<div class="layui-col-md8" style="color:#E84A10;font-weight: bold"><p>' + data.priority + '</p></div>' +
                                    // '</p>' +
                                    '</div>' +
                                '</div>';
                    $("#childTask").html("");
                    $("#childTask").append(details);
                }
            };

            // 查询下级任务详情
            var getTaskDetails = function (){
                $.ajax({
                    url: "/api/budget/childrentask/query/" + id,
                    type: 'get',
                    success: function (res) {
                        if (res.ok) {
                            var arr = res.data.taskResultEOList;
                            //根据后台字段判断是否可点击完成 personInput字段和枚举找后台确定再修改
                            if(res.data.btnFlag==1){
                                $('#finishTaskChild').css("display","inline-block");
                                $('#finishTaskChild').attr("disabled","disabled");
                            }else if(!res.data.btnFlag){
                                $('#finishTaskChild').css("display","none");
                            }else if(res.data.btnFlag==0){
                                $('#finishTaskChild').css("display","inline-block");
                                $('#finishTaskChild').removeAttr("disabled");
                                $('#finishTaskChild').off('click').on("click",function () {

                                    // if(arr && arr.length!=0){
                                    if(arr){
                                        var processDefinitionKey='p2918ddaec97d4e9e8ee828c0c197859a';
                                        var data={};
                                        admin.req('/api/activiti/repository/getProcessStartRequestForm', {
                                            processDefinitionKey: processDefinitionKey
                                        }, function (result) {
                                            if (result.ok && result.data != null) {
                                                if (result.data.id.indexOf('.html') > 0) {
                                                    // 外部表单流程
                                                    admin.popupCenter({
                                                        title: '启动流程',
                                                        path: 'components/tpl/process_def_tpl_start.html',
                                                        area: ['90%', '90%'],
                                                        finish: function () {},
                                                        success: function () {
                                                            $("#process_def_tpl_start").load(result.data.id);
                                                            $("#process_id").val(data.processId);
                                                            $("#process_key").val(data.processKey);
                                                            $("#isExternalForm").val('1');
                                                        }
                                                    });
                                                } else {
                                                    // 正常流程
                                                    admin.req('/api/form/' + result.data.id, {}, function (response) {
                                                        if (response.data.design == 1) {} else {
                                                            var newData = $.extend({}, data, result);
                                                            newData.processDefinitionKey=processDefinitionKey;
                                                            ADCFormDesignHelper.startProcess(newData, function () {
                                                                getTaskDetails();
                                                            },false,false,false,false,id);
                                                        }
                                                    });
                                                }
                                            }
                                        }, {method: 'POST'});
                                    }else{
                                        layer.msg('当前任务下未添加交付物信息,请先去任务编辑窗口中添加交付物信息!',{
                                            icon:5
                                        })
                                    }

                                })
                            }
                            // 展示下级任务详情数据
                            showDetails(res.data);
                        }
                    }
                });
            };
            getTaskDetails();

            // 查询项目甘特图数据
            var gant = function () {
                $("#taskGantChart").empty();
                $('#taskGantChart').ADCGanttChart({
                    url: '/api/budget/TaskStatus/gantt?taskId=' + id,
                    styleBarStart: ""
                });
            };
            gant();
        }

        // 任务交付物
        function taskDetail(id){
            projectId = id;
            $('#tasknoBusiness').css('display',"block");
            // 注意projectId 必须是全局 否则upload 插件上传id还是首次render的id，因为upload.render不能多次渲染
            function getProjectFile(){
                 searchFile({pageSize:downSize,page:1,projectId:projectId});
                // 创建一个上传组件
                if(taskfileUpload == null){
                    taskfileUpload = upload.render({
                        elem: '#taskupload-project-file',
                        url: '/api/sys/file/upload',
                        accept: 'file',
                        exts: exts,
                        size: 50*1024,
                        before: function(obj){
                            // 动态付参数，不能写在外部，否则projectId固定了
                            this.data={userId:config.getAccount().usid,filePath:'c',foreignId:projectId}
                        },
                        done: function(res, index, upload){ //上传后的回调

                            if(res.respCode==0) {
                                searchFile({pageSize:downSize,page:1,projectId:projectId})
                            }
                            else{
                                return layer.msg('上传失败:' + res.message, {
                                    icon: 5
                                });
                            }
                        }
                    })
                }
                function searchFile(params){
                    // admin.req('/api/budget/project/getDeliveryFile',
                    admin.req('/api/budget/taskResult/queryTaskResultFilePageByTaskId/'+params.projectId+'/'+params.page+'/'+params.pageSize,
                        {}, function(res) {
                            if(res.respCode=='0') {
                                if(res.data.list && res.data.list.length!=0){
                                    $('.taskinfoNotic').hide();
                                }else{
                                    $('.taskinfoNotic').show();
                                }
                                var arr2 = [];// 错误数据赋值空,不进行渲染
                                for(var item of res.data.list) {
                                    if(null == item.fileId){
                                        continue;
                                    }else {
                                        var it = {
                                            icon: '../../assetsInfo/images/detailPage/' + extsImage[item.fileType] + '.png',
                                            href: ' /api/sys/file/'+item.fileId+'/download',
                                            date: new Date(item.uploadTime).toLocaleDate(),
                                            fileName: item.fileName+'.'+item.fileType,
                                            size: item.fileSize,
                                            uploader: item.uploadUserName,
                                            fileId:item.fileId
                                        }
                                        arr2.push(it);
                                    }
                                }
                                vm.set({
                                    fileList: arr2
                                })
                                if(params.page==1) {
                                    initPage(res.data.count)
                                }
                                $('.delProFile').off('click').on('click',function(){
                                    var fileId = $(this).attr('fileId');
                                    var fileName = $(this).attr('fileName');
                                    layer.confirm('确定删除文件:'+fileName+'吗？', {
                                        icon: 3,
                                        title: '提示'
                                    }, function() {
                                        // admin.req('/api/budget/project/file/' + fileId, {}, function(data) {
                                        admin.req('/api/sys/file/deleteFileByFileId/' + fileId, {}, function(data) {
                                            if (data.ok) {
                                                layer.msg('删除文件成功！', {
                                                    icon: 1
                                                });
                                                searchFile({pageSize:downSize,page:1,projectId:projectId})
                                            } else {
                                                return layer.msg('删除文件失败：' + data.message, {
                                                    icon: 5
                                                });
                                            }
                                        }, {
                                            method: 'delete'
                                        });
                                    });


                                });
                            } else{
                                layer.msg('查询失败!', {
                                    icon: 5
                                });
                            }
                        },{method:"get"});
                }
                function initPage(count) {
                    // 修改layui page 分页样式 制作简易版 分页 去掉边框，修改选种样式  修改前一页和下一页样式
                    laypage.render({
                        elem: 'file-page'
                        ,count: count
                        ,limit: downSize
                        ,jump: function(obj, first){
                            $('#file-page .layui-laypage-prev').html("<i class='layui-icon layui-icon-left'></i>");
                            $('#file-page .layui-laypage-next').html("<i class='layui-icon layui-icon-right'></i>");
                            if(!first) {
                                searchFile({pageSize:downSize,page:obj.curr,projectId:projectId})
                            }
                        },
                    });
                }
            }
            getProjectFile();
            // 渲染任务详情
            var showDetail = function (data) {
                var detail = "";
                detail += ' <div class="layui-row ">' +
                    '<div class="layui-col-md3">' +
                    '<p>' +
                    '<div class="layui-col-md4" style="width:70px;!important"><b>任务名称:</b></div>' +
                    '<div class="layui-col-md8" style="color:#666"><p>' + data.taskName + '</p></div>' +
                    '</p>' +
                    '<p>' +
                    '<div class="layui-col-md4" style="width:70px;!important"><b>任务类型:</b></div>' +
                    '<div class="layui-col-md8" style="color:#666"><p>' + data.type + '</p></div>' +
                    '</p>' +

                    '</div>' +
                    '<div class="layui-col-md3">' +
                    '<p>' +
                    '<div class="layui-col-md4" style="width:70px;!important"><b>任务状态:</b></div>' +
                    '<div class="layui-col-md8" style="color:#666"><p id="statusTask">' + data.status + '</p></div>' +
                    '</p>' +
                    '<p>' +
                    '<div class="layui-col-md4" style="width:70px;!important"><b>任务成员:</b></div>' +
                    '<div class="layui-col-md8" style="color:#666"><p>' + data.memberNames.join("、") + '</p></div>' +
                    '</p>' +
                    '</div>' +
                    '<div class="layui-col-md3">' +
                    '<p>' +
                    '<div class="layui-col-md4" style="width:70px;!important"><b>开始时间:</b></div>' +
                    '<div class="layui-col-md8" style="color:#666"><p>' + tools.getDate(data.planStartTime,"YYYY-MM-DD HH:mm:ss") + '</p></div>' +
                    '</p>' +
                    '<p>' +
                    '<div class="layui-col-md4" style="width:70px;!important"><b>结束时间:</b></div>' +
                    '<div class="layui-col-md8" style="color:#666"><p>' + tools.getDate(data.planEndTime,"YYYY-MM-DD HH:mm:ss") + '</p></div>' +
                    '</p>' +
                    '</div>' +
                    '<div class="layui-col-md3">' +
                    '<p>' +
                    '<div class="layui-col-md4" style="width:70px;!important"><b>优先级:</b></div>' +
                    '<div class="layui-col-md8" style="color:#E84A10;font-weight: bold"><p>' + data.priority + '</p></div>' +
                    '</p>' +
                    '</div>' +
                    '</div>';
                $("#taskDetail").html("");
                $("#taskDetail").append(detail);
            };

            // 查询任务详情
            var getTaskDetail = function (){
                $.ajax({
                    url: "/api/budget/TaskStatus/query/page/" + id,
                    type: 'get',
                    success: function (res) {
                        if (res.ok) {
                            // 展示任务详情数据
                            showDetail(res.data);
                        }
                    }
                });
                //判断是否完成按钮是否可点
                $.ajax({
                    url: "/api/budget/task/query/" + id,
                    type: 'get',
                    success: function (res) {
                        if (res.ok) {
                            var arr = res.data.taskResultEOList;

                            //根据后台字段判断是否可点击完成 personInput字段和枚举找后台确定再修改
                            if(res.data.btnFlag!=0){
                                $('#finishTask').attr("disabled","disabled")
                            } else {
                                $('#finishTask').removeAttr("disabled");
                                $('#finishTask').off('click').on("click",function () {
                                    var approveUserId = res.data.projectLeaderId ? res.data.projectLeaderId : res.data.pm ;
                                    var vars = "[{'name':'major','value':'"+approveUserId+"'},{'name':'btnType','value':'审批中'}]"
                                    var params ={
                                        variables:eval(vars),
                                        processDefinitionKey:'p01f4c16980734e5085f249dcf5c33f8b',
                                        businessKey:id, //id
                                    };
                                    // $('#finishTask').attr("disabled","disabled");
                                    $.ajax({
                                        url: "/api/budget/task/queryTaskStatusById/"+id,
                                        type: 'get',
                                        success: function (res) {
                                            if(res.data){
                                                // layui.admin.req('/api/budget/childrentask/changeChildTaskStatus', params,function(res){
                                                //     if(res.ok){
                                                //         layer.msg('任务已关闭，请等待审批！', {
                                                //             icon: 1
                                                //         });
                                                //         $('#statusTask').html("审批中");
                                                //     }
                                                // },{
                                                //     method: 'POST'
                                                // });
                                                // if(arr && arr.length!=0){
                                                if(arr){
                                                    var processDefinitionKey='p2918ddaec97d4e9e8ee828c0c197859a';
                                                    var data={};
                                                    admin.req('/api/activiti/repository/getProcessStartRequestForm', {
                                                        processDefinitionKey: processDefinitionKey
                                                    }, function (result) {
                                                        if (result.ok && result.data != null) {
                                                            if (result.data.id.indexOf('.html') > 0) {
                                                                // 外部表单流程
                                                                admin.popupCenter({
                                                                    title: '启动流程',
                                                                    path: 'components/tpl/process_def_tpl_start.html',
                                                                    area: ['90%', '90%'],
                                                                    finish: function () {

                                                                    },
                                                                    success: function () {
                                                                        $("#process_def_tpl_start").load(result.data.id);
                                                                        $("#process_id").val(data.processId);
                                                                        $("#process_key").val(data.processKey);
                                                                        $("#isExternalForm").val('1');
                                                                    }
                                                                });
                                                            } else {
                                                                // 正常流程
                                                                admin.req('/api/form/' + result.data.id, {}, function (response) {
                                                                    if (response.data.design == 1) {} else {
                                                                        var newData = $.extend({}, data, result);
                                                                        newData.processDefinitionKey = processDefinitionKey;
                                                                        ADCFormDesignHelper.startProcess(newData, function () {
                                                                            // 再次调用 修改任务基本信息,例如任务状态
                                                                            getTaskDetail();
                                                                        },false,false,false,false,id);
                                                                    }
                                                                });
                                                            }
                                                        }
                                                    }, {method: 'POST'});

                                                }else{
                                                    layer.msg('当前任务下未添加交付物信息,请先去任务编辑窗口中添加交付物信息!',{
                                                        icon: 5
                                                    })
                                                }

                                                // 给qiushi传状态
                                            }else{
                                                layer.msg('当前任务下有其他成员创建的的子任务，且未完成，暂时不能关闭！', {
                                                    icon: 5
                                                });
                                            }
                                        }
                                    })
                                })
                            }
                        }
                    }
                });
            };
            getTaskDetail();

            // 查询项目甘特图数据
            var gant = function () {
                $("#taskGantChart").empty();
                $('#taskGantChart').ADCGanttChart({
                    url: '/api/budget/TaskStatus/gantt?taskId=' + id,
                    styleBarStart: ""
                });
            };
            gant();
        }
        function getTreeData(model){
            var url=model==1?'/api/budget/budget/orgTree':'/api/budget/budget/tree'

            admin.req(url, {
                type:filterType
            }, function (d)
            {
                if (!d.ok) {
                    return layer.msg('获取组织机构列表失败:' + d.message, {
                        icon: 5
                    });
                }
                // 生成 zTree
                setting =
                    {

                        data: {
                            simpleData: {
                                enable: true,
                                idKey: "id",
                                pIdKey: "parentId",
                                rootPId: 0,
                                contractNO: "contractNO",
                                contractName: "contractName",
                                contractOwner:"contractOwner"
                            },
                            key:{
                                title:"nameTitle",
                                name:'name'
                            }
                        },
                        view: {
                            dblClickExpand: false,
                            showLine: true,
                            selectedMulti: false,
                            addHoverDom: addHoverDom,
                            removeHoverDom: removeHoverDom,
                            showIcon:true,
                            // fontCss:getFontCss,
                            nameIsHTML: true, //允许name支持html
                        },
                        edit: {
                            enable: modelType==0?true:false,
                            showRemoveBtn:modelType==0?true:false,
                            showRenameBtn:false,
                            editNameSelectAll: true,
                            drag:{
                                isMove: false,
                                isCopy:false,
                            },
                            removeTitle:"删除"
                        },
                        callback: {
                            onClick: function (event, treeId, treeNode) {
                                curTreeNode=treeNode;
                                $(".RightContent").hide();
                                $('#nodata').hide();
                                // console.log(treeNode,'treeNode')
                                switch (treeNode.type) {
                                    case 1 :
                                      if(modelType==0){
                                        $("#businessDetailDiv").show();
                                        new businessDetail(treeNode.id,treeNode.nameTitle);
                                      }
                                      else{

                                            $('#nodata').show();
                                        }


                                        break;
                                    case 2 :
                                        if(modelType==0){
                                            $("#projectDetailDiv").show();
                                            new projectDetail(treeNode.id);
                                        }
                                        else{
                                            $('#nodata').show();
                                        }

                                        break;
                                    case 3 :
                                        if(modelType==0){
                                            $("#taskDetailDiv").show();
                                            new taskDetail(treeNode.id);
                                        }
                                        else{
                                            $("#businessDetailDiv").show();
                                            new businessDetail(treeNode.id,treeNode.nameTitle);
                                        }

                                        break;
                                    case 4 :
                                        if(modelType==0){
                                            $("#taskDetailDivChild").show();
                                            new taskDetailChild(treeNode.id);
                                        }
                                        else{
                                            $("#projectDetailDiv").show();
                                            new projectDetail(treeNode.id);
                                        }

                                        break;
                                    default:
                                        $('#nodata').show();
                                }
//                        $("#" + treeNode.tId + "_remove").hide();
//                        $("#" + treeNode.tId + " button").hide();
                                var zTree = $.fn.zTree.getZTreeObj("select-org");
                                zTree.expandNode(treeNode);
                                sessionStorage.setItem('changeNode', JSON.stringify(treeNode))
                            },
                            beforeRemove: beforeRemove,
                            // onRemove:onRemove
                        }
                    };
//            var demo='(0/1)'
//            var text='<span class=\"smallTest\">项目'+demo+'</span>'
                if(d.data){
                    d.data.map(function (item) {

                        item.nameTitle=item.name;
                        if(!item.name)
                        {
                            return


                        }

                        if(item.type==1){
                            if(item.name.length>10){
                                // item.name=item.name.substring(0,10)
                                // item.name=item.name+".."
                            }
                            item.icon="../../assetsInfo/libs/zTree/css/metroStyle/img/file.png"
                        }
                        if(item.type==2){
                            // if(item.name.length>8){
                            //     item.name=item.name.substring(0,8)
                            //     item.name=item.name+".."
                            // }
                            item.icon="../../assetsInfo/libs/zTree/css/metroStyle/img/file1.png"
                        }
                        if(item.type==3){
                            // if(item.name.length>6){
                            //     item.name=item.name.substring(0,6)
                            //     item.name=item.name+".."
                            // }
                            item.icon="../../assetsInfo/libs/zTree/css/metroStyle/img/file2.png"
                        }
                        if(item.type==4){
                            // if(item.name.length>5){
                            //     item.name=item.name.substring(0,5)
                            //     item.name=item.name+".."
                            // }
                            item.icon="../../assetsInfo/libs/zTree/css/metroStyle/img/file2.png"
                        }

                    });
                    d.data.push(
                        {id: "1", name: "最后一条数据", parentId: "0", type: 3}
                    )
                }

                var  zNodes = d.data;

                zTreeObj = $.fn.zTree.init($("#select-org"), setting, zNodes);
                var nodeList = zTreeObj.getNodes();　　　　　　 // 展开第一个根节点

                var userInfo = config.getAccount();

                if (userInfo.orgs.length > 0) {
                    orgId = userInfo.orgs[0].id;
                }
                // var nodeList1 = zTreeObj.getNodesByParamFuzzy("name", '项目');
                // $.fn.zTree.init($("#select-org"), setting, nodeList1);
                $('#key').off('keyup').on('keyup',keyDownSearch);
                // document.onkeydown = keyDownSearch;
                //搜索框回车搜索
                function keyDownSearch(e) {
                    var theEvent = e || window.event;
                    var code = theEvent.keyCode || theEvent.which || theEvent.charCode ;
                    if (code == 13) {
                        var _keywords = $('#key').val();
                        addTree(_keywords);
                        return false;
                    }
                    return true;
                };
                //搜索框单击搜索
                $('.text').off('click').on('click', function() {
                    var _keywords = $('#key').val();
                    addTree(_keywords);
                });

                function beforeRemove(treeId, treeNode) {
                    var zTree = $.fn.zTree.getZTreeObj('select-org');
                    console.log(1211111,treeId,treeNode);
                    var url = "/api/budget/TaskStatus/query/page/";
                    if(treeNode.type==4){
                        url = "/api/budget/childrentask/query/"
                    }
                    $.ajax({
                        url: url + treeNode.id,
                        type: 'get',
                        success: function (res) {
                            if (res.ok) {
                                if(res.data.status == '审批中'){
                                    layer.msg('任务正在'+res.data.status+'，无法删除');
                                }else{
                                    layer.confirm("是否确定删除:" + treeNode.nameTitle,{
                                        btn: ['是','否']},function (index) {
                                        onRemove(null,treeId, treeNode,zTree);

                                    },function (index) {
                                        layer.close(index);
                                    });
                                }
                            }
                        }
                    });

                    return false;
                }
                //刷新树节点 搜索树
                function addTree(keyword,id) {
                  $("#select-org li").off("click");
                  $("#select-org").off("click");
                  console.log(id,'id外面')
                    admin.req(url, {
                        keyword:keyword,
                    }, function (d) {
                        if (!d.ok) {
                            return layer.msg('获取组织机构列表失败:' + d.message, {
                                icon: 5
                            });
                        }
                        if(d.data){
                            console.log(d,'验证左侧树数据为何不对');
                            var chooseParentId='';
                            d.data.map(function (item,index) {
                                if(item.id==id)
                                {
                                    chooseParentId=item.parentId;

                                }
                                if(!item.name)
                                {
                                    return;
                                }
                                item.nameTitle=item.name;
                                if(item.type==1){
                                    // if(item.name.length>10){
                                    //     item.name=item.name.substring(0,10)
                                    //     item.name=item.name+".."
                                    // }
                                    item.icon="../../assetsInfo/libs/zTree/css/metroStyle/img/file.png"
                                }
                                if(item.type==2){
                                    // if(item.name.length>8){
                                    //     item.name=item.name.substring(0,8)
                                    //     item.name=item.name+".."
                                    // }
                                    item.icon="../../assetsInfo/libs/zTree/css/metroStyle/img/file1.png"
                                }
                                if(item.type==3){
                                    // if(item.name.length>6){
                                    //     item.name=item.name.substring(0,6)
                                    //     item.name=item.name+".."
                                    // }
                                    item.icon="../../assetsInfo/libs/zTree/css/metroStyle/img/file2.png"
                                }
                                if(item.type==4){
                                    // if(item.name.length>5){
                                    //     item.name=item.name.substring(0,5)
                                    //     item.name=item.name+".."
                                    // }
                                    item.icon="../../assetsInfo/libs/zTree/css/metroStyle/img/file2.png"
                                }

                            });
                        }

                        var  zNodes = d.data;
                        d.data.push(
                            {id: "1", name: "最后一条数据", parentId: "0", type: 3}
                        )
                        // $.fn.zTree.destroy();
                        // $.fn.zTree.destroy("select-org");
                        zTreeObj = $.fn.zTree.init($("#select-org"), setting, zNodes);
                        // 展开全部
                        var treeObj = $.fn.zTree.getZTreeObj("select-org");
                        if(keyword){

                            expandNodes(treeObj.getNodes());
                        }

                        if(id) {
                          // console.log(id,'id')
                            //被编辑的父节点展开，节点选中，触发点击方法
                            treeObj.expandNode(treeObj.getNodeByParam("id",chooseParentId,null), true, false, false);
                            treeObj.selectNode(treeObj.getNodeByParam("id",id,null), true, false, false);
                            treeObj.setting.callback.onClick(null, treeObj.setting.treeId, treeObj.getNodeByParam("id",id,null));

                        }

                    })
                }
                function onRemove(e, treeId, treeNode,ztree) {
                    //如果节点是业务

                    if (treeNode.type == 1) {
                        budgetDel(treeNode,ztree);
                        $('#tableContent').hide();
                        //如果节点是项目
                    } else if (treeNode.type == 2) {
                        projectDel(treeNode,ztree)
                        //如果节点是任务
                    } else if (treeNode.type == 3) {
                        BudgetId = treeNode.id
                        taskDel(treeNode,ztree)
                        //如果节点是下级任务
                    } else if (treeNode.type == 4) {

                        childTaskDel(treeNode,ztree)
                    }
                }
                lestTreeNode="";
                function addHoverDom(treeId, treeNode) {
                    // console.log(config.getAccount(),545454,treeNode);
                        if(zTreeObj.getSelectedNodes()[0] && treeNode.id == zTreeObj.getSelectedNodes()[0].id){
                            $("#" + treeNode.tId + "_remove").show();
                            $("#" + treeNode.tId + " button").show();
                            lestTreeNode= treeNode.tId;
                        }else{
                            $("#" + treeNode.tId + "_remove").show();
                            $("#" + treeNode.tId + " button").show();
                            if(lestTreeNode){
                                $("#" + lestTreeNode + "_remove").hide();
                                if( $("#" + lestTreeNode + " .diyBtn1").length==1){
                                    $("#" + lestTreeNode + " .diyBtn1").hide();

                                }
                            }

                        }
                    var aObj = $("#" + treeNode.tId + "_a");
                    console.log(treeNode);
                    if (treeNode.contractNO) {
                        aObj.attr("title", treeNode.contractNO+"-"+ treeNode.contractName+"-"+ treeNode.contractOwner);//给ID为....设置title属性，属性值为oname
                    }
                    if ($("#diyBtn_"+treeNode.id).length>0) return;
                    var isAdmin=false;
                    for(var j =0;j<config.getAccount().rolesstr.length;j++){
                        if(config.getAccount().rolesstr[j]=='ZVXUGCP56D'){
                            isAdmin = true;
                        }
                    }
                    if(treeNode.projectType=="2"&&!isAdmin&&treeNode.type==2){
                        $("#" + treeNode.tId + "_remove").hide();
                        $("#" + treeNode.tId + " button").hide();
                        lestTreeNode=false;
                    }else{
                        if(modelType==0)
                        {
                            var editStr = "<span id='diyBtn_space_" +treeNode.id+ "' ></span>"
                                + "<button type='button' style='position: absolute;top:14px;display: inline-block;!important;'  class='diyBtn1' id='diyBtn_" + treeNode.id
                                + "' title='编辑s' onfocus='this.blur();'><span class=\"button add\" id=\"select-org_4_add\"   ></span></button>";
                            var copyStr = "<span id='diyBtn_space_" +treeNode.id+ "' ></span>"
                                + "<button type='button' style='position: absolute;top:14px;display: inline-block;!important;'  class='diyBtn2' id='diyBtn_" + treeNode.id
                                + "' title='复制s' onfocus='this.blur();'><span class=\"button add\" id=\"select-org_4_add\"   ></span></button>";


                            //button 中间添加图片下·
                            aObj.append(editStr);
                            aObj.append(copyStr);
                        }
                    }
                    $("#" + treeNode.tId + "_remove").css({'position':'absolute','top':'14px','right': '24px'});
                    var btn = $("#diyBtn_" + treeNode.id);
                    if (btn) btn.bind("click", function(){
                        // 弹出弹出框
                        if (treeNode.type == 1) {
                            if (treeNode == null) {
                                return layer.msg('请选择1个要编辑的业务', {
                                    icon: 0
                                });
                            }
                            admin.req("/api/budget/budget/" + treeNode.id, {
                            }, function(res) {
                                console.log(res,'ahdahkdkljasfhnk');
                                if(res.data.manager) {
                                    var params = res.data;
                                    localStorage.setItem('type','put');

                                    BudgetpopMenu("edit", params);
                                }
                                else{
                                    layer.msg('您没有权限编辑该业务!', {
                                        icon: 5
                                    });

                                }

                            });
                        // BudgetpopMenu("edit", treeNode);
                        } else if (treeNode.type == 2) {
                            if (treeNode == null) {
                                return layer.msg('请选择1个要编辑的项目', {
                                    icon: 0
                                });
                            }
                            admin.req("/api/budget/budget/" + treeNode.parentId, {}, function(res) {
                                if(res.data.property=="0"){
                                    if(!isAdmin){
                                        layer.msg('您没有权限编辑该项目!', {
                                            icon: 5
                                        });
                                    }else{
                                        admin.req("/api/budget/project/query/" + treeNode.id, {
                                        }, function(res) {
                                            if(res.ok){
                                                var params = res.data;
                                                popMenu("edit", params);
                                            }else{
                                                layer.msg(res.message, {
                                                    icon: 5
                                                });
                                            }

                                        });
                                    }
                                }else{
                                    admin.req("/api/budget/project/query/" + treeNode.id, {
                                    }, function(res) {

                                        if(res.data.manager)
                                        {
                                            var params = res.data;
                                            popMenu("edit", params);
                                        }
                                        else{
                                            layer.msg('您没有权限编辑该项目!', {
                                                icon: 5
                                            });

                                        }
                                    });
                                }
                            });
                        } else if (treeNode.type == 3) {

                            BudgetId = treeNode.id ;

                            if (treeNode == null) {
                                return layer.msg('请选择1个要编辑的任务', {
                                    icon: 0
                                });
                            }
                            admin.req("/api/budget/task/query/" + treeNode.id, {}, function(res) {
                                if(!res.data.manager) {
                                    layer.msg('您没有权限编辑该任务!', {
                                        icon: 5
                                    });
                                    return false;
                                }
                                console.log(res,'1800000')
                                if(res.data.taskStatus == '审批中'||res.data.taskStatus == '已完成'){
                                    layer.msg('任务'+res.data.taskStatus+'，无法编辑');
                                }else{
                                    var params = res.data;
                                    TaskpopMenu("edit", params);
                                }

                            });
                            // TaskpopMenu("edit", treeNode);
                        } else if (treeNode.type == 4) {
                            if (treeNode == null) {
                                return layer.msg('请选择1个要编辑的下级任务', {
                                    icon: 0
                                });
                            }
                            admin.req("/api/budget/childrentask/query/" + treeNode.id, {}, function(res) {
                                console.log(res,1646841321834235)
                                if(!res.data.manager) {
                                    layer.msg('您没有权限编辑该下级任务!', {
                                        icon: 5
                                    });
                                    return false;
                                }
                                if(res.data.status=='审批中'||res.data.status=='已完成'){
                                    return layer.msg('任务'+res.data.status+'，无法编辑');
                                }else{
                                    var params = res.data;
                                    childTaskPopMenu("edit", params);
                                }
                            });
                        }
                    });
                }
                // $('#btn_manage').off('click').on('click', function () {
                //
                //     let processDefinitionKey = "p7111b710ba2d47cf9c1b87d2847060b9";
                //     admin.req('/api/activiti/repository/getProcessStartRequestForm', {
                //         processDefinitionKey:  processDefinitionKey ,
                //         existFinished: 1,
                //     }, function (result) {
                //         if (result.ok && result.data != null) {
                //             if (result.data.id.indexOf('.html') > 0) {
                //                 // 外部表单流程
                //                 admin.popupCenter({
                //                     title: '新增项目',
                //                     path: 'components/tpl/process_def_tpl_start.html',
                //                     area: ['90%', '90%'],
                //                     finish: function () {
                //                     },
                //                     success: function () {
                //                          $("#process_def_tpl_start").load(result.data.id);
                //                     }
                //                 });
                //             } else {
                //                 let data = {processDefinitionKey: processDefinitionKey};
                //                 // 正常流程
                //                 admin.req('/api/form/' + result.data.id, {}, function (response) {
                //                     if (response.data.design == 1) {
                //                     } else {
                //                         var newData = $.extend({}, data, result);
                //                         ADCFormDesignHelper.startProcess(newData, function () {
                //                         });
                //                     }
                //                     // 添加人员右边的icon点击也可触发
                //                     for (var i = 0; i < document.getElementsByClassName("layui-input-inline").length; i++) {
                //                         document.getElementsByClassName("layui-input-inline")[i].addEventListener("click", function () {
                //                             // $(".layui-input-inline").on("click",function(){
                //                             $(this).find("input").trigger("click");
                //                             return false;
                //                         });
                //                     }
                //                     $(".layui-input-inline").css("cursor", "pointer");
                //                 });
                //             }
                //         }
                //     }, {
                //         method: 'POST'
                //     });
                // });
                $('#btn_noManage').off('click').on('click', function () {
                    let processDefinitionKey = "p70053bc83b2b4a27998092819961c768";
                    admin.req('/api/activiti/repository/getProcessStartRequestForm', {
                        processDefinitionKey: processDefinitionKey,
                        existFinished: 1,
                    }, function (result) {
                        if (result.ok && result.data != null) {
                            if (result.data.id.indexOf('.html') > 0) {
                                // 外部表单流程
                                admin.popupCenter({
                                    title: '新增项目',
                                    path: 'components/tpl/process_def_tpl_start.html',
                                    area: ['90%', '90%'],
                                    finish: function () {
                                    },
                                    success: function () {
                                         $("#process_def_tpl_start").load(result.data.id);
                                    }
                                });
                            } else {
                                let data = {processDefinitionKey: processDefinitionKey};
                                // 正常流程
                                admin.req('/api/form/' + result.data.id, {}, function (response) {
                                    if (response.data.design == 1) {
                                    } else {
                                        var newData = $.extend({}, data, result);
                                        ADCFormDesignHelper.startProcess(newData, function () {
                                        });
                                    }
                                    // 添加人员右边的icon点击也可触发
                                    for (var i = 0; i < document.getElementsByClassName("layui-input-inline").length; i++) {
                                        document.getElementsByClassName("layui-input-inline")[i].addEventListener("click", function () {
                                            $(this).find("input").trigger("click");
                                            return false;
                                        });
                                    }
                                    $(".layui-input-inline").css("cursor", "pointer");
                                });
                            }
                        }
                    }, {
                        method: 'POST'
                    });

                });
                $('#btn_research').off('click').on('click', function () {
                    var layerOpen = function(obj) {
                        layer.open({
                            type: 1,
                            title: '科研项目选择',
                            content: '<div id="searchDate" class="layui-form" lay-filter="searchDate"; style="padding: 50px" >\n' +
                                '                    <div class="layui-form-item">\n' +
                                '                        <div class="">\n' +
                                ' <label style="width: 80px;font-weight: normal"><span style="color:red">*</span>请选择：</label>' +
                                '                        <div style="display: inline-block;width: calc(100% - 90px);">' +
                                ' <select  name="projectType"   placeholder="请选择设备费类型" class="layui-input " lay-filter="projectType" id="projectType"  lay-verify="required">' +
                                '</select>\n' +
                                '                        </div></div>\n' +
                                '                    </div>\n' +
                                '                </div>',
                            area: ['600px', '330px'],
                            btn: ['确定', '取消'],
                            yes: function (index, layero) {
                                // if (!$('#projectType').val()) {
                                //     return layer.msg('请选择燃料动力分类', {
                                //         icon: 5
                                //     });
                                    admin.popupCenter({
                                        id: 'ADCFormDesignHelper-startProcess',
                                        maxmin: false,
                                        title: '新建项目',
                                        path: 'components/researchForm/mainForm.html',
                                        area: ['100%', '100%'],
                                        // btn: ['启动', '取消'],
                                        btnAlign: 'c',
                                        resize: false,
                                        finish:   function(data) {
                                            table.reload('tableContent-pro', {
                                                where: {
                                                    reload: new Date().getTime()
                                                }
                                            });
                                            if(data)
                                            {
                                                addTree(null,data.id);

                                            }

                                        },
                                        success: function () {
                                            $('#researchProjectPropertyId').val($('#projectType').attr('data-id'))
                                        }
                                    },'top');
                                layer.close(index);
                            },
                            success: function () {
                                $.ajax({
                                    type: "get",
                                    url: "/api/sys/dictype/list?dicCode=rs_project_property",
                                    success: function (res) {
                                        var list = res.data;
                                        var con = '';
                                        for(i=0;i<list.length;i++){
                                            con += '<option value='+list[i].dicTypeCode+'>'+list[i].dicTypeName+'</option>'
                                        }
                                        if(list.length!=0){
                                            $('select[name=projectType]')[0].dataset.name=list[0].dicTypeName;
                                            $('select[name=projectType]')[0].dataset.id=list[0].dicTypeCode;
                                        }
                                        form.on('select(projectType)',function (data) {
                                            data.elem.dataset.name=data.elem[data.elem.selectedIndex].innerHTML;
                                            data.elem.dataset.id=data.elem[data.elem.selectedIndex].value;
                                            form.render("select");
                                        });
                                        $('#projectType').empty().append(con);
                                        form.render("select");
                                    }
                                });

                                form.render();
                            },
                            resize: false
                        });
                    }
                    layerOpen();
                    // layer.msg('该功能暂未开放，敬请期待哟~')
                });
                $('#btn_admin').off('click').on('click', function () {
                    layer.msg('该功能暂未开放，敬请期待哟~')
                });
                $('#btn_special').off('click').on('click', function () {
                    layer.msg('该功能暂未开放，敬请期待哟~')
                });
                $("#btn_addBuss").off('click').on('click', function () {
                    localStorage.setItem('type','post');
                    BudgetpopMenu("add");
                });
                $("#btn_addTaks").off('click').on('click', function () {
                    TaskpopMenu("add");
                });
                $('#btn_addChildTask').off('click').on('click', function() {
                    childTaskPopMenu('add')
                });
                $('#btn_addNo').off('click').on('click', function () {
                    layer.msg('该功能暂未开放，敬请期待哟~')
                });
                var taskFlag='';
                function popMenu(type, data) {
                    var property = 1;
                    if(data.businessId.indexOf('rs_')!=-1){
                        property=2;
                    }
                    // 判断操作事件
                    taskFlag=0;
                    // $("#myrame").attr("src",'components/tpl/project_save_form.html')
                    if (type === 'add') {
                        var title = '新增项目';
                        data = {};
                    } else if (type === 'edit') {
                        var title = '编辑项目'
                    }
                    // data.handleType = type;

                    admin.popupCenter({
                        title: title,
                        width: 900,
                        path: 'components/tpl/project_save_form.html',
                        finish: function(data) {
                            table.reload('tableContent-pro', {
                                where: {
                                    reload: new Date().getTime()
                                }
                            });

                            if(data)
                            {
                                addTree(null,data.id);

                            }

                        },
                        success: function() {
                            // $("#finishedStatus").chosen({
                            //     disable_search: true
                            // });
                            // 初始化人员列表
                            admin.req('/api/sys/user', {
                                pageNo: 1,
                                pageSize: 10000
                            }, function(res)
                            {
                                var arr = res.data.list,
                                    selectArr=[],
                                    formSelectArr = [];
                                for (var i = 0; i < arr.length; i++) {
                                    formSelectArr.push({
                                        name: arr[i].usname,
                                        value: arr[i].usid
                                    });
                                }
                                formSelects.data('projectMemberIds_pop', 'local', {
                                    arr: formSelectArr
                                });
                                formSelects.data('projectLeader_pop', 'local', {
                                    arr: formSelectArr
                                });
                                //选择后清空搜索
                                formSelects.on('projectMemberIds_pop', function(id, vals, val, isAdd, isDisabled){
                                    //id:           点击select的id
                                    //vals:         当前select已选中的值
                                    //val:          当前select点击的值
                                    //isAdd:        当前操作选中or取消
                                    //isDisabled:   当前选项是否是disabled
                                    $('.projectMemberBox .xm-select-input').val('');
                                    formSelects.search('projectMemberIds_pop', '');
                                    // alert("选择了: " + val.name);
                                });
                                for(var item of arr){
                                    var tipTitle = "";
                                    for(var org of item.orgs){
                                        tipTitle = tipTitle + org.name + ",";
                                    }
                                    tipTitle = (tipTitle.length>1)?tipTitle.substr(0,tipTitle.length-1):"";
                                    $('dd[lay-value="' + item.usid + '"]').attr('title',tipTitle);
                                }

                                formSelects.btns('projectMemberIds_pop', ['select', 'remove']);
                                if(data.mapList)
                                {
                                    for (var i = 0; i < data.mapList.length; i++) {
                                        selectArr.push(data.mapList[i].id);
                                    }
                                    layui.formSelects.value('projectMemberIds_pop', selectArr);
                                }
                                if ( data.projectLeaderId)
                                {
                                    layui.formSelects.value('projectLeader_pop', [data.projectLeaderId]);
                                }
                                getBusiness(data.businessId);
                                setFormValue(data);
                            });
                            //2019-04-17 修改接口地址为 /api/budget/budget/myBudget
                            admin.req('/api/budget/budget/getBudgetList?property='+data.projectType, {

                            }, function(res) {
                                var arr = res.data,
                                    elem = $('#business_blong_project');


                                for (var i = 0; i < arr.length; i++) {
                                    if(arr[i].projectName)
                                    {
                                        elem.append('<option value="' + arr[i].id + '">' + arr[i].projectName + '</option>');
                                    }
                                }
                                formSelects.render('business_blong_project');
                                formSelects.btns('business_blong_project', []);
                                if(data.budgetId)
                                {
                                    formSelects.value('business_blong_project', [data.budgetId]);
                                }
                            },{"method":"get"});
                        }
                    });



                };
                function manageMenu(type, data) {
                    // 判断操作事件
                    taskFlag=0;
                    // $("#myrame").attr("src",'components/tpl/project_save_form.html')
                    if (type === 'add') {
                        var title = '新增项目';
                        data = {};
                    } else if (type === 'edit') {
                        var title = '编辑项目'
                    }
                    // data.handleType = type;

                    admin.popupCenter({
                        title: title,
                        width: 900,
                        path: 'components/tpl/project_save_manage_form.html',
                        finish: function(data) {
                            table.reload('tableContent-pro', {
                                where: {
                                    reload: new Date().getTime()
                                }
                            });

                            if(data)
                            {
                                addTree(null,data.id);
                            }

                        },
                        success: function() {
                            // $("#finishedStatus").chosen({
                            //     disable_search: true
                            // });
                            // 初始化人员列表
                            admin.req('/api/sys/user', {
                                pageNo: 1,
                                pageSize: 10000
                            }, function(res)
                            {
                                var arr = res.data.list,
                                    selectArr=[],
                                    formSelectArr = [];
                                for (var i = 0; i < arr.length; i++) {
                                    formSelectArr.push({
                                        name: arr[i].usname,
                                        value: arr[i].usid
                                    });
                                }
                                formSelects.data('projectMemberIds_pop', 'local', {
                                    arr: formSelectArr
                                });
                                formSelects.data('projectLeader_pop', 'local', {
                                    arr: formSelectArr
                                });
                                formSelects.on('projectMemberIds_pop', function(id, vals, val, isAdd, isDisabled){
                                    //id:           点击select的id
                                    //vals:         当前select已选中的值
                                    //val:          当前select点击的值
                                    //isAdd:        当前操作选中or取消
                                    //isDisabled:   当前选项是否是disabled
                                    $('.projectMemberBox .xm-select-input').val('');
                                    formSelects.search('projectMemberIds_pop', '');
                                    // alert("选择了: " + val.name);
                                });
                                for(var item of arr){
                                    var tipTitle = "";
                                    for(var org of item.orgs){
                                        tipTitle = tipTitle + org.name + ",";
                                    }
                                    tipTitle = (tipTitle.length>1)?tipTitle.substr(0,tipTitle.length-1):"";
                                    $('dd[lay-value="' + item.usid + '"]').attr('title',tipTitle);
                                }

                                formSelects.btns('projectMemberIds_pop', ['select', 'remove']);
                                if(data.mapList)
                                {
                                    for (var i = 0; i < data.mapList.length; i++) {
                                        selectArr.push(data.mapList[i].id);
                                    }
                                    layui.formSelects.value('projectMemberIds_pop', selectArr);
                                }
                                if ( data.projectLeaderId)
                                {
                                    layui.formSelects.value('projectLeader_pop', [data.projectLeaderId]);
                                }
                                getBusiness(data.businessId);
                                setManageFormValue(data);
                            });
                            //2019-04-17 修改接口地址为 /api/budget/budget/myBudget

                            admin.req('/api/budget/budget/getBudgetList?property=0', {

                            }, function(res) {
                                var arr = res.data,
                                    elem = $('#business_blong_project');


                                for (var i = 0; i < arr.length; i++) {
                                    if(arr[i].projectName)
                                    {
                                        elem.append('<option value="' + arr[i].id + '">' + arr[i].projectName + '</option>');
                                    }
                                }
                                formSelects.render('business_blong_project');
                                formSelects.btns('business_blong_project', []);
                                if(data.budgetId)
                                {
                                    formSelects.value('business_blong_project', [data.budgetId]);
                                }
                            },{"method":"get"});
                        }
                    });



                }
                function getBusiness(businessId) {
                    if(businessId.indexOf('rs_')!=-1){
                        admin.req('/api/sys/dictype/list?dicCode=rs_contract_type', {}, function(res) {
                            $('#businessArr').val(JSON.stringify(res.data));
                            var arr = res.data,
                                tmparr = [];
                            // tmparr.push({name:"全部业务",id:"1",parentId:"0"});
                            for (var i = 0; i < arr.length; i++) {
                                tmparr.push({
                                    name: arr[i].dicTypeName,
                                    value: arr[i].dicTypeCode,
                                    id: arr[i].dicTypeCode,
                                    // parentId: arr[i].parentId ? arr[i].parentId:'1'
                                });
                            }

                            // var formSelectArr = admin.toTree(tmparr);
                            formSelects.data('business_pop', 'local', {
                                // arr: formSelectArr
                                arr: tmparr
                            });
                            formSelects.btns('business_pop', []);
                            if (businessId){
                                formSelects.value('business_pop', [businessId]);
                            }


                        });
                    }else{
                        admin.req('/api/budget/business/query/all', {}, function(res) {
                            var arr = res.data,
                                tmparr = [];
                            // tmparr.push({name:"全部业务",id:"1",parentId:"0"});
                            for (var i = 0; i < arr.length; i++) {
                                tmparr.push({
                                    name: arr[i].name,
                                    value: arr[i].id,
                                    id: arr[i].id,
                                    // parentId: arr[i].parentId ? arr[i].parentId:'1'
                                });
                            }

                            // var formSelectArr = admin.toTree(tmparr);
                            formSelects.data('business_pop', 'local', {
                                // arr: formSelectArr
                                arr: tmparr
                            });
                            formSelects.btns('business_pop', []);
                            if (businessId){
                                formSelects.value('business_pop', [businessId]);
                            }


                        });
                    }
                };
                function removeHoverDom(treeId, treeNode) {
                    $("#diyBtn_"+treeNode.id).unbind().remove();
                    $("#diyBtn_space_" +treeNode.id).unbind().remove();
                };
                // 业务弹窗
                function BudgetpopMenu(type, data) {
                    var params = {};
                    var title = '新增业务';

                    if (data) {
                        title = '编辑业务';
                        params = data;
                    }
                    // else{
                    //       //只有市场发展部才能添加业务
                    // if(config.getAccount())
                    // {
                    //     var hasPermission=false;
                    //     for(var item of config.getAccount().orgs)
                    //     {
                    //         if(item.name=='市场发展部')
                    //         {
                    //             hasPermission=true;
                    //         }
                    //     }
                    //     if(!hasPermission)
                    //     {
                    //          layer.msg('您无权限创建业务!', {
                    //                         icon: 5
                    //                     });
                    //         return false
                    //     }
                    // }
                    // }
                    params.handleType = type;
                    admin.popupCenter({
                        title: title,
                        width: 800,
                        path: 'components/tpl/budget_save_form.html',
                        finish: function () {
                            table.reload('tableContent-pro', {
                                where: {
                                    reload: new Date().getTime()
                                }
                            });
                        },
                        success: function () {
                            var propertyOption = '<option value="">-- 请选择 --</option>\n' +
                                                 '<option value="cx">持续</option>\n' +
                                                 '<option value="xz">新增</option>';

                            var propertyElem = $('#property_pop');
                            propertyElem.append(propertyOption);
                            formSelects.render('property_pop');
                            formSelects.btns('property_pop', []);

                            // 关闭弹框
                            $('#popmenuCancle').on('click', function () {
                                admin.closePopupCenter();
                            });

                            var fla = false;// 当部门不是市场发展部时，就判断登陆人身份
                            var aa;// 既不是市场发展部又不是超管和主任身份的一般用户，aa为undefined
                            for(var item of config.getAccount().orgs){// 判断部门
                                if (item.id == "JAD87PGP8V"){// 市场发展部id
                                    fla = true;
                                    aa = 1;
                                    break;
                                }
                            }
                            if(fla == false){
                                for(var item of config.getAccount().roles){// 部门不符合再判断段角色
                                    if(item.extInfo == 'SUPER_ADMIN' || item.extInfo == 'ZHU_REN' || item.extInfo == 'RS_ADMIN'){
                                        aa = 1;
                                        break;
                                    }
                                }
                            }
                            setBudgetFormValue(params,aa)
                            getBudgetDepMember(params);
                        }
                    });
                }
                function setFormValue(obj) {
                    console.log(obj,1);
                    var title = $('.layui-tpl-container .layui-card-header');
                    var formNames = ['id', 'handleType', 'name', 'planStartTime', 'projectType','planEndTime', 'taskStatus','startTime', 'personInput','contractNo','budget'];
                    obj.title && title.text(obj.title);
                    obj.planStartTime = obj.planStartTime ? formatDate(obj.planStartTime) : '';
                    obj.planEndTime = obj.planEndTime ? formatDate(obj.planEndTime) : '';
                    // obj.startTime = obj.projectBeginTime ? formatDate(obj.projectBeginTime) : '';
                    obj.startTime = obj.projectStartTime ? formatDate(obj.projectStartTime) : '';
                    if(obj.businessId.indexOf('rs_')!=-1){
                        // obj.startTime = obj.projectBeginTime ? formatDate(obj.projectBeginTime) : '';
                        obj.startTime = obj.projectStartTime ? formatDate(obj.projectStartTime) : '';
                    }
                    for (var i = 0; i < formNames.length; i++) {
                        if (obj[formNames[i]]) {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val(obj[formNames[i]]);
                        } else {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val('');
                        }
                    }
                    if(obj.projectDescription){
                        $('.layui-tpl-container  textarea[name="projectDescription"]').val(obj.projectDescription);
                    }else{
                        $('.layui-tpl-container  textarea[name="projectDescription"]').val('');
                    }
                }
                function setManageFormValue(obj) {
                    var title = $('.layui-tpl-container .layui-card-header');
                    var formNames = ['id', 'handleType', 'name', 'personInput','contractNo','budget','projectOwner','startTime','contractAmount'];
                    obj.contractAmount = obj.contractAmountStr ;
                    obj.title && title.text(obj.title);
                    obj.startTime = obj.startTime ? formatDate(obj.startTime) : '';
                    for (var i = 0; i < formNames.length; i++) {
                        if (obj[formNames[i]]) {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val(obj[formNames[i]]);
                        } else {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val('');
                        }

                    }
                    $('.layui-tpl-container  input[name="projectId"]').val(obj.id);
                    if(obj.projectDescription){
                        $('.layui-tpl-container  textarea[name="projectDescription"]').val(obj.projectDescription);
                    }else{
                        $('.layui-tpl-container  textarea[name="projectDescription"]').val('');
                    }
                    if(obj.projectContractInvoiceEOList){
                        $('.table-contract_addBox').css('display','block');
                        tableContractInit(obj,'#contractTableEdit','text');
                    }else{
                        $('.table-contract_addBox').css('display','none');
                    }
                }
                // 业务
                function getBudgetDepMember(obj) {
                    var url = url = '/api/budget/budget/users';
                    admin.req(url, {}, function (res) {
                        var arr = res.data;
                        elem = $('#leader_blong')
                        if (arr) {
                            elem.empty();
                            for (var i = 0; i < arr.length; i++) {
                                if (arr[i].name) {
                                    elem.append('<option   value="' + arr[i].id + '">' + arr[i].name + '</option>');
                                }
                            }
                        }
                        formSelects.render('leader_blong');
                        formSelects.btns('leader_blong', []);
                        if (obj.pm) {
                            formSelects.value('leader_blong', [obj.pm])
                        }

                        for(var item of arr) {
                            $('dd[lay-value="' + item.id + '"]').attr('title',item.orgName);
                        }
                    });

                }
                /**
                 * 功能: 编辑业务弹框数据回显
                 * 修改时间: 2019/9/12
                 * 修改内容: 回显科研类业务数据时,周期模块与日常事务类、经营类的周期模块表单元素的name冲突了(layui表单提交操作name)
                 * 作者: menglingyan
                 * @param:
                 */
                function setBudgetFormValue(obj,aa) {
                    var inputs = $('.layui-tpl-container').find('input'),
                        title = $('.layui-tpl-container .layui-card-header'),
                        formNames = ['id', 'handleType', 'projectName', 'remark', 'pm',
                            'teamName', 'cycle', 'currentYearDeal', 'currentYearEstimate'
                        ];
                    if (obj.cycleBegin && obj.cycleEnd) {
                        // 科研类业务周期回显操作
                        if(obj.property == "2"){
                            $('#cycle_keyanRender').attr('name','cycle');
                            $('#cycle_keyanRender').attr('lay-verify','required');
                        }

                        obj.cycleBegin = new Date(parseInt(obj.cycleBegin)).toLocaleDate();
                        obj.cycleEnd = new Date(parseInt(obj.cycleEnd)).toLocaleDate();
                        obj.cycle = obj.cycleBegin + ' - ' + obj.cycleEnd;
                    }
                    if (obj.propertyId) {
                        formSelects.value('property_pop', [obj.propertyId]);
                    }
                    if(obj.property||obj.property==0){
                        $('#propertyInfo').val(obj.property);
                    }
                    for (i = 1; i < 13; i++) {
                        var Deal = 'nextYear' + i + "Deal";
                        var Income = 'nextYear' + i + "Income";
                        formNames.push(Deal);
                        formNames.push(Income);
                    }
                    obj.title && title.text(obj.title);

                    for (var i = 0; i < formNames.length; i++) {
                        if (obj[formNames[i]]) {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val(obj[formNames[i]]);
                        } else {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val('');
                        }
                    }
                    if (obj.remark) {
                        $('.layui-tpl-container  textarea[name="remark"]').val(obj.remark);
                    }
                    if (obj.handleType == 'add') {
                        if(aa) {
                            $('.noIncome').hide();
                        }else {
                            $("input[name=currentYearEstimate]").val(0);
                            $("input[name=currentYearDeal]").val(0);
                        }
                    }
                    else {
                        $("input[name=property]").attr("disabled", "disabled");
                        $("input[name=property]").addClass("layui-disabled");
                            if (obj.property === "0") {
                                $('.noIncome').hide();
                            }
                            else {
                                // 编辑业务时,如果被编辑的是科研业务,让一些表单不渲染
                                if (obj.property == "2"){
                                    $('.keyan_noRender').css('display','none');
                                    $('.keyan_render').css('display','');
                                }

                                $("input[name=currentYearEstimate]").val(0);
                                $("input[name=currentYearDeal]").val(0);
                                $("input[name=currentYearEstimate]").attr("disabled", "disabled");
                                $("input[name=currentYearDeal]").attr("disabled", "disabled");
                                $("input[name=currentYearEstimate]").addClass("layui-disabled");
                                $("input[name=currentYearDeal]").addClass("layui-disabled");
                                $(".income").hide();
                                $(".noIncome").show();
                                $('input:radio:eq(' + obj.property + ')').prop('checked', 'checked');
                            }
                    }
                    form.render();
                }

                // 自定义表单校验规则
                form.verify({
                    isRealNumber: function (value) {
                        if (value != null & value != "" & value != undefined) {
                            if (isNaN(value)) {
                                return '请输入合法数字';
                            }
                        }
                    },
                })

                // 任务弹窗
                function TaskpopMenu(handleType, data) {
                    taskFlag=1;
                    var params = {};
                    var title = "新增任务";
                    if (handleType === 'edit') {
                        title =  '编辑任务';
                        params = data;
                    }
                    params.handleType = handleType;
                    admin.popupCenter({
                        title: title,
                        path: 'components/tpl/task_save_form_business.html',
                        finish: function (data) {
                            $('#projectListSelect').val();
                            if(data) {
                                addTree(null,data.id);
                            }
                        },
                        success: function () {
                            setTaskFormValue(params);
                        }
                    });
                };
                var taskID = "";
                // 下级任务弹窗
                function childTaskPopMenu (type, data) {
                    if (type === 'add') {
                        var title = '新增下级任务';
                        data = {};
                    } else if (type === 'edit') {
                        var title = '编辑下级任务'
                    }
                    //  data.type = type;
                    admin.popupCenter({
                        title: title,
                        path: 'components/tpl/childTask_save_form.html',
                        finish: function (data) {
                            if(data) {
                                addTree(null,data.id);
                            }
                            reset();
                        },
                        success: function () {
                            $("#status").chosen({
                                width: '100%',
                                disable_search: true,
                            });
                            var elem = $('#personId');
                            initelect(elem);
                            initelect($('#taskId'));

                            if (data.taskId) {
                                getChildTaskUser(data)
                            } else {
                                var option = '<option value="">请选择</option>';
                                $("#personId").empty().append(option);
                                $("#personId").trigger("chosen:updated");
                                var optionTask = '<option value="">请选择</option>';
                                $("#taskId").empty().append(optionTask);
                                $("#taskId").trigger("chosen:updated");
                            }
                            if(type=='add') {
                                admin.req('/api/budget/task/currentUserProject', {}, function (res) {
                                    var arr = res.data?res.data:[],
                                    //  arr=[{"id":"CLXYW9GL46","name":"立项"}]
                                        option = '<option value=""></option>';
                                    for (var i = 0; arr && i < arr.length; i++) {
                                        option += '<option value="' + arr[i].id + '">' + arr[i].name + '</option>';
                                    }
                                    $("#projectId2").empty().append(option);

                                    initelect($('#projectId2'));
                                    if(type=='edit')
                                    {
                                        $('#projectId2').prop('disabled', true).trigger("chosen:updated");
                                    }
                                });
                                // 新增下级任务时 业务任务带不出来，联调子西 添加入参 projectTeam
                                admin.req('/api/budget/budget', {}, function (res) {
                                    var arr = res.data,
                                    //  arr=[{"id":"CLXYW9GL46","name":"立项"}]
                                        option = '<option value=""></option>';
                                    for (var i = 0; arr && i < arr.length; i++) {
                                        option += '<option value="' + arr[i].id + '">' + arr[i].projectName + '</option>';
                                    }
                                    $("#business_blong2").empty().append(option);
                                    initelect($('#business_blong2'));
                                    if(type=='edit')
                                    {
                                        $('#business_blong2').prop('disabled', true).trigger("chosen:updated");
                                    }
                                },{"method":"get"});
                                $('#budgetName').css('display','none');
                                $('#projectName').css('display','none');

                            } else{
                                $('#business_blong2').css('display','none');
                                $('#projectId2').css('display','none');
                                $('#budgetName').css('display','block');
                                $('#projectName').css('display','block');
                                setChildTaskFormValue(data);
                            }
                            if(data.projectId==""){
                                console.log("ceshi")
                                $('input:radio:last').prop('checked', 'checked');
                                $('#business_form').show();
                                $('#project_form').hide();
                            }
                        }
                    });
                }
                function reset() {
                    var elem = $('#taskListSelect');
                    elem.empty().append('<option value=""></option>');
                    elem.trigger("chosen:updated");

                }
                // 下级任务弹窗初始化
                function initelect(elem) {
                    elem.chosen({
                        no_results_text: "没有找到结果！", //搜索无结果时显示的提示
                        search_contains: true, //关键字模糊搜索。设置为true，只要选项包含搜索词就会显示；设置为false，则要求从选项开头开始匹配
                        allow_single_deselect: true, //单选下拉框是否允许取消选择。如果允许，选中选项会有一个x号可以删除选项
                        disable_search: false, //禁用搜索。设置为true，则无法搜索选项。
                        disable_search_threshold: 0, //当选项少等于于指定个数时禁用搜索。
                        inherit_select_classes: true, //是否继承原下拉框的样式类，此处设为继承
                        placeholder_text_multiple: '请选择任务成员', //单选选择框的默认提示信息，当选项为空时会显示。如果原下拉框设置了data-placeholder，会覆盖这里的值。
                        width: '100%', //设置chosen下拉框的宽度。即使原下拉框本身设置了宽度，也会被width覆盖。
                        max_shown_results: 1000, //下拉框最大显示选项数量
                        display_disabled_options: false,
                        single_backstroke_delete: false, //false表示按两次删除键才能删除选项，true表示按一次删除键即可删除
                        case_sensitive_search: false, //搜索大小写敏感。此处设为不敏感
                        group_search: false, //选项组是否可搜。此处搜索不可搜
                        include_group_label_in_selected: true //选中选项是否显示选项分组。false不显示，true显示。默认false。
                    });
                }
                // 下级任务弹窗赋值(子任务)
                function setChildTaskFormValue(obj) {
                    obj.parentTask = obj.taskId;

                    if (obj.planStartTime) {
                        obj.planStartTime = new Date(parseInt(obj.planStartTime)).toLocaleString()
                    }
                    if (obj.planEndTime) {
                        obj.planEndTime = new Date(parseInt(obj.planEndTime)).toLocaleString()
                    }
                    var title = $('.layui-tpl-container .layui-card-header');
                    var formNames = ['id', 'childTaskName', 'planStartTime', 'planEndTime', 'projectId', 'taskId','budgetName','projectName','parentTask','budgetId','taskTarget'];
                    obj.title && title.text(obj.title);
                    for (var i = 0; i < formNames.length; i++) {
                        if (obj[formNames[i]]) {
                            if(formNames[i]=="taskId"){
                                $('.layui-tpl-container  input[name="taskIdText"]').val(obj["belongTaskName"]);
                            }
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val(obj[formNames[i]]);
                        }
                        else {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val('');
                        }
                    }
                    if(obj.taskTarget){
                        $('.layui-tpl-container  textarea[name="taskTarget"]').val(obj.taskTarget);
                    }
                    if(obj.taskResultEOList&&obj.taskResultEOList.length!=0){
                        var html='';
                        for (var x = 0; x <obj.taskResultEOList.length ; x++) {
                            if(x==0){
                                $('.planOutcomesData').eq(x).val(obj.taskResultEOList[x].resultName);
                                $('.planOutcomesData').eq(x).attr('data-id',obj.taskResultEOList[x].id);
                            } else {
                                html+='<div style="display: inline-block;width: 100%;margin-top: 5px">\n' +
                                    '    <input maxlength="50" value="'+obj.taskResultEOList[x].resultName+'"  data-id="'+obj.taskResultEOList[x].id+'" lay-verify="required" autocomplete="off" type="text"  style="width: calc(100% - 40px);display: inline-block;" placeholder="请填写交付物" class="layui-input planOutcomesData" >\n' +
                                    '    <i class="clickImg layui-icon layui-icon-delete" style="font-size: 20px; margin-right:-50px;cursor:pointer" href="javascript:;" onclick="delPlanOutcomes(this)"></i>\n' +
                                    '</div>';
                            }
                        }
                        $('#planAddBox').append(html);
                    }
                    // if(obj.projectId==""){
                    //     $('.layui-tpl-container  input[name="taskIdText"]').val(obj["belongTaskName"]);
                    // }
                    if (obj.status) {
                        $("#status option[value='" + obj.status + "']").attr('selected', 'selected')
                        $("#status").trigger("chosen:updated");
                    }
                    if (obj.projectId) {
                        $('#business_form').hide();
                        $('#project_form').show();
                        $('input:radio:first').prop('checked', 'checked');
                        $('input:radio:last').prop('disabled', 'disabled');
                    } else {

                        $('#business_form').show();
                        $('#project_form').hide();
                        // setChildsetBudgetData(obj);
                        $('input:radio:last').prop('checked', 'checked');
                        $('input:radio:first').prop('disabled', 'disabled');
                    }
                    form.render("radio");
                }
                // 下级人物获取人员
                function getChildTaskUser(obj) {
                    admin.req("/api/budget/task/query/" + obj.taskId, {}, function(res) {

                        if (res.data == null || res.data.memberIds == null || res.data.memberNames == null) {
                            var option = '<option value="">暂无成员!</option>';
                            $("#personId").empty().append(option);
                            $("#personId").trigger("chosen:updated");
                            return;
                        }
                        for (var item of res.data.mapsList) {
                            $("#personId").append('<option value="' + item.id + '">' + item.name + '</option>');
                        }
                        $("#personId").trigger("chosen:updated");
                        /*
                         添加默认值
                         */
                        if (obj.personId) {
                            $("#personId option[value='" + obj.personId + "']").attr('selected', 'selected');
                            $("#personId").trigger("chosen:updated");
                        }


                    });
                }
                var flag = 0,
                    projectId = "";
                formSelects.on('project_blong', function(id, vals, val){
                    setTaskMember(0,val.value)
                });
                formSelects.on('business_blong', function(id, vals, val){
                    setTaskMember(1,val.value);
                });
                form.on('radio(type)',function(data){


                    if(data.value==="0")
                    {
                        $('#business_form').hide();
                        $('#project_form').show();
                        setProjectData({});
                        setTaskMember();
                    }
                    else if(data.value==1)
                    {
                        $('#business_form').show();
                        $('#project_form').hide();

                        setBudgetData({});
                        setTaskMember();
                    }else {//下级任务
                        if(data.othis[0].textContent.indexOf('业务任务')=='-1'){
//                项目任务
                            $('#business_form').hide();
                            $('#project_form').show();

                            $('#business_blong2').val('').trigger("chosen:updated");
                            $("#taskId").empty().trigger("chosen:updated");
                            $("#personId").empty().trigger("chosen:updated");
                        }else {
                            $('#business_form').show();
                            $('#project_form').hide();
                            $('#projectId2').val('').trigger("chosen:updated");
                            $("#taskId").empty().trigger("chosen:updated");
                            $("#personId").empty().trigger("chosen:updated");
                        }
                    }

                })
                function setProjectData(obj) {
                    admin.req('/api/budget/task/currentUserProject', {
                    }, function(res) {
                        var arr = res.data?res.data:[],
                            elem = $('#project_blong');
                        if(null==arr || arr.length==0){
                            elem.empty().append('');
                        } else {
                            for (var i = 0; i < arr.length; i++) {
                                if(arr[i].name)
                                {
                                    if(i == 0) {
                                        elem.empty().append('<option value="' + arr[i].id + '">' + arr[i].name + '</option>');
                                    }else{
                                        elem.append('<option value="' + arr[i].id + '">' + arr[i].name + '</option>');

                                    }
                                }
                            }
                        }
                        formSelects.render('project_blong');
                        formSelects.btns('project_blong', []);
                        $(".layui-input-block").css("overflow","");
                        if(obj.projectId)
                        {
                            formSelects.value('project_blong', [obj.projectId]);
                        }

                        if(projectId)
                        {
                            formSelects.disabled('project_blong');

                        }
                        else
                        {
                            formSelects.undisabled('project_blong');
                        }

                    });

                }

                // 任务弹窗赋值
                function setTaskFormValue(obj) {
                    var title = $('.layui-tpl-container .layui-card-header');
                    var formNames = ['id', 'handleType', 'name', 'planStartTime', 'planEndTime', 'taskStatus','taskTarget'];

                    obj.title && title.text(obj.title);
                    obj.planStartTime = obj.planStartTime ? formatDate(obj.planStartTime) : '';
                    obj.planEndTime = obj.planEndTime ? formatDate(obj.planEndTime) : '';
                    for (var i = 0; i < formNames.length; i++) {
                        if (obj[formNames[i]]) {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val(obj[formNames[i]]);
                        } else {
                            $('.layui-tpl-container  input[name="' + formNames[i] + '"]').val('');
                        }
                    }
                    if(obj.taskTarget){
                        $('.layui-tpl-container  textarea[name="taskTarget"]').val(obj.taskTarget);
                    }
                    if(obj.taskResultEOList&&obj.taskResultEOList.length!=0){
                        var html='';
                        for (var x = 0; x <obj.taskResultEOList.length ; x++) {
                            if(x==0){
                                $('.planOutcomesData').eq(x).val(obj.taskResultEOList[x].resultName);
                                $('.planOutcomesData').eq(x).attr('data-id',obj.taskResultEOList[x].id);
                            }else{
                                html+='<div style="display: inline-block;width: 100%;margin-top: 5px">\n' +
                                    '    <input maxlength="50" value="'+obj.taskResultEOList[x].resultName+'"  data-id="'+obj.taskResultEOList[x].id+'" lay-verify="required" autocomplete="off" type="text"  style="width: calc(100% - 40px);display: inline-block;" placeholder="请填写交付物" class="layui-input planOutcomesData" >\n' +
                                    '    <i class="clickImg layui-icon layui-icon-delete" style="font-size: 20px; margin-right:-50px;cursor:pointer" href="javascript:;" onclick="delPlanOutcomes(this)"></i>\n' +
                                    ' </div>';
                            }
                        }
                        $('#planAddBox').append(html);
                    }
                    //初始化项目
                    setTaskMember(obj);
                    // formSelects.data('taskStatus_blong', 'local', {
                    //     arr: [{name:'未完成',value:'未完成',},{name:'已完成',value:'已完成'}]
                    // });

                    // if(obj.taskStatus) {
                    //     formSelects.value('taskStatus_blong', [obj.taskStatus]);
                    //     form.render();
                    // }

                    formSelects.data('priority_blong', 'local', {
                        arr: [{name:'普通',value:'普通'},{name:'紧急',value:'紧急'},{name:'十分紧急',value:'十分紧急'}]
                    });

                    if(obj.priority) {
                        formSelects.value('priority_blong', [obj.priority]);
                        form.render();
                    }
                    if (flag==0) {
                        $('#business_form').hide();
                    }
                    else if(flag==1) {
                        obj.budgetId=BudgetId;
                    }
                    if(obj.handleType=='add') {
                        setProjectData(obj);
                    }
                    // modify by tls 20190223 start
                    if (obj.budgetId) {
                        $('input:radio:last').prop('checked', 'checked');
                        $('input:radio:first').prop('disabled', 'disabled');
                        $('#business_form').show();
                        $('#project_form').hide();
                        setBudgetData(obj);
                    } else if (obj.projectId) {
                        $('input:radio:first').prop('checked', 'checked');
                        $('input:radio:last').prop('disabled', 'disabled');
                        $('#business_form').hide();
                        $('#project_form').show();
                        setProjectData(obj);
                    }

                    if (obj.projectId){
                        setTaskMember(0,obj.projectId,obj);
                        obj.type=0;
                    } else if (obj.budgetId) {
                        setTaskMember(1,obj.budgetId,obj);
                        obj.type=1;
                    }

                    form.render('radio');
                }
                //5-7日修改接口为/api/budget/budget/getBelongBudget
                function setBudgetData(obj) {

                    admin.req('/api/budget/budget/getBelongBudget', {}, function (res) {
                        var arr = res.data,
                            elem = $('#business_blong');
                        elem.empty().append('');
                        for (var i = 0; i < arr.length; i++) {
                            if (arr[i].projectName) {
                                if (i == 0) {
                                    elem.empty().append('<option value="' + arr[i].id + '">' + arr[i].projectName + '</option>')
                                } else {
                                    elem.append('<option value="' + arr[i].id + '">' + arr[i].projectName + '</option>');
                                }
                            }
                        }
                        formSelects.render('business_blong');
                        formSelects.btns('business_blong', []);
                        if (obj.budgetId) {
                            formSelects.value('business_blong', [obj.budgetId]);
                            //formSelects.disabled('business_blong');
                        }
                        // TODO by tls 20190223
                        // if (BudgetId) {
                        //     formSelects.disabled('business_blong');
                        //
                        // }
                        // else {
                        //     formSelects.undisabled('business_blong');
                        // }


                    },{ method: 'get'});

                }
                //下级任务项目返现
                function setChildsetBudgetData(obj) {
                    console.log("下级业务返现")



                }

                //下级项目返现
                function setChildsetProjectData(obj) {
                    console.log("下级项目返现")
                    $('#projectId2').val(obj.projectId)
                    // admin.req('/api/budget/task/currentUserProject', {
                    // }, function(res)
                    // {
                    //     var arr = res.data,
                    //         elem = $('#project_blong');
                    //     console.log(elem)
                    //
                    //     if(arr.length==0){
                    //         elem.empty().append('');
                    //     } else {
                    //         for (var i = 0; i < arr.length; i++) {
                    //             if(arr[i].name)
                    //             {
                    //                 if(i == 0) {
                    //                     elem.empty().append('<option value="' + arr[i].id + '">' + arr[i].name + '</option>');
                    //                 }else{
                    //                     elem.append('<option value="' + arr[i].id + '">' + arr[i].name + '</option>');
                    //
                    //                 }
                    //             }
                    //         }
                    //     }
                    //
                    formSelects.render('projectId2');
                    formSelects.btns('projectId2', []);
                    //     $(".layui-input-block").css("overflow","");
                    //     if(obj.projectId)
                    //     {
                    formSelects.value('projectId2', [obj.projectId]);
                    //     }
                    //
                    //     if(projectId)
                    //     {
                    //         formSelects.disabled('project_blong');
                    //
                    //     }
                    //     else
                    //     {
                    //         formSelects.undisabled('project_blong');
                    //     }
                    //
                    // });

                }

                $("#closeAll").on('click', function () {
                    $(this).removeClass('disBlock').addClass('disNone');
                    $(this).siblings("#expandAll").removeClass('disNone').addClass('disBlock')
                    closeTree();
                });

                //收起树：只展开根节点下的一级节点
                function closeTree() {
                    var tree = $.fn.zTree.getZTreeObj('select-org');
                    //获取 zTree 的全部节点数据将节点数据转换为简单 Array 格式
                    var nodes = tree.transformToArray(tree.getNodes());
                    for (var i = 0; i < nodes.length; i++) {

                        tree.expandNode(nodes[i], false, true, false)

                    }
                }

                $(".dofer").on('mouseover',function(data){
                    $("#add-dropdown").css("display",'block');
                    if(data.target.id=='btn_Jump'||data.target.id=='btn_add'||data.target.id=='btn_manage'||data.target.id=='btn_research'||data.target.id=='btn_admin'||data.target.id=='btn_special'){
                        $("#manageBox").css("display",'block');
                    }else{
                        $("#manageBox").css("display",'none');
                    }
                }).on('mouseleave',function () {
                    $("#add-dropdown").css("display",'none');
                    $("#manageBox").css("display",'none');
                });
                $("#add-dropdown") .on('mouseleave',function () {
                    $("#add-dropdown").css("display",'none');
                });
                // window.onclick=function (event) {
                //     var e = event || window.event; //浏览器兼容性获取点击位置
                //     var elem = e.target || e.srcElement;
                //     while (elem) { //循环判断至跟节点，防止点击的是div子元素
                //         if (elem.id && elem.id == 'tanchu' ) {
                //             return;
                //         }else{
                //             $(".dropdown-menu").css("display",'none')
                //         }
                //         elem = elem.parentNode;
                //     }
                // }
                $("#expandAll").on('click', function () {
                    var treeObj = $.fn.zTree.getZTreeObj("select-org");
                    expandNodes(treeObj.getNodes());
                    $(this).removeClass('disBlock').addClass('disNone');
                    $(this).siblings("#closeAll").removeClass('disNone').addClass('disBlock')
                })

                function expandNodes(nodes) {
                    //如果nodes为null 则return
                    if (!nodes) return;
//将状态设置为expand
                    curStatus = 'expand';
                    //获取当前的树
                    var treeObj = $.fn.zTree.getZTreeObj("select-org");
                    //循环展开节点
                    for (var i = 0; i < nodes.length; i++) {
                        treeObj.expandNode(nodes[i], true, false, false);
                        //递归 如果子节点的是父节点则进行递归操作
                        if (nodes[i].isParent && nodes[i].zAsync) {
                            expandNodes(nodes[i].children);
                        } else {
                            goAsync = true;
                        }
                    }
                }

                function formatDate(time) {
                    var now = new Date(time)
                    var year = now.getFullYear(),
                        month = now.getMonth() + 1,
                        date = now.getDate(),
                        hour = now.getHours(),
                        minute = now.getMinutes(),
                        second = now.getSeconds();
                    return year + "-" + (month < 10 ? '0' + month : month) + "-" + (date < 10 ? '0' + date : date) + " " + (hour < 10 ? '0' + hour : hour) + ":" + (minute < 10 ? '0' + minute : minute) + ":" + (second < 10 ? '0' + second : second);
                }

                function setTaskMember(type, id, obj) {
                    if(taskFlag==0){
                        return
                    }
                    if (!id) {
                        var elem = $('#memberIds_blong');
                        elem.empty().append('');
                        formSelects.btns('memberIds_blong', ['select', 'remove', 'reverse']);
                        formSelects.render('memberIds_blong');
                        return;
                    }
                    var url = '';
                    if (type == 0) {
                        url = '/api/budget/project/hasPermissions/' + id +'/task';
                    }
                    else if (type == 1) {
                        url = '/api/budget/budget/users';
                    }
                    $.ajax({
                        type: "get",
                        url: url,
                        success: function (data) {
                            if(data.ok){
                                var arr ="";
                                if (type == 0) {
                                    arr = data.data.mapList;
                                }
                                else {
                                    arr = data.data;
                                }
                                elem = $('#memberIds_blong');
                                if (arr == null || arr.length == 0) {
                                    elem.empty().append('');
                                }
                                else {
                                    elem.empty();
                                    for (var i = 0; i < arr.length; i++) {
                                        if (arr[i].name) {
                                            elem.append('<option value="' + arr[i].id + '">' + arr[i].name + '</option>');
                                        }
                                    }
                                }
                                //formSelects.render('memberIds_blong');
                                //formSelects.btns('memberIds_blong',[] );

                                formSelects.btns('memberIds_blong', ['select', 'remove', 'reverse']);
                                formSelects.render('memberIds_blong');
                                var goslist = [];
                                if (obj) {
                                    for (var i in obj.mapsList) {
                                        goslist.push(obj.mapsList[i].id)
                                    }
                                    formSelects.value('memberIds_blong', goslist);
                                }
                                for(var item of arr)
                                {
                                    $('dd[lay-value="' + item.id + '"]').attr('title',item.orgName);
                                }
                            } else{
                                $("#project_blong>option[selected]").removeAttr("selected");
                                $("#memberIds_blong").empty();
                                formSelects.render('project_blong');
                                formSelects.render('memberIds_blong');
                                layer.msg(data.message, {
                                    icon: 5
                                });
                            }
                        }
                    })
                }

                //业务删除方法
                function budgetDel(node,ztree){
                    var delArr=[];
                    if (node == null) {
                        return layer.msg('请选择要删除的业务', {
                            icon: 0
                        });
                    }
                    // layer.confirm("是否确定删除业务:" + node.nameTitle,{icon:3,title:"删除"},
                    delArr.push(node.id);
                    admin.req('/api/budget/budget/' + delArr.join(','), {},
                        function(data) {
                            if (data.ok) {
                                layer.msg('数据删除成功！', {
                                    icon: 1
                                });
                                ztree.removeNode(node);
                                table.reload('tableContent', {
                                    where: {
                                        reload: new Date().getTime()
                                    }
                                });
                            } else {
                                return layer.msg('数据删除失败:' + data.message, {
                                    icon: 5
                                });
                            }
                        }, {
                            method: 'delete'
                        });
                }
                //项目删除方法
                function projectDel(node,ztree){
                    if (node == null) {
                        return layer.msg('请选择要删除的项目', {
                            icon: 0
                        });
                    };
                    var delArr = [];
                    delArr.push(node.id);
                    admin.req('/api/budget/project/' + delArr.join(','), {},
                        function(data) {
                            if (data.ok) {
                                layer.msg('删除项目成功！', {
                                    icon: 1
                                });
                                ztree.removeNode(node);
                                table.reload('tableContent-pro', {
                                    where: {
                                        reload: new Date().getTime()
                                    }
                                });
                            } else {
                                return layer.msg('删除项目失败:' + data.message, {
                                    icon: 5
                                });
                            }
                        }, {
                            method: 'delete'
                        });

                }
                //任务删除方法
                function taskDel(node,ztree){
                    if (node == null) {
                        return layer.msg('请选择要删除的任务', {
                            icon: 0
                        });
                    };
                    admin.req('/api/budget/task/' + node.id, {}, function(data) {
                        if (data.ok) {
                            layer.msg('删除任务成功！', {
                                icon: 1
                            });
                            ztree.removeNode(node);
                            table.reload('tableContent-task', {
                                where: {
                                    reload: new Date().getTime()
                                }
                            });
                        } else {
                            return layer.msg('删除角色信息失败:' + data.message, {
                                icon: 5
                            });
                        }
                    }, {
                        method: 'delete'
                    });
                }
                // 下级任务删除方法
                function childTaskDel(node,ztree){
                    if (node == null) {
                        return layer.msg('请选择要删除的下级任务', {
                            icon: 0
                        });
                    };
                    admin.req('/api/budget/childrentask/' + node.id, {}, function(data) {
                        if (data.ok) {
                            layer.msg('删除任务成功！', {
                                icon: 1
                            });
                            ztree.removeNode(node);
                            // rereshNode(node.id)
                        } else {
                            return layer.msg('删除下级任务信息失败:' + data.message, {
                                icon: 5
                            });
                        }
                    }, {
                        method: 'delete'
                    });


                }
                // 保存业务
                form.on('submit(menuSave-budget)', function(data) {
                    console.log(data,'100000');
                    // return;
                    var d = data.field,
                        elem = data.elem;
                    // if (d.property && d.property!=2){
                        if(d.cycle) {
                            var cycle = d.cycle.split(' - ');
                            if (cycle) {
                                if(new Date(cycle[0]).getTime() - (new Date(cycle[1]).getTime()) > 0){
                                    layer.msg('开始时间不能大于结束时间');
                                    return
                                }
                                d.cycleBegin = cycle[0];
                                d.cycleEnd = cycle[1];
                            }
                        }
                        var ajaxType = localStorage.getItem('type');
                        admin.req('/api/budget/budget', d, function(res) {
                            if (res.ok) {
                                table.reload('tableContent', {
                                    where: {
                                        reload: new Date().getTime()
                                    }
                                });
                                admin.finishPopupCenter();
                                addTree(null,res.data.id);
                            } else {
                                layer.msg('保存失败' + res.message, {
                                    icon: 5
                                });
                            }
                        }, {method: ajaxType});
                    // }else{
                    //     layer.msg('开发中', {
                    //         icon: 1
                    //     });
                    // }
                });

               // formSelects.on('business_blong', function(id, vals, val){
               //     setTaskMember(1,val.value);
               // });

                // 刷新父节点
                function refreshNode(id){
                    var treeObj = $.fn.zTree.getZTreeObj("select-org")

                    var node = treeObj.getNodeByParam("id",id,null)

                    treeObj.updateNode(node)
                }
                // 触发选中事件
                // zTreeObj.setting.callback.onClick(null, zTreeObj.setting.treeId, zTreeObj.getNodeByParam("id",zTreeObj.getNodes()[0].id,null));
                var leaderProjectId = sessionStorage.getItem("leaderProjectId");
                var leaderTaskId = sessionStorage.getItem("leaderTaskId");
                var zTree = $.fn.zTree.getZTreeObj("select-org");
                //判断是否从领导视角页面跳转过来
                if(leaderProjectId){
                    $(".RightContent").hide();
                    $('#nodata').hide();
                    $("#projectDetailDiv").show();
                    new projectDetail(leaderProjectId);
                    var node = zTree.getNodeByParam("id",leaderProjectId);
                    zTree.selectNode(node);
                    sessionStorage.removeItem('leaderProjectId');
                }
                if(leaderTaskId){
                    $(".RightContent").hide();
                    $('#nodata').hide();
                    $("#taskDetailDiv").show();
                    new taskDetail(leaderTaskId);
                    var node = zTree.getNodeByParam("id",leaderTaskId);
                    zTree.selectNode(node);
                    sessionStorage.removeItem('leaderTaskId');
                }
            });
        }
        //里程碑

        var oldId;
        var renderTable = function (id,status,projectName) {
            if (!status && status!=0) {
                status = '';
            }
            if(id != oldId){
                $('#statusChange').val('全部')
                oldId= id
            }

            var statusArr = ['未开始','未完成','未完成（已有风险）','已完成']
            table.render({
                elem: '#milestone-form',
                id: 'milestone-form',
                url: admin.formatUrl('/api/progress/projectMilepost/page4Tips'),
                contentType: "application/json",
                method: 'post',
                // 格式化后台返回的数据
                parseData: function (res) {
                    return {
                        "code": res.respCode, //解析接口状态
                        "msg": res.message, //解析提示文本
                        "count": res.data.count, //解析数据长度
                        "data": res.data.list //解析数据列表
                    };
                },
                cols: [
                    [{
                        field: 'milepostName',
                        title: '里程碑名称',
                        width: 160,
                        templet:function(d) {
                            var text= d.milepostName ? d.milepostName : "";
                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                        }
                    }, {
                        field: 'milepostManagerName',
                        title: '负责人',
                        align: 'center',
                        templet:function(d) {
                            var text= d.milepostManagerName ? d.milepostManagerName : "";
                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                        }
                    }, {
                        field: 'milepostBeginTime',
                        title: '开始时间',
                        align: 'center',
                        templet: function(d) {
                            return d.milepostBeginTime?layui.util.toDateString(d.milepostBeginTime,'yyyy-MM-dd'):'';
                        }
                    }, {
                        field: 'milepostEndTime',
                        title: '结束时间',
                        align: 'center',
                        templet: function(d) {
                            return d.milepostEndTime?layui.util.toDateString(d.milepostEndTime,'yyyy-MM-dd'):'';
                        }
                    }, {
                        field: 'milepostTarget',
                        title: '目标',
                        align: 'center',
                        templet:function(d) {
                            var text= d.milepostTarget ? d.milepostTarget : "";
                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                        }
                    }, {
                        field: 'finishStatus',
                        title: '项目完成状态',
                        align: 'center',
                        templet:function(d) {
                            var color;
                            if(d.finishStatus==9){
                                color='#00BE36';
                            }else if(d.finishStatus==6||d.finishStatus==3){
                                color='#FF0000';
                            }else if(d.finishStatus==0){
                                color='#999';
                            }
                            var text= d.finishStatus||d.finishStatus==0 ? statusArr[d.finishStatus/3]: "";
                            return '<div style="color:'+color+'" title="'+text+'"><span>'+ text +'</span></div>'
                        }
                    }, {
                        field: 'resultName',
                        title: '预计成果物',
                        align: 'center',
                        width: 160,
                        templet:function(d) {
                            var text= d.resultName ? d.resultName : '';
                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                        }
                    }, {
                        templet: '#control-2',
                        title: '操作',
                        align: 'center',
                        unresize: true,
                    }]
                ],
                page: {
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                },
                request: {
                    pageName: 'page',
                    limitName: 'pageSize'
                },
                cellMinWidth: 120,
                where: {
                    projectId: id,
                    finishStatus: status
                },
                skin: 'row',
                even: true,
                done: function(){
                    if($('.milestone').find('.layui-table-body').children().length>1){
                        $('.milestone').find('.layui-table-body').find('.layui-none').remove();
                        $('.milestone').find('.layui-table-body').append('<div class="box" style="width: 100%;"><img src="../../assetsInfo/images/box.jpg" alt=""></div>')
                    }
                }
            });
            table.on('tool(milestone-form)', function (obj) {
                // 获取点击列的数据
                var data = obj.data;
                var layEvent = obj.event;
                if (layEvent === 'view'){
                    if(data.finishStatus==9||data.extInfo1){
                        json = JSON.stringify(data);
                        layer.open({
                            type: 2,
                            title: data.milepostName,
                            area: ['80%', '90%'], //宽高
                            content: 'components/tpl/milestone_form.html',
                            btn: ['确定', '取消']
                        });
                    }else if(data.finishStatus==0||data.finishStatus==3||data.finishStatus==6){
                        if(projectIsChange){
                            var processDefinitionKey='p5992ffe665f44d859c912f725eb771f2';
                            admin.req('/api/activiti/repository/getProcessStartRequestForm', {
                                processDefinitionKey: processDefinitionKey
                            }, function (result) {
                                if (result.ok && result.data != null) {
                                    if (result.data.id.indexOf('.html') > 0) {
                                        // 外部表单流程
                                        admin.popupCenter({
                                            title: '启动流程',
                                            path: 'components/tpl/process_def_tpl_start.html',
                                            area: ['90%', '90%'],
                                            finish: function () {

                                            },
                                            success: function () {
                                                $("#process_def_tpl_start").load(result.data.id);
                                                $("#process_id").val(data.processId);
                                                $("#process_key").val(data.processKey);
                                                $("#isExternalForm").val('1');
                                            }
                                        });
                                    } else {
                                        // 正常流程
                                        admin.req('/api/form/' + result.data.id, {}, function (response) {
                                            if (response.data.design == 1) {} else {
                                                var newData = $.extend({}, data, result);
                                                newData.processDefinitionKey=processDefinitionKey;
                                                ADCFormDesignHelper.startProcess(newData, function () {
                                                    table.reload('milestone-form', {
                                                        where: {
                                                            reload: new Date().getTime()
                                                        }
                                                    });
                                                },false,data.id,projectName);
                                            }
                                        });
                                    }
                                }

                            }, {
                                method: 'POST'
                            });
                        }else{
                            layer.msg('请先完成项目变更申请表流程', {
                                icon: 5,
                           });
                        }

                        }
                }
            })
            $('#statusChange').off('change').on('change', function(){
                var status =$(this).val();
                var finishStatus;
                if(statusArr.indexOf(status)!= -1){
                    finishStatus = statusArr.indexOf(status)*3
                }
                renderTable(id,finishStatus,projectName);

            });
        }
        // 项目交付物
        upload.render({
                elem: '.uploadFile',
                url: '/api/progress/projectMilepostResult/upload',
                field: 'file',
                accept: 'file',
                multiple: 'true',
                exts:'pdf|doc|docx|xlsx|xls|zip|rar|jpg|jpeg|png|gif|ppt|pptx',
                data: {
                    milepostResultId: function(){
                        return  $('.uploadFile').attr('name')
                    }
                },
                done: function(res) {
                    console.log(res,234)
                    if (res.ok) {
                        layer.msg('文件上传成功！', {
                            icon: 1
                        });
                        table.reload('deliverable-form', {
                            where: {
                                reload: new Date().getTime()
                            }
                        });
                    } else {
                        layer.msg('文件上传失败：' + res.message, {
                            icon: 5
                        });
                    }
                },
            });
        var renderTree = function (id) {
            $('.deliverable-tree').children('li').remove();
            $('.deliverable-box .layui-form').remove();
            /*$('.uploadFile').addClass('disable');
            $('.moveFile').addClass('disable');*/
            /*$('.right').hide()
            $('.uploadFile').hide();
            $('.moveFile').hide();*/
            /*$('.box').show();*/
//            $('#deliverable-box .layui-form').hide()

            var newData = [];
            $.ajax({
                type: "get",
                url: "/api/progress/detail/tree?projectId="+id,
                success: function (data) {
                    if (data !=null) {
                        var childrenData = []
                        var data = data.data
                        for(var i=0; i<data.length; i++){
                            if(data[i].type ==1){
                                newData.push(data[i])
                            }else if(data[i].type ==2){
                                childrenData.push(data[i])
                            }
                        }
                        for(var j=0; j<newData.length; j++){
                            newData[j].children=[];
                            for(var i=0; i<childrenData.length; i++){
                                if(childrenData[i].parentId==newData[j].id){
                                    newData[j].children.push(childrenData[i])
                                }
                            }
                        }

                        tableShow();
                        function tableShow(url,item){
                            if(item){
                                if(item.type==1){
                                    var stageId=item.id
                                }else{
                                    var milepostId=item.id
                                }
                            }
                            table.render({
                                elem: '#deliverable-form',
                                id: 'deliverable-form',
                                url: url?url:'',
                                data: [],
                                contentType: "application/json",
                                method: 'post',
                                // 格式化后台返回的数据
                                parseData: function (res) {
                                    return {
                                        "code": res.respCode, //解析接口状态
                                        "msg": res.message, //解析提示文本
                                        "count": res.data?res.data.count:'', //解析数据长度
                                        "data": res.data?res.data.list:[] //解析数据列表
                                    };
                                },
                                cols: [
                                    [{
                                        type: 'checkbox'
                                    },
                                        {
                                            field: 'fileName',
                                            title: '文件名称',
                                            align: 'center',
                                            templet:function(d) {
                                                var text= d.fileName ? d.fileName : "";
                                                return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                            }
                                        }, {
                                        field: 'fileSize',
                                        title: '大小',
                                        align: 'center',
                                        width: 60,
                                        templet:function(d) {
                                            var text= d.fileSize ? d.fileSize : "";
                                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                        }
                                    }, {
                                        field: 'uploadUserName',
                                        title: '上传人',
                                        align: 'center',
                                        templet:function(d) {
                                            var text= d.uploadUserName ? d.uploadUserName : "";
                                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                        }
                                    }, {
                                        field: 'createTime',
                                        title: '上传时间',
                                        align: 'center',
                                        templet: function(d) {
                                            return d.createTime?layui.util.toDateString(d.createTime,'yyyy-MM-dd'):'';
                                        }
                                    }, {
                                        templet: '#control-3',
                                        title: '操作',
                                        align: 'center',
                                        unresize: true,
                                        width: 150
                                    }]
                                ],
                                page: {
                                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                                },
                                /*page: true,
                                limit: 10, //显示的数量
                                limits:[10,15,20,25,30],*/
                                request: {
                                    pageName: 'page',
                                    limitName: 'pageSize'
                                },
                                where: {
                                    stageId: stageId?stageId:'',
                                    milepostId: milepostId?milepostId:''
                                },
                                height: 386,
                                cellMinWidth: 70,
                                skin: 'row',
                                even: true,
                                done: function(){
                                    $('#deliverable-box').find('.layui-table-body').find('.box').remove()
                                    if($('#deliverable-box').find('.layui-table-body').children().length>1){
                                        $('#deliverable-box').find('.layui-table-body').find('.layui-none').remove();
                                        $('#deliverable-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: 310px; text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: 310px"></div>')
                                    }
                                }
                            });
                            table.on('tool(deliverable-form)', function (obj) {
                                // 获取点击的数据
                                var data = obj.data;
                                var layEvent = obj.event;
                                if (layEvent === 'download'){
                                    window.location.href = "/api/progress/projectMilepostResult/"+data.fileId+'/download';
                                }else if(layEvent === 'delete'){
                                    layer.confirm('确认要删除文件: ' + data.fileName+ '?', {
                                        icon: 3,
                                        title: '提示'
                                    }, function () {
                                        admin.req('/api/progress/projectMilepostResult/deleteFile/'+data.fileId, {},function (data) {
                                            if (data.ok) {
                                                layer.msg('删除成功', {
                                                    icon: 1
                                                });
                                                table.reload('deliverable-form', {
                                                    where: {
                                                        reload: new Date().getTime()
                                                    }
                                                });

                                            } else {
                                                return layer.msg(data.reason, {
                                                    icon: 5
                                                });
                                            }
                                        }, {
                                            method: 'get'
                                        });
                                    });
                                }
                            })

                        }
                        //移动
                        $('.moveFile').off('click').on('click', function(){
                            var checkStatus = table.checkStatus('deliverable-form');
                            console.log(checkStatus,123)
                            if (checkStatus.data.length == 0) {
                                return layer.msg('请选择至少一个文件！', {
                                    icon: 0
                                });
                            }
                            var fileIdArr = [];
                            var foreignId;
                            for(var i = 0; i<checkStatus.data.length; i++){
                                fileIdArr.push(checkStatus.data[i].fileId)
                            }
                            var index = layer.open({
                                type: 1,
                                title:'移动',
                                area: ['360px', '430px'],
                                btn: ['确定', '取消'],
                                content: '<div>'+
                                    '<div id="deliverable-movetree" class="deliverable-tree" style=" padding: 20px 0 0 30px;height: 310px"></div>'+
                                    '</div>',
                                yes: function(index, layero){
                                    if(!foreignId){
                                        return layer.msg('请选择阶段或里程碑！', {
                                            icon: 0
                                        });
                                    }
                                    $.ajax({
                                        type: "get",
                                        url: "/api/progress/projectMilepostResult/moveFile/"+fileIdArr+'/'+foreignId,
                                        success: function (data) {
                                            if (data.ok) {
                                                layer.msg('移动成功！', {
                                                    icon: 1
                                                });
                                                table.reload('deliverable-form', {
                                                    where: {
                                                        reload: new Date().getTime()
                                                    }
                                                });
                                            } else {
                                                layer.msg('移动失败：' + res.message, {
                                                    icon: 5
                                                });
                                            }
                                        },
                                        error: function () {
                                            layer.alert("获取数据错误");
                                        }
                                    });
                                    layer.close(index)
                                }

                            });
                            layui.tree({
                                elem: '#deliverable-movetree', //指定元素
                                showLine: 'false',
                                nodes: newData,
                                click: function(item){ //点击节点回调
                                    foreignId = item.id;
                                }
                            });
                            $('#deliverable-movetree li a cite').on('click', function(){
                                $('#deliverable-movetree li a cite').css('color', '#666')
                                $(this).css('color', '#18B1EB')
                            })
                            $('#deliverable-movetree li>a').off('dblclick')
                            $('#deliverable-movetree li').find('.layui-tree-spread').parent().prepend('<img src="../../assetsInfo/images/icon/shouqi.png"/><img style="display:none" src="../../assetsInfo/images/icon/zhankai1.png"/>')
                            $('#deliverable-movetree li').find('.layui-tree-leaf').parent().parent().prepend('<img src="../../assetsInfo/images/icon/zhankai.png"/>')
                            $('#deliverable-movetree li').find('img').css('cursor', 'pointer');

                            /*$('#deliverable-movetree li').find('.layui-tree-spread').parent().children('a').on('click', function(){
                                $(this).parent().find('img').toggle();
                                $(this).parent().find('ul').toggleClass('layui-show')
                            })*/
                            $('#deliverable-movetree li').find('.layui-tree-spread').parent().children('img').off('click').on('click', function(){
                                $(this).parent().find('img').toggle();
                                $(this).parent().find('ul').toggleClass('layui-show')
                            })
                        })
                        layui.tree({
                            elem: '#deliverable-tree', //指定元素
                            showLine: 'false',
                            nodes: newData,
                            click: function(item){ //点击节点回调
                                var url = '/api/progress/myFileEO/myFilePage';
                                tableShow(url,item);
//                                $('.box').hide();
                                $('.uploadFile').attr('name', item.id);
                                /* $('.uploadFile').removeClass('disable');
                                 $('.moveFile').removeClass('disable');*/
                                /*$('.uploadFile').show();
                                $('.moveFile').show();
                                $('.right').show();*/

                            }
                        });
                        //默认选中第一个树节点
                        $('.deliverable-tree li a cite').first().css('color', '#18B1EB');
                        tableShow('/api/progress/myFileEO/myFilePage',newData[0]);
                        $('.uploadFile').attr('name', newData[0].id);
                        //左侧树样式
                        $('#deliverable-tree li a cite').on('click', function(){
                            $('.deliverable-tree li a cite').css('color', '#666')
                            $(this).css('color', '#18B1EB')
                        })
                        var citeArr = document.getElementsByTagName("cite")
                        for(i=0;i<citeArr.length;i++){
                            var text = citeArr[i].innerText
                            $(citeArr[i]).attr('title',text)
                        }
                        $('#deliverable-tree li>a').off('dblclick')
                        $('#deliverable-tree li').find('.layui-tree-spread').parent().prepend('<img src="../../assetsInfo/images/icon/shouqi.png"/><img style="display:none" src="../../assetsInfo/images/icon/zhankai1.png"/>')
                        $('#deliverable-tree li').find('.layui-tree-leaf').parent().parent().prepend('<img src="../../assetsInfo/images/icon/zhankai.png"/>')
                        $('#deliverable-tree li').find('img').css('cursor', 'pointer');

                        /* $('#deliverable-tree li').find('.layui-tree-spread').parent().children('a').on('click', function(){
                             $(this).parent().find('img').toggle();
                             $(this).parent().find('ul').toggleClass('layui-show')
                         })*/
                        $('#deliverable-tree li').find('.layui-tree-spread').parent().children('img').off('click').on('click', function(){
                            $(this).parent().find('img').toggle();
                            $(this).parent().find('ul').toggleClass('layui-show')
                        })
                    } else {
                        layer.alert(data);
                    }

                },
                error: function () {
                    layer.alert("获取数据错误");
                }
            });


        }
        // 任务交付物上传
        upload.render({
            elem: '.taskuploadFile',
            url: '/api/progress/projectMilepostResult/upload',
            field: 'file',
            accept: 'file',
            multiple: 'true',
            exts:'pdf|doc|docx|xlsx|xls|zip|rar|jpg|jpeg|png|gif|ppt|pptx',
            data: {
                milepostResultId: function(){
                    return  $('.uploadFile').attr('name')
                }
            },
            done: function(res) {
                if (res.ok) {
                    layer.msg('文件上传成功！', {
                        icon: 1
                    });
                    table.reload('taskdeliverable-form', {
                        where: {
                            reload: new Date().getTime()
                        }
                    });
                } else {
                    layer.msg('文件上传失败：' + res.message, {
                        icon: 5
                    });
                }
            },
        })
        var renderTreeTask = function (id) {
            $('.taskdeliverable-tree').children('li').remove();
            $('.taskdeliverable-box .layui-form').remove();
            /*$('.uploadFile').addClass('disable');
            $('.moveFile').addClass('disable');*/
            /*$('.right').hide()
            $('.uploadFile').hide();
            $('.moveFile').hide();*/
            /*$('.box').show();*/
            //$('#deliverable-box .layui-form').hide()

            var newData = [];
            $.ajax({
                type: "get",
                url: "/api/progress/detail/tree?projectId="+id,
                success: function (data) {
                    if (data !=null) {
                        var childrenData = []
                        var data = data.data
                        for(var i=0; i<data.length; i++){
                            if(data[i].type ==1){
                                newData.push(data[i])
                            }else if(data[i].type ==2){
                                childrenData.push(data[i])
                            }
                        }
                        for(var j=0; j<newData.length; j++){
                            newData[j].children=[];
                            for(var i=0; i<childrenData.length; i++){
                                if(childrenData[i].parentId==newData[j].id){
                                    newData[j].children.push(childrenData[i])
                                }
                            }
                        }

                        tableShow();
                        function tableShow(url,item){
                            if(item){
                                if(item.type==1){
                                    var stageId=item.id
                                }else{
                                    var milepostId=item.id
                                }
                            }
                            table.render({
                                elem: '#taskdeliverable-form',
                                id: 'taskdeliverable-form',
                                url: url?url:'',
                                data: [],
                                contentType: "application/json",
                                method: 'post',
                                // 格式化后台返回的数据
                                parseData: function (res) {
                                    return {
                                        "code": res.respCode, //解析接口状态
                                        "msg": res.message, //解析提示文本
                                        "count": res.data?res.data.count:'', //解析数据长度
                                        "data": res.data?res.data.list:[] //解析数据列表
                                    };
                                },
                                cols: [
                                    [{
                                        type: 'checkbox'
                                    },
                                        {
                                            field: 'fileName',
                                            title: '文件名称',
                                            align: 'center',
                                            templet:function(d) {
                                                var text= d.fileName ? d.fileName : "";
                                                return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                            }
                                        }, {
                                        field: 'fileSize',
                                        title: '大小',
                                        align: 'center',
                                        width: 60,
                                        templet:function(d) {
                                            var text= d.fileSize ? d.fileSize : "";
                                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                        }
                                    }, {
                                        field: 'uploadUserName',
                                        title: '上传人',
                                        align: 'center',
                                        templet:function(d) {
                                            var text= d.uploadUserName ? d.uploadUserName : "";
                                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                        }
                                    }, {
                                        field: 'createTime',
                                        title: '上传时间',
                                        align: 'center',
                                        templet: function(d) {
                                            return d.createTime?layui.util.toDateString(d.createTime,'yyyy-MM-dd'):'';
                                        }
                                    }, {
                                        templet: '#control-3',
                                        title: '操作',
                                        align: 'center',
                                        unresize: true,
                                        width: 150
                                    }]
                                ],
                                page: {
                                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                                },
                                /*page: true,
                                limit: 10, //显示的数量
                                limits:[10,15,20,25,30],*/
                                request: {
                                    pageName: 'page',
                                    limitName: 'pageSize'
                                },
                                where: {
                                    stageId: stageId?stageId:'',
                                    milepostId: milepostId?milepostId:''
                                },
                                height: 386,
                                cellMinWidth: 70,
                                skin: 'row',
                                even: true,
                                done: function(){
                                    $('#taskdeliverable-box').find('.layui-table-body').find('.box').remove()
                                    if($('#taskdeliverable-box').find('.layui-table-body').children().length>1){
                                        $('#taskdeliverable-box').find('.layui-table-body').find('.layui-none').remove();
                                        $('#taskdeliverable-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: 310px; text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: 310px"></div>')
                                    }
                                }
                            });
                            table.on('tool(taskdeliverable-form)', function (obj) {
                                // 获取点击的数据
                                var data = obj.data;
                                var layEvent = obj.event;
                                if (layEvent === 'download'){
                                    window.location.href = "/api/progress/projectMilepostResult/"+data.fileId+'/download';
                                }else if(layEvent === 'delete'){
                                    layer.confirm('确认要删除文件: ' + data.fileName+ '?', {
                                        icon: 3,
                                        title: '提示'
                                    }, function () {
                                        admin.req('/api/progress/projectMilepostResult/deleteFile/'+data.fileId, {},function (data) {
                                            if (data.ok) {
                                                layer.msg('删除成功', {
                                                    icon: 1
                                                });
                                                table.reload('taskdeliverable-form', {
                                                    where: {
                                                        reload: new Date().getTime()
                                                    }
                                                });

                                            } else {
                                                return layer.msg(data.reason, {
                                                    icon: 5
                                                });
                                            }
                                        }, {method: 'get'});
                                    });
                                }
                            })

                        }
                        //移动
                        $('.taskmoveFile').off('click').on('click', function(){
                            var checkStatus = table.checkStatus('taskdeliverable-form');
                            console.log(checkStatus,123)
                            if (checkStatus.data.length == 0) {
                                return layer.msg('请选择至少一个文件！', {
                                    icon: 0
                                });
                            }
                            var fileIdArr = [];
                            var foreignId;
                            for(var i = 0; i<checkStatus.data.length; i++){
                                fileIdArr.push(checkStatus.data[i].fileId)
                            }
                            var index = layer.open({
                                type: 1,
                                title:'移动',
                                area: ['360px', '430px'],
                                btn: ['确定', '取消'],
                                content: '<div>'+
                                    '<div id="taskdeliverable-movetree" class="taskdeliverable-tree" style=" padding: 20px 0 0 30px;height: 310px"></div>'+
                                    '</div>',
                                yes: function(index, layero){
                                    if(!foreignId){
                                        return layer.msg('请选择阶段或里程碑！', {
                                            icon: 0
                                        });
                                    }
                                    $.ajax({
                                        type: "get",
                                        url: "/api/progress/projectMilepostResult/moveFile/"+fileIdArr+'/'+foreignId,
                                        success: function (data) {
                                            if (data.ok) {
                                                layer.msg('移动成功！', {
                                                    icon: 1
                                                });
                                                table.reload('taskdeliverable-form', {
                                                    where: {
                                                        reload: new Date().getTime()
                                                    }
                                                });
                                            } else {
                                                layer.msg('移动失败：' + res.message, {
                                                    icon: 5
                                                });
                                            }
                                        },
                                        error: function () {
                                            layer.alert("获取数据错误");
                                        }
                                    });
                                    layer.close(index)
                                }

                            });
                            layui.tree({
                                elem: '#taskdeliverable-movetree', //指定元素
                                showLine: 'false',
                                nodes: newData,
                                click: function(item){ //点击节点回调
                                    foreignId = item.id;
                                }
                            });
                            $('#taskdeliverable-movetree li a cite').on('click', function(){
                                $('#taskdeliverable-movetree li a cite').css('color', '#666')
                                $(this).css('color', '#18B1EB')
                            })
                            $('#taskdeliverable-movetree li>a').off('dblclick')
                            $('#taskdeliverable-movetree li').find('.layui-tree-spread').parent().prepend('<img src="../../assetsInfo/images/icon/shouqi.png"/><img style="display:none" src="../../assetsInfo/images/icon/zhankai1.png"/>')
                            $('#taskdeliverable-movetree li').find('.layui-tree-leaf').parent().parent().prepend('<img src="../../assetsInfo/images/icon/zhankai.png"/>')
                            $('#taskdeliverable-movetree li').find('img').css('cursor', 'pointer');

                            /*$('#deliverable-movetree li').find('.layui-tree-spread').parent().children('a').on('click', function(){
                                $(this).parent().find('img').toggle();
                                $(this).parent().find('ul').toggleClass('layui-show')
                            })*/
                            $('#taskdeliverable-movetree li').find('.layui-tree-spread').parent().children('img').off('click').on('click', function(){
                                $(this).parent().find('img').toggle();
                                $(this).parent().find('ul').toggleClass('layui-show')
                            })
                        })
                        layui.tree({
                            elem: '#taskdeliverable-tree', //指定元素
                            showLine: 'false',
                            nodes: newData,
                            click: function(item){ //点击节点回调
                                var url = '/api/progress/myFileEO/myFilePage';
                                tableShow(url,item);
//                                $('.box').hide();
                                $('.taskuploadFile').attr('name', item.id);
                                /* $('.uploadFile').removeClass('disable');
                                 $('.moveFile').removeClass('disable');*/
                                /*$('.uploadFile').show();
                                $('.moveFile').show();
                                $('.right').show();*/

                            }
                        });
                        //默认选中第一个树节点
                        $('.taskdeliverable-tree li a cite').first().css('color', '#18B1EB');
                        tableShow('/api/progress/myFileEO/myFilePage',newData[0]);
                        $('.taskuploadFile').attr('name', newData[0].id);
                        //左侧树样式
                        $('#taskdeliverable-tree li a cite').on('click', function(){
                            $('.taskdeliverable-tree li a cite').css('color', '#666')
                            $(this).css('color', '#18B1EB')
                        })
                        var citeArr = document.getElementsByTagName("cite")
                        for(i=0;i<citeArr.length;i++){
                            var text = citeArr[i].innerText
                            $(citeArr[i]).attr('title',text)
                        }
                        $('#taskdeliverable-tree li>a').off('dblclick')
                        $('#taskdeliverable-tree li').find('.layui-tree-spread').parent().prepend('<img src="../../assetsInfo/images/icon/shouqi.png"/><img style="display:none" src="../../assetsInfo/images/icon/zhankai1.png"/>')
                        $('#taskdeliverable-tree li').find('.layui-tree-leaf').parent().parent().prepend('<img src="../../assetsInfo/images/icon/zhankai.png"/>')
                        $('#taskdeliverable-tree li').find('img').css('cursor', 'pointer');

                        /* $('#deliverable-tree li').find('.layui-tree-spread').parent().children('a').on('click', function(){
                             $(this).parent().find('img').toggle();
                             $(this).parent().find('ul').toggleClass('layui-show')
                         })*/
                        $('#taskdeliverable-tree li').find('.layui-tree-spread').parent().children('img').off('click').on('click', function(){
                            $(this).parent().find('img').toggle();
                            $(this).parent().find('ul').toggleClass('layui-show')
                        })
                    } else {
                        layer.alert(data);
                    }

                },
                error: function () {
                    layer.alert("获取数据错误");
                }
            });
        }
    })

</script>
