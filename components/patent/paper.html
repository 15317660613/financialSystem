
<style>
    #paper-tree{
        float:left;
        width: 19%;
        height: 97%;
        padding-top: 10px;
        border:1px solid #F5F5F5;
        overflow: auto;
    }
    .paperRight{
        float:right;
        width: 78%;
        height:calc(100vh - 150px);
        /*height: 490px;*/
    }
    /*#paper-box .layui-form{*/
        /*height: calc(100vh - 170px)*/
    /*}*/
    .right{
        position: absolute;
        top: 50%;
        left: 21%
    }
    #tabTitle{
        box-shadow: none;
        background-color: rgba(0,0,0,0);
        border-bottom: 2px solid #f6f6f6;
        padding:7.5px 7.5px 0 27.5px;
    }
    #paper-tree li a cite{
        font-size: 14px;
        color: #666;
        font-weight: 400;
        width: 140px;
        display: inline-block;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }
    #paper-tree li ul{
        margin-left: 22px;
    }
    #paper-tree ul{
        margin-bottom: 0;
    }
    #paper-tree .layui-tree-branch{
        display: none;
    }
    #paper-tree li .layui-tree-spread{
        display: none;
    }
    #paper-tree .layui-tree-leaf{
        display: none;
    }
    #paper-tree li a{
        color: #666;
    }
    #paper-tree>li{
        margin:  0 0 27px 10px;
    }
    #paper-tree>li:first-child{
        margin-top:  10px;
    }
    #paper-tree li ul li:first-child{
        margin: 10px 0 0 0px;
    }
    #paper-tree li ul li{
        margin:  10px 0 0 0px;
    }
    .layui-show .layui-form-select dl{
        top: 32px;
    }
    .layui-layer-load{
        background-color: white;
    }
</style>
<link rel="stylesheet" href="../../assetsInfo/libs/zTree/css/metroStyle/metroStyle.css">
<div class="layui-row layui-col-space15">
    <div class="layui-col-md12">
        <!--<div class="layui-card cardHeight" style="height: calc(100vh - 70px);">-->
        <div class="layui-card cardHeight" style="height: calc(100vh - 80px);">
           <div class="layui-tab layui-tab-brief" lay-filter="demo" >
               <ul class="layui-tab-title " id="tabTitle">
                   <li class="layui-this">论文</li>
                   <li>获奖</li>
                   <li>软件著作</li>
                   <li>专利</li>
                   <!--<li>书籍</li>
                   <li>其他</li>-->
               </ul>
               <div class="layui-tab-content" style="overflow: auto; top: 40px;">
                   <div id="paper-tree" class="paper" ></div>
                    <!--<img src="../../assetsInfo/images/icon/right.png" alt="" class="right">-->
                   <!--论文-->
                   <div id="paper-box" class="layui-tab-item layui-show paperRight">
                       <div class="search layui-form" style="height:30px">
                           <div class="layui-inline layui-form-item" style="float: left;width:160px; margin-right:10px;margin-bottom: 0">
                               <select id="searchName" lay-filter="searchName">
                                   <option selected value="">请选择</option>
                                   <option value="name">题名</option>
                                   <option value="publishedJournals">发表期刊</option>
                                   <option value="index">索引</option>
                                   <option value="company">公司</option>
                                   <option value="authorUserNames">作者</option>
                                   <option value="keywords">关键词</option>
                                   <option value="6">刊登时间</option>
                               </select>
                           </div>
                           <input type="text" id="searchKey" style="width: 181px;float: left;" class="layui-input" >
                           <input type="text" id="published" style="width: 181px;float: left; display: none" class="layui-input">
                           <div class="layui-inline" style=" display: none;float: left;width: 181px;" id="paperIndex">
                               <select name="index">
                                   <option value="" selected>请选择</option>
                                   <option value="0">无</option>
                                   <option value="1">EI</option>
                                   <option value="2">SCI</option>
                                   <option value="3">ISTP</option>
                                   <option value="4">ISR</option>
                               </select>
                           </div>
                           <div class="layui-inline" style="float: left;margin-left:10px">
                               <button id="searchTask" style="background-color: rgba(51,166,212,1);color:#fff"  class="layui-btn layui-btn-sm layui-btn-normal" lay-submit title="查询">查询</button>
                               <button  id="resetTask" style="border:1px solid #d9d9d9;color:#999999" class="layui-btn layui-btn-sm layui-btn-normal" lay-submit title="重置">重置</button>
                           </div>
                           <div class="layui-inline" style="float: right;">
                               <button  style="background-color: rgba(51,166,212,1);color:#fff"  class="layui-btn layui-btn-sm layui-btn-normal addPaper" lay-submit title="增加">增加</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal delPaper" lay-submit title="删除">删除</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal editPaper" lay-submit title="编辑">编辑</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal downPaper" lay-submit title="导出">导出</button>
                           </div>

                       </div>
                       <a class="paper-refresh" style="display: none;" href="javascript:;" title="刷新" ></a>
                       <table id="paper-table" lay-filter="paper-table"></table>
                   </div>
                   <!--获奖-->
                   <div id="prize-box" class="layui-tab-item paperRight">
                       <div class="search layui-form" style="height:30px">
                           <div class="layui-inline layui-form-item" style="float: left;width:160px; margin-right:10px;margin-bottom: 0">
                               <select id="searchPrize" lay-filter="searchPrize">
                                   <option selected value="">请选择</option>
                                   <option value="projectName">获奖项目名称</option>
                                   <option value="prizeName">奖项名称</option>
                                   <option value="level">获奖等级</option>
                                   <option value="1">获奖时间</option>
                                   <option value="issuedDept">颁发单位</option>
                                   <option value="belongedUserName">获奖人</option>
                               </select>
                           </div>
                           <input type="text" id="prizeKey" style="width: 181px;float: left;" class="layui-input" >
                           <input type="text" id="prizeDate" style="width: 181px;float: left; display: none" class="layui-input">
                           <div class="layui-inline" style="float: left;margin-left:10px">
                               <button id="prizeSearchTask" style="background-color: rgba(51,166,212,1);color:#fff"  class="layui-btn layui-btn-sm layui-btn-normal" lay-submit title="查询">查询</button>
                               <button  id="prizeResetTask" style="border:1px solid #d9d9d9;color:#999999" class="layui-btn layui-btn-sm layui-btn-normal" lay-submit title="重置">重置</button>
                           </div>
                           <div class="layui-inline" style="float: right;">
                               <button  style="background-color: rgba(51,166,212,1);color:#fff"  class="layui-btn layui-btn-sm layui-btn-normal addPrize" lay-submit title="增加">增加</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal delPrize" lay-submit title="删除">删除</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal editPrize" lay-submit title="编辑">编辑</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal downPrize" lay-submit title="导出">导出</button>
                           </div>

                       </div>
                       <a class="prize-refresh" style="display: none;" href="javascript:;" title="刷新" ></a>
                       <table id="prize-table" lay-filter="prize-table"></table>
                   </div>
                   <!--软件著作-->
                   <div id="copyright-box" class="layui-tab-item paperRight">
                       <div class="search layui-form" style="height:30px">
                           <div class="layui-inline layui-form-item" style="float: left;width:160px; margin-right:10px;margin-bottom: 0">
                               <select id="searchCopyright" lay-filter="searchCopyright">
                                   <option selected value="">请选择</option>
                                   <option value="softwareName">软件名称</option>
                                   <option value="copyrightType">类型</option>
                                   <option value="1">申请日期</option>
                                   <option value="2">登记日期</option>
                                   <option value="registerNum">登记号</option>
                                   <option value="state">状态</option>
                                   <option value="belongUserName">著作权人</option>
                               </select>
                           </div>
                           <input type="text" id="copyrightKey" style="width: 181px;float: left;" class="layui-input" >
                           <input type="text" id="copyrightDate" style="width: 181px;float: left; display: none" class="layui-input">
                           <div class="layui-inline" style="float: left;margin-left:10px">
                               <button id="copyrightSearchTask" style="background-color: rgba(51,166,212,1);color:#fff"  class="layui-btn layui-btn-sm layui-btn-normal" lay-submit title="查询">查询</button>
                               <button  id="copyrightResetTask" style="border:1px solid #d9d9d9;color:#999999" class="layui-btn layui-btn-sm layui-btn-normal" lay-submit title="重置">重置</button>
                           </div>
                           <div class="layui-inline" style="float: right;">
                               <button  style="background-color: rgba(51,166,212,1);color:#fff"  class="layui-btn layui-btn-sm layui-btn-normal addCopyright" lay-submit title="增加">增加</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal delCopyright" lay-submit title="删除">删除</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal editCopyright" lay-submit title="编辑">编辑</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal downCopyright" lay-submit title="导出">导出</button>
                           </div>

                       </div>
                       <a class="copyright-refresh" style="display: none;" href="javascript:;" title="刷新" ></a>
                       <table id="copyright-table" lay-filter="copyright-table"></table>
                   </div>
                   <!--专利-->
                   <div id="patent-box" class="layui-tab-item paperRight">
                       <div class="search layui-form" style="height:30px">
                           <div class="layui-inline layui-form-item" style="float: left;width:160px; margin-right:10px;margin-bottom: 0">
                               <select id="searchPatent" lay-filter="searchPatent">
                                   <option selected value="">请选择</option>
                                   <option value="type">专利类型</option>
                                   <option value="name">专利名称</option>
                                   <option value="designerUserNames">设计人</option>
                                   <option value="num">专利号</option>
                                   <option value="1">专利申请日</option>
                                   <option value="belongUserName">专利权人</option>
                                   <option value="2">授权公告日</option>
                                   <option value="authorizeNum">授权公告号</option>
                                   <option value="certificateNum">证书号</option>
                               </select>
                           </div>
                           <input type="text" id="patentKey" style="width: 181px;float: left;" class="layui-input" >
                           <input type="text" id="patentDate" style="width: 181px;float: left; display: none" class="layui-input">
                           <div class="layui-inline" style=" display: none;float: left;width: 181px;" id="patentType">
                               <select name="type">
                                   <option value="" selected>请选择</option>
                                   <option value="0" >发明专利</option>
                                   <option value="1">实用新型专利</option>
                                   <option value="2">外观设计专利</option>
                               </select>
                           </div>
                           <div class="layui-inline " style="float: left;margin-left:10px">
                               <button id="patentSearchTask" style="background-color: rgba(51,166,212,1);color:#fff"  class="layui-btn layui-btn-sm layui-btn-normal" lay-submit title="查询">查询</button>
                               <button  id="patentResetTask" style="border:1px solid #d9d9d9;color:#999999" class="layui-btn layui-btn-sm layui-btn-normal" lay-submit title="重置">重置</button>
                           </div>
                           <div class="layui-inline" style="float: right;">
                               <button  style="background-color: rgba(51,166,212,1);color:#fff"  class="layui-btn layui-btn-sm layui-btn-normal addPatent" lay-submit title="增加">增加</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal delPatent" lay-submit title="删除">删除</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal editPatent" lay-submit title="编辑">编辑</button>
                               <button style="color:#999999" class="layui-btn layui-btn-sm layui-btn-normal downPatent" lay-submit title="导出">导出</button>
                           </div>

                       </div>
                       <a class="btn-refresh" style="display: none;" href="javascript:;" title="刷新" ></a>
                       <table id="patent-table" lay-filter="patent-table"></table>
                   </div>
                   <!--<div class="layui-tab-item">书籍</div>
                   <div class="layui-tab-item">其他</div>-->
               </div>
           </div>
       </div>
    </div>
</div>
<script src="../../assetsInfo/libs/zTree/js/jquery.ztree.all.min.js"></script>
<script src="../../assetsInfo/js/MenuAuthHelper.js"></script>
<script>
    layui.use(['element','laypage','tree','util','table','form','laydate'], function () {
        var element = layui.element,
            table = layui.table,
            tree = layui.tree,
            form = layui.form,
            admin = layui.admin,
            laydate = layui.laydate,
            config = layui.config,
            util = layui.util;
        var index = 0;
        var he = $(document).height()-200;
        laydate.render({
            elem: '#published',
            range: '~',
            value: new Date().toLocaleDate()+' ~ '+new Date().toLocaleDate()
        });
        laydate.render({
            elem: '#patentDate',
            range: '~',
            value: new Date().toLocaleDate()+' ~ '+new Date().toLocaleDate()
        });
        laydate.render({
            elem: '#prizeDate',
            range: '~',
            value: new Date().toLocaleDate()+' ~ '+new Date().toLocaleDate()
        });
        laydate.render({
            elem: '#copyrightDate',
            range: '~',
            value: new Date().toLocaleDate()+' ~ '+new Date().toLocaleDate()
        });
        var newData = [];
        $.ajax({
            type: "get",
            url: "/api/sys/org/listOrgTree?orgId=" + 'MH8JQV5TSN',
            success: function (data) {
                if (data != null) {
                    var childrenData = [];
                    var nextData = []
                    var data = data.data
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].type == 0) {
                            newData.push(data[i])
                        } else if (data[i].type == 1) {
                            childrenData.push(data[i])
                        } else if(data[i].type == 2){
                            nextData.push(data[i])
                        }
                    }
                    for (var j = 0; j < childrenData.length; j++) {
                        childrenData[j].children = [];
                        for (var i = 0; i < nextData.length; i++) {
                            if (nextData[i].parentId == childrenData[j].id) {
                                childrenData[j].children.push(nextData[i])
                            }
                        }
                    }
                    for (var j = 0; j < newData.length; j++) {
                        newData[j].children = [];
                        for (var i = 0; i < childrenData.length; i++) {
                            if (childrenData[i].parentId == newData[j].id) {
                                newData[j].children.push(childrenData[i])
                            }
                        }
                    }
                    element.on('tab(demo)', function(data){
                        index = data.index;
                        var tableArr = [tablePaper, tablePrize,tableCopyright,tablePatent,tablePaper,tablePaper];
                        tableArr[index]()
                        $('#paper-tree li a cite').css('color', '#666');
                        $('#searchName').attr('name', '');
                    });
                    tablePaper();
                    layui.tree({
                        elem: '#paper-tree', //指定元素
                        showLine: 'false',
                        nodes: newData,
                        click: function(item){ //点击节点回调
                            if(index==0){
                                tablePaper(item.id);
                            }else if(index==3){
                                tablePatent(item.id);
                            }else if(index == 1){
                                tablePrize(item.id)
                            }else if(index == 2){
                                tableCopyright(item.id)
                            }
                            $('#searchName').attr('name', item.id);
                        }
                    });
                    //默认选中第一个树节点
//                    $('#paper-tree li a cite').first().css('color', '#18B1EB');
                    $('#paper-tree li ul').addClass('layui-show');
//                    $('#searchName').attr('name', newData[0].id);
//                    $('#searchPatent').attr('name', newData[0].id);
                    //左侧树样式
                    $('#paper-tree li a cite').on('click', function(){
                        $('#paper-tree li a cite').css('color', '#666')
                        $(this).css('color', '#18B1EB')
                    })
                    $('#paper-tree li>a').off('dblclick')
                    $('#paper-tree li').find('.layui-tree-spread').parent().prepend('<img style="display:none" src="../../assetsInfo/images/icon/shouqi.png"/><img src="../../assetsInfo/images/icon/zhankai1.png"/>')
                    $('#paper-tree li').find('.layui-tree-leaf').parent().parent().prepend('<img src="../../assetsInfo/images/icon/zhankai.png"/>')
                    $('#paper-tree li ul li ul li').find('.layui-tree-leaf').parent().parent().find('img').css('visibility', 'hidden')
                    $('#paper-tree li').find('img').css('cursor', 'pointer');

                    /* $('#deliverable-tree li').find('.layui-tree-spread').parent().children('a').on('click', function(){
                     $(this).parent().find('img').toggle();
                     $(this).parent().find('ul').toggleClass('layui-show')
                     })*/
                    $('#paper-tree li').find('.layui-tree-spread').parent().children('img').off('click').on('click', function(){
                        $(this).parent().find('img').toggle();
                        $(this).parent().find('ul').toggleClass('layui-show')
                    });
            /* 论文 */
                    function tablePaper(deptId,searchName,searchKey){
                        var search = {};
                        if(searchName){
                            if(searchName=='6'){
                                search.startPublishedTime=searchKey.split('~')[0];
                                search.endPublishedTime=searchKey.split('~')[1];
                                // var searchWord = '&startPublishedTime='+searchKey.split('~')[0]+'&endPublishedTime='+searchKey.split('~')[1];
                            }else{
                                search[searchName]=searchKey;
                                // var searchWord = '&'+searchName + '='+ searchKey;
                            }
                        }
                        if(deptId){
                            search.deptId=deptId;
                        }

                        table.render({
                            elem: '#paper-table',
                            id: 'paper-table',
                            height: he,
                            url: admin.formatUrl('/api/knowledge/paper/page'),
                            contentType: "application/json",
                            method: 'post',
                            // 格式化后台返回的数据
                            parseData: function (res) {
                                return {
                                    "code": res.respCode, //解析接口状态
                                    "msg": res.message, //解析提示文本
                                    "count": res.data?res.data.count:'', //解析数据长度
                                    "data": res.data?res.data.list:[] //解析数据列表
                                };
                            },
                            cols: [
                                [{
                                    type: 'checkbox'
                                },
                                    {
                                        field: 'publishedJournals',
                                        title: '发表期刊',
                                        align: 'center',
                                        event: 'view',
                                        templet:function(d) {
                                            var text= d.publishedJournals ? d.publishedJournals : "";
                                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                        }
                                    }, {
                                    field: 'name',
                                    title: '题名',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.name ? d.name : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                }, {
                                    field: 'keywords',
                                    title: '关键词',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.keywords ? d.keywords : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'index',
                                    title: '索引',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.index ? d.index : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'company',
                                    title: '公司',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.company ? d.company : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'authorUserNames',
                                    title: '作者',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.authorUserNames ? d.authorUserNames : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                }, {
                                    field: 'deptName',
                                    title: '部门',
                                    event: 'view',
                                    align: 'center',
                                    templet:function(d) {
                                        var text= d.deptName ? d.deptName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'uploadUserName',
                                    title: '上传人',
                                    event: 'view',
                                    align: 'center',
                                    templet:function(d) {
                                        var text= d.uploadUserName ? d.uploadUserName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'updateTime',
                                    title: '更新时间',
                                    align: 'center',
                                    event: 'view',
                                    templet: function(d) {
                                        return d.updateTime?layui.util.toDateString(d.updateTime,'yyyy-MM-dd'):'';
                                    }
                                }]
                            ],
                            page: {
                                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                            },
                            request: {
                                pageName: 'page',
                                limitName: 'pageSize'
                            },
                            limit: 10,
                            where: search,
                            skin: 'row',
                            even: true,
                            done: function(){
                                $('#paper-box').find('.layui-table-body').find('.box').remove()
                                if($('#paper-box').find('.layui-table-body').children().length>1){
                                    $('#paper-box').find('.layui-table-body').find('.layui-none').remove();
                                    // $('#paper-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: calc(100vh - 270px); text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: calc(100vh - 270px)"></div>')
                                    $('#paper-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: 330px; text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: 330px"></div>')
                                }
                            }
                        });
                    }
                    form.on('select(searchName)', function(data){
                        if(data.value=='6'){
                            $('#published').show();
                            $('#searchKey').hide();
                            $('#paperIndex').hide()
                        }else if(data.value=='index'){
                            $('#published').hide();
                            $('#searchKey').hide();
                            $('#paperIndex').show()
                        }else{
                            $('#published').hide();
                            $('#searchKey').show();
                            $('#paperIndex').hide()
                        }
                    })
                    //论文搜索
                    $('#searchTask').on('click',function () {
                        var searchName = $('#searchName option:selected').val();
                        if(searchName == '6'){
                            var searchKey = $('#published').val();
                            if(new Date(searchKey.split('~')[0]).getTime() - (new Date(searchKey.split('~')[1]).getTime()) > 0){
                                layer.msg('开始时间不能大于结束时间');
                                return
                            }
                        }else if(searchName == 'index'){
                            var searchKey = $('#paperIndex option:selected').text();
                        }else{
                            var searchKey = $('#searchKey').val();
                        }
                        var deptId = $('#searchName').attr('name');
                        tablePaper(deptId,searchName,searchKey);
                    })
                    //论文重置
                    $('#resetTask').on('click',function(){
                        $("#searchName option[value='']").prop('selected', 'selected');
                        form.render('select');
                        $('#published').val('');
                        $('#searchKey').val('');
                        var deptId = $('#searchName').attr('name');
                        tablePaper(deptId);
                    })
                    //论文删除
                    $('.delPaper').on('click', function () {
                        var checkStatus = table.checkStatus('paper-table');
                        var account = config.getAccount();
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择一个文件！', {
                                icon: 0
                            });
                        }else if(checkStatus.data.length >1){
                            return layer.msg('只能选择一个文件！', {
                                icon: 0
                            });
                        }
                        if(account.usid!==checkStatus.data[0].uploadUserId&&account.usname!=='管理员1号'){
                            return layer.msg('您无权删除', {
                                icon: 0
                            });
                        }
                        var patentArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            patentArr.push(checkStatus.data[i].id)
                        }
                        layer.confirm('确认要删除' + checkStatus.data[0].name+ '吗?', {
                            icon: 3,
                            title: '提示'
                        }, function () {
                            admin.req('/api/knowledge/paper/'+checkStatus.data[0].id, {},function (data) {
                                if (data.ok) {
                                    layer.msg('删除成功', {
                                        icon: 1
                                    });
                                    table.reload('paper-table', {
                                        where: {
                                            reload: new Date().getTime()
                                        }
                                    });

                                } else {
                                    return layer.msg(data.reason, {
                                        icon: 5
                                    });
                                }
                            }, {
                                method: 'delete'
                            });
                        });
                    })
                    //论文导出
                    $('.downPaper').on('click',function(){
                        var checkStatus = table.checkStatus('paper-table');
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择文件！', {
                                icon: 0
                            });
                        }
                        var paperArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            paperArr.push(checkStatus.data[i].id)
                        }
                        var data = layui.util.toDateString().split(' ')[0].split('-')
                        window.location.href = "/ADC_info/api/knowledge/paper/export?fileName="+'论文-'+data[0]+data[1]+data[2]+"&paperIds="+paperArr
                    })
                    //论文增加
                    $('.addPaper').off('click').on('click',function(){
                        var index = layer.open({
                            type: 2,
                            title: '新增论文',
                            area: ['55%', '87%'], //宽高
                            content: 'components/tpl/add_paper_form.html',
                        });
                    })
                    $('.paper-refresh').on('click',function () {
                        table.reload('paper-table', {
                            where: {
                                reload: new Date().getTime()
                            }
                        });
                    });
                    //论文编辑
                    $('.editPaper').off('click').on('click',function(){
                        var checkStatus = table.checkStatus('paper-table');
                        var account = config.getAccount();
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择一个文件！', {
                                icon: 0
                            });
                        }else if(checkStatus.data.length >1){
                            return layer.msg('只能选择一个文件！', {
                                icon: 0
                            });
                        }
                        if(account.usid!==checkStatus.data[0].uploadUserId&&account.usname!=='管理员1号'){
                            return layer.msg('您无权编辑此条论文', {
                                icon: 0
                            });
                        }
                        /*var patentArr = [];
                         for(var i = 0; i<checkStatus.data.length; i++){
                         patentArr.push(checkStatus.data[i].id)
                         }*/
                        $('.editPaper').attr('name',checkStatus.data[0].id)
                        var index = layer.open({
                            type: 2,
                            title: '编辑论文',
                            area: ['55%', '87%'], //宽高
                            content: 'components/tpl/add_paper_form.html',
                        });
                    })
                    //论文查看
                    table.on('tool(paper-table)',function(obj){
                        if(obj.event=='view'){
                            var data = obj.data;
                            json = JSON.stringify(data);
                            layer.open({
                                type: 2,
                                title: '查看论文',
                                area: ['55%', '80%'], //宽高
                                content: 'components/tpl/view_paper_form.html'
                            });
                        }
                    })

            /* 专利 */
                    function tablePatent(deptId,searchName,searchKey){
                        var search = {};
                        var typeArr = ['发明专利','实用新型专利','外观设计专利'];

                        if(searchName){
                            if(searchName=='1'){
                                search.startApplyDate=searchKey.split('~')[0];
                                search.endApplyDate=searchKey.split('~')[1];
                            }else if(searchName=='2'){
                                search.startAuthorizeDate=searchKey.split('~')[0];
                                search.endAuthorizeDate=searchKey.split('~')[1];
                            }else{
                                search[searchName]=searchKey;
                            }
                        }
                        if(deptId){
                            search.deptId=deptId;
                        }
                        var exportData='';
                        var patent = table.render({
                            elem: '#patent-table',
                            id: 'patent-table',
                            url: admin.formatUrl('/api/knowledge/patent/page'),
                            contentType: "application/json",
                            method: 'post',
                            // 格式化后台返回的数据
                            parseData: function (res) {
                                return {
                                    "code": res.respCode, //解析接口状态
                                    "msg": res.message, //解析提示文本
                                    "count": res.data?res.data.count:'', //解析数据长度
                                    "data": res.data?res.data.list:[] //解析数据列表
                                };
                            },
                            cols: [
                                [{
                                    type: 'checkbox'
                                },
                                    {
                                        field: 'type',
                                        title: '专利类型',
                                        align: 'center',
                                        event: 'view',
                                        templet:function(d) {
                                            var text= d.type ? d.type : "";
                                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                        }
                                    }, {
                                    field: 'name',
                                    title: '专利名称',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.name ? d.name : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                }, {
                                    field: 'designerUserNames',
                                    title: '设计人',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.designerUserNames ? d.designerUserNames : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'num',
                                    title: '专利号',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.num ? d.num : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'applyDate',
                                    title: '专利申请日',
                                    align: 'center',
                                    event: 'view',
                                    width: 105,
                                    templet:function(d) {
                                        return d.applyDate?layui.util.toDateString(d.applyDate,'yyyy-MM-dd'):'';
                                    }
                                },{
                                    field: 'belongUserName',
                                    title: '专利权人',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.belongUserName ? d.belongUserName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                }, {
                                    field: 'authorizeDate',
                                    title: '授权公告日',
                                    align: 'center',
                                    event: 'view',
                                    width: 105,
                                    templet: function(d) {
                                        return d.authorizeDate?layui.util.toDateString(d.authorizeDate,'yyyy-MM-dd'):'';
                                    }
                                },{
                                    field: 'authorizeNum',
                                    title: '授权公告号',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.authorizeNum ? d.authorizeNum : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'certificateNum',
                                    title: '证书号',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.certificateNum ? d.certificateNum : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'uploadUserName',
                                    title: '上传人',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.uploadUserName ? d.uploadUserName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'uploadTime',
                                    title: '更新时间',
                                    align: 'center',
                                    event: 'view',
                                    width: 105,
                                    templet: function(d) {
                                        return d.uploadTime?layui.util.toDateString(d.uploadTime,'yyyy-MM-dd'):'';
                                    }
                                }]
                            ],
                            page: {
                                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                            },
                            request: {
                                pageName: 'page',
                                limitName: 'pageSize'
                            },
                            limit: 10,
                            where: search,
                            height: he,
                            skin: 'row',
                            even: true,
                            done: function(res){
                                exportData = res.data
                                $('#patent-box').find('.layui-table-body').find('.box').remove()
                                if($('#patent-box').find('.layui-table-body').children().length>1){
                                    $('#patent-box').find('.layui-table-body').find('.layui-none').remove();
//                                    $('#patent-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: calc(100vh - 270px); text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: calc(100vh - 270px)"></div>')
                                    $('#patent-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: 330px; text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: 330px"></div>')
                                }
                            }
                        });
                        //专利导出
                        /*$('.downPatent').on('click', function (){
                            table.exportFile(patent.config.id, exportData,'xls')
                        })*/
                    }
                    //专利增加
                    $('.addPatent').off('click').on('click',function(){
                        var index = layer.open({
                            type: 2,
                            title: '新增专利',
                            area: ['55%', '83%'], //宽高
                            content: 'components/tpl/add_patent_form.html',
                        });
                    })
                    //专利编辑
                    $('.editPatent').off('click').on('click',function(){
                        var checkStatus = table.checkStatus('patent-table');
                        var account = config.getAccount();
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择一个文件！', {
                                icon: 0
                            });
                        }else if(checkStatus.data.length >1){
                            return layer.msg('只能选择一个文件！', {
                                icon: 0
                            });
                        }
                        if(account.usid!==checkStatus.data[0].uploadUserId&&account.usname!=='管理员1号'){
                            return layer.msg('您无权编辑此条专利', {
                                icon: 0
                            });
                        }
                        /*var patentArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            patentArr.push(checkStatus.data[i].id)
                        }*/
                        $('.editPatent').attr('name',checkStatus.data[0].id)
                        var index = layer.open({
                            type: 2,
                            title: '编辑专利',
                            area: ['55%', '83%'], //宽高
                            content: 'components/tpl/add_patent_form.html',
                        });
                    })
                    $('.btn-refresh').on('click',function () {
                        table.reload('patent-table', {
                            where: {
                                reload: new Date().getTime()
                            }
                        });
                    });
                    //专利查看
                    table.on('tool(patent-table)',function(obj){
                        if(obj.event=='view'){
                            var data = obj.data;
                            json = JSON.stringify(data);
                            layer.open({
                                type: 2,
                                title: '查看专利',
                                area: ['55%', '69%'], //宽高
                                content: 'components/tpl/view_patent_form.html'
                            });
                        }
                    })
                    //专利删除
                    $('.delPatent').on('click', function () {
                        var checkStatus = table.checkStatus('patent-table');
                        var account = config.getAccount();
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择一个文件！', {
                                icon: 0
                            });
                        } else if(checkStatus.data.length >1){
                            return layer.msg('只能选择一个文件！', {
                                icon: 0
                            });
                        }
                        if(account.usid!==checkStatus.data[0].uploadUserId&&account.usname!=='管理员1号'){
                            return layer.msg('您无权删除', {
                                icon: 0
                            });
                        }
                        var patentArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            patentArr.push(checkStatus.data[i].id)
                        }
                        layer.confirm('确认要删除' + checkStatus.data[0].name+ '吗?', {
                            icon: 3,
                            title: '提示'
                        }, function () {
                            admin.req('/api/knowledge/patent/'+checkStatus.data[0].id, {},function (data) {
                                if (data.ok) {
                                    layer.msg('删除成功', {
                                        icon: 1
                                    });
                                    table.reload('patent-table', {
                                        where: {
                                            reload: new Date().getTime()
                                        }
                                    });

                                } else {
                                    return layer.msg(data.reason, {
                                        icon: 5
                                    });
                                }
                            }, {
                                method: 'delete'
                            });
                        });
                    })
                    //专利搜索
                    form.on('select(searchPatent)', function(data){
                        if(data.value=='1'||data.value=='2'){
                            $('#patentDate').show();
                            $('#patentKey').hide();
                            $('#patentType').hide();
                        }else if(data.value=='type'){
                            $('#patentDate').hide();
                            $('#patentKey').hide();
                            $('#patentType').show();
                        }else{
                            $('#patentDate').hide();
                            $('#patentKey').show();
                            $('#patentType').hide();
                        }
                    })
                    $('#patentSearchTask').on('click',function () {
                        var searchName = $('#searchPatent option:selected').val();
                        if(searchName == '1'||searchName == '2'){
                            var searchKey = $('#patentDate').val();
                            if(new Date(searchKey.split('~')[0]).getTime() - (new Date(searchKey.split('~')[1]).getTime()) > 0){
                                layer.msg('开始时间不能大于结束时间');
                                return
                            }
                        }else if(searchName == 'type'){
                            var searchKey = $('#patentType option:selected').text();
                        }else{
                            var searchKey = $('#patentKey').val();
                        }
                        var deptId = $('#searchName').attr('name')
                        tablePatent(deptId,searchName,searchKey);
                    })
                    //专利重置
                    $('#patentResetTask').on('click',function(){
                        $("#searchPatent option[value='']").prop('selected', 'selected');
                        $("#patentType option[value='']").prop('selected', 'selected');
                        form.render('select');
                        $('#patentDate').val('');
                        $('#patentKey').val('');
                        var deptId = $('#searchName').attr('name');
                        tablePatent(deptId);
                    })
                    //专利导出
                    $('.downPatent').on('click',function(){
                        var checkStatus = table.checkStatus('patent-table');
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择文件！', {
                                icon: 0
                            });
                        }
                        var patentArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            patentArr.push(checkStatus.data[i].id)
                        }
                        var data = layui.util.toDateString().split(' ')[0].split('-')
                        window.location.href = "/ADC_info/api/knowledge/patent/export?fileName="+'专利-'+data[0]+data[1]+data[2]+"&patentIds="+patentArr
                    })

            /* 获奖 */
                    function tablePrize(deptId,searchName,searchKey){
                        var search = {};

                        if(searchName){
                            if(searchName=='1'){
                                search.startPrizeTime=searchKey.split('~')[0];
                                search.endPrizeTime=searchKey.split('~')[1];
                            }else{
                                search[searchName]=searchKey;
                            }
                        }
                        if(deptId){
                            search.deptId=deptId;
                        }
                        var prize = table.render({
                            elem: '#prize-table',
                            id: 'prize-table',
                            url: admin.formatUrl('/api/knowledge/prize/page'),
                            contentType: "application/json",
                            method: 'post',
                            // 格式化后台返回的数据
                            parseData: function (res) {
                                return {
                                    "code": res.respCode, //解析接口状态
                                    "msg": res.message, //解析提示文本
                                    "count": res.data?res.data.count:'', //解析数据长度
                                    "data": res.data?res.data.list:[] //解析数据列表
                                };
                            },
                            cols: [
                                [{
                                    type: 'checkbox'
                                },
                                    {
                                        field: 'projectName',
                                        title: '获奖项目名称',
                                        align: 'center',
                                        event: 'view',
                                        templet:function(d) {
                                            var text= d.projectName ? d.projectName : "";
                                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                        }
                                    }, {
                                    field: 'prizeName',
                                    title: '奖项名称',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.prizeName ? d.prizeName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                }, {
                                    field: 'level',
                                    title: '获奖等级',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.level ? d.level : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'prizeTime',
                                    title: '获奖时间',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        return d.prizeTime?layui.util.toDateString(d.prizeTime,'yyyy-MM-dd'):'';
                                    }
                                },{
                                    field: 'issuedDept',
                                    title: '颁发单位',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.issuedDept ? d.issuedDept : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'belongedUserName',
                                    title: '获奖人',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.belongedUserName ? d.belongedUserName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'deptName',
                                    title: '部门',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.deptName ? d.deptName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'uploadUserName',
                                    title: '上传人',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.uploadUserName ? d.uploadUserName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'updateTime',
                                    title: '更新时间',
                                    align: 'center',
                                    event: 'view',
                                    templet: function(d) {
                                        return d.updateTime?layui.util.toDateString(d.updateTime,'yyyy-MM-dd'):'';
                                    }
                                }]
                            ],
                            page: {
                                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                            },
                            request: {
                                pageName: 'page',
                                limitName: 'pageSize'
                            },
                            limit: 10,
                            where: search,
                            height: he,
                            skin: 'row',
                            even: true,
                            done: function(res){
                                exportData = res.data
                                $('#prize-box').find('.layui-table-body').find('.box').remove()
                                if($('#prize-box').find('.layui-table-body').children().length>1){
                                    $('#prize-box').find('.layui-table-body').find('.layui-none').remove();
//                                    $('#prize-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: calc(100vh - 270px); text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: calc(100vh - 270px)"></div>')
                                    $('#prize-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: 330px; text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: 330px"></div>')
                                }
                            }
                        });
                    }
                    //获奖搜索
                    form.on('select(searchPrize)', function(data){
                        if(data.value=='1'){
                            $('#prizeDate').show();
                            $('#prizeKey').hide()
                        }else{
                            $('#prizeDate').hide();
                            $('#prizeKey').show()
                        }
                    });
                    $('#prizeSearchTask').on('click',function () {
                        var searchName = $('#searchPrize option:selected').val();
                        if(searchName == '1'){
                            var searchKey = $('#prizeDate').val();
                            if(new Date(searchKey.split('~')[0]).getTime() - (new Date(searchKey.split('~')[1]).getTime()) > 0){
                                layer.msg('开始时间不能大于结束时间');
                                return
                            }
                        }else{
                            var searchKey = $('#prizeKey').val();
                        }
                        var deptId = $('#searchName').attr('name')
                        tablePrize(deptId,searchName,searchKey);
                    });
                    //获奖删除
                    $('.delPrize').on('click', function () {
                        var checkStatus = table.checkStatus('prize-table');
                        var account = config.getAccount();

                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择一个文件！', {
                                icon: 0
                            });
                        }else if(checkStatus.data.length >1){
                            return layer.msg('只能选择一个文件！', {
                                icon: 0
                            });
                        }
                        if(account.usid!==checkStatus.data[0].uploadUserId&&account.usname!=='管理员1号'){
                            return layer.msg('您无权删除', {
                                icon: 0
                            });
                        }
                        var patentArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            patentArr.push(checkStatus.data[i].id)
                        }
                        layer.confirm('确认要删除' + checkStatus.data[0].prizeName+ '吗?', {
                            icon: 3,
                            title: '提示'
                        }, function () {
                            admin.req('/api/knowledge/prize/'+checkStatus.data[0].id, {},function (data) {
                                if (data.ok) {
                                    layer.msg('删除成功', {
                                        icon: 1
                                    });
                                    table.reload('prize-table', {
                                        where: {
                                            reload: new Date().getTime()
                                        }
                                    });

                                } else {
                                    return layer.msg(data.reason, {
                                        icon: 5
                                    });
                                }
                            }, {
                                method: 'delete'
                            });
                        });
                    });
                    //获奖重置
                    $('#prizeResetTask').on('click',function(){
                        $("#searchPrize option[value='']").prop('selected', 'selected');
                        form.render('select');
                        $('#prizeKey').val('');
                        $('#prizeDate').val('');
                        var deptId = $('#searchName').attr('name');
                        tablePrize(deptId);
                    });
                    //获奖导出
                    $('.downPrize').on('click',function(){
                        var checkStatus = table.checkStatus('prize-table');
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择文件！', {
                                icon: 0
                            });
                        }
                        var prizeArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            prizeArr.push(checkStatus.data[i].id)
                        }
                        var data = layui.util.toDateString().split(' ')[0].split('-')
                        window.location.href = "/ADC_info/api/knowledge/prize/export?fileName="+'获奖-'+data[0]+data[1]+data[2]+"&prizeIds="+prizeArr
                    });
                    //获奖增加
                    $('.prize-refresh').on('click',function () {
                        table.reload('prize-table', {
                            where: {
                                reload: new Date().getTime()
                            }
                        });
                    });
                    $('.addPrize').off('click').on('click',function(){
                        var index = layer.open({
                            type: 2,
                            title: '新增获奖',
                            area: ['55%', '80%'], //宽高
                            content: 'components/tpl/add_prize_form.html',

                        });
                    })
                    //获奖编辑
                    $('.editPrize').off('click').on('click',function(){
                        var checkStatus = table.checkStatus('prize-table');
                        var account = config.getAccount();
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择一个文件！', {
                                icon: 0
                            });
                        }else if(checkStatus.data.length >1){
                            return layer.msg('只能选择一个文件！', {
                                icon: 0
                            });
                        }
                        if(account.usid!==checkStatus.data[0].uploadUserId&&account.usname!=='管理员1号'){
                            return layer.msg('您无权编辑此条获奖信息', {
                                icon: 0
                            });
                        }
                        /*var patentArr = [];
                         for(var i = 0; i<checkStatus.data.length; i++){
                         patentArr.push(checkStatus.data[i].id)
                         }*/
                        $('.editPrize').attr('name',checkStatus.data[0].id)
                        var index = layer.open({
                            type: 2,
                            title: '编辑获奖',
                            area: ['55%', '80%'], //宽高
                            content: 'components/tpl/add_prize_form.html',
                        });
                    })
                    //获奖查看
                    table.on('tool(prize-table)',function(obj){
                        console.log(2222)
                        if(obj.event=='view'){
                            var data = obj.data;
                            json = JSON.stringify(data);
                            layer.open({
                                type: 2,
                                title: '查看获奖',
                                area: ['55%', '72%'], //宽高
                                content: 'components/tpl/view_prize_form.html'
                            });
                        }
                    })

            /* 软件著作 */
                    function tableCopyright(deptId,searchName,searchKey){
                        var search = {};
                        if(searchName){
                            if(searchName=='1'){
                                search.startApplyDate=searchKey.split('~')[0];
                                search.endApplyDate=searchKey.split('~')[1];
                            }else if(searchName=='2'){
                                search.startRegisterDate=searchKey.split('~')[0];
                                search.endRegisterDate=searchKey.split('~')[1];
                            }else{
                                search[searchName]=searchKey;
                            }
                        }
                        if(deptId){
                            search.deptId=deptId;
                        }
                        var exportData='';
                        var copyright = table.render({
                            elem: '#copyright-table',
                            id: 'copyright-table',
                            url: admin.formatUrl('/api/knowledge/copyright/page'),
                            contentType: "application/json",
                            method: 'post',
                            // 格式化后台返回的数据
                            parseData: function (res) {
                                return {
                                    "code": res.respCode, //解析接口状态
                                    "msg": res.message, //解析提示文本
                                    "count": res.data?res.data.count:'', //解析数据长度
                                    "data": res.data?res.data.list:[] //解析数据列表
                                };
                            },
                            cols: [
                                [{
                                    type: 'checkbox'
                                },
                                    {
                                        field: 'softwareName',
                                        title: '软件名称',
                                        align: 'center',
                                        event: 'view',
                                        templet:function(d) {
                                            var text= d.softwareName ? d.softwareName : "";
                                            return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                        }
                                    }, {
                                    field: 'copyrightType',
                                    title: '类型',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.copyrightType ? d.copyrightType : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                }, {
                                    field: 'applyDate',
                                    title: '申请日期',
                                    align: 'center',
                                    event: 'view',
                                    width: 105,
                                    templet:function(d) {
                                        return d.applyDate?layui.util.toDateString(d.applyDate,'yyyy-MM-dd'):'';
                                    }
                                },{
                                    field: 'registerDate',
                                    title: '登记日期',
                                    align: 'center',
                                    width: 105,
                                    event: 'view',
                                    templet:function(d) {
                                        return d.registerDate?layui.util.toDateString(d.registerDate,'yyyy-MM-dd'):'';
                                    }
                                },{
                                    field: 'registerNum',
                                    title: '登记号',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.registerNum ? d.registerNum : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                }, {
                                    field: 'state',
                                    title: '状态',
                                    align: 'center',
                                    event: 'view',
                                    templet: function(d) {
                                        var text= d.state ? d.state : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'belongUserName',
                                    title: '著作权人',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.belongUserName ? d.belongUserName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'deptName',
                                    title: '部门',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.deptName ? d.deptName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'uploadUserName',
                                    title: '上传人',
                                    align: 'center',
                                    event: 'view',
                                    templet:function(d) {
                                        var text= d.uploadUserName ? d.uploadUserName : "";
                                        return '<div title="'+text+'"><span>'+ text +'</span></div>'
                                    }
                                },{
                                    field: 'updateTime',
                                    title: '更新时间',
                                    align: 'center',
                                    event: 'view',
                                    width: 105,
                                    templet: function(d) {
                                        return d.updateTime?layui.util.toDateString(d.updateTime,'yyyy-MM-dd'):'';
                                    }
                                }]
                            ],
                            page: {
                                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                            },
                            request: {
                                pageName: 'page',
                                limitName: 'pageSize'
                            },
                            limit: 10,
                            where: search,
                            height: he,
                            skin: 'row',
                            even: true,
                            done: function(res){
                                exportData = res.data
                                $('#copyright-box').find('.layui-table-body').find('.box').remove()
                                if($('#copyright-box').find('.layui-table-body').children().length>1){
                                    $('#copyright-box').find('.layui-table-body').find('.layui-none').remove();
//                                    $('#copyright-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: calc(100vh - 270px); text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: calc(100vh - 270px)"></div>')
                                    $('#copyright-box').find('.layui-table-body').append('<div class="box" style="width: 100%; height: 330px; text-align: center"><img src="../../assetsInfo/images/box.jpg" alt="" style="height: 330px"></div>')
                                }
                            }
                        });
                    }
                    //软件著作搜索
                    form.on('select(searchCopyright)', function(data){
                        if(data.value=='1'||data.value=='2'){
                            $('#copyrightDate').show();
                            $('#copyrightKey').hide()
                        }else{
                            $('#copyrightDate').hide();
                            $('#copyrightKey').show()
                        }
                    });
                    $('#copyrightSearchTask').on('click',function () {
                        var searchName = $('#searchCopyright option:selected').val();
                        if(searchName == '1'||searchName == '2'){
                            var searchKey = $('#copyrightDate').val();
                            if(new Date(searchKey.split('~')[0]).getTime() - (new Date(searchKey.split('~')[1]).getTime()) > 0){
                                layer.msg('开始时间不能大于结束时间');
                                return
                            }
                        }else{
                            var searchKey = $('#copyrightKey').val();
                        }
                        var deptId = $('#searchName').attr('name')
                        tableCopyright(deptId,searchName,searchKey);
                    });
                    //软件著作删除
                    $('.delCopyright').on('click', function () {
                        var checkStatus = table.checkStatus('copyright-table');
                        console.log(checkStatus,12325)
                        var account = config.getAccount();
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择一个文件！', {
                                icon: 0
                            });
                        }else if(checkStatus.data.length >1){
                            return layer.msg('只能选择一个文件！', {
                                icon: 0
                            });
                        }
                        if(account.usid!==checkStatus.data[0].uploadUserId&&account.usname!=='管理员1号'){
                            return layer.msg('您无权删除', {
                                icon: 0
                            });
                        }
                        var patentArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            patentArr.push(checkStatus.data[i].id)
                        }
                        layer.confirm('确认要删除' + checkStatus.data[0].softwareName+ '吗?', {
                            icon: 3,
                            title: '提示'
                        }, function () {
                            admin.req('/api/knowledge/copyright/'+checkStatus.data[0].id, {},function (data) {
                                if (data.ok) {
                                    layer.msg('删除成功', {
                                        icon: 1
                                    });
                                    table.reload('copyright-table', {
                                        where: {
                                            reload: new Date().getTime()
                                        }
                                    });

                                } else {
                                    return layer.msg(data.reason, {
                                        icon: 5
                                    });
                                }
                            }, {
                                method: 'delete'
                            });
                        });
                    })
                    //软件著作重置
                    $('#copyrightResetTask').on('click',function(){
                        $("#searchCopyright option[value='']").prop('selected', 'selected');
                        form.render('select');
                        $('#copyrightKey').val('');
                        $('#copyrightDate').val('');
                        var deptId = $('#searchName').attr('name');
                        tableCopyright(deptId);
                    });
                    //软件著作导出
                    $('.downCopyright').on('click',function(){
                        var checkStatus = table.checkStatus('copyright-table');
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择文件！', {
                                icon: 0
                            });
                        }
                        var copyrightArr = [];
                        for(var i = 0; i<checkStatus.data.length; i++){
                            copyrightArr.push(checkStatus.data[i].id)
                        }
                        var data = layui.util.toDateString().split(' ')[0].split('-')
                        window.location.href = "/ADC_info/api/knowledge/copyright/export?fileName="+'软著-'+data[0]+data[1]+data[2]+"&copyrightIds="+copyrightArr
                    })
                    //软件增加
                    $('.copyright-refresh').on('click',function () {
                        table.reload('copyright-table', {
                            where: {
                                reload: new Date().getTime()
                            }
                        });
                    });
                    $('.addCopyright').off('click').on('click',function(){
                        var index = layer.open({
                            type: 2,
                            title: '新增软件著作权',
                            area: ['55%', '65%'], //宽高
                            content: 'components/tpl/add_copyright_form.html',
                            /*success: function(layero, index){
                                var frameId = $(layero).find("iframe").attr('id')
                                var application = $(window.frames[frameId].document).find("#application")[0]
                                var registerDate = $(window.frames[frameId].document).find("#registerDate")[0]
                                laydate.render({
                                    elem: application,
                                });
                                laydate.render({
                                    elem: registerDate
                                });
                            }*/
                        });
                    })
                    //软件编辑
                    $('.editCopyright').off('click').on('click',function(){
                        var checkStatus = table.checkStatus('copyright-table');
                        var account = config.getAccount();
                        if (checkStatus.data.length == 0) {
                            return layer.msg('请选择一个文件！', {
                                icon: 0
                            });
                        }else if(checkStatus.data.length >1){
                            return layer.msg('只能选择一个文件！', {
                                icon: 0
                            });
                        }
                        if(account.usid!==checkStatus.data[0].uploadUserId&&account.usname!=='管理员1号'){
                            return layer.msg('您无权编辑此条软件著作', {
                                icon: 0
                            });
                        }
                        /*var patentArr = [];
                         for(var i = 0; i<checkStatus.data.length; i++){
                         patentArr.push(checkStatus.data[i].id)
                         }*/
                        $('.editCopyright').attr('name',checkStatus.data[0].id)
                        var index = layer.open({
                            type: 2,
                            title: '编辑软件著作权',
                            area: ['55%', '60%'], //宽高
                            content: 'components/tpl/add_copyright_form.html',
                        });
                    })
                    //软件查看
                    table.on('tool(copyright-table)',function(obj){
                        if(obj.event=='view'){
                            var data = obj.data;
                            json = JSON.stringify(data);
                            layer.open({
                                type: 2,
                                title: '查看软件著作权',
                                area: ['55%', '57%'], //宽高
                                content: 'components/tpl/view_copyright_form.html'
                            });
                        }
                    })
                    //组织机构弹框
                    window.dept = function (callback){
                        layer.open({
                            type: 2,
                            id: 'orgsSelect',
                            title: false,
                            moveOut: true,
                            content: 'components/tpl/dept_select.html',
                            area: ['50%', '70%'],
                            btn: ['确定', '取消'],
                            yes: function (index, layero) {
                                var finalData = $('#orgsSelect iframe')[0].contentWindow
                                    .task_orgs_select.finish();
                                // 获取到数据，执行回掉函数
                                if (finalData.id == '' || finalData.name == '') {
                                    return layer.msg('请选择组织机构', {
                                        icon: 0
                                    });
                                }

                                callback && typeof callback === 'function' && callback(
                                    finalData);
                                layer.close(index);
                            },
                            resize: false
                        });
                    }
                }
            },
            error: function () {
                layer.alert("获取数据错误");
            }
        })
    })
</script>